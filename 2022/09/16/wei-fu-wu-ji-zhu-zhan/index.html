<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="å¾®æœåŠ¡æŠ€æœ¯æ ˆ, å­¦ä¹ ç¬”è®°">
    <meta name="description" content="
å¾®æœåŠ¡æŠ€æœ¯æ ˆğŸ¤¤åŸºç¡€ç¯‡

è®¤è¯†å¾®æœåŠ¡
æœåŠ¡æ‹†åˆ†
è¿œç¨‹è°ƒç”¨
Eureka
Ribbon
Nacos
Feign
Gateway
RabbitMQ
Elasticsearch

ğŸ’»é«˜çº§ç¯‡

JMeter
Sentinel
Seata
Red">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>å¾®æœåŠ¡æŠ€æœ¯æ ˆ | å­¦ä¹ ç¬”è®°</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="å­¦ä¹ ç¬”è®°" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">å­¦ä¹ ç¬”è®°</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>mudies</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a target="_blank" rel="noopener" href="https://music.apple.com/cn/browse">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://ddys.tv/big-mouth/">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://weread.qq.com/web/shelf">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a target="_blank" rel="noopener" href="https://leetcode.cn/">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>LiCode</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="æ·±è‰²/æµ…è‰²æ¨¡å¼" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">å­¦ä¹ ç¬”è®°</div>
        <div class="logo-desc">
            
            è®°å½•å­¦ä¹ 
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			mudies
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a target="_blank" rel="noopener" href="https://music.apple.com/cn/browse " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://ddys.tv/big-mouth/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://weread.qq.com/web/shelf " style="margin-left:75px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>

                  <a target="_blank" rel="noopener" href="https://leetcode.cn/ " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>LiCode</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">å¾®æœåŠ¡æŠ€æœ¯æ ˆ</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/springcloud/">
                                <span class="chip bg-color">springcloud</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" class="post-category">
                                å¾®æœåŠ¡
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2022-09-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2023-01-18
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    47.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>é˜…è¯»æ—¶é•¿:&nbsp;&nbsp;
                    195 åˆ†
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230118200155176.png" alt="image-20230118200155176"></p>
<h1 id="å¾®æœåŠ¡æŠ€æœ¯æ ˆ"><a href="#å¾®æœåŠ¡æŠ€æœ¯æ ˆ" class="headerlink" title="å¾®æœåŠ¡æŠ€æœ¯æ ˆ"></a>å¾®æœåŠ¡æŠ€æœ¯æ ˆ</h1><p>ğŸ¤¤åŸºç¡€ç¯‡</p>
<ul>
<li>è®¤è¯†å¾®æœåŠ¡</li>
<li>æœåŠ¡æ‹†åˆ†</li>
<li>è¿œç¨‹è°ƒç”¨</li>
<li>Eureka</li>
<li>Ribbon</li>
<li>Nacos</li>
<li>Feign</li>
<li>Gateway</li>
<li>RabbitMQ</li>
<li>Elasticsearch</li>
</ul>
<p>ğŸ’»é«˜çº§ç¯‡</p>
<ul>
<li>JMeter</li>
<li>Sentinel</li>
<li>Seata</li>
<li>Redis</li>
<li>â€¦</li>
</ul>
<h2 id="è®¤è¯†å¾®æœåŠ¡"><a href="#è®¤è¯†å¾®æœåŠ¡" class="headerlink" title="è®¤è¯†å¾®æœåŠ¡"></a>è®¤è¯†å¾®æœåŠ¡</h2><h3 id="å•ä½“æ¶æ„"><a href="#å•ä½“æ¶æ„" class="headerlink" title="å•ä½“æ¶æ„"></a>å•ä½“æ¶æ„</h3><p><strong>å•ä½“æ¶æ„</strong>ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901083809.png" alt="img"></p>
<p><strong>ä¼˜ç‚¹</strong>ï¼šæ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½</p>
<p><strong>ç¼ºç‚¹</strong>ï¼šè€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰</p>
<h3 id="åˆ†å¸ƒå¼æ¶æ„"><a href="#åˆ†å¸ƒå¼æ¶æ„" class="headerlink" title="åˆ†å¸ƒå¼æ¶æ„"></a>åˆ†å¸ƒå¼æ¶æ„</h3><p><strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092921.png" alt="img"></p>
<p><strong>ä¼˜ç‚¹</strong>ï¼šé™ä½æœåŠ¡è€¦åˆï¼Œæœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•</p>
<p><strong>ç¼ºç‚¹</strong>ï¼šæœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚</p>
<p>åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š</p>
<ul>
<li>æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ</li>
<li>æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ</li>
<li>æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ</li>
</ul>
<p><strong>äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚</strong></p>
<h3 id="å¾®æœåŠ¡"><a href="#å¾®æœåŠ¡" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h3><p>å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š</p>
<ul>
<li>å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£</li>
<li>è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜</li>
<li>é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³</li>
<li>éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2022/202205162352847.png" alt="img"></p>
<p>å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§<strong>å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†</strong>ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚</p>
<p><strong>å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¾®æœåŠ¡æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ ã€‚</strong></p>
<p>å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚</p>
<h3 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h3><p>SpringCloud æ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud%E3%80%82">https://spring.io/projects/spring-cloudã€‚</a></p>
<p>SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚</p>
<p>å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901083717.png" alt="img"></p>
<p>å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901084050.png" alt="img"></p>
<h3 id="å†…å®¹çŸ¥è¯†"><a href="#å†…å®¹çŸ¥è¯†" class="headerlink" title="å†…å®¹çŸ¥è¯†"></a>å†…å®¹çŸ¥è¯†</h3><p><img src="https://cdn.xn2001.com/img/2021/20210901092925.png" alt="éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹"></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901084131.png" alt="æŠ€æœ¯æ ˆ"></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090737.png" alt="è‡ªåŠ¨åŒ–éƒ¨ç½²"></p>
<h3 id="æŠ€æœ¯æ ˆå¯¹æ¯”"><a href="#æŠ€æœ¯æ ˆå¯¹æ¯”" class="headerlink" title="æŠ€æœ¯æ ˆå¯¹æ¯”"></a><strong>æŠ€æœ¯æ ˆå¯¹æ¯”</strong></h3><p><img src="https://cdn.xn2001.com/img/2021/20210901090726.png" alt="img"></p>
<h1 id="æœåŠ¡æ‹†åˆ†"><a href="#æœåŠ¡æ‹†åˆ†" class="headerlink" title="æœåŠ¡æ‹†åˆ†"></a><strong>æœåŠ¡æ‹†åˆ†</strong></h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo">https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo">https://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo</a></p>
</blockquote>
<p><strong>æœåŠ¡æ‹†åˆ†æ³¨æ„äº‹é¡¹</strong></p>
<p>å•ä¸€èŒè´£ï¼šä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡</p>
<p>æ•°æ®ç‹¬ç«‹ï¼šä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“</p>
<p>é¢å‘æœåŠ¡ï¼šå°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090745.png" alt="img"></p>
<p>cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–</p>
<ul>
<li>order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡</li>
<li>user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡</li>
</ul>
<p>è¦æ±‚ï¼š</p>
<ul>
<li>è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰<strong>å„è‡ªçš„æ•°æ®åº“</strong>ï¼Œç›¸äº’ç‹¬ç«‹</li>
<li>è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡<strong>éƒ½å¯¹å¤–æš´éœ² Restful çš„æ¥å£</strong></li>
<li>è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ<strong>åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£</strong>ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“</li>
</ul>
<p>å¾®æœåŠ¡é¡¹ç›®ä¸‹ï¼Œæ‰“å¼€ idea ä¸­çš„ Serviceï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090750.png" alt="img"></p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090757.png" alt="img"></p>
<h1 id="è¿œç¨‹è°ƒç”¨"><a href="#è¿œç¨‹è°ƒç”¨" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a><strong>è¿œç¨‹è°ƒç”¨</strong></h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate">https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate">https://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate</a></p>
</blockquote>
<p>æ­£å¦‚ä¸Šé¢çš„æœåŠ¡æ‹†åˆ†è¦æ±‚ä¸­æ‰€æåˆ°ï¼Œ</p>
<blockquote>
<p>è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ<strong>åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£</strong>ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“</p>
</blockquote>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ Java å¦‚ä½•å»å‘é€ http è¯·æ±‚ï¼ŒSpring æä¾›äº†ä¸€ä¸ª RestTemplate å·¥å…·ï¼Œåªéœ€è¦æŠŠå®ƒåˆ›å»ºå‡ºæ¥å³å¯ã€‚ï¼ˆå³æ³¨å…¥ Beanï¼‰</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090814.png" alt="img"></p>
<p>å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨åºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090846.png" alt="img"></p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090909.png" alt="img"></p>
<p>åœ¨ä¸Šé¢ä»£ç çš„ url ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è°ƒç”¨æœåŠ¡çš„åœ°å€é‡‡ç”¨ç¡¬ç¼–ç ï¼Œè¿™åœ¨åç»­çš„å¼€å‘ä¸­è‚¯å®šæ˜¯ä¸ç†æƒ³çš„ï¼Œè¿™å°±éœ€è¦<strong>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</strong>ï¼ˆEurekaï¼‰æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚</p>
<h1 id="Eurekaæ³¨å†Œä¸­å¿ƒ"><a href="#Eurekaæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Eurekaæ³¨å†Œä¸­å¿ƒ"></a><strong>Eurekaæ³¨å†Œä¸­å¿ƒ</strong></h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka">https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka">https://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka</a></p>
</blockquote>
<p>æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090919.png" alt="img"></p>
<p><strong>order-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ</strong></p>
<ul>
<li>user-service æœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-server(EurekaæœåŠ¡ç«¯)ï¼Œå«åš<strong>æœåŠ¡æ³¨å†Œ</strong></li>
<li>eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»</li>
<li>order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ï¼Œè¿™ä¸ªå«<strong>æœåŠ¡å‘ç°</strong>æˆ–æœåŠ¡æ‹‰å–</li>
</ul>
<p><strong>order-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ</strong></p>
<p>order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨<strong>è´Ÿè½½å‡è¡¡ç®—æ³•</strong>é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€ï¼Œå‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨</p>
<p><strong>order-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ</strong></p>
<ul>
<li>user-service ä¼š<strong>æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤30ç§’)å‘ eureka-server å‘èµ·è¯·æ±‚</strong>ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸º<strong>å¿ƒè·³</strong></li>
<li>å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤</li>
<li>order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†</li>
</ul>
<hr>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090932.png" alt="img"></p>
<h3 id="æ­å»ºæ³¨å†Œä¸­å¿ƒ"><a href="#æ­å»ºæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ­å»ºæ³¨å†Œä¸­å¿ƒ"></a><strong>æ­å»ºæ³¨å†Œä¸­å¿ƒ</strong></h3><p><strong>æ­å»º eureka-server</strong></p>
<p>å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ <strong>server</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>server<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ç¼–å†™å¯åŠ¨ç±»</strong></p>
<p>æ³¨æ„è¦æ·»åŠ ä¸€ä¸ª <code>@EnableEurekaServer</code> <strong>æ³¨è§£</strong>ï¼Œå¼€å¯ eureka çš„<strong>æ³¨å†Œä¸­å¿ƒ</strong>åŠŸèƒ½</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>eureka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ç¼–å†™é…ç½®æ–‡ä»¶</strong></p>
<p>ç¼–å†™ä¸€ä¸ª application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…¶ä¸­ <code>default-zone</code> æ˜¯å› ä¸ºå‰é¢é…ç½®ç±»å¼€å¯äº†æ³¨å†Œä¸­å¿ƒæ‰€éœ€è¦é…ç½®çš„ eureka çš„<strong>åœ°å€ä¿¡æ¯</strong>ï¼Œå› ä¸º eureka æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™é‡Œä¹Ÿè¦å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œå½“åé¢ eureka <strong>é›†ç¾¤</strong>æ—¶ï¼Œè¿™é‡Œå°±å¯ä»¥å¡«å†™å¤šä¸ªï¼Œä½¿ç”¨ â€œ,â€ éš”å¼€ã€‚</p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090945.png" alt="img"></p>
<h3 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h3><blockquote>
<p>å°† user-serviceã€order-service éƒ½æ³¨å†Œåˆ° eureka</p>
</blockquote>
<p>å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ <strong>client</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š<code>@EnableEurekaClient</code></p>
<p>åœ¨ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token comment">#nameï¼šorderservice</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901090958.png" alt="img"></p>
<p>è¿™é‡Œå¦å¤–å†è¡¥å……ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ idea çš„å¤šå®ä¾‹å¯åŠ¨ï¼Œæ¥æŸ¥çœ‹ Eureka çš„é›†ç¾¤æ•ˆæœã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091005.png" alt="img"></p>
<p>4ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091015.png" alt="img"></p>
<h3 id="æœåŠ¡æ‹‰å–"><a href="#æœåŠ¡æ‹‰å–" class="headerlink" title="æœåŠ¡æ‹‰å–"></a>æœåŠ¡æ‹‰å–</h3><blockquote>
<p>åœ¨ order-service ä¸­å®ŒæˆæœåŠ¡æ‹‰å–ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡æŒ‘é€‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ç°è¿œç¨‹è°ƒç”¨</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬è®© order-service å‘ eureka-server æ‹‰å– user-service çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚</p>
<p>é¦–å…ˆç»™ <code>RestTemplate</code> è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª <code>@LoadBalanced</code> <strong>æ³¨è§£</strong>ï¼Œç”¨äºå¼€å¯<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚ï¼ˆåé¢ä¼šè®²ï¼‰</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¿®æ”¹ OrderService è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨<strong>æœåŠ¡å</strong>ä»£æ›¿ipã€ç«¯å£ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091216.png" alt="img"></p>
<p>spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» eureka-server ä¸­ï¼Œæ ¹æ® userservice è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨åå»å®Œæˆè´Ÿè½½å‡è¡¡ã€‚</p>
<h1 id="Ribbonè´Ÿè½½å‡è¡¡"><a href="#Ribbonè´Ÿè½½å‡è¡¡" class="headerlink" title="Ribbonè´Ÿè½½å‡è¡¡"></a><strong>Ribbonè´Ÿè½½å‡è¡¡</strong></h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon">https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon">https://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon</a></p>
</blockquote>
<p>æˆ‘ä»¬æ·»åŠ äº† <code>@LoadBalanced</code> æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ</p>
<p><strong>SpringCloud åº•å±‚æä¾›äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091242.png" alt="img"></p>
<h2 id="æºç è·Ÿè¸ª"><a href="#æºç è·Ÿè¸ª" class="headerlink" title="æºç è·Ÿè¸ª"></a>æºç è·Ÿè¸ª</h2><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸éœ€è¦è·å–ipå’Œç«¯å£ï¼Œè¿™æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯<code>LoadBalancerInterceptor</code>ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡ id è·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡ idã€‚</p>
<p>æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091323.png" alt="img"></p>
<p>è¿™é‡Œçš„ <code>intercept()</code> æ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š</p>
<ul>
<li><code>request.getURI()</code>ï¼šè·å–è¯·æ±‚uriï¼Œå³ <a target="_blank" rel="noopener" href="http://user-service/user/8">http://user-service/user/8</a></li>
<li><code>originalUri.getHost()</code>ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡id <code>user-service</code></li>
<li><code>this.loadBalancer.execute()</code>ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚</li>
</ul>
<p>è¿™é‡Œçš„ <code>this.loadBalancer</code> æ˜¯ <code>LoadBalancerClient</code> ç±»å‹</p>
<p>ç»§ç»­è·Ÿå…¥ <code>execute()</code> æ–¹æ³•ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091330.png!/format/webp" alt="img"></p>
<ul>
<li><code>getLoadBalancer(serviceId)</code>ï¼šæ ¹æ®æœåŠ¡idè·å– <code>ILoadBalancer</code>ï¼Œè€Œ <code>ILoadBalancer</code> ä¼šæ‹¿ç€æœåŠ¡ id å» eureka ä¸­è·å–æœåŠ¡åˆ—è¡¨ã€‚</li>
<li><code>getServer(loadBalancer)</code>ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚åœ¨å›¾ä¸­<strong>å¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡</strong></li>
</ul>
<p>å¯ä»¥çœ‹åˆ°è·å–æœåŠ¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ª <code>getServer()</code> æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091345.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091355.png!/format/webp" alt="img"></p>
<p>ç»§ç»­è·Ÿè¸ªæºç  <code>chooseServer()</code> æ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091414.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª <code>rule</code> æ˜¯è°ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091432.png!/format/webp" alt="img"></p>
<p>è¿™é‡Œçš„ rule é»˜è®¤å€¼æ˜¯ä¸€ä¸ª <code>RoundRobinRule</code> ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091442.png!/format/webp" alt="img"></p>
<p>è´Ÿè½½å‡è¡¡é»˜è®¤ä½¿ç”¨äº†è½®è®­ç®—æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚</p>
<h2 id="æµç¨‹æ€»ç»“"><a href="#æµç¨‹æ€»ç»“" class="headerlink" title="æµç¨‹æ€»ç»“"></a>æµç¨‹æ€»ç»“</h2><p>SpringCloud Ribbon åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚</p>
<p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ‹¦æˆªæˆ‘ä»¬çš„ <code>RestTemplate</code> è¯·æ±‚ <a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></li>
<li><code>RibbonLoadBalancerClient</code> ä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ user-service</li>
<li><code>DynamicServerListLoadBalancer</code> æ ¹æ® user-service åˆ° eureka æ‹‰å–æœåŠ¡åˆ—è¡¨</li>
<li>eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082</li>
<li><code>IRule</code> åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081</li>
<li><code>RibbonLoadBalancerClient</code> ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå¾—åˆ° <a target="_blank" rel="noopener" href="http://localhost:8081/user/1%EF%BC%8C%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E8%AF%B7%E6%B1%82">http://localhost:8081/user/1ï¼Œå‘èµ·çœŸå®è¯·æ±‚</a></li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091755.png!/format/webp" alt="img"></p>
<h2 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>è´Ÿè½½å‡è¡¡ç­–ç•¥</h2><p>è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨ IRule æ¥å£ä¸­ï¼Œè€Œ IRule æœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091811.png!/format/webp" alt="img"></p>
<p>ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»</th>
<th>è§„åˆ™æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>RoundRobinRule</td>
<td>ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼šï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚ ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRule è§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚</td>
</tr>
<tr>
<td><strong>ZoneAvoidanceRule</strong></td>
<td>ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚</td>
</tr>
<tr>
<td>RandomRule</td>
<td>éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚</td>
</tr>
<tr>
<td>RetryRule</td>
<td>é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘</td>
</tr>
</tbody></table>
<p>é»˜è®¤çš„å®ç°å°±æ˜¯ <code>ZoneAvoidanceRule</code>ï¼Œ<strong>æ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ</strong>ã€‚</p>
<h2 id="è‡ªå®šä¹‰ç­–ç•¥"><a href="#è‡ªå®šä¹‰ç­–ç•¥" class="headerlink" title="è‡ªå®šä¹‰ç­–ç•¥"></a>è‡ªå®šä¹‰ç­–ç•¥</h2><p>é€šè¿‡å®šä¹‰ IRule å®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>1 ä»£ç æ–¹å¼åœ¨ order-service ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091832.png!/format/webp" alt="img"></p>
<p>2 é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ order-service çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># ç»™éœ€è¦è°ƒç”¨çš„å¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒorderserviceæœåŠ¡å»è°ƒç”¨userserviceæœåŠ¡</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># è´Ÿè½½å‡è¡¡è§„åˆ™ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>æ³¨æ„</strong>ï¼šä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚</p>
<h2 id="é¥¥é¥¿åŠ è½½"><a href="#é¥¥é¥¿åŠ è½½" class="headerlink" title="é¥¥é¥¿åŠ è½½"></a>é¥¥é¥¿åŠ è½½</h2><p>å½“æˆ‘ä»¬å¯åŠ¨ orderserviceï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæ—¶é—´æ¶ˆè€—ä¼šå¤§å¾ˆå¤šï¼Œè¿™æ˜¯å› ä¸º Ribbon æ‡’åŠ è½½çš„æœºåˆ¶ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091850.png!/format/webp" alt="img"></p>
<p>Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œæ‹‰å–é›†ç¾¤åœ°å€ï¼Œæ‰€ä»¥è¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p>
<p>è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»º LoadBalanceClientï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> userservice <span class="token comment"># é¡¹ç›®å¯åŠ¨æ—¶ç›´æ¥å»æ‹‰å–userserviceçš„é›†ç¾¤ï¼Œå¤šä¸ªç”¨","éš”å¼€</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="Nacosæ³¨å†Œä¸­å¿ƒ"><a href="#Nacosæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="Nacosæ³¨å†Œä¸­å¿ƒ"></a>Nacosæ³¨å†Œä¸­å¿ƒ</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos">https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>SpringCloudAlibaba æ¨å‡ºäº†ä¸€ä¸ªåä¸º Nacos çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å›½å¤–ä¹Ÿæœ‰å¤§é‡çš„ä½¿ç”¨ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091857.png!/format/webp" alt="img"></p>
<p>è§£å‹å¯åŠ¨ Nacosï¼Œè¯¦ç»†è¯·çœ‹ <a target="_blank" rel="noopener" href="https://www.xn2001.com/archives/661.html">Nacoså®‰è£…æŒ‡å—</a></p>
<p><code>startup.cmd -m standalone</code></p>
<p>è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/">http://localhost:8848/nacos/</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091904.png!/format/webp" alt="img"></p>
<h2 id="æœåŠ¡æ³¨å†Œ-1"><a href="#æœåŠ¡æ³¨å†Œ-1" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><p>è¿™é‡Œä¸Šæ¥å°±ç›´æ¥æœåŠ¡æ³¨å†Œï¼Œå¾ˆå¤šä¸œè¥¿å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œå…¶å® Nacos æœ¬èº«å°±æ˜¯ä¸€ä¸ª SprintBoot é¡¹ç›®ï¼Œè¿™ç‚¹ä½ ä»å¯åŠ¨çš„æ§åˆ¶å°æ‰“å°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥å°±ä¸å†éœ€è¦å»é¢å¤–æ­å»ºä¸€ä¸ªåƒ Eureka çš„æ³¨å†Œä¸­å¿ƒã€‚</p>
<p><strong>å¼•å…¥ä¾èµ–</strong></p>
<p>åœ¨ cloud-demo çˆ¶å·¥ç¨‹ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶ååœ¨ user-service å’Œ order-service ä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥ nacos-discovery ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>é…ç½®nacosåœ°å€</strong></p>
<p>åœ¨ user-service å’Œ order-service çš„ application.yml ä¸­æ·»åŠ  nacos åœ°å€ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¡¹ç›®é‡æ–°å¯åŠ¨åï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½è¢«æ³¨å†Œè¿›äº† Nacos</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091918.png!/format/webp" alt="img"></p>
<p>è§ˆå™¨è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101%EF%BC%8C%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE%EF%BC%8C%E5%90%8C%E6%97%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%9F%E6%AD%A3%E5%B8%B8%E3%80%82">http://localhost:8080/order/101ï¼Œæ­£å¸¸è®¿é—®ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡ä¹Ÿæ­£å¸¸ã€‚</a></p>
<h2 id="åˆ†çº§å­˜å‚¨æ¨¡å‹"><a href="#åˆ†çº§å­˜å‚¨æ¨¡å‹" class="headerlink" title="åˆ†çº§å­˜å‚¨æ¨¡å‹"></a>åˆ†çº§å­˜å‚¨æ¨¡å‹</h2><p>ä¸€ä¸ª<strong>æœåŠ¡</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>å®ä¾‹</strong>ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ user-serviceï¼Œå¯ä»¥æœ‰:</p>
<ul>
<li>127.0.0.1:8081</li>
<li>127.0.0.1:8082</li>
<li>127.0.0.1:8083</li>
</ul>
<p>å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿</li>
<li>127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿</li>
<li>127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿</li>
</ul>
<p>Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ï¼Œåˆ’åˆ†ä¸ºä¸€ä¸ª<strong>é›†ç¾¤</strong>ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091928.png!/format/webp" alt="img"></p>
<p>å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚<strong>å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚</strong>ä¾‹å¦‚ï¼šæ­å·æœºæˆ¿å†…çš„ order-service åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ user-serviceã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091937.png!/format/webp" alt="img"></p>
<h2 id="é…ç½®é›†ç¾¤"><a href="#é…ç½®é›†ç¾¤" class="headerlink" title="é…ç½®é›†ç¾¤"></a>é…ç½®é›†ç¾¤</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»™ user-service <strong>é…ç½®é›†ç¾¤</strong></p>
<p>ä¿®æ”¹ user-service çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># é›†ç¾¤åç§° HZæ­å·</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ä¸¤ä¸ª user-service å®ä¾‹åï¼Œæˆ‘ä»¬å†å»å¯åŠ¨ä¸€ä¸ªä¸Šæµ·é›†ç¾¤çš„å®ä¾‹ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210901091947.png!/format/webp" alt="img"></p>
<p>æŸ¥çœ‹ nacos æ§åˆ¶å°</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901091957.png!/format/webp" alt="img"></p>
<h2 id="NacosRule"><a href="#NacosRule" class="headerlink" title="NacosRule"></a>NacosRule</h2><p>Ribbonçš„é»˜è®¤å®ç° <code>ZoneAvoidanceRule</code> å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬æŠŠè§„åˆ™æ”¹æˆ <strong>NacosRule</strong> å³å¯ã€‚æˆ‘ä»¬æ˜¯ç”¨ orderservice è°ƒç”¨ userserviceï¼Œæ‰€ä»¥åœ¨ orderservice é…ç½®è§„åˆ™ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">iRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//é»˜è®¤ä¸ºè½®è¯¢è§„åˆ™ï¼Œè¿™é‡Œè‡ªå®šä¹‰ä¸ºéšæœºè§„åˆ™</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤–ï¼Œä½ åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®çš„å½¢å¼æ¥å®Œæˆï¼Œå…·ä½“å‚è€ƒä¸Šé¢çš„ Ribbon æ ç›®ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment">#è´Ÿè½½å‡è¡¡è§„åˆ™ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åï¼Œå†å¯¹ orderservice é…ç½®é›†ç¾¤ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># é›†ç¾¤åç§°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨æˆ‘å¯åŠ¨äº†å››ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>orderservice - HZ</li>
<li>userservice - HZ</li>
<li>userservice1 - HZ</li>
<li>userservice2 - SH</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p>åœ¨è®¿é—®ä¸­æˆ‘ä»¬å‘ç°ï¼Œåªæœ‰åŒåœ¨ä¸€ä¸ª HZ é›†ç¾¤ä¸‹çš„ userserviceã€userservice1 ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯éšæœºçš„ã€‚</p>
<p>æˆ‘ä»¬è¯•ç€æŠŠ userserviceã€userservice2 åœæ‰ã€‚ä¾æ—§å¯ä»¥è®¿é—®ã€‚</p>
<p>åœ¨ userservice3 æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å‘å‡ºäº†ä¸€ä¸²çš„è­¦å‘Šï¼Œå› ä¸º orderservice æœ¬èº«æ˜¯åœ¨ HZ é›†ç¾¤çš„ï¼Œè¿™æ³¢ HZ é›†ç¾¤æ²¡æœ‰äº† userserviceï¼Œå°±ä¼šå»åˆ«çš„é›†ç¾¤æ‰¾.</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092012.png!/format/webp" alt="img"></p>
<h2 id="æƒé‡é…ç½®"><a href="#æƒé‡é…ç½®" class="headerlink" title="æƒé‡é…ç½®"></a>æƒé‡é…ç½®</h2><p>å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š</p>
<p>æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ NacosRule æ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚</p>
<p>å› æ­¤ï¼ŒNacos æä¾›äº†<strong>æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡</strong>ï¼Œ0~1 ä¹‹é—´ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ï¼Œæƒé‡ä¿®æ”¹ä¸º 0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®ã€‚</p>
<p>åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° user-service çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092020.png!/format/webp" alt="img"></p>
<p>åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092026.png!/format/webp" alt="img"></p>
<p>å¦å¤–ï¼Œåœ¨æœåŠ¡å‡çº§çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§è¾ƒå¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´æƒé‡æ¥è¿›è¡Œå¹³æ»‘å‡çº§ï¼Œä¾‹å¦‚ï¼šå…ˆæŠŠ userservice æƒé‡è°ƒèŠ‚ä¸º 0ï¼Œè®©ç”¨æˆ·å…ˆæµå‘ userservice2ã€userservice3ï¼Œå‡çº§ userserviceåï¼Œå†æŠŠæƒé‡ä» 0 è°ƒåˆ° 0.1ï¼Œè®©ä¸€éƒ¨åˆ†ç”¨æˆ·å…ˆä½“éªŒï¼Œç”¨æˆ·ä½“éªŒç¨³å®šåå°±å¯ä»¥å¾€ä¸Šè°ƒæƒé‡å•¦ã€‚</p>
<h2 id="ç¯å¢ƒéš”ç¦»"><a href="#ç¯å¢ƒéš”ç¦»" class="headerlink" title="ç¯å¢ƒéš”ç¦»"></a>ç¯å¢ƒéš”ç¦»</h2><p>Nacos æä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚</p>
<ul>
<li>Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace</li>
<li>namespace ä¸‹å¯ä»¥æœ‰ groupã€service ç­‰</li>
<li>ä¸åŒ namespace ä¹‹é—´<strong>ç›¸äº’éš”ç¦»</strong>ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092032.png!/format/webp" alt="img"></p>
<h3 id="åˆ›å»ºnamespace"><a href="#åˆ›å»ºnamespace" class="headerlink" title="åˆ›å»ºnamespace"></a>åˆ›å»ºnamespace</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ serviceã€dataã€group éƒ½åœ¨åŒä¸€ä¸ª namespaceï¼Œåä¸º public(ä¿ç•™ç©ºé—´)ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092038.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ª namespaceï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092050.png!/format/webp" alt="img"></p>
<p>ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092059.png!/format/webp" alt="img"></p>
<p>å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092114.png!/format/webp" alt="img"></p>
<h3 id="é…ç½®namespace"><a href="#é…ç½®namespace" class="headerlink" title="é…ç½®namespace"></a>é…ç½®namespace</h3><p>ç»™å¾®æœåŠ¡é…ç½® namespace åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¿®æ”¹ order-service çš„ application.yml æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 492a7d5d<span class="token punctuation">-</span>237b<span class="token punctuation">-</span>46a1<span class="token punctuation">-</span>a99a<span class="token punctuation">-</span>fa8e98e4b0f9 <span class="token comment"># å‘½åç©ºé—´ID</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ order-service åï¼Œè®¿é—®æ§åˆ¶å°ã€‚</p>
<p><strong>public</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092143.png!/format/webp" alt="img"></p>
<p><strong>dev</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092130.png!/format/webp" alt="img"></p>
<p>æ­¤æ—¶è®¿é—® order-serviceï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092138.png!/format/webp" alt="img"></p>
<h2 id="ä¸´æ—¶å®ä¾‹"><a href="#ä¸´æ—¶å®ä¾‹" class="headerlink" title="ä¸´æ—¶å®ä¾‹"></a>ä¸´æ—¶å®ä¾‹</h2><p>Nacos çš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li><strong>ä¸´æ—¶å®ä¾‹</strong>ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œ<strong>é»˜è®¤çš„ç±»å‹</strong>ã€‚</li>
<li>éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚</li>
</ul>
<p>é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤–ï¼ŒNacos é›†ç¾¤**é»˜è®¤é‡‡ç”¨APæ–¹å¼(å¯ç”¨æ€§)<strong>ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œ</strong>é‡‡ç”¨CPæ¨¡å¼(ä¸€è‡´æ€§)**ï¼›è€Œ Eureka é‡‡ç”¨APæ–¹å¼ï¼Œä¸å¯åˆ‡æ¢ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯ CAP åŸç†ï¼Œåé¢ä¼šå†™åˆ°ï¼‰</p>
<h1 id="Nacosé…ç½®ä¸­å¿ƒ"><a href="#Nacosé…ç½®ä¸­å¿ƒ" class="headerlink" title="Nacosé…ç½®ä¸­å¿ƒ"></a>Nacosé…ç½®ä¸­å¿ƒ</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos">https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>Nacosé™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚</p>
<p>å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚<strong>æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092150.png!/format/webp" alt="img"></p>
<p>Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œ<strong>å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚</strong></p>
<h2 id="åˆ›å»ºé…ç½®"><a href="#åˆ›å»ºé…ç½®" class="headerlink" title="åˆ›å»ºé…ç½®"></a>åˆ›å»ºé…ç½®</h2><p>åœ¨ Nacos æ§åˆ¶é¢æ¿ä¸­æ·»åŠ é…ç½®æ–‡ä»¶</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092159.png!/format/webp" alt="img"></p>
<p>ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092206.png!/format/webp" alt="img"></p>
<p><strong>æ³¨æ„</strong>ï¼šé¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®(ä¾‹å¦‚æ•°æ®åº“è¿æ¥)è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚</p>
<h2 id="æ‹‰å–é…ç½®"><a href="#æ‹‰å–é…ç½®" class="headerlink" title="æ‹‰å–é…ç½®"></a>æ‹‰å–é…ç½®</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ Nacos è¯»å–é…ç½®æ–‡ä»¶çš„ç¯èŠ‚æ˜¯åœ¨å“ªä¸€æ­¥ï¼Œåœ¨æ²¡åŠ å…¥ Nacos é…ç½®ä¹‹å‰ï¼Œè·å–é…ç½®æ˜¯è¿™æ ·ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092215.png!/format/webp" alt="img"></p>
<p>åŠ å…¥ Nacos é…ç½®ï¼Œå®ƒçš„è¯»å–æ˜¯åœ¨ application.yml ä¹‹å‰çš„ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092223.png!/format/webp" alt="img"></p>
<p>è¿™æ—¶å€™å¦‚æœæŠŠ nacos åœ°å€æ”¾åœ¨ application.yml ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œ<strong>Nacos å°±æ— æ³•æ ¹æ®åœ°å€å»è·å–é…ç½®äº†ã€‚</strong></p>
<p>å› æ­¤ï¼Œnacos åœ°å€å¿…é¡»æ”¾åœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ bootstrap.yml æ–‡ä»¶ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092228.png!/format/webp" alt="img"></p>
<p><strong>å¼•å…¥ nacos-config ä¾èµ–</strong></p>
<p>é¦–å…ˆï¼Œåœ¨ user-service æœåŠ¡ä¸­ï¼Œå¼•å…¥ nacos-config çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--nacosé…ç½®ç®¡ç†ä¾èµ–--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ·»åŠ  bootstrap.yml</strong></p>
<p>ç„¶åï¼Œåœ¨ user-service ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># æœåŠ¡åç§°</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment">#å¼€å‘ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯dev </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacosåœ°å€</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ® spring.cloud.nacos.server-addr è·å– nacosåœ°å€ï¼Œå†æ ¹æ®<code>${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}</code>ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– <code>userservice-dev.yaml</code></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092237.png!/format/webp" alt="img"></p>
<p>ä½¿ç”¨ä»£ç æ¥éªŒè¯æ˜¯å¦æ‹‰å–æˆåŠŸ</p>
<p>åœ¨ user-service ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®å¹¶ä½¿ç”¨ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${pattern.dateformat}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//æ ¼å¼åŒ–æ—¶é—´</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210901092243.png!/format/webp" alt="img"></p>
<p>å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8081/user/now">http://localhost:8081/user/now</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092251.png!/format/webp" alt="img"></p>
<h2 id="é…ç½®çƒ­æ›´æ–°"><a href="#é…ç½®çƒ­æ›´æ–°" class="headerlink" title="é…ç½®çƒ­æ›´æ–°"></a>é…ç½®çƒ­æ›´æ–°</h2><p>æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯<strong>é…ç½®çƒ­æ›´æ–°</strong>ã€‚</p>
<p>æœ‰ä¸¤ç§æ–¹å¼ï¼š1. ç”¨ <code>@value</code> è¯»å–é…ç½®æ—¶ï¼Œæ­é… <code>@RefreshScope</code>ï¼›2. ç›´æ¥ç”¨ <code>@ConfigurationProperties</code> è¯»å–é…ç½®</p>
<h3 id="RefreshScope"><a href="#RefreshScope" class="headerlink" title="@RefreshScope"></a>@RefreshScope</h3><p>æ–¹å¼ä¸€ï¼šåœ¨ <code>@Value</code> æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ <code>@RefreshScope</code></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092258.png!/format/webp" alt="img"></p>
<h3 id="ConfigurationProperties"><a href="#ConfigurationProperties" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h3><p>æ–¹å¼äºŒï¼šä½¿ç”¨ <code>@ConfigurationProperties</code> æ³¨è§£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦åŠ  <code>@RefreshScope</code> æ³¨è§£ã€‚</p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª PatternProperties ç±»ï¼Œè¯»å– <code>patterrn.dateformat</code> å±æ€§</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"pattern"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">PatternProperties</span> patternProperties<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//æ ¼å¼åŒ–æ—¶é—´</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>patternProperties<span class="token punctuation">.</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®å…±äº«"><a href="#é…ç½®å…±äº«" class="headerlink" title="é…ç½®å…±äº«"></a>é…ç½®å…±äº«</h2><p>å…¶å®åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œnacos ä¼šè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>[spring.application.name]-[spring.profiles.active].yaml</code>ï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml</li>
<li><code>[spring.application.name].yaml</code>ï¼Œä¾‹å¦‚ï¼šuserservice.yaml</li>
</ul>
<p>è¿™é‡Œçš„ <code>[spring.application.name].yaml</code> ä¸åŒ…å«ç¯å¢ƒï¼Œ<strong>å› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«</strong>ã€‚</p>
<p><strong>æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®</strong></p>
<p>æˆ‘ä»¬åœ¨ nacos ä¸­æ·»åŠ ä¸€ä¸ª userservice.yaml æ–‡ä»¶ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092323.png!/format/webp" alt="img"></p>
<p><strong>åœ¨ user-service ä¸­è¯»å–å…±äº«é…ç½®</strong></p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ PatternProperties ç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092314.png!/format/webp" alt="img"></p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092331.png!/format/webp" alt="img"></p>
<p><strong>è¿è¡Œä¸¤ä¸ª UserApplicationï¼Œä½¿ç”¨ä¸åŒçš„profile</strong></p>
<p>ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œæ”¹å˜å…¶profileå€¼ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092345.png!/format/webp" alt="img"></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092338.png!/format/webp" alt="img"></p>
<p>è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯test</p>
<p>å¯åŠ¨ UserApplication å’Œ UserApplication2</p>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8081/user/prop%EF%BC%8C%E7%BB%93%E6%9E%9C%EF%BC%9A">http://localhost:8081/user/propï¼Œç»“æœï¼š</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092400.png!/format/webp" alt="img"></p>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8082/user/prop%EF%BC%8C%E7%BB%93%E6%9E%9C%EF%BC%9A">http://localhost:8082/user/propï¼Œç»“æœï¼š</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092419.png!/format/webp" alt="img"></p>
<p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚</p>
<p>ä¸Šé¢çš„éƒ½æ˜¯åŒä¸€ä¸ªå¾®æœåŠ¡ä¸‹ï¼Œ<strong>é‚£ä¹ˆä¸åŒå¾®æœåŠ¡ä¹‹é—´å¯ä»¥ç¯å¢ƒå…±äº«å—ï¼Ÿ</strong></p>
<p>é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š</p>
<ul>
<li>extension-configs</li>
<li>shared-configs</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span>
        <span class="token key atrule">extends-configs</span><span class="token punctuation">:</span> <span class="token comment"># å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># è¦å…±äº«çš„é…ç½®æ–‡ä»¶id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span> <span class="token comment"># å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># è¦å…±äº«çš„é…ç½®æ–‡ä»¶id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®ä¼˜å…ˆçº§"><a href="#é…ç½®ä¼˜å…ˆçº§" class="headerlink" title="é…ç½®ä¼˜å…ˆçº§"></a>é…ç½®ä¼˜å…ˆçº§</h2><p>å½“ nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶<strong>å‡ºç°ç›¸åŒå±æ€§æ—¶</strong>ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092501.png!/format/webp" alt="img"></p>
<p>æ›´ç»†è‡´çš„é…ç½®</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092520.png!/format/webp" alt="img"></p>
<h1 id="Nacosé›†ç¾¤"><a href="#Nacosé›†ç¾¤" class="headerlink" title="Nacosé›†ç¾¤"></a>Nacosé›†ç¾¤</h1><p><strong>æ¶æ„ä»‹ç»</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/202108181959897.png!/format/webp" alt="img"></p>
<p>å…¶ä¸­åŒ…å« 3 ä¸ªNacos èŠ‚ç‚¹ï¼Œç„¶åä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ Nginx ä»£ç† 3 ä¸ª Nacosï¼Œæˆ‘ä»¬è®¡åˆ’çš„ Nacos é›†ç¾¤å¦‚ä¸‹å›¾ï¼ŒMySQL çš„ä¸»ä»å¤åˆ¶åç»­å†æ·»åŠ ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108182000220.png!/format/webp" alt="img"></p>
<p>ä¸‰ä¸ª Nacos èŠ‚ç‚¹çš„åœ°å€</p>
<table>
<thead>
<tr>
<th align="left">èŠ‚ç‚¹</th>
<th align="left">ip</th>
<th align="left">port</th>
</tr>
</thead>
<tbody><tr>
<td align="left">nacos1</td>
<td align="left">192.168.150.1</td>
<td align="left">8845</td>
</tr>
<tr>
<td align="left">nacos2</td>
<td align="left">192.168.150.1</td>
<td align="left">8846</td>
</tr>
<tr>
<td align="left">nacos3</td>
<td align="left">192.168.150.1</td>
<td align="left">8847</td>
</tr>
</tbody></table>
<h2 id="åˆå§‹åŒ–æ•°æ®åº“"><a href="#åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="åˆå§‹åŒ–æ•°æ®åº“"></a>åˆå§‹åŒ–æ•°æ®åº“</h2><p>Nacos é»˜è®¤æ•°æ®å­˜å‚¨åœ¨å†…åµŒæ•°æ®åº“ Derby ä¸­ï¼Œä¸å±äºç”Ÿäº§å¯ç”¨çš„æ•°æ®åº“ã€‚å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨å¸¦æœ‰ä¸»ä»çš„é«˜å¯ç”¨æ•°æ®åº“é›†ç¾¤ï¼Œä¸»ä»æ¨¡å¼çš„é«˜å¯ç”¨æ•°æ®åº“ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥å•ç‚¹çš„æ•°æ®åº“ä¸ºä¾‹ã€‚</p>
<p>é¦–å…ˆæ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå‘½åä¸º nacosï¼Œè€Œåå¯¼å…¥ä¸‹é¢çš„ SQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_use<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>effect<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_aggr   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å†…å®¹'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¢åŠ ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_beta   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_tag   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_tags_relation   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = group_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>quota<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>usage<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = his_config_info   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>op_type<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¤šç§Ÿæˆ·æ”¹é€ '</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = tenant_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>quota<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>usage<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>kp<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_source<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>kp<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>enabled<span class="token punctuation">`</span></span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>roles<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>permissions<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>resource<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>action<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>resource<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>action<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®Nacos"><a href="#é…ç½®Nacos" class="headerlink" title="é…ç½®Nacos"></a>é…ç½®Nacos</h2><p>è¿›å…¥ nacos çš„ conf ç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ cluster.conf.exampleï¼Œé‡å‘½åä¸º cluster.conf</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108182004564.png!/format/webp" alt="img"></p>
<p>æ·»åŠ å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1:8845
127.0.0.1.8846
127.0.0.1.8847<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åä¿®æ”¹ application.properties æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“é…ç½®</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.datasource.platform</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>
<span class="token key attr-name">db.num</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token key attr-name">db.url.0</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span>
<span class="token key attr-name">db.user.0</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">db.password.0</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°† nacos æ–‡ä»¶å¤¹å¤åˆ¶ä¸‰ä»½ï¼Œåˆ†åˆ«å‘½åä¸ºï¼šnacos1ã€nacos2ã€nacos3</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108182004103.png!/format/webp" alt="img"></p>
<p>ç„¶ååˆ†åˆ«ä¿®æ”¹ä¸‰ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ application.propertiesï¼Œ</p>
<p>nacos1</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8845</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>nacos2</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8846</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>nacos3</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8847</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶ååˆ†åˆ«å¯åŠ¨ä¸‰ä¸ª nacos</p>
<pre class="line-numbers language-none"><code class="language-none">startup.cmd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Nginxåå‘ä»£ç†"><a href="#Nginxåå‘ä»£ç†" class="headerlink" title="Nginxåå‘ä»£ç†"></a>Nginxåå‘ä»£ç†</h2><p>ä¿®æ”¹ nginx æ–‡ä»¶å¤¹ä¸‹çš„ conf/nginx.conf æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">upstream</span> nacos-cluster</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8845</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8846</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8847</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /nacos</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://nacos-cluster</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨ nginxï¼Œåœ¨æµè§ˆå™¨è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost/nacos">http://localhost/nacos</a></p>
<p>åœ¨ä»£ç ä¸­çš„ application.yml æ–‡ä»¶é…ç½®æ”¹ä¸ºå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">spring:
  cloud:
    nacos:
      server-addr: localhost:80 # Nacosåœ°å€<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®é™…éƒ¨ç½²æ—¶ï¼Œéœ€è¦ç»™åšåå‘ä»£ç†çš„ Nginx æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªåŸŸåï¼Œè¿™æ ·åç»­å¦‚æœæœ‰æœåŠ¡å™¨è¿ç§» Nacos çš„å®¢æˆ·ç«¯ä¹Ÿæ— éœ€æ›´æ”¹é…ç½®ã€‚Nacos çš„å„ä¸ªèŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åˆ°å¤šä¸ªä¸åŒæœåŠ¡å™¨ï¼Œåšå¥½å®¹ç¾å’Œéš”ç¦»å·¥ä½œã€‚</p>
<h1 id="Feignè¿œç¨‹è°ƒç”¨"><a href="#Feignè¿œç¨‹è°ƒç”¨" class="headerlink" title="Feignè¿œç¨‹è°ƒç”¨"></a>Feignè¿œç¨‹è°ƒç”¨</h1><blockquote>
<p>ä»£ç å‚è€ƒ</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign">https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign">https://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign</a></p>
</blockquote>
<p>æˆ‘ä»¬ä»¥å‰åˆ©ç”¨ RestTemplate å‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092616.png!/format/webp" alt="img"></p>
<ul>
<li>ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€</li>
<li>å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤</li>
</ul>
<p>Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ http å®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬<strong>ä¼˜é›…çš„å®ç° http è¯·æ±‚çš„å‘é€</strong>ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092639.png!/format/webp" alt="img"></p>
<h2 id="Feignä½¿ç”¨"><a href="#Feignä½¿ç”¨" class="headerlink" title="Feignä½¿ç”¨"></a>Feignä½¿ç”¨</h2><p><strong>å¼•å…¥ä¾èµ–</strong></p>
<p>æˆ‘ä»¬åœ¨ order-service å¼•å…¥ feign ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ·»åŠ æ³¨è§£</strong></p>
<p>åœ¨ order-service å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯ Feign</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092704.png!/format/webp" alt="img"></p>
<p><strong>è¯·æ±‚æ¥å£</strong></p>
<p>åœ¨ order-service ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>order<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"userservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>@FeignClient("userservice")</code>ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯å¾®æœåŠ¡å</p>
<p><code>@GetMapping("/user/{id}")</code>ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯è¯·æ±‚è·¯å¾„</p>
<p>è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäº SpringMVC çš„æ³¨è§£ <code>@GetMapping</code> æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯</p>
<p>Feign å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚</p>
<p><strong>æµ‹è¯•</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserClient</span> userClient<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">queryOrderAndUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.æŸ¥è¯¢è®¢å•</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: 2021/8/20 ä½¿ç”¨feignè¿œç¨‹è°ƒç”¨</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userClient<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. å°†ç”¨æˆ·ä¿¡æ¯å°è£…è¿›è®¢å•</span>
    order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.è¿”å›</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è‡ªå®šä¹‰é…ç½®"><a href="#è‡ªå®šä¹‰é…ç½®" class="headerlink" title="è‡ªå®šä¹‰é…ç½®"></a>è‡ªå®šä¹‰é…ç½®</h2><p>Feign å¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ä½œç”¨</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>feign.Logger.Level</td>
<td>ä¿®æ”¹æ—¥å¿—çº§åˆ«</td>
<td>åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>å“åº”ç»“æœçš„è§£æå™¨</td>
<td>httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>è¯·æ±‚å‚æ•°ç¼–ç </td>
<td>å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>æ”¯æŒçš„æ³¨è§£æ ¼å¼</td>
<td>é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>å¤±è´¥é‡è¯•æœºåˆ¶</td>
<td>è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯•</td>
</tr>
</tbody></table>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Bean å³å¯ã€‚ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚</p>
<p>åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ feign çš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  æ—¥å¿—çº§åˆ« </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡</strong>ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  æ—¥å¿—çº§åˆ« </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š</p>
<ul>
<li>NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚</li>
<li>BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´</li>
<li>HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯</li>
<li>FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®</li>
</ul>
<p>ä¹Ÿå¯ä»¥åŸºäº <strong>Java ä»£ç </strong>æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ª Logger.Level çš„å¯¹è±¡</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFeignConfiguration</span>  <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLogLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>BASIC<span class="token punctuation">;</span> <span class="token comment">// æ—¥å¿—çº§åˆ«ä¸ºBASIC</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœè¦<strong>å…¨å±€ç”Ÿæ•ˆ</strong>ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„ <code>@EnableFeignClients</code> è¿™ä¸ªæ³¨è§£ä¸­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>defaultConfiguration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¦‚æœæ˜¯<strong>å±€éƒ¨ç”Ÿæ•ˆ</strong>ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„ <code>@FeignClient</code> è¿™ä¸ªæ³¨è§£ä¸­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userservice"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><p>Feign åº•å±‚å‘èµ· http è¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°æœ‰ï¼š</p>
<ul>
<li>URLConnection: é»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± </li>
<li><strong>Apache HttpClient</strong> ï¼šæ”¯æŒè¿æ¥æ± </li>
<li><strong>OKHttp</strong>ï¼šæ”¯æŒè¿æ¥æ± </li>
</ul>
<p>å› æ­¤æé«˜ Feign æ€§èƒ½çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨<strong>è¿æ¥æ± </strong>ä»£æ›¿é»˜è®¤çš„ URLConnection</p>
<p>å¦å¤–ï¼Œæ—¥å¿—çº§åˆ«åº”è¯¥å°½é‡ç”¨ basic/noneï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ€§èƒ½ã€‚</p>
<p><strong>è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„HttpClientæ¥æ¼”ç¤ºè¿æ¥æ± ã€‚</strong></p>
<p>åœ¨ order-service çš„ pom æ–‡ä»¶ä¸­å¼•å…¥ HttpClient ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--httpClientçš„ä¾èµ– --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>é…ç½®è¿æ¥æ± </strong></p>
<p>åœ¨ order-service çš„ application.yml ä¸­æ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># defaultå…¨å±€çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> BASIC <span class="token comment"># æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ</span>
    <span class="token key atrule">max-connections</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># æœ€å¤§çš„è¿æ¥æ•°</span>
    <span class="token key atrule">max-connections-per-route</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ FeignClientFactoryBean ä¸­çš„ loadBalance æ–¹æ³•ä¸­æ‰“æ–­ç‚¹</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092729.png!/format/webp" alt="img"></p>
<p>Debug æ–¹å¼å¯åŠ¨ order-service æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ clientï¼Œåº•å±‚å°±æ˜¯ HttpClient</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092737.png!/format/webp" alt="img"></p>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="ç»§æ‰¿æ–¹å¼"><a href="#ç»§æ‰¿æ–¹å¼" class="headerlink" title="ç»§æ‰¿æ–¹å¼"></a>ç»§æ‰¿æ–¹å¼</h3><p>ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š</p>
<p>1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜</p>
<p>2ï¼‰Feign å®¢æˆ·ç«¯ã€Controller éƒ½é›†æˆè¯¥æ¥å£</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092803.png!/format/webp" alt="img"></p>
<p>ä¼˜ç‚¹</p>
<ul>
<li>ç®€å•</li>
<li>å®ç°äº†ä»£ç å…±äº«</li>
</ul>
<p>ç¼ºç‚¹</p>
<ul>
<li>æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ</li>
<li>å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤ Controller ä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£</li>
</ul>
<h3 id="æŠ½å–æ–¹å¼"><a href="#æŠ½å–æ–¹å¼" class="headerlink" title="æŠ½å–æ–¹å¼"></a>æŠ½å–æ–¹å¼</h3><p>å°† FeignClient æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ pojoã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼šå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092811.png!/format/webp" alt="img"></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨è¯¥æ–¹æ³•åœ¨ä»£ç ä¸­å®ç°</p>
<p><strong>é¦–å…ˆåˆ›å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º feign-api</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092835.png!/format/webp" alt="img"></p>
<p>åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>order-serviceä¸­ çš„ UserClientã€User éƒ½å¤åˆ¶åˆ° feign-api é¡¹ç›®ä¸­</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092848.png!/format/webp" alt="img"></p>
<p>æ¥ä¸‹æ¥åœ¨ order-service ä¸­ä½¿ç”¨ feign-api</p>
<p>ç”±äºæˆ‘ä»¬å·²ç»å°† UserClientã€User æ”¾åœ¨ fegin-api ä¸­å…±äº«äº† ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤ order-service ä¸­çš„ UserClientã€Userï¼Œç„¶ååœ¨ order-service ä¸­å¼•å…¥ feign-api</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xn2001.feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ä¿®æ”¹æ³¨è§£</strong></p>
<p>å½“å®šä¹‰çš„ FeignClient ä¸åœ¨ SpringBootApplication çš„æ‰«æåŒ…èŒƒå›´ä¸‹æ—¶ï¼Œè¿™äº› FeignClient å°±ä¸èƒ½ä½¿ç”¨ã€‚</p>
<p>ä¿®æ”¹ order-service å¯åŠ¨ç±»ä¸Šçš„ <code>@EnableFeignClients</code> æ³¨è§£</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.xn2001.feign.clients"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>







<h1 id="Gatewayç½‘å…³"><a href="#Gatewayç½‘å…³" class="headerlink" title="Gatewayç½‘å…³"></a>Gatewayç½‘å…³</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway">https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway">https://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway</a></p>
</blockquote>
<p>Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p>
<p>Gateway ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œ<strong>æ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚</strong></p>
<p><strong>ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§</strong>:</p>
<ul>
<li>è¯·æ±‚è·¯ç”±</li>
<li>æƒé™æ§åˆ¶</li>
<li>é™æµ</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210901092857.png!/format/webp" alt="img"></p>
<p><strong>æƒé™æ§åˆ¶</strong>ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚</p>
<p><strong>è·¯ç”±å’Œè´Ÿè½½å‡è¡¡</strong>ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚</p>
<p><strong>é™æµ</strong>ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚</p>
<p>åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul æ˜¯åŸºäº Servlet å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ Spring Cloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<h2 id="å…¥é—¨ä½¿ç”¨"><a href="#å…¥é—¨ä½¿ç”¨" class="headerlink" title="å…¥é—¨ä½¿ç”¨"></a>å…¥é—¨ä½¿ç”¨</h2><ol>
<li>åˆ›å»º SpringBoot å·¥ç¨‹ gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–</li>
<li>ç¼–å†™å¯åŠ¨ç±»</li>
<li>ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™</li>
<li>å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•</li>
</ol>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--ç½‘å…³--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--nacosæœåŠ¡å‘ç°ä¾èµ–--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># ç½‘å…³ç«¯å£</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># æœåŠ¡åç§°</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacosåœ°å€</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># ç½‘å…³è·¯ç”±é…ç½®</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å°†ç¬¦åˆ<code>Path</code> è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° <code>uri</code>å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚</p>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† <code>/user/**</code> å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ° <code>lb://userservice</code>ï¼Œå…¶ä¸­ lb æ˜¯è´Ÿè½½å‡è¡¡(LoadBalance)ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
<p>é‡å¯ç½‘å…³ï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010/user/1</a> æ—¶ï¼Œç¬¦åˆ <code>/user/**</code> è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ° uriï¼š<a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/202108220125749.png!/format/webp" alt="img"></p>
<p>å¤šä¸ª predicates çš„è¯ï¼Œè¦åŒæ—¶æ»¡è¶³è§„åˆ™ï¼Œä¸‹æ–‡æœ‰ä¾‹å­ã€‚</p>
<h2 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a><strong>æµç¨‹å›¾</strong></h2><p><img src="https://cdn.xn2001.com/img/2021/202108220127419.png!/format/webp" alt="img"></p>
<p>è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š</p>
<ul>
<li>è·¯ç”±id: è·¯ç”±çš„å”¯ä¸€æ ‡è¯†</li>
<li>è·¯ç”±ç›®æ ‡ uri: è·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttp ä»£è¡¨å›ºå®šåœ°å€ï¼Œ lb ä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡</li>
<li>è·¯ç”±æ–­è¨€ predicates: åˆ¤æ–­è·¯ç”±çš„è§„åˆ™</li>
<li>è·¯ç”±è¿‡æ»¤å™¨ filters: å¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†</li>
</ul>
<h2 id="æ–­è¨€å·¥å‚"><a href="#æ–­è¨€å·¥å‚" class="headerlink" title="æ–­è¨€å·¥å‚"></a>æ–­è¨€å·¥å‚</h2><p>æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢« Predicate Factory è¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶ã€‚</p>
<p>ä¾‹å¦‚ <code>Path=/user/**</code> æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±</p>
<p><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code> ç±»æ¥å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ Spring Cloud Gateway è¿˜æœ‰åå‡ ä¸ª</p>
<table>
<thead>
<tr>
<th align="left">åç§°</th>
<th align="left">è¯´æ˜</th>
<th align="left">ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td align="left">After</td>
<td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚</td>
<td align="left">- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="left">Before</td>
<td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
<td align="left">- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td>
</tr>
<tr>
<td align="left">Between</td>
<td align="left">æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
<td align="left">- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="left">Cookie</td>
<td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie</td>
<td align="left">- Cookie=chocolate, ch.p</td>
</tr>
<tr>
<td align="left">Header</td>
<td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header</td>
<td align="left">- Header=X-Request-Id, \d+</td>
</tr>
<tr>
<td align="left">Host</td>
<td align="left">è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰</td>
<td align="left">- Host=<code>**.somehost.org</code>, <code>**.anotherhost.org</code></td>
</tr>
<tr>
<td align="left">Method</td>
<td align="left">è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼</td>
<td align="left">- Method=GET,POST</td>
</tr>
<tr>
<td align="left">Path</td>
<td align="left">è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™</td>
<td align="left">- Path=/red/{segment},/blue/**</td>
</tr>
<tr>
<td align="left">Query</td>
<td align="left">è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°</td>
<td align="left">- Query=name, Jackæˆ–è€…- Query=name</td>
</tr>
<tr>
<td align="left">RemoteAddr</td>
<td align="left">è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´</td>
<td align="left">- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td align="left">Weight</td>
<td align="left">æƒé‡å¤„ç†</td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a></p>
</blockquote>
<p>ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚</p>
<p>ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>
  <span class="token punctuation">-</span> After=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åƒè¿™æ ·çš„è§„åˆ™ï¼Œç°åœ¨æ˜¯ 2021å¹´8æœˆ22æ—¥01:32:42ï¼Œå¾ˆæ˜æ˜¾ After æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯ä»¥ä¸ä¼šè½¬å‘ï¼Œè·¯ç”±ä¸èµ·ä½œç”¨ã€‚</p>
<h2 id="è¿‡æ»¤å™¨å·¥å‚"><a href="#è¿‡æ»¤å™¨å·¥å‚" class="headerlink" title="è¿‡æ»¤å™¨å·¥å‚"></a>è¿‡æ»¤å™¨å·¥å‚</h2><p>GatewayFilter æ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108220133487.png!/format/webp" alt="img"></p>
<p>Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p>
</blockquote>
<table>
<thead>
<tr>
<th align="left"><strong>åç§°</strong></th>
<th align="left"><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">AddRequestHeader</td>
<td align="left">ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´</td>
</tr>
<tr>
<td align="left">RemoveRequestHeader</td>
<td align="left">ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´</td>
</tr>
<tr>
<td align="left">AddResponseHeader</td>
<td align="left">ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´</td>
</tr>
<tr>
<td align="left">RemoveResponseHeader</td>
<td align="left">ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´</td>
</tr>
<tr>
<td align="left">RequestRateLimiter</td>
<td align="left">é™åˆ¶è¯·æ±‚çš„æµé‡</td>
</tr>
</tbody></table>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥ AddRequestHeader ä¸ºä¾‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108220139913.png!/format/webp" alt="img"></p>
<p><strong>éœ€æ±‚</strong>ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼š<code>sign=xn2001.com is eternal</code></p>
<p>åªéœ€è¦ä¿®æ”¹ gateway æœåŠ¡çš„ application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># ç½‘å…³è·¯ç”±é…ç½®</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># æ·»åŠ è¯·æ±‚å¤´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä½•éªŒè¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ userservice ä¸­çš„ä¸€ä¸ªæ¥å£</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"sign"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sign<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010/user/1</a></p>
<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è¿™ä¸ªè¯·æ±‚å¤´</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108220145565.png!/format/webp" alt="img"></p>
<p>å½“ç„¶ï¼ŒGateway ä¹Ÿæ˜¯æœ‰<strong>å…¨å±€è¿‡æ»¤å™¨</strong>çš„ï¼Œå¦‚æœè¦<strong>å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆ</strong>ï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default-filters ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># æ·»åŠ è¯·æ±‚å¤´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å…¨å±€è¿‡æ»¤å™¨"><a href="#å…¨å±€è¿‡æ»¤å™¨" class="headerlink" title="å…¨å±€è¿‡æ»¤å™¨"></a>å…¨å±€è¿‡æ»¤å™¨</h2><p>ä¸Šé¢ä»‹ç»çš„è¿‡æ»¤å™¨å·¥å‚ï¼Œç½‘å…³æä¾›äº† 31 ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚<strong>å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°</strong>ã€‚</p>
<p>å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œ<strong>ä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·</strong>ã€‚åŒºåˆ«åœ¨äº GlobalFilter çš„é€»è¾‘å¯ä»¥<strong>å†™ä»£ç æ¥è‡ªå®šä¹‰è§„åˆ™</strong>ï¼›è€Œ GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ã€‚</p>
<p><strong>éœ€æ±‚</strong>ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶</p>
<ul>
<li>å‚æ•°ä¸­æ˜¯å¦æœ‰ authorization</li>
<li>authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin</li>
</ul>
<p>å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆªã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token comment">// æµ‹è¯•ï¼šhttp://localhost:10010/order/101?authorization=admin</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ç¬¬ä¸€ä¸ª authorization å‚æ•°</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// æ”¾è¡Œ</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®¾ç½®æ‹¦æˆªçŠ¶æ€ç ä¿¡æ¯</span>
        exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®æ‹¦æˆª</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼Œå€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜</span>
    <span class="token comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨ @Order æ³¨è§£</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è¿‡æ»¤å™¨é¡ºåº"><a href="#è¿‡æ»¤å™¨é¡ºåº" class="headerlink" title="è¿‡æ»¤å™¨é¡ºåº"></a>è¿‡æ»¤å™¨é¡ºåº</h2><p>è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šDefaultFilterã€å½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€GlobalFilterï¼›</p>
<p>è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†ä¸‰è€…åˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨.</p>
<p><img src="https://cdn.xn2001.com/img/2021/202108230002747.png!/format/webp" alt="img"></p>
<p>æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ul>
<li>æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼, order å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰ã€‚</li>
<li>GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨ @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®šã€‚</li>
<li>è·¯ç”±è¿‡æ»¤å™¨å’Œ defaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚</li>
<li>å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œ<strong>ä¼šæŒ‰ç…§ defaultFilter &gt; è·¯ç”±è¿‡æ»¤å™¨ &gt; GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚</strong></li>
</ul>
<h2 id="è·¨åŸŸé—®é¢˜"><a href="#è·¨åŸŸé—®é¢˜" class="headerlink" title="è·¨åŸŸé—®é¢˜"></a>è·¨åŸŸé—®é¢˜</h2><p>ä¸äº†è§£è·¨åŸŸé—®é¢˜çš„åŒå­¦å¯ä»¥ç™¾åº¦äº†è§£ä¸€ä¸‹ï¼›åœ¨ Gateway ç½‘å…³ä¸­è§£å†³è·¨åŸŸé—®é¢˜è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># å…¨å±€çš„è·¨åŸŸå¤„ç†</span>
        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ allowedOrigins: â€œ*â€ å…è®¸æ‰€æœ‰ç½‘ç«™</span>
              <span class="token punctuation">-</span> <span class="token string">"http://localhost:8090"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼</span>
              <span class="token punctuation">-</span> <span class="token string">"GET"</span>
              <span class="token punctuation">-</span> <span class="token string">"POST"</span>
              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>
              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>
              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">"*"</span> <span class="token comment"># å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># æ˜¯å¦å…è®¸æºå¸¦cookie</span>
            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000</span> <span class="token comment"># è¿™æ¬¡è·¨</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶"><a href="#RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶" class="headerlink" title="RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶"></a>RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶</h1><h2 id="åŒæ­¥å¼‚æ­¥é€šè®¯"><a href="#åŒæ­¥å¼‚æ­¥é€šè®¯" class="headerlink" title="åŒæ­¥å¼‚æ­¥é€šè®¯"></a>åŒæ­¥å¼‚æ­¥é€šè®¯</h2><p><strong>å¾®æœåŠ¡é—´é€šè®¯æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼</strong></p>
<p>åŒæ­¥é€šè®¯ï¼šå°±åƒæ‰“ç”µè¯ï¼Œéœ€è¦å®æ—¶å“åº”ã€‚</p>
<p>å¼‚æ­¥é€šè®¯ï¼šå°±åƒå‘é‚®ä»¶ï¼Œä¸éœ€è¦é©¬ä¸Šå›å¤ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904133345.png!/format/webp" alt="img"></p>
<p>ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæ‰“ç”µè¯å¯ä»¥ç«‹å³å¾—åˆ°å“åº”ï¼Œä½†æ˜¯ä½ å´ä¸èƒ½è·Ÿå¤šä¸ªäººåŒæ—¶é€šè¯ã€‚å‘é€é‚®ä»¶å¯ä»¥åŒæ—¶ä¸å¤šä¸ªäººæ”¶å‘é‚®ä»¶ï¼Œä½†æ˜¯å¾€å¾€å“åº”ä¼šæœ‰å»¶è¿Ÿã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ <strong>Feign è°ƒç”¨</strong>å°±å±äº<strong>åŒæ­¥æ–¹å¼</strong>ï¼Œè™½ç„¶è°ƒç”¨å¯ä»¥å®æ—¶å¾—åˆ°ç»“æœï¼Œä½†å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ul>
<li>è€¦åˆåº¦é«˜</li>
<li>æ€§èƒ½ä¸‹é™</li>
<li>èµ„æºæµªè´¹</li>
<li>çº§è”å¤±è´¥</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210904133517.png!/format/webp" alt="img"></p>
<p><strong>åŒæ­¥è°ƒç”¨çš„ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>æ—¶æ•ˆæ€§è¾ƒå¼ºï¼Œå¯ä»¥ç«‹å³å¾—åˆ°ç»“æœ</li>
</ul>
<p><strong>åŒæ­¥è°ƒç”¨çš„ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>è€¦åˆåº¦é«˜</li>
<li>æ€§èƒ½å’Œååèƒ½åŠ›ä¸‹é™</li>
<li>æœ‰é¢å¤–çš„èµ„æºæ¶ˆè€—</li>
<li>æœ‰çº§è”å¤±è´¥é—®é¢˜</li>
</ul>
<p>å¼‚æ­¥è°ƒç”¨åˆ™å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬ä»¥è´­ä¹°å•†å“ä¸ºä¾‹ï¼Œç”¨æˆ·æ”¯ä»˜åéœ€è¦è°ƒç”¨è®¢å•æœåŠ¡å®Œæˆè®¢å•çŠ¶æ€ä¿®æ”¹ï¼Œè°ƒç”¨ç‰©æµæœåŠ¡ï¼Œä»ä»“åº“åˆ†é…å“åº”çš„åº“å­˜å¹¶å‡†å¤‡å‘è´§ã€‚åœ¨äº‹ä»¶æ¨¡å¼ä¸­ï¼Œæ”¯ä»˜æœåŠ¡æ˜¯äº‹ä»¶å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼Œåœ¨æ”¯ä»˜å®Œæˆååªéœ€è¦å‘å¸ƒä¸€ä¸ªæ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼ˆeventï¼‰ï¼Œäº‹ä»¶ä¸­å¸¦ä¸Šè®¢å•idã€‚è®¢å•æœåŠ¡å’Œç‰©æµæœåŠ¡æ˜¯äº‹ä»¶è®¢é˜…è€…ï¼ˆConsumerï¼‰ï¼Œè®¢é˜…æ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼Œç›‘å¬åˆ°äº‹ä»¶åå®Œæˆè‡ªå·±ä¸šåŠ¡å³å¯ã€‚</p>
<p>ä¸ºäº†è§£é™¤äº‹ä»¶å‘å¸ƒè€…ä¸è®¢é˜…è€…ä¹‹é—´çš„è€¦åˆï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸­é—´äººï¼ˆBrokerï¼‰ã€‚å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°Brokerï¼Œä¸å…³å¿ƒè°æ¥è®¢é˜…äº‹ä»¶ã€‚è®¢é˜…è€…ä»Brokerè®¢é˜…äº‹ä»¶ï¼Œä¸å…³å¿ƒè°å‘æ¥çš„æ¶ˆæ¯ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904144714.png!/format/webp" alt="img"></p>
<p>Broker æ˜¯ä¸€ä¸ªåƒæ•°æ®æ€»çº¿ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰€æœ‰çš„æœåŠ¡è¦æ¥æ”¶æ•°æ®å’Œå‘é€æ•°æ®éƒ½å‘åˆ°è¿™ä¸ªæ€»çº¿ä¸Šï¼Œè¿™ä¸ªæ€»çº¿å°±åƒåè®®ä¸€æ ·ï¼Œè®©æœåŠ¡é—´çš„é€šè®¯å˜å¾—æ ‡å‡†å’Œå¯æ§ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904145001.png!/format/webp" alt="img"></p>
<p>å¼‚æ­¥è°ƒç”¨çš„å¥½å¤„ï¼š</p>
<ul>
<li>ååé‡æå‡ï¼šæ— éœ€ç­‰å¾…è®¢é˜…è€…å¤„ç†å®Œæˆï¼Œå“åº”æ›´å¿«é€Ÿ</li>
<li>æ•…éšœéš”ç¦»ï¼šæœåŠ¡æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œä¸å­˜åœ¨çº§è”å¤±è´¥é—®é¢˜</li>
<li>è°ƒç”¨é—´æ²¡æœ‰é˜»å¡ï¼Œä¸ä¼šé€ æˆæ— æ•ˆçš„èµ„æºå ç”¨</li>
<li>è€¦åˆåº¦æä½ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥çµæ´»æ’æ‹”ï¼Œå¯æ›¿æ¢</li>
<li>æµé‡å‰Šå³°ï¼šä¸ç®¡å‘å¸ƒäº‹ä»¶çš„æµé‡æ³¢åŠ¨å¤šå¤§ï¼Œéƒ½ç”± Broker æ¥æ”¶ï¼Œè®¢é˜…è€…å¯ä»¥æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦å»å¤„ç†äº‹ä»¶</li>
</ul>
<p>å¼‚æ­¥è°ƒç”¨çš„ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ¶æ„å¤æ‚äº†ï¼Œä¸šåŠ¡æ²¡æœ‰æ˜æ˜¾çš„æµç¨‹çº¿ï¼Œä¸å¥½ç®¡ç†</li>
<li>éœ€è¦ä¾èµ–äº Broker çš„å¯é ã€å®‰å…¨ã€æ€§èƒ½</li>
</ul>
<h2 id="MQæ¶ˆæ¯é˜Ÿåˆ—"><a href="#MQæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="MQæ¶ˆæ¯é˜Ÿåˆ—"></a><strong>MQæ¶ˆæ¯é˜Ÿåˆ—</strong></h2><p>MQï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„ Broker</p>
<p>æ¯”è¾ƒå¸¸è§çš„ MQ å®ç°ï¼š</p>
<ul>
<li>ActiveMQ</li>
<li>RabbitMQ</li>
<li>RocketMQ</li>
<li>Kafka</li>
</ul>
<p>å‡ ç§å¸¸è§MQçš„å¯¹æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><strong>RabbitMQ</strong></th>
<th align="left"><strong>ActiveMQ</strong></th>
<th align="left"><strong>RocketMQ</strong></th>
<th align="left"><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">å…¬å¸/ç¤¾åŒº</td>
<td align="left">Rabbit</td>
<td align="left">Apache</td>
<td align="left">é˜¿é‡Œ</td>
<td align="left">Apache</td>
</tr>
<tr>
<td align="left">å¼€å‘è¯­è¨€</td>
<td align="left">Erlang</td>
<td align="left">Java</td>
<td align="left">Java</td>
<td align="left">Scala&amp;Java</td>
</tr>
<tr>
<td align="left">åè®®æ”¯æŒ</td>
<td align="left">AMQPã€XMPPã€SMTPã€STOMP</td>
<td align="left">OpenWireã€STOMPã€RESTã€XMPPã€AMQP</td>
<td align="left">è‡ªå®šä¹‰åè®®</td>
<td align="left">è‡ªå®šä¹‰åè®®</td>
</tr>
<tr>
<td align="left">å¯ç”¨æ€§</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">é«˜</td>
<td align="left">é«˜</td>
</tr>
<tr>
<td align="left">å•æœºååé‡</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">å·®</td>
<td align="left">é«˜</td>
<td align="left">éå¸¸é«˜</td>
</tr>
<tr>
<td align="left">æ¶ˆæ¯å»¶è¿Ÿ</td>
<td align="left">å¾®ç§’çº§</td>
<td align="left">æ¯«ç§’çº§</td>
<td align="left">æ¯«ç§’çº§</td>
<td align="left">æ¯«ç§’ä»¥å†…</td>
</tr>
<tr>
<td align="left">æ¶ˆæ¯å¯é æ€§</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
</tr>
</tbody></table>
<h2 id="RabbitMQå®‰è£…"><a href="#RabbitMQå®‰è£…" class="headerlink" title="RabbitMQå®‰è£…"></a>RabbitMQå®‰è£…</h2><p>åœ¨çº¿æ‹‰å–é•œåƒ</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull rabbitmq:ç‰ˆæœ¬å·<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡ŒMQå®¹å™¨</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run <span class="token punctuation">\</span>
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>admin <span class="token punctuation">\</span>   æŒ‡å®šç”¨æˆ·å
 -e <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token punctuation">\</span>  å¯†ç 
 --name mq <span class="token punctuation">\</span>    å®¹å™¨åå­—
 --hostname mq1 <span class="token punctuation">\</span>
 -p <span class="token number">15672</span>:15672 <span class="token punctuation">\</span>  ç«¯å£æ˜ å°„
 -p <span class="token number">5672</span>:5672 <span class="token punctuation">\</span>
 -d <span class="token punctuation">\</span>
 rabbitmq:3-management<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨æˆåŠŸåè®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:15672/">http://192.168.211.128:15672</a></p>
<h2 id="MQ-çš„åŸºæœ¬ç»“æ„"><a href="#MQ-çš„åŸºæœ¬ç»“æ„" class="headerlink" title="MQ çš„åŸºæœ¬ç»“æ„"></a><strong>MQ çš„åŸºæœ¬ç»“æ„</strong></h2><p><strong>RabbitMQ ä¸­çš„ä¸€äº›è§’è‰²</strong></p>
<ul>
<li>publisher: ç”Ÿäº§è€…</li>
<li>consumer: æ¶ˆè´¹è€…</li>
<li>exchange: äº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±</li>
<li>queue: é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯</li>
<li>virtualHost: è™šæ‹Ÿä¸»æœºï¼Œéš”ç¦» <strong>ä¸ç”¨ç”¨æˆ·</strong> çš„exchange,queue,æ¶ˆæ¯çš„éš”ç¦»</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210904172912.png!/format/webp" alt="img"></p>
<h2 id="å…¥é—¨æ¡ˆä¾‹"><a href="#å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="å…¥é—¨æ¡ˆä¾‹"></a><strong>å…¥é—¨æ¡ˆä¾‹</strong></h2><p>RabbitMQ å®˜æ–¹æä¾›äº† 5 ä¸ªä¸åŒçš„ Demo ç¤ºä¾‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904173739.png!/format/webp" alt="img"></p>
<h3 id="Hello-World-æ¨¡å‹"><a href="#Hello-World-æ¨¡å‹" class="headerlink" title="Hello World æ¨¡å‹"></a>Hello World æ¨¡å‹</h3><p><img src="https://cdn.xn2001.com/img/2021/20210904200637.png!/format/webp" alt="img"></p>
<p>å®˜æ–¹çš„ HelloWorld æ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue</li>
<li>queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯</li>
<li>consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
</ul>
<h3 id="publisherå®ç°"><a href="#publisherå®ç°" class="headerlink" title="publisherå®ç°"></a>publisherå®ç°</h3><ul>
<li>å»ºç«‹è¿æ¥</li>
<li>åˆ›å»º channel</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>å‘é€æ¶ˆæ¯</li>
<li>å…³é—­è¿æ¥å’Œ channel</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç </span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.åˆ›å»ºé€šé“Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.åˆ›å»ºé˜Ÿåˆ—</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.å‘é€æ¶ˆæ¯</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Hello RabbitMQï¼"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å‘é€æ¶ˆæ¯æˆåŠŸï¼š["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.å…³é—­é€šé“å’Œè¿æ¥</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="consumerå®ç°"><a href="#consumerå®ç°" class="headerlink" title="consumerå®ç°"></a>consumerå®ç°</h3><ul>
<li>å»ºç«‹è¿æ¥</li>
<li>åˆ›å»º channel</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>è®¢é˜…æ¶ˆæ¯</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç </span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.åˆ›å»ºé€šé“Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.åˆ›å»ºé˜Ÿåˆ—</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.è®¢é˜…æ¶ˆæ¯</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span>
                                       <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.å¤„ç†æ¶ˆæ¯</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ä¸­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h2><p>SpringAMQP æ˜¯åŸºäº RabbitMQ å°è£…çš„ä¸€å¥—æ¨¡æ¿ï¼Œå¹¶ä¸”è¿˜åˆ©ç”¨ SpringBoot å¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p>
<p>SpringAMQP çš„å®˜æ–¹åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp">https://spring.io/projects/spring-amqp</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904202046.png!/format/webp" alt="img"></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904202056.png!/format/webp" alt="img"></p>
<p>SpringAMQP æä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»</li>
<li>åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯</li>
<li>å°è£…äº† RabbitTemplate å·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯</li>
</ul>
<h3 id="å¯¼å…¥ä¾èµ–"><a href="#å¯¼å…¥ä¾èµ–" class="headerlink" title="å¯¼å…¥ä¾èµ–"></a>å¯¼å…¥ä¾èµ–</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="BasicQueue"><a href="#BasicQueue" class="headerlink" title="BasicQueue"></a>BasicQueue</h3><p>é¦–å…ˆé…ç½® MQåœ°å€ï¼Œåœ¨ publisherã€consumer æœåŠ¡ä¸­çš„ application.yml ä¸­æ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101 <span class="token comment"># ä¸»æœºå</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># ç«¯å£</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># è™šæ‹Ÿä¸»æœº</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin <span class="token comment"># ç”¨æˆ·å</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span> <span class="token comment"># å¯†ç </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡ä¸­æ·»åŠ å‘é€æ¶ˆæ¯çš„æµ‹è¯•ç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAmqpTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜Ÿåˆ—åç§°</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¶ˆæ¯</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"ä½ å¥½å•Šï¼Œä¹å¿ƒæ¹–ï¼"</span><span class="token punctuation">;</span>
        <span class="token comment">// å‘é€æ¶ˆæ¯</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ consumer æœåŠ¡ä¸­æ·»åŠ ç›‘å¬é˜Ÿåˆ—</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenSimpleQueueMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101160558487.png" alt="image-20230101160558487"></p>
<h3 id="WorkQueue"><a href="#WorkQueue" class="headerlink" title="WorkQueue"></a>WorkQueue</h3><p>Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯<strong>è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</strong>ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904211238.png!/format/webp" alt="img"></p>
<p>å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚</p>
<p>æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚</p>
<p>æˆ‘ä»¬å¾ªç¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ï¼Œåœ¨ publisher æœåŠ¡ä¸­çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * workQueue
 * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// é˜Ÿåˆ—åç§°</span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, message_"</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘é€æ¶ˆæ¯</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ¶ˆæ¯æ¥æ”¶</strong></p>
<p>è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨ consumer æœåŠ¡çš„ RabbitMQListener ä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨ ConsumerApplication åï¼Œåœ¨æ‰§è¡Œ publisher æœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³• testWorkQueue</p>
<p>å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯<strong>å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…</strong>ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸º RabbitMQ é»˜è®¤æœ‰ä¸€ä¸ªæ¶ˆæ¯é¢„å–æœºåˆ¶ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯èƒ½è€…å¤šåŠ³å˜›ï¼Œæ‰€ä»¥å»é™åˆ¶æ¯æ¬¡åªèƒ½å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>åœ¨ spring ä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œè®¾ç½® prefetch å±æ€§ï¼Œæˆ‘ä»¬ä¿®æ”¹ consumer æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Work æ¨¡å‹çš„ä½¿ç”¨ï¼š</p>
<ul>
<li>å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</li>
<li>é€šè¿‡è®¾ç½® prefetch æ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡</li>
</ul>
<h3 id="å‘å¸ƒ-è®¢é˜…"><a href="#å‘å¸ƒ-è®¢é˜…" class="headerlink" title="å‘å¸ƒ/è®¢é˜…"></a>å‘å¸ƒ/è®¢é˜…</h3><p><img src="https://cdn.xn2001.com/img/2021/20210904213455.png!/format/webp" alt="img"></p>
<p>å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ª exchange è§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–</p>
<ul>
<li>Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œ<strong>è€Œæ˜¯å‘ç»™ exchangeï¼ˆäº¤æ¢æœºï¼‰</strong></li>
<li>Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–</li>
<li>Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯</li>
<li>Exchangeï¼šäº¤æ¢æœºï¼Œä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼›å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äº Exchange çš„ç±»å‹ã€‚Exchange æœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š<ul>
<li>Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—</li>
<li>Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®š routing key çš„é˜Ÿåˆ—</li>
<li>Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆ routing patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
<p><strong>Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›</strong>ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸ Exchange ç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼</p>
<h4 id="Fanout"><a href="#Fanout" class="headerlink" title="Fanout"></a>Fanout</h4><p>Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œåœ¨ MQ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºå¹¿æ’­ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210912160350.png!/format/webp" alt="img"></p>
<p>åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—</li>
<li>æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ° Exchangeï¼ˆäº¤æ¢æœºï¼‰</li>
<li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š</li>
<li>äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—</li>
<li>è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯</li>
</ul>
<p>æ¥ä¸‹é‡Œæˆ‘ä»¬ç”¨ SpringAMQP æ¥ç®€å•å®ç° FanoutExchange</p>
<ol>
<li>åœ¨ consumer æœåŠ¡ä¸­ï¼Œåˆ©ç”¨ä»£ç å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºï¼Œå¹¶å°†ä¸¤è€…ç»‘å®š</li>
<li>åœ¨ consumer æœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬ fanout.queue1 å’Œ fanout.queue2</li>
<li>åœ¨ publisher ä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘ fanoutå‘é€æ¶ˆæ¯</li>
</ol>
<p><strong>å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</strong></p>
<p>Spring æä¾›äº†ä¸€ä¸ªæ¥å£ Exchangeï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210904213809.png!/format/webp" alt="img"></p>
<p>åœ¨ consumer ä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€<strong>ç»‘å®šå¯¹è±¡ Binding</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å£°æ˜äº¤æ¢æœº
     * @return Fanoutç±»å‹äº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">"xn2001.fanout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å£°æ˜é˜Ÿåˆ—
     * @return Queue
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue1</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue2</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210912181932.png!/format/webp" alt="img"></p>
<p>é€šè¿‡è¿™æ · <code>@Bean</code> çš„æ–¹å¼æ¥ç”³æ˜ç¡®å®æ¯”è¾ƒéº»çƒ¦ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ <code>@RabbitListener</code> æ³¨è§£æ¥å®Œæˆçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p>åœ¨ consumer æœåŠ¡çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸‰ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fanout.queue3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue3</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue3çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * fanout
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, everybody!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œè¯¥æ–¹æ³•ï¼Œå¯ä»¥å‘ç° fanout.queue1ã€fanout.queue2 éƒ½æ”¶åˆ°äº†äº¤æ¢æœºçš„æ¶ˆæ¯ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210912182458.png!/format/webp" alt="img"></p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>æ¥æ”¶ publisher å‘é€çš„æ¶ˆæ¯</li>
<li>å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li>
<li>ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±</li>
<li>FanoutExchange ä¼šå°†æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—</li>
</ul>
<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101165223630.png" alt="image-20230101165223630"></p>
<h4 id="Direct"><a href="#Direct" class="headerlink" title="Direct"></a>Direct</h4><p>åœ¨ Fanout æ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ° DirectExchange</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210912182822.png!/format/webp" alt="img"></p>
<p>åœ¨ Direct æ¨¡å‹ä¸‹ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª<code>RoutingKey</code>ï¼ˆè·¯ç”±keyï¼‰</li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ <code>RoutingKey</code>ã€‚</li>
<li>Exchange ä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„<code>Routing Key</code>è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„<code>Routingkey</code> ä¸æ¶ˆæ¯çš„ <code>Routing key</code>å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li>
</ul>
<p>åœ¨ consumer çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to a!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to b!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101171056007.png" alt="image-20230101171056007"></p>
<h4 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h4><p><code>Topic </code>ä¸ <code>Direct</code>ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®<code>RoutingKey</code>æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡<code>Topic </code>ç±»å‹å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š<code>Routing key</code> çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼</p>
<p>é€šé…ç¬¦è§„åˆ™ï¼š</p>
<p><code>#</code>ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯</p>
<p><code>*</code>ï¼šåªèƒ½åŒ¹é…ä¸€ä¸ªè¯</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">item.#`ï¼šèƒ½å¤ŸåŒ¹é…`item.spu.insert` æˆ–è€… `item.spu
item.*`ï¼šåªèƒ½åŒ¹é…`item.spu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210912194016.png!/format/webp" alt="img"></p>
<ul>
<li>Queue1ï¼šç»‘å®šçš„æ˜¯ <code>china.#</code> ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ <code>china.</code> å¼€å¤´çš„ <code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬ china.news å’Œ china.weather</li>
<li>Queue2ï¼šç»‘å®šçš„æ˜¯ <code>#.news</code> ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ <code>.news </code>ç»“å°¾çš„ <code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬ china.news å’Œ japan.news</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"china.#"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"china.*"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * topic
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTopicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message1 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> message2 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news.2"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news"</span><span class="token punctuation">,</span> message1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news.2"</span><span class="token punctuation">,</span> message2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210912200012.png!/format/webp" alt="img"></p>
<h3 id="AMPQæ¶ˆæ¯è½¬æ¢å™¨"><a href="#AMPQæ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="AMPQæ¶ˆæ¯è½¬æ¢å™¨"></a>AMPQæ¶ˆæ¯è½¬æ¢å™¨</h3><p>Spring ä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™ MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚</p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ Spring é‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯ JDK åºåˆ—åŒ–ã€‚</strong></p>
<p>æˆ‘ä»¬å¯ä»¥å»è¯•ä¸€ä¸‹æ•ˆæœ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"object.queue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenObjectQueue</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"objectæ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token comment">// å‡†å¤‡æ¶ˆæ¯</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€æ¶ˆæ¯</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"object.queue"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210912204117.png!/format/webp" alt="img"></p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š</p>
<ul>
<li>æ•°æ®ä½“ç§¯è¿‡å¤§</li>
<li>æœ‰å®‰å…¨æ¼æ´</li>
<li>å¯è¯»æ€§å·®</li>
</ul>
<p>æˆ‘ä»¬æ¨èå¯ä»¥ä½¿ç”¨ JSON æ¥åºåˆ—åŒ–</p>
<p>åœ¨ publisher å’Œ consumer ä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-dataformat-xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚</p>
<p>åœ¨å„è‡ªçš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ª Bean å³å¯</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">jsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>		<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210912204512.png!/format/webp" alt="img"></p>
<p><img src="D:/PicGo/imgimage-20230101175936216.png" alt="image-20230101175936216"></p>
<h1 id="ELasticsearchæœç´¢å¼•æ“"><a href="#ELasticsearchæœç´¢å¼•æ“" class="headerlink" title="ELasticsearchæœç´¢å¼•æ“"></a><strong>ELasticsearchæœç´¢å¼•æ“</strong></h1><p>ELasticsearch æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„å¼€æºæœç´¢å¼•æ“ï¼Œå…·å¤‡éå¸¸å¤šå¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»æµ·é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥å®ç°æœç´¢ã€æ—¥å¿—ç»Ÿè®¡ã€åˆ†æã€ç³»ç»Ÿç›‘æ§ç­‰åŠŸèƒ½ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918202359.png!/format/webp" alt="img"></p>
<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101181501377.png" alt="image-20230101181501377"></p>
<h2 id="å€’æ’ç´¢å¼•"><a href="#å€’æ’ç´¢å¼•" class="headerlink" title="å€’æ’ç´¢å¼•"></a>å€’æ’ç´¢å¼•</h2><p><strong>é¦–å…ˆï¼Œå€’æ’ç´¢å¼•çš„æ¦‚å¿µæ˜¯åŸºäº MySQL è¿™æ ·çš„æ­£å‘ç´¢å¼•è€Œè¨€çš„ã€‚</strong></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å…ˆè®²ä½•ä¸ºæ­£å‘ç´¢å¼•ã€‚ä¾‹å¦‚ç»™ä¸‹è¡¨ï¼ˆtb_goodsï¼‰ä¸­çš„ id åˆ›å»ºç´¢å¼•</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918202527.png!/format/webp" alt="img"></p>
<p>å¦‚æœæ˜¯æ ¹æ® id æŸ¥è¯¢ï¼Œé‚£ä¹ˆç›´æ¥èµ°ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ã€‚</p>
<p>ä½†å¦‚æœæ˜¯åŸºäº title åšæ¨¡ç³ŠæŸ¥è¯¢ï¼Œåªèƒ½æ˜¯é€è¡Œæ‰«ææ•°æ®ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·æœç´¢æ•°æ®ï¼Œæ¡ä»¶æ˜¯ title ç¬¦åˆ <code>"%æ‰‹æœº%"</code></li>
<li>é€è¡Œè·å–æ•°æ®ï¼Œæ¯”å¦‚ id ä¸º 1 çš„æ•°æ®</li>
<li>åˆ¤æ–­æ•°æ®ä¸­çš„ title æ˜¯å¦ç¬¦åˆç”¨æˆ·æœç´¢æ¡ä»¶</li>
<li>å¦‚æœç¬¦åˆåˆ™æ”¾å…¥ç»“æœé›†ï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚ç„¶åå›åˆ°æ­¥éª¤1</li>
</ol>
<p>é€è¡Œæ‰«æï¼Œä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æï¼Œéšç€æ•°æ®é‡å¢åŠ ï¼Œå…¶æŸ¥è¯¢æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ã€‚å½“æ•°æ®é‡è¾¾åˆ°æ•°ç™¾ä¸‡æ—¶ï¼Œå°±æ˜¯ã€‚ã€‚ã€‚</p>
<p>è€Œå€’æ’ç´¢å¼•ä¸­æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æ–‡æ¡£ï¼ˆ<code>Document</code>ï¼‰ï¼šç”¨æ¥æœç´¢çš„æ•°æ®ï¼Œå…¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µã€ä¸€ä¸ªå•†å“ä¿¡æ¯</li>
<li>è¯æ¡ï¼ˆ<code>Term</code>ï¼‰ï¼šå¯¹æ–‡æ¡£æ•°æ®æˆ–ç”¨æˆ·æœç´¢æ•°æ®ï¼Œåˆ©ç”¨æŸç§ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°çš„å…·å¤‡å«ä¹‰çš„è¯è¯­å°±æ˜¯è¯æ¡ã€‚ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸­å›½äººï¼Œå°±å¯ä»¥åˆ†ä¸ºï¼šæˆ‘ã€æ˜¯ã€ä¸­å›½äººã€ä¸­å›½ã€å›½äººè¿™æ ·çš„å‡ ä¸ªè¯æ¡</li>
</ul>
<p><strong>åˆ›å»ºå€’æ’ç´¢å¼•</strong>æ˜¯å¯¹æ­£å‘ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šå¤„ç†ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å°†æ¯ä¸€ä¸ªæ–‡æ¡£çš„æ•°æ®åˆ©ç”¨ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ªè¯æ¡</li>
<li>åˆ›å»ºè¡¨ï¼Œæ¯è¡Œæ•°æ®åŒ…æ‹¬è¯æ¡ã€è¯æ¡æ‰€åœ¨æ–‡æ¡£ idã€ä½ç½®ç­‰ä¿¡æ¯</li>
<li>å› ä¸ºè¯æ¡å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»™è¯æ¡åˆ›å»ºç´¢å¼•ï¼Œä¾‹å¦‚ hash è¡¨ç»“æ„ç´¢å¼•</li>
</ul>
<p>å¦‚å›¾ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918203514.png!/format/webp" alt="img"></p>
<p><strong>å€’æ’ç´¢å¼•çš„æœç´¢æµç¨‹</strong>å¦‚ä¸‹ï¼ˆä»¥æœç´¢â€åä¸ºæ‰‹æœºâ€ä¸ºä¾‹ï¼‰</p>
<ol>
<li>ç”¨æˆ·è¾“å…¥æ¡ä»¶<code>"åä¸ºæ‰‹æœº"</code>è¿›è¡Œæœç´¢</li>
<li>å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹<strong>åˆ†è¯</strong>ï¼Œå¾—åˆ°è¯æ¡ï¼š<code>åä¸º</code>ã€<code>æ‰‹æœº</code></li>
<li>æ‹¿ç€è¯æ¡åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°åŒ…å«è¯æ¡çš„æ–‡æ¡£ id æœ‰ 1ã€2ã€3</li>
<li>æ‹¿ç€æ–‡æ¡£ id åˆ°æ­£å‘ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“æ–‡æ¡£</li>
</ol>
<p><img src="https://cdn.xn2001.com/img/2021/20210918203815.png!/format/webp" alt="img"></p>
<p><strong>è™½ç„¶è¦å…ˆæŸ¥è¯¢å€’æ’ç´¢å¼•ï¼Œå†æŸ¥è¯¢æ­£å‘ç´¢å¼•ï¼Œä½†æ˜¯è¯æ¡å’Œæ–‡æ¡£id éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼æ— éœ€å…¨è¡¨æ‰«æã€‚</strong></p>
<p>ä¸ºä»€ä¹ˆä¸€ä¸ªå«åšæ­£å‘ç´¢å¼•ï¼Œä¸€ä¸ªå«åšå€’æ’ç´¢å¼•å‘¢ï¼Ÿ</p>
<p><strong>æ­£å‘ç´¢å¼•</strong>æ˜¯æœ€ä¼ ç»Ÿçš„ï¼Œæ ¹æ® id ç´¢å¼•çš„æ–¹å¼ã€‚ä½†æ ¹æ®è¯æ¡æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»å…ˆé€æ¡è·å–æ¯ä¸ªæ–‡æ¡£ï¼Œç„¶ååˆ¤æ–­æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€è¦çš„è¯æ¡ï¼Œæ˜¯<strong>æ ¹æ®æ–‡æ¡£æ‰¾è¯æ¡çš„è¿‡ç¨‹</strong></p>
<p><strong>å€’æ’ç´¢å¼•</strong>åˆ™ç›¸åï¼Œæ˜¯å…ˆæ‰¾åˆ°ç”¨æˆ·è¦æœç´¢çš„è¯æ¡ï¼Œæ ¹æ®å¾—åˆ°çš„æ–‡æ¡£ id è·å–è¯¥æ–‡æ¡£ã€‚æ˜¯<strong>æ ¹æ®è¯æ¡æ‰¾æ–‡æ¡£çš„è¿‡ç¨‹</strong></p>
<h3 id="æ–‡æ¡£å’Œå­—æ®µ"><a href="#æ–‡æ¡£å’Œå­—æ®µ" class="headerlink" title="æ–‡æ¡£å’Œå­—æ®µ"></a><strong>æ–‡æ¡£å’Œå­—æ®µ</strong></h3><p>elasticsearch æ˜¯é¢å‘<strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong>å­˜å‚¨çš„ï¼Œå¯ä»¥æ˜¯æ•°æ®åº“ä¸­çš„ä¸€æ¡å•†å“æ•°æ®ï¼Œä¸€ä¸ªè®¢å•ä¿¡æ¯ã€‚æ–‡æ¡£æ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸º json æ ¼å¼åå­˜å‚¨åœ¨ elasticsearch</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918212707.png!/format/webp" alt="img"></p>
<p>è€Œ JSON æ–‡æ¡£ä¸­å¾€å¾€åŒ…å«å¾ˆå¤šçš„<strong>å­—æ®µï¼ˆFieldï¼‰</strong>ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚</p>
<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101193808235.png" alt="image-20230101193808235"></p>
<h3 id="ç´¢å¼•å’Œæ˜ å°„"><a href="#ç´¢å¼•å’Œæ˜ å°„" class="headerlink" title="ç´¢å¼•å’Œæ˜ å°„"></a>ç´¢å¼•å’Œæ˜ å°„</h3><p><strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong>ï¼Œå°±æ˜¯ç›¸åŒç±»å‹çš„æ–‡æ¡£çš„é›†åˆã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>æ‰€æœ‰ç”¨æˆ·æ–‡æ¡£ï¼Œå°±å¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºç”¨æˆ·çš„ç´¢å¼•ï¼›</li>
<li>æ‰€æœ‰å•†å“çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºå•†å“çš„ç´¢å¼•ï¼›</li>
<li>æ‰€æœ‰è®¢å•çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºè®¢å•çš„ç´¢å¼•ï¼›</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210918213357.png!/format/webp" alt="img"></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç´¢å¼•å½“åšæ˜¯æ•°æ®åº“ä¸­çš„è¡¨ã€‚</p>
<p>æ•°æ®åº“çš„è¡¨ä¼šæœ‰çº¦æŸä¿¡æ¯ï¼Œç”¨æ¥å®šä¹‰è¡¨çš„ç»“æ„ã€å­—æ®µçš„åç§°ã€ç±»å‹ç­‰ä¿¡æ¯ã€‚å› æ­¤ï¼Œç´¢å¼•åº“ä¸­å°±æœ‰<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong>ï¼Œæ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„å­—æ®µçº¦æŸä¿¡æ¯ï¼Œç±»ä¼¼è¡¨çš„ç»“æ„çº¦æŸã€‚</p>
<h2 id="mysql-ä¸-elasticsearch"><a href="#mysql-ä¸-elasticsearch" class="headerlink" title="mysql ä¸ elasticsearch"></a><strong>mysql ä¸ elasticsearch</strong></h2><table>
<thead>
<tr>
<th align="left"><strong>MySQL</strong></th>
<th align="left"><strong>Elasticsearch</strong></th>
<th align="left"><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Table</td>
<td align="left">Index</td>
<td align="left">ç´¢å¼•(index)ï¼Œå°±æ˜¯æ–‡æ¡£çš„é›†åˆï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨(table)</td>
</tr>
<tr>
<td align="left">Row</td>
<td align="left">Document</td>
<td align="left">æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå°±æ˜¯ä¸€æ¡æ¡çš„æ•°æ®ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ï¼Œæ–‡æ¡£éƒ½æ˜¯JSONæ ¼å¼</td>
</tr>
<tr>
<td align="left">Column</td>
<td align="left">Field</td>
<td align="left">å­—æ®µï¼ˆFieldï¼‰ï¼Œå°±æ˜¯JSONæ–‡æ¡£ä¸­çš„å­—æ®µï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„åˆ—ï¼ˆColumnï¼‰</td>
</tr>
<tr>
<td align="left">Schema</td>
<td align="left">Mapping</td>
<td align="left">Mappingï¼ˆæ˜ å°„ï¼‰æ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œä¾‹å¦‚å­—æ®µç±»å‹çº¦æŸã€‚ç±»ä¼¼æ•°æ®åº“çš„è¡¨ç»“æ„ï¼ˆSchemaï¼‰</td>
</tr>
<tr>
<td align="left">SQL</td>
<td align="left">DSL</td>
<td align="left">DSLæ˜¯elasticsearchæä¾›çš„JSONé£æ ¼çš„è¯·æ±‚è¯­å¥ï¼Œç”¨æ¥æ“ä½œelasticsearchï¼Œå®ç°CRUD</td>
</tr>
</tbody></table>
<ul>
<li>Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§</li>
<li>Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—</li>
</ul>
<p>å› æ­¤åœ¨ä¼ä¸šä¸­ï¼Œå¾€å¾€æ˜¯ä¸¤è€…ç»“åˆä½¿ç”¨ï¼š</p>
<ul>
<li>å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„å†™æ“ä½œï¼Œä½¿ç”¨ MySQL å®ç°</li>
<li>å¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æœç´¢éœ€æ±‚ï¼Œä½¿ç”¨ ELasticsearch å®ç°</li>
<li>ä¸¤è€…å†åŸºäºæŸç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210918213631.png!/format/webp" alt="img"></p>
<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101194751518.png" alt="image-20230101194751518"></p>
<h2 id="å®‰è£…-Elasticsearch"><a href="#å®‰è£…-Elasticsearch" class="headerlink" title="å®‰è£… Elasticsearch"></a>å®‰è£… Elasticsearch</h2><p>å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½² kibana å®¹å™¨ï¼Œéœ€è¦è®© es å’Œ kibana å®¹å™¨äº’è”ã€‚è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š</p>
<p><code>docker network create es-net</code></p>
<p>å®‰è£…</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker run -d \
--name es \
-e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
-e "discovery.type=single-node" \
-v es-data:/usr/share/elasticsearch/data \   æ•°æ®æŒ‚è½½
-v es-plugins:/usr/share/elasticsearch/plugins \
--privileged \
--network es-net \
-p 9200:9200 \  ç«¯å£æ˜ å°„
-p 9300:9300 \
elasticsearch:7.12.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘½ä»¤è§£é‡Šï¼š</p>
<ul>
<li><code>-e "cluster.name=es-docker-cluster"</code>ï¼šè®¾ç½®é›†ç¾¤åç§°</li>
<li><code>-e "http.host=0.0.0.0"</code>ï¼šç›‘å¬çš„åœ°å€ï¼Œå¯ä»¥å¤–ç½‘è®¿é—®</li>
<li><code>-e "ES_JAVA_OPTS=-Xms512m -Xmx512m"</code>ï¼šå†…å­˜å¤§å°</li>
<li><code>-e "discovery.type=single-node"</code>ï¼šéé›†ç¾¤æ¨¡å¼</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ•°æ®ç›®å½•</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ—¥å¿—ç›®å½•</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ’ä»¶ç›®å½•</li>
<li><code>--privileged</code>ï¼šæˆäºˆé€»è¾‘å·è®¿é—®æƒ</li>
<li><code>--network es-net</code> ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­</li>
<li><code>-p 9200:9200</code>ï¼šç«¯å£æ˜ å°„é…ç½®</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:9200/">http://192.168.211.128:9200</a> å³å¯çœ‹åˆ° elasticsearch çš„å“åº”ç»“æœ<img src="https://cdn.xn2001.com/img/2021/20210918214620.png!/format/webp" alt="img"></p>
<h2 id="å®‰è£…-Kibana"><a href="#å®‰è£…-Kibana" class="headerlink" title="å®‰è£… Kibana"></a>å®‰è£… Kibana</h2><p>kibana å¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª elasticsearch çš„å¯è§†åŒ–ç•Œé¢ï¼Œä¾¿äºæˆ‘ä»¬å­¦ä¹ å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">docker run <span class="token operator">-</span>d \
<span class="token operator">--</span>name kibana \
<span class="token operator">-</span>e ELASTICSEARCH_HOSTS<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>es<span class="token operator">:</span><span class="token number">9200</span> \
<span class="token operator">--</span>network<span class="token operator">=</span>es<span class="token operator">-</span>net \
<span class="token operator">-</span>p <span class="token number">5601</span><span class="token operator">:</span><span class="token number">5601</span>  \
kibana<span class="token operator">:</span><span class="token number">7.12</span><span class="token number">.1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>--network es-net</code> ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­ï¼Œä¸ elasticsearch åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200"</code>ï¼šè®¾ç½® elasticsearch çš„åœ°å€ï¼Œå› ä¸º kibana å·²ç»ä¸ elasticsearch åœ¨ä¸€ä¸ªç½‘ç»œï¼Œå› æ­¤å¯ä»¥ç”¨å®¹å™¨åç›´æ¥è®¿é—® elasticsearch</li>
<li><code>-p 5601:5601</code>ï¼šç«¯å£æ˜ å°„é…ç½®</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:5601/">http://192.168.211.128:5601</a>ï¼Œå³å¯çœ‹åˆ°ç»“æœ</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918214722.png!/format/webp" alt="img"></p>
<p>æ§åˆ¶é¢æ¿ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:5601/app/dev_tools#/console">http://192.168.211.128:5601/app/dev_tools#/console</a></p>
<h2 id="å®‰è£…-IK-åˆ†è¯å™¨"><a href="#å®‰è£…-IK-åˆ†è¯å™¨" class="headerlink" title="å®‰è£… IK åˆ†è¯å™¨"></a>å®‰è£… IK åˆ†è¯å™¨</h2><p>ç”±äºå›½å†…è®¿é—® GitHub è¾ƒæ…¢ï¼Œæˆ‘ä»¬é€‰æ‹©ç¦»çº¿æ¨¡å¼å®‰è£…ã€‚</p>
<p>å®‰è£…æ’ä»¶éœ€è¦çŸ¥é“ elasticsearch çš„ plugins ç›®å½•ä½ç½®ï¼Œè€Œæˆ‘ä»¬ç”¨äº†æ•°æ®å·æŒ‚è½½ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹ elasticsearch çš„æ•°æ®å·ç›®å½•ï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker volume inspect es-plugins<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ˜¾ç¤ºç»“æœï¼š</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[
    {
        "CreatedAt": "2022-05-06T10:06:34+08:00",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/es-plugins/_data",
        "Name": "es-plugins",
        "Options": null,
        "Scope": "local"
    }
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯´æ˜ plugins ç›®å½•è¢«æŒ‚è½½åˆ°äº† <code>/var/lib/docker/volumes/es-plugins/_data </code>è¿™ä¸ªç›®å½•ä¸­</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918215615.png!/format/webp" alt="img"></p>
<p>é‡å¯å®¹å™¨</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 4ã€é‡å¯å®¹å™¨
docker restart es

# æŸ¥çœ‹esæ—¥å¿—
docker logs -f es<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li><code>ik_smart</code>ï¼šæ™ºèƒ½åˆ‡åˆ†ï¼Œç²—ç²’åº¦</li>
<li><code>ik_max_word</code>ï¼šæœ€ç»†åˆ‡åˆ†ï¼Œç»†ç²’åº¦</li>
</ul>
<p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„ Kibana æ§åˆ¶å°æµ‹è¯•</p>
<pre class="line-numbers language-none"><code class="language-none">GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="æ‰©å±•è¯è¯å…¸"><a href="#æ‰©å±•è¯è¯å…¸" class="headerlink" title="æ‰©å±•è¯è¯å…¸"></a>æ‰©å±•è¯è¯å…¸</h3><p>åœ¨ä¸Šé¢çš„IKåˆ†è¯å™¨æˆ‘ä»¬å¯ä»¥éšç€çƒ­ç‚¹è¯æ¥æ‰©å±•ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ ï¼Œæ¯”å¦‚ â€é’Ÿè€å¸ˆåº”è¯¥æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¯â€œï¼Œå¦å¤–ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸€äº›åœç”¨æ‰çš„æ•æ„Ÿè¯ï¼Œè®©å…¶ä¸è¿›è¡Œåˆ†è¯ã€‚</p>
<p>æ‰“å¼€IKåˆ†è¯å™¨ config ç›®å½•æ˜¯ <code>IKAnalyzer.cfg.xml</code>ï¼Œæ·»åŠ ä¸€ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬ä»¥ <code>ext.dic</code> æ–‡ä»¶åä¸ºä¾‹ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918221159.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬å»åˆ›å»º <code>ext.dic</code> ï¼Œåœ¨å…¶ä¸­æ·»åŠ çƒ­ç‚¹è¯å°±å¥½äº†ï¼Œä¸€ä¸ªè¯ä¸€è¡Œã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210918220910.png!/format/webp" alt="img"></p>
<p>é‡å¯ elasticsearch</p>
<pre class="line-numbers language-none"><code class="language-none">docker restart es<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é‡æ–°æµ‹è¯•</p>
<pre class="line-numbers language-none"><code class="language-none">GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "é’Ÿè€å¸ˆä½ å¥½èœå•Š"
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210918221424.png!/format/webp" alt="img"></p>
<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101202533941.png" alt="image-20230101202533941"></p>
<h2 id="ç´¢å¼•åº“æ“ä½œ"><a href="#ç´¢å¼•åº“æ“ä½œ" class="headerlink" title="ç´¢å¼•åº“æ“ä½œ"></a>ç´¢å¼•åº“æ“ä½œ</h2><h3 id="Mappingå±æ€§æ˜ å°„"><a href="#Mappingå±æ€§æ˜ å°„" class="headerlink" title="Mappingå±æ€§æ˜ å°„"></a>Mappingå±æ€§æ˜ å°„</h3><p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101210720944.png" alt="image-20230101210720944"></p>
<p>ç´¢å¼•åº“å°±ç±»ä¼¼æ•°æ®åº“è¡¨ï¼Œ<strong>mapping æ˜ å°„å°±ç±»ä¼¼è¡¨çš„ç»“æ„</strong></p>
<p>æˆ‘ä»¬è¦å‘ es ä¸­å­˜å‚¨æ•°æ®ï¼Œå¿…é¡»å…ˆåˆ›å»ºâ€œåº“â€å’Œâ€œè¡¨â€</p>
<p>mapping æ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„ mapping å±æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li>typeï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š<ul>
<li>å­—ç¬¦ä¸²ï¼štextï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€keywordï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰</li>
<li>æ•°å€¼ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€</li>
<li>å¸ƒå°”ï¼šboolean</li>
<li>æ—¥æœŸï¼šdate</li>
<li>å¯¹è±¡ï¼šobject</li>
</ul>
</li>
<li><strong>indexï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸º true</strong></li>
<li>analyzerï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨</li>
<li>propertiesï¼šè¯¥å­—æ®µçš„å­å­—æ®µ</li>
</ul>
<p>æˆ‘ä»¬ä»¥éœ€è¦å­˜å‚¨ä¸‹é¢çš„ JSON ä¸ºä¾‹æ¥è®²è§£</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"age"</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
    <span class="token property">"weight"</span><span class="token operator">:</span> <span class="token number">52.1</span><span class="token punctuation">,</span>
    <span class="token property">"isMarried"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"é’Ÿè€å¸ˆçœŸèœ"</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"jialna@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">99.1</span><span class="token punctuation">,</span> <span class="token number">99.5</span><span class="token punctuation">,</span> <span class="token number">98.9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"æ¹–"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"å¿ƒ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆå¯¹åº”çš„æ¯ä¸ªå­—æ®µæ˜ å°„ï¼ˆmappingï¼‰æƒ…å†µå¦‚ä¸‹ï¼š</p>
<ul>
<li>ageï¼šç±»å‹ä¸º integerï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>weightï¼šç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>isMarriedï¼šç±»å‹ä¸ºbooleanï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>infoï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ textï¼›å‚ä¸æœç´¢ï¼Œindexä¸ºtrueï¼›åˆ†è¯å™¨å¯ä»¥ç”¨ ik_smart</li>
<li>emailï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸éœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ keywordï¼›ä¸å‚ä¸æœç´¢ï¼Œindex ä¸º falseï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>scoreï¼šè™½ç„¶æ˜¯æ•°ç»„ï¼Œ<strong>ä½†æ˜¯æˆ‘ä»¬åªçœ‹å…ƒç´ çš„ç±»å‹</strong>ï¼Œç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>nameï¼šç±»å‹ä¸º objectï¼Œéœ€è¦å®šä¹‰å¤šä¸ªå­å±æ€§<ul>
<li>name.firstNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>name.lastNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
</ul>
</li>
</ul>
<h3 id="åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„"><a href="#åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„" class="headerlink" title="åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„"></a>åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„</h3><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº† Mapping å±æ€§æ˜ å°„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»çœ‹çœ‹å¦‚ä½•åˆ›å»ºç´¢å¼•åº“åŠæ˜ å°„ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /ç´¢å¼•åº“åç§°
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"å­—æ®µå"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"å­—æ®µå2"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"å­—æ®µå3"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"å­å­—æ®µ"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...ç•¥</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /xn2001
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"info"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"email"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20210918224647.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬ç”¨çœŸå®çš„æ•°æ®åº“è¡¨æ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•åº“</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210919164626.png!/format/webp" alt="img"></p>
<ul>
<li>å­—æ®µåã€å­—æ®µæ•°æ®ç±»å‹ï¼Œå¯ä»¥å‚è€ƒæ•°æ®è¡¨ç»“æ„çš„åç§°å’Œç±»å‹</li>
<li>æ˜¯å¦å‚ä¸æœç´¢è¦åˆ†æä¸šåŠ¡æ¥åˆ¤æ–­ï¼Œä¾‹å¦‚å›¾ç‰‡åœ°å€ï¼Œå°±æ— éœ€å‚ä¸æœç´¢</li>
<li>æ˜¯å¦åˆ†è¯å‘¢è¦çœ‹å†…å®¹ï¼Œå†…å®¹å¦‚æœæ˜¯ä¸€ä¸ªæ•´ä½“å°±æ— éœ€åˆ†è¯</li>
<li>åˆ†è¯å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿä¸€ä½¿ç”¨ <code>ik_max_word</code></li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /hotel
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç‰¹æ®Šå­—æ®µè¯´æ˜ï¼š</p>
<ul>
<li>locationï¼šåœ°ç†åæ ‡ï¼Œé‡Œé¢åŒ…å«ç²¾åº¦ã€çº¬åº¦</li>
<li>allï¼šä¸€ä¸ªç»„åˆå­—æ®µï¼Œå…¶ç›®çš„æ˜¯å°†å¤šå­—æ®µçš„å€¼åˆ©ç”¨ <code>copy_to</code> åˆå¹¶ï¼Œæä¾›ç»™ç”¨æˆ·æœç´¢ï¼Œè¿™æ ·ä¸€æ¥å°±åªéœ€è¦æœç´¢ä¸€ä¸ªå­—æ®µå°±å¯ä»¥å¾—åˆ°ç»“æœï¼Œæ€§èƒ½æ›´å¥½ã€‚</li>
</ul>
<blockquote>
<p>ESä¸­æ”¯æŒä¸¤ç§åœ°ç†åæ ‡æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li>geo_pointï¼šç”±çº¬åº¦ï¼ˆlatitudeï¼‰å’Œç»åº¦ï¼ˆlongitudeï¼‰ç¡®å®šçš„ä¸€ä¸ªç‚¹ã€‚ä¾‹å¦‚ï¼šâ€32.8752345, 120.2981576â€</li>
<li>geo_shapeï¼šæœ‰å¤šä¸ª geo_point ç»„æˆçš„å¤æ‚å‡ ä½•å›¾å½¢ã€‚ä¾‹å¦‚ä¸€æ¡ç›´çº¿ï¼Œâ€LINESTRING (-77.03653 38.897676, -77.009051 38.889939)â€</li>
</ul>
</blockquote>
<h3 id="ä¿®æ”¹ç´¢å¼•åº“"><a href="#ä¿®æ”¹ç´¢å¼•åº“" class="headerlink" title="ä¿®æ”¹ç´¢å¼•åº“"></a>ä¿®æ”¹ç´¢å¼•åº“</h3><p>å€’æ’ç´¢å¼•ç»“æ„è™½ç„¶ä¸å¤æ‚ï¼Œä½†æ˜¯ä¸€æ—¦æ•°æ®ç»“æ„æ”¹å˜ï¼ˆæ¯”å¦‚æ”¹å˜äº†åˆ†è¯å™¨ï¼‰ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œè¿™ç®€ç›´æ˜¯ç¾éš¾ã€‚å› æ­¤ç´¢å¼•åº“<strong>ä¸€æ—¦åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹ mapping</strong></p>
<p>è™½ç„¶æ— æ³•ä¿®æ”¹ mapping ä¸­å·²æœ‰çš„å­—æ®µï¼Œä½†æ˜¯å´å…è®¸æ·»åŠ æ–°çš„å­—æ®µåˆ° mapping ä¸­ï¼Œä¸ä¼šå¯¹å€’æ’ç´¢å¼•äº§ç”Ÿå½±å“ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /ç´¢å¼•åº“å/_mapping
<span class="token punctuation">{</span>
  <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"æ–°å­—æ®µå"</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ é™¤ç´¢å¼•åº“"><a href="#åˆ é™¤ç´¢å¼•åº“" class="headerlink" title="åˆ é™¤ç´¢å¼•åº“"></a>åˆ é™¤ç´¢å¼•åº“</h3><pre class="line-numbers language-none"><code class="language-none">DELETE /ç´¢å¼•åº“å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="æŸ¥è¯¢ç´¢å¼•åº“"><a href="#æŸ¥è¯¢ç´¢å¼•åº“" class="headerlink" title="æŸ¥è¯¢ç´¢å¼•åº“"></a>æŸ¥è¯¢ç´¢å¼•åº“</h3><pre class="line-numbers language-none"><code class="language-none">GET /æ•°æ®åº“å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101212442406.png" alt="image-20230101212442406"></p>
<h2 id="DSLæ–‡æ¡£æ“ä½œ"><a href="#DSLæ–‡æ¡£æ“ä½œ" class="headerlink" title="DSLæ–‡æ¡£æ“ä½œ"></a><strong>DSLæ–‡æ¡£æ“ä½œ</strong></h2><p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101214343109.png"></p>
<h3 id="æ–°å¢æ–‡æ¡£"><a href="#æ–°å¢æ–‡æ¡£" class="headerlink" title="æ–°å¢æ–‡æ¡£"></a>æ–°å¢æ–‡æ¡£</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /ç´¢å¼•åº“å/_doc/æ–‡æ¡£id
<span class="token punctuation">{</span>
    <span class="token property">"å­—æ®µ1"</span><span class="token operator">:</span> <span class="token string">"å€¼1"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ2"</span><span class="token operator">:</span> <span class="token string">"å€¼2"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ3"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"å­å±æ€§1"</span><span class="token operator">:</span> <span class="token string">"å€¼3"</span><span class="token punctuation">,</span>
        <span class="token property">"å­å±æ€§2"</span><span class="token operator">:</span> <span class="token string">"å€¼4"</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /xn2001/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"æˆ‘ä¸ä¼šJava"</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"jialna@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"é’Ÿ"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"å¼Ÿå¼Ÿ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ä¿®æ”¹æ–‡æ¡£"><a href="#ä¿®æ”¹æ–‡æ¡£" class="headerlink" title="ä¿®æ”¹æ–‡æ¡£"></a>ä¿®æ”¹æ–‡æ¡£</h3><p>ä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£</li>
<li>å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</li>
</ul>
<p><strong>å…¨é‡ä¿®æ”¹</strong>æ˜¯è¦†ç›–åŸæ¥çš„æ–‡æ¡£ï¼Œå…¶æœ¬è´¨æ˜¯ï¼š</p>
<ul>
<li>æ ¹æ®æŒ‡å®šçš„ id åˆ é™¤æ–‡æ¡£</li>
<li>æ–°å¢ä¸€ä¸ªç›¸åŒ id çš„æ–‡æ¡£</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ ¹æ® id åˆ é™¤æ—¶ï¼Œid ä¸å­˜åœ¨ï¼Œç¬¬äºŒæ­¥çš„æ–°å¢ä¹Ÿä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å˜æˆäº†æ–°å¢æ“ä½œ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /<span class="token punctuation">{</span>ç´¢å¼•åº“å<span class="token punctuation">}</span>/_doc/id
<span class="token punctuation">{</span>
    <span class="token property">"å­—æ®µ1"</span><span class="token operator">:</span> <span class="token string">"å€¼1"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ2"</span><span class="token operator">:</span> <span class="token string">"å€¼2"</span><span class="token punctuation">,</span>
    <span class="token comment">// ... ç•¥</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /xn2001/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"æˆ‘ä¹Ÿä¸ä¼šæ•²ä»£ç "</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"3300123589@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"å¼Ÿå¼Ÿ"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"é’Ÿ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>å¢é‡ä¿®æ”¹</strong>æ˜¯åªä¿®æ”¹æŒ‡å®š id åŒ¹é…çš„æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /<span class="token punctuation">{</span>ç´¢å¼•åº“å<span class="token punctuation">}</span>/_update/æ–‡æ¡£id
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">"å­—æ®µå"</span><span class="token operator">:</span> <span class="token string">"æ–°çš„å€¼"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /heima/_update/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"update@qq.com"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h1 id="åˆ†å‰²çº¿"><a href="#åˆ†å‰²çº¿" class="headerlink" title="åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h1><blockquote>
<p>ä¸çŸ¥é“å‡ºç°ä»€ä¹ˆé—®é¢˜äº†ï¼Œæ–‡æ¡£å‡ºç°äº†å¾ˆå¤šé‡å¤å†…å®¹</p>
</blockquote>
<hr>
<h1 id="å¾®æœåŠ¡æŠ€æœ¯æ ˆ-1"><a href="#å¾®æœåŠ¡æŠ€æœ¯æ ˆ-1" class="headerlink" title="å¾®æœåŠ¡æŠ€æœ¯æ ˆ"></a>å¾®æœåŠ¡æŠ€æœ¯æ ˆ</h1><ul>
<li><p>åšä¸»ï¼š <a target="_blank" rel="noopener" href="https://www.xn2001.com/author/1/">é’Ÿå°æ¹–</a></p>
</li>
<li></li>
<li><p>å‘å¸ƒæ—¶é—´ï¼š2021 å¹´ 09 æœˆ 01 æ—¥</p>
</li>
<li></li>
<li><p>54384 æ¬¡æµè§ˆ</p>
</li>
<li></li>
<li><p><a target="_blank" rel="noopener" href="https://www.xn2001.com/archives/663.html#comments">66 æ¡è¯„è®º</a></p>
</li>
<li></li>
<li><p>109035å­—æ•°</p>
</li>
<li></li>
<li><p>åˆ†ç±»ï¼š <a target="_blank" rel="noopener" href="https://www.xn2001.com/category/my-code/">ç¼–ç¨‹æ‚è®°</a> <a target="_blank" rel="noopener" href="https://www.xn2001.com/category/Java/">Java</a></p>
</li>
</ul>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.xn2001.com/">é¦–é¡µ</a></li>
<li>æ­£æ–‡ </li>
</ol>
<p>è¯·æ³¨æ„ï¼Œæœ¬æ–‡ç¼–å†™äº 487 å¤©å‰ï¼Œæœ€åä¿®æ”¹äº 93 å¤©å‰ï¼Œå…¶ä¸­æŸäº›ä¿¡æ¯å¯èƒ½å·²ç»è¿‡æ—¶ã€‚</p>
<p>ğŸ˜€ æˆ‘åˆå·å·å­¦ä¹ å¹¶æ›´æ–°äº† 2022.09.30 2:55</p>
<p>ğŸ“‡ å³ä¾§å¯ä»¥æ‰“å¼€ç›®å½•å™¢ã€‚</p>
<p>ğŸ“ºï¸ æ„Ÿè°¢bilibiliå¤§å­¦å’Œé»‘é©¬ç¨‹åºå‘˜çš„æ— å¿åˆ†äº«ï¼š<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1LQ4y127n4">https://www.bilibili.com/video/BV1LQ4y127n4</a></p>
<p>ğŸ¤¤åŸºç¡€ç¯‡</p>
<ul>
<li>è®¤è¯†å¾®æœåŠ¡</li>
<li>æœåŠ¡æ‹†åˆ†</li>
<li>è¿œç¨‹è°ƒç”¨</li>
<li>Eureka</li>
<li>Ribbon</li>
<li>Nacos</li>
<li>Feign</li>
<li>Gateway</li>
<li>RabbitMQ</li>
<li>Elasticsearch</li>
</ul>
<p>ğŸ’»é«˜çº§ç¯‡</p>
<ul>
<li>JMeter</li>
<li>Sentinel</li>
<li>Seata</li>
<li>Redis</li>
<li>ã€‚ã€‚ã€‚</li>
</ul>
<h1 id="è®¤è¯†å¾®æœåŠ¡-1"><a href="#è®¤è¯†å¾®æœåŠ¡-1" class="headerlink" title="è®¤è¯†å¾®æœåŠ¡"></a>è®¤è¯†å¾®æœåŠ¡</h1><h2 id="å•ä½“æ¶æ„-1"><a href="#å•ä½“æ¶æ„-1" class="headerlink" title="å•ä½“æ¶æ„"></a>å•ä½“æ¶æ„</h2><p><strong>å•ä½“æ¶æ„</strong>ï¼šå°†ä¸šåŠ¡çš„æ‰€æœ‰åŠŸèƒ½é›†ä¸­åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘ï¼Œæ‰“æˆä¸€ä¸ªåŒ…éƒ¨ç½²ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901083809.png"><img src="https://cdn.xn2001.com/img/2021/20210901083809.png!/format/webp" alt="img"></a></p>
<p><strong>ä¼˜ç‚¹</strong>ï¼šæ¶æ„ç®€å•ï¼Œéƒ¨ç½²æˆæœ¬ä½</p>
<p><strong>ç¼ºç‚¹</strong>ï¼šè€¦åˆåº¦é«˜ï¼ˆç»´æŠ¤å›°éš¾ã€å‡çº§å›°éš¾ï¼‰</p>
<h2 id="åˆ†å¸ƒå¼æ¶æ„-1"><a href="#åˆ†å¸ƒå¼æ¶æ„-1" class="headerlink" title="åˆ†å¸ƒå¼æ¶æ„"></a>åˆ†å¸ƒå¼æ¶æ„</h2><p><strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼šæ ¹æ®ä¸šåŠ¡åŠŸèƒ½å¯¹ç³»ç»Ÿåšæ‹†åˆ†ï¼Œæ¯ä¸ªä¸šåŠ¡åŠŸèƒ½æ¨¡å—ä½œä¸ºç‹¬ç«‹é¡¹ç›®å¼€å‘ï¼Œç§°ä¸ºä¸€ä¸ªæœåŠ¡ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092921.png"><img src="https://cdn.xn2001.com/img/2021/20210901092921.png!/format/webp" alt="img"></a></p>
<p><strong>ä¼˜ç‚¹</strong>ï¼šé™ä½æœåŠ¡è€¦åˆï¼Œæœ‰åˆ©äºæœåŠ¡å‡çº§å’Œæ‹“å±•</p>
<p><strong>ç¼ºç‚¹</strong>ï¼šæœåŠ¡è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚</p>
<p>åˆ†å¸ƒå¼æ¶æ„è™½ç„¶é™ä½äº†æœåŠ¡è€¦åˆï¼Œä½†æ˜¯æœåŠ¡æ‹†åˆ†æ—¶ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜éœ€è¦æ€è€ƒï¼š</p>
<ul>
<li>æœåŠ¡æ‹†åˆ†çš„ç²’åº¦å¦‚ä½•ç•Œå®šï¼Ÿ</li>
<li>æœåŠ¡ä¹‹é—´å¦‚ä½•è°ƒç”¨ï¼Ÿ</li>
<li>æœåŠ¡çš„è°ƒç”¨å…³ç³»å¦‚ä½•ç®¡ç†ï¼Ÿ</li>
</ul>
<p><strong>äººä»¬éœ€è¦åˆ¶å®šä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ ‡å‡†æ¥çº¦æŸåˆ†å¸ƒå¼æ¶æ„ã€‚</strong></p>
<h2 id="å¾®æœåŠ¡-1"><a href="#å¾®æœåŠ¡-1" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h2><p>å¾®æœåŠ¡çš„æ¶æ„ç‰¹å¾ï¼š</p>
<ul>
<li>å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡æ‹†åˆ†ç²’åº¦æ›´å°ï¼Œæ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£</li>
<li>è‡ªæ²»ï¼šå›¢é˜Ÿç‹¬ç«‹ã€æŠ€æœ¯ç‹¬ç«‹ã€æ•°æ®ç‹¬ç«‹ï¼Œç‹¬ç«‹éƒ¨ç½²å’Œäº¤ä»˜</li>
<li>é¢å‘æœåŠ¡ï¼šæœåŠ¡æä¾›ç»Ÿä¸€æ ‡å‡†çš„æ¥å£ï¼Œä¸è¯­è¨€å’ŒæŠ€æœ¯æ— å…³</li>
<li>éš”ç¦»æ€§å¼ºï¼šæœåŠ¡è°ƒç”¨åšå¥½éš”ç¦»ã€å®¹é”™ã€é™çº§ï¼Œé¿å…å‡ºç°çº§è”é—®é¢˜</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2022/202205162352847.png"><img src="https://cdn.xn2001.com/img/2022/202205162352847.png!/format/webp" alt="img"></a></p>
<p>å¾®æœåŠ¡çš„ä¸Šè¿°ç‰¹æ€§<strong>å…¶å®æ˜¯åœ¨ç»™åˆ†å¸ƒå¼æ¶æ„åˆ¶å®šä¸€ä¸ªæ ‡å‡†</strong>ï¼Œè¿›ä¸€æ­¥é™ä½æœåŠ¡ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæä¾›æœåŠ¡çš„ç‹¬ç«‹æ€§å’Œçµæ´»æ€§ã€‚åšåˆ°é«˜å†…èšï¼Œä½è€¦åˆã€‚</p>
<p><strong>å› æ­¤ï¼Œå¯ä»¥è®¤ä¸ºå¾®æœåŠ¡æ˜¯ä¸€ç§ç»è¿‡è‰¯å¥½æ¶æ„è®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„æ–¹æ¡ˆ ã€‚</strong></p>
<p>å…¶ä¸­åœ¨ Java é¢†åŸŸæœ€å¼•äººæ³¨ç›®çš„å°±æ˜¯ SpringCloud æä¾›çš„æ–¹æ¡ˆäº†ã€‚</p>
<h2 id="SpringCloud-1"><a href="#SpringCloud-1" class="headerlink" title="SpringCloud"></a>SpringCloud</h2><p>SpringCloud æ˜¯ç›®å‰å›½å†…ä½¿ç”¨æœ€å¹¿æ³›çš„å¾®æœåŠ¡æ¡†æ¶ã€‚å®˜ç½‘åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud%E3%80%82">https://spring.io/projects/spring-cloudã€‚</a></p>
<p>SpringCloud é›†æˆäº†å„ç§å¾®æœåŠ¡åŠŸèƒ½ç»„ä»¶ï¼Œå¹¶åŸºäº SpringBoot å®ç°äº†è¿™äº›ç»„ä»¶çš„è‡ªåŠ¨è£…é…ï¼Œä»è€Œæä¾›äº†è‰¯å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚</p>
<p>å…¶ä¸­å¸¸è§çš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901083717.png"><img src="https://cdn.xn2001.com/img/2021/20210901083717.png!/format/webp" alt="img"></a></p>
<p>å¦å¤–ï¼ŒSpringCloud åº•å±‚æ˜¯ä¾èµ–äº SpringBoot çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬çš„å…¼å®¹å…³ç³»ï¼Œå¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901084050.png"><img src="https://cdn.xn2001.com/img/2021/20210901084050.png!/format/webp" alt="img"></a></p>
<h2 id="å†…å®¹çŸ¥è¯†-1"><a href="#å†…å®¹çŸ¥è¯†-1" class="headerlink" title="å†…å®¹çŸ¥è¯†"></a>å†…å®¹çŸ¥è¯†</h2><p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092925.png"><img src="https://cdn.xn2001.com/img/2021/20210901092925.png!/format/webp" alt="éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092925.png">éœ€è¦å­¦ä¹ çš„å¾®æœåŠ¡çŸ¥è¯†å†…å®¹</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901084131.png"><img src="https://cdn.xn2001.com/img/2021/20210901084131.png!/format/webp" alt="æŠ€æœ¯æ ˆ"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901084131.png">æŠ€æœ¯æ ˆ</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090737.png"><img src="https://cdn.xn2001.com/img/2021/20210901090737.png!/format/webp" alt="è‡ªåŠ¨åŒ–éƒ¨ç½²"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090737.png">è‡ªåŠ¨åŒ–éƒ¨ç½²</a></p>
<h2 id="æŠ€æœ¯æ ˆå¯¹æ¯”-1"><a href="#æŠ€æœ¯æ ˆå¯¹æ¯”-1" class="headerlink" title="æŠ€æœ¯æ ˆå¯¹æ¯”"></a>æŠ€æœ¯æ ˆå¯¹æ¯”</h2><p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090726.png"><img src="https://cdn.xn2001.com/img/2021/20210901090726.png!/format/webp" alt="img"></a></p>
<h1 id="æœåŠ¡æ‹†åˆ†-1"><a href="#æœåŠ¡æ‹†åˆ†-1" class="headerlink" title="æœåŠ¡æ‹†åˆ†"></a>æœåŠ¡æ‹†åˆ†</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo">https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo">https://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo</a></p>
</blockquote>
<p><strong>æœåŠ¡æ‹†åˆ†æ³¨æ„äº‹é¡¹</strong></p>
<p>å•ä¸€èŒè´£ï¼šä¸åŒå¾®æœåŠ¡ï¼Œä¸è¦é‡å¤å¼€å‘ç›¸åŒä¸šåŠ¡</p>
<p>æ•°æ®ç‹¬ç«‹ï¼šä¸è¦è®¿é—®å…¶å®ƒå¾®æœåŠ¡çš„æ•°æ®åº“</p>
<p>é¢å‘æœåŠ¡ï¼šå°†è‡ªå·±çš„ä¸šåŠ¡æš´éœ²ä¸ºæ¥å£ï¼Œä¾›å…¶å®ƒå¾®æœåŠ¡è°ƒç”¨</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090745.png"><img src="https://cdn.xn2001.com/img/2021/20210901090745.png!/format/webp" alt="img"></a></p>
<p>cloud-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†ä¾èµ–</p>
<ul>
<li>order-serviceï¼šè®¢å•å¾®æœåŠ¡ï¼Œè´Ÿè´£è®¢å•ç›¸å…³ä¸šåŠ¡</li>
<li>user-serviceï¼šç”¨æˆ·å¾®æœåŠ¡ï¼Œè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡</li>
</ul>
<p>è¦æ±‚ï¼š</p>
<ul>
<li>è®¢å•å¾®æœåŠ¡å’Œç”¨æˆ·å¾®æœåŠ¡éƒ½å¿…é¡»æœ‰<strong>å„è‡ªçš„æ•°æ®åº“</strong>ï¼Œç›¸äº’ç‹¬ç«‹</li>
<li>è®¢å•æœåŠ¡å’Œç”¨æˆ·æœåŠ¡<strong>éƒ½å¯¹å¤–æš´éœ² Restful çš„æ¥å£</strong></li>
<li>è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ<strong>åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£</strong>ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“</li>
</ul>
<p>å¾®æœåŠ¡é¡¹ç›®ä¸‹ï¼Œæ‰“å¼€ idea ä¸­çš„ Serviceï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯åŠ¨ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090750.png"><img src="https://cdn.xn2001.com/img/2021/20210901090750.png!/format/webp" alt="img"></a></p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090757.png"><img src="https://cdn.xn2001.com/img/2021/20210901090757.png!/format/webp" alt="img"></a></p>
<h1 id="è¿œç¨‹è°ƒç”¨-1"><a href="#è¿œç¨‹è°ƒç”¨-1" class="headerlink" title="è¿œç¨‹è°ƒç”¨"></a>è¿œç¨‹è°ƒç”¨</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate">https://gitee.com/xn2001/cloudcode/tree/master/02-cloud-restTemplate</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate">https://github.com/lexinhu/cloudcode/tree/master/02-cloud-restTemplate</a></p>
</blockquote>
<p>æ­£å¦‚ä¸Šé¢çš„æœåŠ¡æ‹†åˆ†è¦æ±‚ä¸­æ‰€æåˆ°ï¼Œ</p>
<blockquote>
<p>è®¢å•æœåŠ¡å¦‚æœéœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œ<strong>åªèƒ½è°ƒç”¨ç”¨æˆ·æœåŠ¡çš„ Restful æ¥å£</strong>ï¼Œä¸èƒ½æŸ¥è¯¢ç”¨æˆ·æ•°æ®åº“</p>
</blockquote>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦çŸ¥é“ Java å¦‚ä½•å»å‘é€ http è¯·æ±‚ï¼ŒSpring æä¾›äº†ä¸€ä¸ª RestTemplate å·¥å…·ï¼Œåªéœ€è¦æŠŠå®ƒåˆ›å»ºå‡ºæ¥å³å¯ã€‚ï¼ˆå³æ³¨å…¥ Beanï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090814.png"><img src="https://cdn.xn2001.com/img/2021/20210901090814.png!/format/webp" alt="img"></a></p>
<p>å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨åºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090846.png"><img src="https://cdn.xn2001.com/img/2021/20210901090846.png!/format/webp" alt="img"></a></p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090909.png"><img src="https://cdn.xn2001.com/img/2021/20210901090909.png!/format/webp" alt="img"></a></p>
<p>åœ¨ä¸Šé¢ä»£ç çš„ url ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è°ƒç”¨æœåŠ¡çš„åœ°å€é‡‡ç”¨ç¡¬ç¼–ç ï¼Œè¿™åœ¨åç»­çš„å¼€å‘ä¸­è‚¯å®šæ˜¯ä¸ç†æƒ³çš„ï¼Œè¿™å°±éœ€è¦<strong>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</strong>ï¼ˆEurekaï¼‰æ¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªäº‹æƒ…ã€‚</p>
<h1 id="Eurekaæ³¨å†Œä¸­å¿ƒ-1"><a href="#Eurekaæ³¨å†Œä¸­å¿ƒ-1" class="headerlink" title="Eurekaæ³¨å†Œä¸­å¿ƒ"></a>Eurekaæ³¨å†Œä¸­å¿ƒ</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka">https://gitee.com/xn2001/cloudcode/tree/master/03-cloud-eureka</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka">https://github.com/lexinhu/cloudcode/tree/master/03-cloud-eureka</a></p>
</blockquote>
<p>æœ€å¹¿ä¸ºäººçŸ¥çš„æ³¨å†Œä¸­å¿ƒå°±æ˜¯ Eurekaï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090919.png"><img src="https://cdn.xn2001.com/img/2021/20210901090919.png!/format/webp" alt="img"></a></p>
<p><strong>order-service å¦‚ä½•å¾—çŸ¥ user-service å®ä¾‹åœ°å€ï¼Ÿ</strong></p>
<ul>
<li>user-service æœåŠ¡å®ä¾‹å¯åŠ¨åï¼Œå°†è‡ªå·±çš„ä¿¡æ¯æ³¨å†Œåˆ° eureka-server(EurekaæœåŠ¡ç«¯)ï¼Œå«åš<strong>æœåŠ¡æ³¨å†Œ</strong></li>
<li>eureka-server ä¿å­˜æœåŠ¡åç§°åˆ°æœåŠ¡å®ä¾‹åœ°å€åˆ—è¡¨çš„æ˜ å°„å…³ç³»</li>
<li>order-service æ ¹æ®æœåŠ¡åç§°ï¼Œæ‹‰å–å®ä¾‹åœ°å€åˆ—è¡¨ï¼Œè¿™ä¸ªå«<strong>æœåŠ¡å‘ç°</strong>æˆ–æœåŠ¡æ‹‰å–</li>
</ul>
<p><strong>order-service å¦‚ä½•ä»å¤šä¸ª user-service å®ä¾‹ä¸­é€‰æ‹©å…·ä½“çš„å®ä¾‹ï¼Ÿ</strong></p>
<p>order-serviceä»å®ä¾‹åˆ—è¡¨ä¸­åˆ©ç”¨<strong>è´Ÿè½½å‡è¡¡ç®—æ³•</strong>é€‰ä¸­ä¸€ä¸ªå®ä¾‹åœ°å€ï¼Œå‘è¯¥å®ä¾‹åœ°å€å‘èµ·è¿œç¨‹è°ƒç”¨</p>
<p><strong>order-service å¦‚ä½•å¾—çŸ¥æŸä¸ª user-service å®ä¾‹æ˜¯å¦ä¾ç„¶å¥åº·ï¼Œæ˜¯ä¸æ˜¯å·²ç»å®•æœºï¼Ÿ</strong></p>
<ul>
<li>user-service ä¼š<strong>æ¯éš”ä¸€æ®µæ—¶é—´(é»˜è®¤30ç§’)å‘ eureka-server å‘èµ·è¯·æ±‚</strong>ï¼ŒæŠ¥å‘Šè‡ªå·±çŠ¶æ€ï¼Œç§°ä¸º<strong>å¿ƒè·³</strong></li>
<li>å½“è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å‘é€å¿ƒè·³æ—¶ï¼Œeureka-server ä¼šè®¤ä¸ºå¾®æœåŠ¡å®ä¾‹æ•…éšœï¼Œå°†è¯¥å®ä¾‹ä»æœåŠ¡åˆ—è¡¨ä¸­å‰”é™¤</li>
<li>order-service æ‹‰å–æœåŠ¡æ—¶ï¼Œå°±èƒ½å°†æ•…éšœå®ä¾‹æ’é™¤äº†</li>
</ul>
<hr>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åŠ¨æ‰‹å®è·µçš„æ­¥éª¤åŒ…æ‹¬</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090932.png"><img src="https://cdn.xn2001.com/img/2021/20210901090932.png!/format/webp" alt="img"></a></p>
<h2 id="æ­å»ºæ³¨å†Œä¸­å¿ƒ-1"><a href="#æ­å»ºæ³¨å†Œä¸­å¿ƒ-1" class="headerlink" title="æ­å»ºæ³¨å†Œä¸­å¿ƒ"></a>æ­å»ºæ³¨å†Œä¸­å¿ƒ</h2><p><strong>æ­å»º eureka-server</strong></p>
<p>å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ <strong>server</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ç¼–å†™å¯åŠ¨ç±»</strong></p>
<p>æ³¨æ„è¦æ·»åŠ ä¸€ä¸ª <code>@EnableEurekaServer</code> <strong>æ³¨è§£</strong>ï¼Œå¼€å¯ eureka çš„<strong>æ³¨å†Œä¸­å¿ƒ</strong>åŠŸèƒ½</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>eureka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ç¼–å†™é…ç½®æ–‡ä»¶</strong></p>
<p>ç¼–å†™ä¸€ä¸ª application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…¶ä¸­ <code>default-zone</code> æ˜¯å› ä¸ºå‰é¢é…ç½®ç±»å¼€å¯äº†æ³¨å†Œä¸­å¿ƒæ‰€éœ€è¦é…ç½®çš„ eureka çš„<strong>åœ°å€ä¿¡æ¯</strong>ï¼Œå› ä¸º eureka æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¿™é‡Œä¹Ÿè¦å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œå½“åé¢ eureka <strong>é›†ç¾¤</strong>æ—¶ï¼Œè¿™é‡Œå°±å¯ä»¥å¡«å†™å¤šä¸ªï¼Œä½¿ç”¨ â€œ,â€ éš”å¼€ã€‚</p>
<p>å¯åŠ¨å®Œæˆåï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090945.png"><img src="https://cdn.xn2001.com/img/2021/20210901090945.png!/format/webp" alt="img"></a></p>
<h2 id="æœåŠ¡æ³¨å†Œ-2"><a href="#æœåŠ¡æ³¨å†Œ-2" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><blockquote>
<p>å°† user-serviceã€order-service éƒ½æ³¨å†Œåˆ° eureka</p>
</blockquote>
<p>å¼•å…¥ SpringCloud ä¸º eureka æä¾›çš„ starter ä¾èµ–ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç”¨ <strong>client</strong></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼š<code>@EnableEurekaClient</code></p>
<p>åœ¨ application.yml æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„é…ç½®ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
      <span class="token comment">#nameï¼šorderservice</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> 
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>127.0.0.1<span class="token punctuation">:</span>10086/eureka<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901090958.png"><img src="https://cdn.xn2001.com/img/2021/20210901090958.png!/format/webp" alt="img"></a></p>
<p>è¿™é‡Œå¦å¤–å†è¡¥å……ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ idea çš„å¤šå®ä¾‹å¯åŠ¨ï¼Œæ¥æŸ¥çœ‹ Eureka çš„é›†ç¾¤æ•ˆæœã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091005.png"><img src="https://cdn.xn2001.com/img/2021/20210901091005.png!/format/webp" alt="img"></a></p>
<p>4ä¸ªé¡¹ç›®å¯åŠ¨åï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10086/">http://localhost:10086/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091015.png"><img src="https://cdn.xn2001.com/img/2021/20210901091015.png!/format/webp" alt="img"></a></p>
<h2 id="æœåŠ¡æ‹‰å–-1"><a href="#æœåŠ¡æ‹‰å–-1" class="headerlink" title="æœåŠ¡æ‹‰å–"></a>æœåŠ¡æ‹‰å–</h2><blockquote>
<p>åœ¨ order-service ä¸­å®ŒæˆæœåŠ¡æ‹‰å–ï¼Œç„¶åé€šè¿‡è´Ÿè½½å‡è¡¡æŒ‘é€‰ä¸€ä¸ªæœåŠ¡ï¼Œå®ç°è¿œç¨‹è°ƒç”¨</p>
</blockquote>
<p>ä¸‹é¢æˆ‘ä»¬è®© order-service å‘ eureka-server æ‹‰å– user-service çš„ä¿¡æ¯ï¼Œå®ç°æœåŠ¡å‘ç°ã€‚</p>
<p>é¦–å…ˆç»™ <code>RestTemplate</code> è¿™ä¸ª Bean æ·»åŠ ä¸€ä¸ª <code>@LoadBalanced</code> <strong>æ³¨è§£</strong>ï¼Œç”¨äºå¼€å¯<strong>è´Ÿè½½å‡è¡¡</strong>ã€‚ï¼ˆåé¢ä¼šè®²ï¼‰</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¿®æ”¹ OrderService è®¿é—®çš„urlè·¯å¾„ï¼Œç”¨<strong>æœåŠ¡å</strong>ä»£æ›¿ipã€ç«¯å£ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091216.png"><img src="https://cdn.xn2001.com/img/2021/20210901091216.png!/format/webp" alt="img"></a></p>
<p>spring ä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ä» eureka-server ä¸­ï¼Œæ ¹æ® userservice è¿™ä¸ªæœåŠ¡åç§°ï¼Œè·å–å®ä¾‹åˆ—è¡¨åå»å®Œæˆè´Ÿè½½å‡è¡¡ã€‚</p>
<h1 id="Ribbonè´Ÿè½½å‡è¡¡-1"><a href="#Ribbonè´Ÿè½½å‡è¡¡-1" class="headerlink" title="Ribbonè´Ÿè½½å‡è¡¡"></a>Ribbonè´Ÿè½½å‡è¡¡</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon">https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon">https://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon</a></p>
</blockquote>
<p>æˆ‘ä»¬æ·»åŠ äº† <code>@LoadBalanced</code> æ³¨è§£ï¼Œå³å¯å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ</p>
<p><strong>SpringCloud åº•å±‚æä¾›äº†ä¸€ä¸ªåä¸º Ribbon çš„ç»„ä»¶ï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091242.png"><img src="https://cdn.xn2001.com/img/2021/20210901091242.png!/format/webp" alt="img"></a></p>
<h2 id="æºç è·Ÿè¸ª-1"><a href="#æºç è·Ÿè¸ª-1" class="headerlink" title="æºç è·Ÿè¸ª"></a>æºç è·Ÿè¸ª</h2><p>ä¸ºä»€ä¹ˆæˆ‘ä»¬åªè¾“å…¥äº† service åç§°å°±å¯ä»¥è®¿é—®äº†å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸éœ€è¦è·å–ipå’Œç«¯å£ï¼Œè¿™æ˜¾ç„¶æœ‰äººå¸®æˆ‘ä»¬æ ¹æ® service åç§°ï¼Œè·å–åˆ°äº†æœåŠ¡å®ä¾‹çš„ipå’Œç«¯å£ã€‚å®ƒå°±æ˜¯<code>LoadBalancerInterceptor</code>ï¼Œè¿™ä¸ªç±»ä¼šåœ¨å¯¹ RestTemplate çš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œç„¶åä» Eureka æ ¹æ®æœåŠ¡ id è·å–æœåŠ¡åˆ—è¡¨ï¼Œéšååˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•å¾—åˆ°çœŸå®çš„æœåŠ¡åœ°å€ä¿¡æ¯ï¼Œæ›¿æ¢æœåŠ¡ idã€‚</p>
<p>æˆ‘ä»¬è¿›è¡Œæºç è·Ÿè¸ªï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091323.png"><img src="https://cdn.xn2001.com/img/2021/20210901091323.png!/format/webp" alt="img"></a></p>
<p>è¿™é‡Œçš„ <code>intercept()</code> æ–¹æ³•ï¼Œæ‹¦æˆªäº†ç”¨æˆ·çš„ HttpRequest è¯·æ±‚ï¼Œç„¶ååšäº†å‡ ä»¶äº‹ï¼š</p>
<ul>
<li><code>request.getURI()</code>ï¼šè·å–è¯·æ±‚uriï¼Œå³ <a target="_blank" rel="noopener" href="http://user-service/user/8">http://user-service/user/8</a></li>
<li><code>originalUri.getHost()</code>ï¼šè·å–uriè·¯å¾„çš„ä¸»æœºåï¼Œå…¶å®å°±æ˜¯æœåŠ¡id <code>user-service</code></li>
<li><code>this.loadBalancer.execute()</code>ï¼šå¤„ç†æœåŠ¡idï¼Œå’Œç”¨æˆ·è¯·æ±‚</li>
</ul>
<p>è¿™é‡Œçš„ <code>this.loadBalancer</code> æ˜¯ <code>LoadBalancerClient</code> ç±»å‹</p>
<p>ç»§ç»­è·Ÿå…¥ <code>execute()</code> æ–¹æ³•ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091330.png"><img src="https://cdn.xn2001.com/img/2021/20210901091330.png!/format/webp" alt="img"></a></p>
<ul>
<li><code>getLoadBalancer(serviceId)</code>ï¼šæ ¹æ®æœåŠ¡idè·å– <code>ILoadBalancer</code>ï¼Œè€Œ <code>ILoadBalancer</code> ä¼šæ‹¿ç€æœåŠ¡ id å» eureka ä¸­è·å–æœåŠ¡åˆ—è¡¨ã€‚</li>
<li><code>getServer(loadBalancer)</code>ï¼šåˆ©ç”¨å†…ç½®çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œä»æœåŠ¡åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªã€‚åœ¨å›¾ä¸­<strong>å¯ä»¥çœ‹åˆ°è·å–äº†8082ç«¯å£çš„æœåŠ¡</strong></li>
</ul>
<p>å¯ä»¥çœ‹åˆ°è·å–æœåŠ¡æ—¶ï¼Œé€šè¿‡ä¸€ä¸ª <code>getServer()</code> æ–¹æ³•æ¥åšè´Ÿè½½å‡è¡¡:</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091345.png"><img src="https://cdn.xn2001.com/img/2021/20210901091345.png!/format/webp" alt="img"></a></p>
<p>æˆ‘ä»¬ç»§ç»­è·Ÿå…¥ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091355.png"><img src="https://cdn.xn2001.com/img/2021/20210901091355.png!/format/webp" alt="img"></a></p>
<p>ç»§ç»­è·Ÿè¸ªæºç  <code>chooseServer()</code> æ–¹æ³•ï¼Œå‘ç°è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091414.png"><img src="https://cdn.xn2001.com/img/2021/20210901091414.png!/format/webp" alt="img"></a></p>
<p>æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª <code>rule</code> æ˜¯è°ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091432.png"><img src="https://cdn.xn2001.com/img/2021/20210901091432.png!/format/webp" alt="img"></a></p>
<p>è¿™é‡Œçš„ rule é»˜è®¤å€¼æ˜¯ä¸€ä¸ª <code>RoundRobinRule</code> ï¼Œçœ‹ç±»çš„ä»‹ç»ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091442.png"><img src="https://cdn.xn2001.com/img/2021/20210901091442.png!/format/webp" alt="img"></a></p>
<p>è´Ÿè½½å‡è¡¡é»˜è®¤ä½¿ç”¨äº†è½®è®­ç®—æ³•ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚</p>
<h2 id="æµç¨‹æ€»ç»“-1"><a href="#æµç¨‹æ€»ç»“-1" class="headerlink" title="æµç¨‹æ€»ç»“"></a>æµç¨‹æ€»ç»“</h2><p>SpringCloud Ribbon åº•å±‚é‡‡ç”¨äº†ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ‹¦æˆªäº† RestTemplate å‘å‡ºçš„è¯·æ±‚ï¼Œå¯¹åœ°å€åšäº†ä¿®æ”¹ã€‚</p>
<p>åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ‹¦æˆªæˆ‘ä»¬çš„ <code>RestTemplate</code> è¯·æ±‚ <a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></li>
<li><code>RibbonLoadBalancerClient</code> ä¼šä»è¯·æ±‚urlä¸­è·å–æœåŠ¡åç§°ï¼Œä¹Ÿå°±æ˜¯ user-service</li>
<li><code>DynamicServerListLoadBalancer</code> æ ¹æ® user-service åˆ° eureka æ‹‰å–æœåŠ¡åˆ—è¡¨</li>
<li>eureka è¿”å›åˆ—è¡¨ï¼Œlocalhost:8081ã€localhost:8082</li>
<li><code>IRule</code> åˆ©ç”¨å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä¾‹å¦‚ localhost:8081</li>
<li><code>RibbonLoadBalancerClient</code> ä¿®æ”¹è¯·æ±‚åœ°å€ï¼Œç”¨ localhost:8081 æ›¿ä»£ userserviceï¼Œå¾—åˆ° <a target="_blank" rel="noopener" href="http://localhost:8081/user/1%EF%BC%8C%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E8%AF%B7%E6%B1%82">http://localhost:8081/user/1ï¼Œå‘èµ·çœŸå®è¯·æ±‚</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091755.png"><img src="https://cdn.xn2001.com/img/2021/20210901091755.png!/format/webp" alt="img"></a></p>
<h2 id="è´Ÿè½½å‡è¡¡ç­–ç•¥-1"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥-1" class="headerlink" title="è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>è´Ÿè½½å‡è¡¡ç­–ç•¥</h2><p>è´Ÿè½½å‡è¡¡çš„è§„åˆ™éƒ½å®šä¹‰åœ¨ IRule æ¥å£ä¸­ï¼Œè€Œ IRule æœ‰å¾ˆå¤šä¸åŒçš„å®ç°ç±»ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091811.png"><img src="https://cdn.xn2001.com/img/2021/20210901091811.png!/format/webp" alt="img"></a></p>
<p>ä¸åŒè§„åˆ™çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left"><strong>å†…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ç±»</strong></th>
<th align="left"><strong>è§„åˆ™æè¿°</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">RoundRobinRule</td>
<td align="left">ç®€å•è½®è¯¢æœåŠ¡åˆ—è¡¨æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚å®ƒæ˜¯Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚</td>
</tr>
<tr>
<td align="left">AvailabilityFilteringRule</td>
<td align="left">å¯¹ä»¥ä¸‹ä¸¤ç§æœåŠ¡å™¨è¿›è¡Œå¿½ç•¥ï¼šï¼ˆ1ï¼‰åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™å°æœåŠ¡å™¨å¦‚æœ3æ¬¡è¿æ¥å¤±è´¥ï¼Œè¿™å°æœåŠ¡å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºâ€œçŸ­è·¯â€çŠ¶æ€ã€‚çŸ­è·¯çŠ¶æ€å°†æŒç»­30ç§’ï¼Œå¦‚æœå†æ¬¡è¿æ¥å¤±è´¥ï¼ŒçŸ­è·¯çš„æŒç»­æ—¶é—´å°±ä¼šå‡ ä½•çº§åœ°å¢åŠ ã€‚ ï¼ˆ2ï¼‰å¹¶å‘æ•°è¿‡é«˜çš„æœåŠ¡å™¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å™¨çš„å¹¶å‘è¿æ¥æ•°è¿‡é«˜ï¼Œé…ç½®äº†AvailabilityFilteringRule è§„åˆ™çš„å®¢æˆ·ç«¯ä¹Ÿä¼šå°†å…¶å¿½ç•¥ã€‚å¹¶å‘è¿æ¥æ•°çš„ä¸Šé™ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯è®¾ç½®ã€‚</td>
</tr>
<tr>
<td align="left">WeightedResponseTimeRule</td>
<td align="left">ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å™¨èµ‹äºˆä¸€ä¸ªæƒé‡å€¼ã€‚æœåŠ¡å™¨å“åº”æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„æƒé‡å°±è¶Šå°ã€‚è¿™ä¸ªè§„åˆ™ä¼šéšæœºé€‰æ‹©æœåŠ¡å™¨ï¼Œè¿™ä¸ªæƒé‡å€¼ä¼šå½±å“æœåŠ¡å™¨çš„é€‰æ‹©ã€‚</td>
</tr>
<tr>
<td align="left"><strong>ZoneAvoidanceRule</strong></td>
<td align="left">ä»¥åŒºåŸŸå¯ç”¨çš„æœåŠ¡å™¨ä¸ºåŸºç¡€è¿›è¡ŒæœåŠ¡å™¨çš„é€‰æ‹©ã€‚ä½¿ç”¨Zoneå¯¹æœåŠ¡å™¨è¿›è¡Œåˆ†ç±»ï¼Œè¿™ä¸ªZoneå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæœºæˆ¿ã€ä¸€ä¸ªæœºæ¶ç­‰ã€‚è€Œåå†å¯¹Zoneå†…çš„å¤šä¸ªæœåŠ¡åšè½®è¯¢ã€‚</td>
</tr>
<tr>
<td align="left">BestAvailableRule</td>
<td align="left">å¿½ç•¥é‚£äº›çŸ­è·¯çš„æœåŠ¡å™¨ï¼Œå¹¶é€‰æ‹©å¹¶å‘æ•°è¾ƒä½çš„æœåŠ¡å™¨ã€‚</td>
</tr>
<tr>
<td align="left">RandomRule</td>
<td align="left">éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨ã€‚</td>
</tr>
<tr>
<td align="left">RetryRule</td>
<td align="left">é‡è¯•æœºåˆ¶çš„é€‰æ‹©é€»è¾‘</td>
</tr>
</tbody></table>
<p>é»˜è®¤çš„å®ç°å°±æ˜¯ <code>ZoneAvoidanceRule</code>ï¼Œ<strong>æ˜¯ä¸€ç§è½®è¯¢æ–¹æ¡ˆ</strong>ã€‚</p>
<h2 id="è‡ªå®šä¹‰ç­–ç•¥-1"><a href="#è‡ªå®šä¹‰ç­–ç•¥-1" class="headerlink" title="è‡ªå®šä¹‰ç­–ç•¥"></a>è‡ªå®šä¹‰ç­–ç•¥</h2><p>é€šè¿‡å®šä¹‰ IRule å®ç°å¯ä»¥ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>1 ä»£ç æ–¹å¼åœ¨ order-service ä¸­çš„ OrderApplication ç±»ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ IRuleï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091832.png"><img src="https://cdn.xn2001.com/img/2021/20210901091832.png!/format/webp" alt="img"></a></p>
<p>2 é…ç½®æ–‡ä»¶æ–¹å¼ï¼šåœ¨ order-service çš„ application.yml æ–‡ä»¶ä¸­ï¼Œæ·»åŠ æ–°çš„é…ç½®ä¹Ÿå¯ä»¥ä¿®æ”¹è§„åˆ™ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># ç»™éœ€è¦è°ƒç”¨çš„å¾®æœåŠ¡é…ç½®è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒorderserviceæœåŠ¡å»è°ƒç”¨userserviceæœåŠ¡</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule <span class="token comment"># è´Ÿè½½å‡è¡¡è§„åˆ™ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>æ³¨æ„</strong>ï¼šä¸€èˆ¬ç”¨é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™ï¼Œä¸åšä¿®æ”¹ã€‚</p>
<h2 id="é¥¥é¥¿åŠ è½½-1"><a href="#é¥¥é¥¿åŠ è½½-1" class="headerlink" title="é¥¥é¥¿åŠ è½½"></a>é¥¥é¥¿åŠ è½½</h2><p>å½“æˆ‘ä»¬å¯åŠ¨ orderserviceï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œæ—¶é—´æ¶ˆè€—ä¼šå¤§å¾ˆå¤šï¼Œè¿™æ˜¯å› ä¸º Ribbon æ‡’åŠ è½½çš„æœºåˆ¶ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091850.png"><img src="https://cdn.xn2001.com/img/2021/20210901091850.png!/format/webp" alt="img"></a></p>
<p>Ribbon é»˜è®¤æ˜¯é‡‡ç”¨æ‡’åŠ è½½ï¼Œå³ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰ä¼šå»åˆ›å»º LoadBalanceClientï¼Œæ‹‰å–é›†ç¾¤åœ°å€ï¼Œæ‰€ä»¥è¯·æ±‚æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p>
<p>è€Œé¥¥é¥¿åŠ è½½åˆ™ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶åˆ›å»º LoadBalanceClientï¼Œé™ä½ç¬¬ä¸€æ¬¡è®¿é—®çš„è€—æ—¶ï¼Œé€šè¿‡ä¸‹é¢é…ç½®å¼€å¯é¥¥é¥¿åŠ è½½ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> userservice <span class="token comment"># é¡¹ç›®å¯åŠ¨æ—¶ç›´æ¥å»æ‹‰å–userserviceçš„é›†ç¾¤ï¼Œå¤šä¸ªç”¨","éš”å¼€</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Nacosæ³¨å†Œä¸­å¿ƒ-1"><a href="#Nacosæ³¨å†Œä¸­å¿ƒ-1" class="headerlink" title="Nacosæ³¨å†Œä¸­å¿ƒ"></a>Nacosæ³¨å†Œä¸­å¿ƒ</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos">https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>SpringCloudAlibaba æ¨å‡ºäº†ä¸€ä¸ªåä¸º Nacos çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨å›½å¤–ä¹Ÿæœ‰å¤§é‡çš„ä½¿ç”¨ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091857.png"><img src="https://cdn.xn2001.com/img/2021/20210901091857.png!/format/webp" alt="img"></a></p>
<p>è§£å‹å¯åŠ¨ Nacosï¼Œè¯¦ç»†è¯·çœ‹ <a target="_blank" rel="noopener" href="https://www.xn2001.com/archives/661.html">Nacoså®‰è£…æŒ‡å—</a></p>
<pre class="line-numbers language-none"><code class="language-none">startup.cmd -m standalone<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/">http://localhost:8848/nacos/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091904.png"><img src="https://cdn.xn2001.com/img/2021/20210901091904.png!/format/webp" alt="img"></a></p>
<h2 id="æœåŠ¡æ³¨å†Œ-3"><a href="#æœåŠ¡æ³¨å†Œ-3" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><p>è¿™é‡Œä¸Šæ¥å°±ç›´æ¥æœåŠ¡æ³¨å†Œï¼Œå¾ˆå¤šä¸œè¥¿å¯èƒ½æœ‰ç–‘æƒ‘ï¼Œå…¶å® Nacos æœ¬èº«å°±æ˜¯ä¸€ä¸ª SprintBoot é¡¹ç›®ï¼Œè¿™ç‚¹ä½ ä»å¯åŠ¨çš„æ§åˆ¶å°æ‰“å°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ‰€ä»¥å°±ä¸å†éœ€è¦å»é¢å¤–æ­å»ºä¸€ä¸ªåƒ Eureka çš„æ³¨å†Œä¸­å¿ƒã€‚</p>
<p><strong>å¼•å…¥ä¾èµ–</strong></p>
<p>åœ¨ cloud-demo çˆ¶å·¥ç¨‹ä¸­å¼•å…¥ SpringCloudAlibaba çš„ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶ååœ¨ user-service å’Œ order-service ä¸­çš„pomæ–‡ä»¶ä¸­å¼•å…¥ nacos-discovery ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>é…ç½®nacosåœ°å€</strong></p>
<p>åœ¨ user-service å’Œ order-service çš„ application.yml ä¸­æ·»åŠ  nacos åœ°å€ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¡¹ç›®é‡æ–°å¯åŠ¨åï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªæœåŠ¡éƒ½è¢«æ³¨å†Œè¿›äº† Nacos</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091918.png"><img src="https://cdn.xn2001.com/img/2021/20210901091918.png!/format/webp" alt="img"></a></p>
<p>æµè§ˆå™¨è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101%EF%BC%8C%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE%EF%BC%8C%E5%90%8C%E6%97%B6%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B9%9F%E6%AD%A3%E5%B8%B8%E3%80%82">http://localhost:8080/order/101ï¼Œæ­£å¸¸è®¿é—®ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡ä¹Ÿæ­£å¸¸ã€‚</a></p>
<h2 id="åˆ†çº§å­˜å‚¨æ¨¡å‹-1"><a href="#åˆ†çº§å­˜å‚¨æ¨¡å‹-1" class="headerlink" title="åˆ†çº§å­˜å‚¨æ¨¡å‹"></a>åˆ†çº§å­˜å‚¨æ¨¡å‹</h2><p>ä¸€ä¸ª<strong>æœåŠ¡</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>å®ä¾‹</strong>ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ user-serviceï¼Œå¯ä»¥æœ‰:</p>
<ul>
<li>127.0.0.1:8081</li>
<li>127.0.0.1:8082</li>
<li>127.0.0.1:8083</li>
</ul>
<p>å‡å¦‚è¿™äº›å®ä¾‹åˆ†å¸ƒäºå…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>127.0.0.1:8081ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿</li>
<li>127.0.0.1:8082ï¼Œåœ¨ä¸Šæµ·æœºæˆ¿</li>
<li>127.0.0.1:8083ï¼Œåœ¨æ­å·æœºæˆ¿</li>
</ul>
<p>Nacoså°±å°†åŒä¸€æœºæˆ¿å†…çš„å®ä¾‹ï¼Œåˆ’åˆ†ä¸ºä¸€ä¸ª<strong>é›†ç¾¤</strong>ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091928.png"><img src="https://cdn.xn2001.com/img/2021/20210901091928.png!/format/webp" alt="img"></a></p>
<p>å¾®æœåŠ¡äº’ç›¸è®¿é—®æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½è®¿é—®åŒé›†ç¾¤å®ä¾‹ï¼Œå› ä¸ºæœ¬åœ°è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚<strong>å½“æœ¬é›†ç¾¤å†…ä¸å¯ç”¨æ—¶ï¼Œæ‰è®¿é—®å…¶å®ƒé›†ç¾¤ã€‚</strong>ä¾‹å¦‚ï¼šæ­å·æœºæˆ¿å†…çš„ order-service åº”è¯¥ä¼˜å…ˆè®¿é—®åŒæœºæˆ¿çš„ user-serviceã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091937.png"><img src="https://cdn.xn2001.com/img/2021/20210901091937.png!/format/webp" alt="img"></a></p>
<h2 id="é…ç½®é›†ç¾¤-1"><a href="#é…ç½®é›†ç¾¤-1" class="headerlink" title="é…ç½®é›†ç¾¤"></a>é…ç½®é›†ç¾¤</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»™ user-service <strong>é…ç½®é›†ç¾¤</strong></p>
<p>ä¿®æ”¹ user-service çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é›†ç¾¤é…ç½®ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># é›†ç¾¤åç§° HZæ­å·</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ä¸¤ä¸ª user-service å®ä¾‹åï¼Œæˆ‘ä»¬å†å»å¯åŠ¨ä¸€ä¸ªä¸Šæµ·é›†ç¾¤çš„å®ä¾‹ã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091947.png"><img src="https://cdn.xn2001.com/img/2021/20210901091947.png!/format/webp" alt="img"></a></p>
<p>æŸ¥çœ‹ nacos æ§åˆ¶å°</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901091957.png"><img src="https://cdn.xn2001.com/img/2021/20210901091957.png!/format/webp" alt="img"></a></p>
<h2 id="NacosRule-1"><a href="#NacosRule-1" class="headerlink" title="NacosRule"></a>NacosRule</h2><p>Ribbonçš„é»˜è®¤å®ç° <code>ZoneAvoidanceRule</code> å¹¶ä¸èƒ½å®ç°æ ¹æ®åŒé›†ç¾¤ä¼˜å…ˆæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬æŠŠè§„åˆ™æ”¹æˆ <strong>NacosRule</strong> å³å¯ã€‚æˆ‘ä»¬æ˜¯ç”¨ orderservice è°ƒç”¨ userserviceï¼Œæ‰€ä»¥åœ¨ orderservice é…ç½®è§„åˆ™ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">iRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//é»˜è®¤ä¸ºè½®è¯¢è§„åˆ™ï¼Œè¿™é‡Œè‡ªå®šä¹‰ä¸ºéšæœºè§„åˆ™</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NacosRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤–ï¼Œä½ åŒæ ·å¯ä»¥ä½¿ç”¨é…ç½®çš„å½¢å¼æ¥å®Œæˆï¼Œå…·ä½“å‚è€ƒä¸Šé¢çš„ Ribbon æ ç›®ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">userservice</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.alibaba.cloud.nacos.ribbon.NacosRule <span class="token comment">#è´Ÿè½½å‡è¡¡è§„åˆ™ </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åï¼Œå†å¯¹ orderservice é…ç½®é›†ç¾¤ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ <span class="token comment"># é›†ç¾¤åç§°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨æˆ‘å¯åŠ¨äº†å››ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>orderservice - HZ</li>
<li>userservice - HZ</li>
<li>userservice1 - HZ</li>
<li>userservice2 - SH</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/order/101">http://localhost:8080/order/101</a></p>
<p>åœ¨è®¿é—®ä¸­æˆ‘ä»¬å‘ç°ï¼Œåªæœ‰åŒåœ¨ä¸€ä¸ª HZ é›†ç¾¤ä¸‹çš„ userserviceã€userservice1 ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯éšæœºçš„ã€‚</p>
<p>æˆ‘ä»¬è¯•ç€æŠŠ userserviceã€userservice2 åœæ‰ã€‚ä¾æ—§å¯ä»¥è®¿é—®ã€‚</p>
<p>åœ¨ userservice3 æ§åˆ¶å°å¯ä»¥çœ‹åˆ°å‘å‡ºäº†ä¸€ä¸²çš„è­¦å‘Šï¼Œå› ä¸º orderservice æœ¬èº«æ˜¯åœ¨ HZ é›†ç¾¤çš„ï¼Œè¿™æ³¢ HZ é›†ç¾¤æ²¡æœ‰äº† userserviceï¼Œå°±ä¼šå»åˆ«çš„é›†ç¾¤æ‰¾ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092012.png"><img src="https://cdn.xn2001.com/img/2021/20210901092012.png!/format/webp" alt="img"></a></p>
<h2 id="æƒé‡é…ç½®-1"><a href="#æƒé‡é…ç½®-1" class="headerlink" title="æƒé‡é…ç½®"></a>æƒé‡é…ç½®</h2><p>å®é™…éƒ¨ç½²ä¸­ä¼šå‡ºç°è¿™æ ·çš„åœºæ™¯ï¼š</p>
<p>æœåŠ¡å™¨è®¾å¤‡æ€§èƒ½æœ‰å·®å¼‚ï¼Œéƒ¨åˆ†å®ä¾‹æ‰€åœ¨æœºå™¨æ€§èƒ½è¾ƒå¥½ï¼Œå¦ä¸€äº›è¾ƒå·®ï¼Œæˆ‘ä»¬å¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨æ‰¿æ‹…æ›´å¤šçš„ç”¨æˆ·è¯·æ±‚ã€‚ä½†é»˜è®¤æƒ…å†µä¸‹ NacosRule æ˜¯åŒé›†ç¾¤å†…éšæœºæŒ‘é€‰ï¼Œä¸ä¼šè€ƒè™‘æœºå™¨çš„æ€§èƒ½é—®é¢˜ã€‚</p>
<p>å› æ­¤ï¼ŒNacos æä¾›äº†<strong>æƒé‡é…ç½®æ¥æ§åˆ¶è®¿é—®é¢‘ç‡</strong>ï¼Œ0~1 ä¹‹é—´ï¼Œæƒé‡è¶Šå¤§åˆ™è®¿é—®é¢‘ç‡è¶Šé«˜ï¼Œæƒé‡ä¿®æ”¹ä¸º 0ï¼Œåˆ™è¯¥å®ä¾‹æ°¸è¿œä¸ä¼šè¢«è®¿é—®ã€‚</p>
<p>åœ¨ Nacos æ§åˆ¶å°ï¼Œæ‰¾åˆ° user-service çš„å®ä¾‹åˆ—è¡¨ï¼Œç‚¹å‡»ç¼–è¾‘ï¼Œå³å¯ä¿®æ”¹æƒé‡ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092020.png"><img src="https://cdn.xn2001.com/img/2021/20210901092020.png!/format/webp" alt="img"></a></p>
<p>åœ¨å¼¹å‡ºçš„ç¼–è¾‘çª—å£ï¼Œä¿®æ”¹æƒé‡</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092026.png"><img src="https://cdn.xn2001.com/img/2021/20210901092026.png!/format/webp" alt="img"></a></p>
<p>å¦å¤–ï¼Œåœ¨æœåŠ¡å‡çº§çš„æ—¶å€™ï¼Œæœ‰ä¸€ç§è¾ƒå¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒæ•´æƒé‡æ¥è¿›è¡Œå¹³æ»‘å‡çº§ï¼Œä¾‹å¦‚ï¼šå…ˆæŠŠ userservice æƒé‡è°ƒèŠ‚ä¸º 0ï¼Œè®©ç”¨æˆ·å…ˆæµå‘ userservice2ã€userservice3ï¼Œå‡çº§ userserviceåï¼Œå†æŠŠæƒé‡ä» 0 è°ƒåˆ° 0.1ï¼Œè®©ä¸€éƒ¨åˆ†ç”¨æˆ·å…ˆä½“éªŒï¼Œç”¨æˆ·ä½“éªŒç¨³å®šåå°±å¯ä»¥å¾€ä¸Šè°ƒæƒé‡å•¦ã€‚</p>
<h2 id="ç¯å¢ƒéš”ç¦»-1"><a href="#ç¯å¢ƒéš”ç¦»-1" class="headerlink" title="ç¯å¢ƒéš”ç¦»"></a>ç¯å¢ƒéš”ç¦»</h2><p>Nacos æä¾›äº† namespace æ¥å®ç°ç¯å¢ƒéš”ç¦»åŠŸèƒ½ã€‚</p>
<ul>
<li>Nacos ä¸­å¯ä»¥æœ‰å¤šä¸ª namespace</li>
<li>namespace ä¸‹å¯ä»¥æœ‰ groupã€service ç­‰</li>
<li>ä¸åŒ namespace ä¹‹é—´<strong>ç›¸äº’éš”ç¦»</strong>ï¼Œä¾‹å¦‚ä¸åŒ namespace çš„æœåŠ¡äº’ç›¸ä¸å¯è§</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092032.png"><img src="https://cdn.xn2001.com/img/2021/20210901092032.png!/format/webp" alt="img"></a></p>
<h3 id="åˆ›å»ºnamespace-1"><a href="#åˆ›å»ºnamespace-1" class="headerlink" title="åˆ›å»ºnamespace"></a>åˆ›å»ºnamespace</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ serviceã€dataã€group éƒ½åœ¨åŒä¸€ä¸ª namespaceï¼Œåä¸º public(ä¿ç•™ç©ºé—´)ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092038.png"><img src="https://cdn.xn2001.com/img/2021/20210901092038.png!/format/webp" alt="img"></a></p>
<p>æˆ‘ä»¬å¯ä»¥ç‚¹å‡»é¡µé¢æ–°å¢æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ª namespaceï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092050.png"><img src="https://cdn.xn2001.com/img/2021/20210901092050.png!/format/webp" alt="img"></a></p>
<p>ç„¶åï¼Œå¡«å†™è¡¨å•ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092059.png"><img src="https://cdn.xn2001.com/img/2021/20210901092059.png!/format/webp" alt="img"></a></p>
<p>å°±èƒ½åœ¨é¡µé¢çœ‹åˆ°ä¸€ä¸ªæ–°çš„ namespaceï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092114.png"><img src="https://cdn.xn2001.com/img/2021/20210901092114.png!/format/webp" alt="img"></a></p>
<h3 id="é…ç½®namespace-1"><a href="#é…ç½®namespace-1" class="headerlink" title="é…ç½®namespace"></a>é…ç½®namespace</h3><p>ç»™å¾®æœåŠ¡é…ç½® namespace åªèƒ½é€šè¿‡ä¿®æ”¹é…ç½®æ¥å®ç°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¿®æ”¹ order-service çš„ application.yml æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> HZ
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 492a7d5d<span class="token punctuation">-</span>237b<span class="token punctuation">-</span>46a1<span class="token punctuation">-</span>a99a<span class="token punctuation">-</span>fa8e98e4b0f9 <span class="token comment"># å‘½åç©ºé—´ID</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ order-service åï¼Œè®¿é—®æ§åˆ¶å°ã€‚</p>
<p><strong>public</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092143.png"><img src="https://cdn.xn2001.com/img/2021/20210901092143.png!/format/webp" alt="img"></a></p>
<p><strong>dev</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092130.png"><img src="https://cdn.xn2001.com/img/2021/20210901092130.png!/format/webp" alt="img"></a></p>
<p>æ­¤æ—¶è®¿é—® order-serviceï¼Œå› ä¸º namespace ä¸åŒï¼Œä¼šå¯¼è‡´æ‰¾ä¸åˆ° userserviceï¼Œæ§åˆ¶å°ä¼šæŠ¥é”™ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092138.png"><img src="https://cdn.xn2001.com/img/2021/20210901092138.png!/format/webp" alt="img"></a></p>
<h2 id="ä¸´æ—¶å®ä¾‹-1"><a href="#ä¸´æ—¶å®ä¾‹-1" class="headerlink" title="ä¸´æ—¶å®ä¾‹"></a>ä¸´æ—¶å®ä¾‹</h2><p>Nacos çš„æœåŠ¡å®ä¾‹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li><strong>ä¸´æ—¶å®ä¾‹</strong>ï¼šå¦‚æœå®ä¾‹å®•æœºè¶…è¿‡ä¸€å®šæ—¶é—´ï¼Œä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œ<strong>é»˜è®¤çš„ç±»å‹</strong>ã€‚</li>
<li>éä¸´æ—¶å®ä¾‹ï¼šå¦‚æœå®ä¾‹å®•æœºï¼Œä¸ä¼šä»æœåŠ¡åˆ—è¡¨å‰”é™¤ï¼Œä¹Ÿå¯ä»¥å«æ°¸ä¹…å®ä¾‹ã€‚</li>
</ul>
<p>é…ç½®ä¸€ä¸ªæœåŠ¡å®ä¾‹ä¸ºæ°¸ä¹…å®ä¾‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">ephemeral</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># è®¾ç½®ä¸ºéä¸´æ—¶å®ä¾‹</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤–ï¼ŒNacos é›†ç¾¤**é»˜è®¤é‡‡ç”¨APæ–¹å¼(å¯ç”¨æ€§)<strong>ï¼Œå½“é›†ç¾¤ä¸­å­˜åœ¨éä¸´æ—¶å®ä¾‹æ—¶ï¼Œ</strong>é‡‡ç”¨CPæ¨¡å¼(ä¸€è‡´æ€§)**ï¼›è€Œ Eureka é‡‡ç”¨APæ–¹å¼ï¼Œä¸å¯åˆ‡æ¢ã€‚ï¼ˆè¿™é‡Œè¯´çš„æ˜¯ CAP åŸç†ï¼Œåé¢ä¼šå†™åˆ°ï¼‰</p>
<h1 id="Nacosé…ç½®ä¸­å¿ƒ-1"><a href="#Nacosé…ç½®ä¸­å¿ƒ-1" class="headerlink" title="Nacosé…ç½®ä¸­å¿ƒ"></a>Nacosé…ç½®ä¸­å¿ƒ</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos">https://gitee.com/xn2001/cloudcode/tree/master/05-cloud-nacos</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos">https://github.com/lexinhu/cloudcode/tree/master/05-cloud-nacos</a></p>
</blockquote>
<p>Nacosé™¤äº†å¯ä»¥åšæ³¨å†Œä¸­å¿ƒï¼ŒåŒæ ·å¯ä»¥åšé…ç½®ç®¡ç†æ¥ä½¿ç”¨ã€‚</p>
<p>å½“å¾®æœåŠ¡éƒ¨ç½²çš„å®ä¾‹è¶Šæ¥è¶Šå¤šï¼Œè¾¾åˆ°æ•°åã€æ•°ç™¾æ—¶ï¼Œé€ä¸ªä¿®æ”¹å¾®æœåŠ¡é…ç½®å°±ä¼šè®©äººæŠ“ç‹‚ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å‡ºé”™ã€‚<strong>æˆ‘ä»¬éœ€è¦ä¸€ç§ç»Ÿä¸€é…ç½®ç®¡ç†æ–¹æ¡ˆï¼Œå¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰å®ä¾‹çš„é…ç½®ã€‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092150.png"><img src="https://cdn.xn2001.com/img/2021/20210901092150.png!/format/webp" alt="img"></a></p>
<p>Nacos ä¸€æ–¹é¢å¯ä»¥å°†é…ç½®é›†ä¸­ç®¡ç†ï¼Œå¦ä¸€æ–¹å¯ä»¥åœ¨é…ç½®å˜æ›´æ—¶ï¼ŒåŠæ—¶é€šçŸ¥å¾®æœåŠ¡ï¼Œ<strong>å®ç°é…ç½®çš„çƒ­æ›´æ–°ã€‚</strong></p>
<h2 id="åˆ›å»ºé…ç½®-1"><a href="#åˆ›å»ºé…ç½®-1" class="headerlink" title="åˆ›å»ºé…ç½®"></a>åˆ›å»ºé…ç½®</h2><p>åœ¨ Nacos æ§åˆ¶é¢æ¿ä¸­æ·»åŠ é…ç½®æ–‡ä»¶</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092159.png"><img src="https://cdn.xn2001.com/img/2021/20210901092159.png!/format/webp" alt="img"></a></p>
<p>ç„¶ååœ¨å¼¹å‡ºçš„è¡¨å•ä¸­ï¼Œå¡«å†™é…ç½®ä¿¡æ¯ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092206.png"><img src="https://cdn.xn2001.com/img/2021/20210901092206.png!/format/webp" alt="img"></a></p>
<p><strong>æ³¨æ„</strong>ï¼šé¡¹ç›®çš„æ ¸å¿ƒé…ç½®ï¼Œéœ€è¦çƒ­æ›´æ–°çš„é…ç½®æ‰æœ‰æ”¾åˆ° nacos ç®¡ç†çš„å¿…è¦ã€‚åŸºæœ¬ä¸ä¼šå˜æ›´çš„ä¸€äº›é…ç½®(ä¾‹å¦‚æ•°æ®åº“è¿æ¥)è¿˜æ˜¯ä¿å­˜åœ¨å¾®æœåŠ¡æœ¬åœ°æ¯”è¾ƒå¥½ã€‚</p>
<h2 id="æ‹‰å–é…ç½®-1"><a href="#æ‹‰å–é…ç½®-1" class="headerlink" title="æ‹‰å–é…ç½®"></a>æ‹‰å–é…ç½®</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ Nacos è¯»å–é…ç½®æ–‡ä»¶çš„ç¯èŠ‚æ˜¯åœ¨å“ªä¸€æ­¥ï¼Œåœ¨æ²¡åŠ å…¥ Nacos é…ç½®ä¹‹å‰ï¼Œè·å–é…ç½®æ˜¯è¿™æ ·ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092215.png"><img src="https://cdn.xn2001.com/img/2021/20210901092215.png!/format/webp" alt="img"></a></p>
<p>åŠ å…¥ Nacos é…ç½®ï¼Œå®ƒçš„è¯»å–æ˜¯åœ¨ application.yml ä¹‹å‰çš„ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092223.png"><img src="https://cdn.xn2001.com/img/2021/20210901092223.png!/format/webp" alt="img"></a></p>
<p>è¿™æ—¶å€™å¦‚æœæŠŠ nacos åœ°å€æ”¾åœ¨ application.yml ä¸­ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ï¼Œ<strong>Nacos å°±æ— æ³•æ ¹æ®åœ°å€å»è·å–é…ç½®äº†ã€‚</strong></p>
<p>å› æ­¤ï¼Œnacos åœ°å€å¿…é¡»æ”¾åœ¨ä¼˜å…ˆçº§æœ€é«˜çš„ bootstrap.yml æ–‡ä»¶ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092228.png"><img src="https://cdn.xn2001.com/img/2021/20210901092228.png!/format/webp" alt="img"></a></p>
<p><strong>å¼•å…¥ nacos-config ä¾èµ–</strong></p>
<p>é¦–å…ˆï¼Œåœ¨ user-service æœåŠ¡ä¸­ï¼Œå¼•å…¥ nacos-config çš„å®¢æˆ·ç«¯ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--nacosé…ç½®ç®¡ç†ä¾èµ–--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ·»åŠ  bootstrap.yml</strong></p>
<p>ç„¶åï¼Œåœ¨ user-service ä¸­æ·»åŠ ä¸€ä¸ª bootstrap.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> userservice <span class="token comment"># æœåŠ¡åç§°</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev <span class="token comment">#å¼€å‘ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯dev </span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacosåœ°å€</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ® spring.cloud.nacos.server-addr è·å– nacosåœ°å€ï¼Œå†æ ¹æ®<code>${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}</code>ä½œä¸ºæ–‡ä»¶idï¼Œæ¥è¯»å–é…ç½®ã€‚</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¾‹ä¸­ï¼Œå°±æ˜¯å»è¯»å– <code>userservice-dev.yaml</code></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092237.png"><img src="https://cdn.xn2001.com/img/2021/20210901092237.png!/format/webp" alt="img"></a></p>
<p>ä½¿ç”¨ä»£ç æ¥éªŒè¯æ˜¯å¦æ‹‰å–æˆåŠŸ</p>
<p>åœ¨ user-service ä¸­çš„ UserController ä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å– pattern.dateformat é…ç½®å¹¶ä½¿ç”¨ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${pattern.dateformat}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//æ ¼å¼åŒ–æ—¶é—´</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092243.png"><img src="https://cdn.xn2001.com/img/2021/20210901092243.png!/format/webp" alt="img"></a></p>
<p>å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:8081/user/now">http://localhost:8081/user/now</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092251.png"><img src="https://cdn.xn2001.com/img/2021/20210901092251.png!/format/webp" alt="img"></a></p>
<h2 id="é…ç½®çƒ­æ›´æ–°-1"><a href="#é…ç½®çƒ­æ›´æ–°-1" class="headerlink" title="é…ç½®çƒ­æ›´æ–°"></a>é…ç½®çƒ­æ›´æ–°</h2><p>æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„ï¼Œæ˜¯ä¿®æ”¹ nacos ä¸­çš„é…ç½®åï¼Œå¾®æœåŠ¡ä¸­æ— éœ€é‡å¯å³å¯è®©é…ç½®ç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯<strong>é…ç½®çƒ­æ›´æ–°</strong>ã€‚</p>
<p>æœ‰ä¸¤ç§æ–¹å¼ï¼š1. ç”¨ <code>@value</code> è¯»å–é…ç½®æ—¶ï¼Œæ­é… <code>@RefreshScope</code>ï¼›2. ç›´æ¥ç”¨ <code>@ConfigurationProperties</code> è¯»å–é…ç½®</p>
<h3 id="RefreshScope-1"><a href="#RefreshScope-1" class="headerlink" title="@RefreshScope"></a>@RefreshScope</h3><p>æ–¹å¼ä¸€ï¼šåœ¨ <code>@Value</code> æ³¨å…¥çš„å˜é‡æ‰€åœ¨ç±»ä¸Šæ·»åŠ æ³¨è§£ <code>@RefreshScope</code></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092258.png"><img src="https://cdn.xn2001.com/img/2021/20210901092258.png!/format/webp" alt="img"></a></p>
<h3 id="ConfigurationProperties-1"><a href="#ConfigurationProperties-1" class="headerlink" title="@ConfigurationProperties"></a>@ConfigurationProperties</h3><p>æ–¹å¼äºŒï¼šä½¿ç”¨ <code>@ConfigurationProperties</code> æ³¨è§£è¯»å–é…ç½®æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦åŠ  <code>@RefreshScope</code> æ³¨è§£ã€‚</p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª PatternProperties ç±»ï¼Œè¯»å– <code>patterrn.dateformat</code> å±æ€§</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"pattern"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PatternProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> dateformat<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">PatternProperties</span> patternProperties<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"now2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">now2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//æ ¼å¼åŒ–æ—¶é—´</span>
    <span class="token keyword">return</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span>patternProperties<span class="token punctuation">.</span>dateformat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®å…±äº«-1"><a href="#é…ç½®å…±äº«-1" class="headerlink" title="é…ç½®å…±äº«"></a>é…ç½®å…±äº«</h2><p>å…¶å®åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œnacos ä¼šè¯»å–å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>[spring.application.name]-[spring.profiles.active].yaml</code>ï¼Œä¾‹å¦‚ï¼šuserservice-dev.yaml</li>
<li><code>[spring.application.name].yaml</code>ï¼Œä¾‹å¦‚ï¼šuserservice.yaml</li>
</ul>
<p>è¿™é‡Œçš„ <code>[spring.application.name].yaml</code> ä¸åŒ…å«ç¯å¢ƒï¼Œ<strong>å› æ­¤å¯ä»¥è¢«å¤šä¸ªç¯å¢ƒå…±äº«</strong>ã€‚</p>
<p><strong>æ·»åŠ ä¸€ä¸ªç¯å¢ƒå…±äº«é…ç½®</strong></p>
<p>æˆ‘ä»¬åœ¨ nacos ä¸­æ·»åŠ ä¸€ä¸ª userservice.yaml æ–‡ä»¶ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092323.png"><img src="https://cdn.xn2001.com/img/2021/20210901092323.png!/format/webp" alt="img"></a></p>
<p><strong>åœ¨ user-service ä¸­è¯»å–å…±äº«é…ç½®</strong></p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ PatternProperties ç±»ï¼Œè¯»å–æ–°æ·»åŠ çš„å±æ€§ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092314.png"><img src="https://cdn.xn2001.com/img/2021/20210901092314.png!/format/webp" alt="img"></a></p>
<p>åœ¨ user-service æœåŠ¡ä¸­ï¼Œä¿®æ”¹ UserControllerï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092331.png"><img src="https://cdn.xn2001.com/img/2021/20210901092331.png!/format/webp" alt="img"></a></p>
<p><strong>è¿è¡Œä¸¤ä¸ª UserApplicationï¼Œä½¿ç”¨ä¸åŒçš„profile</strong></p>
<p>ä¿®æ”¹ UserApplication2 è¿™ä¸ªå¯åŠ¨é¡¹ï¼Œæ”¹å˜å…¶profileå€¼ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092345.png"><img src="https://cdn.xn2001.com/img/2021/20210901092345.png!/format/webp" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092338.png"><img src="https://cdn.xn2001.com/img/2021/20210901092338.png!/format/webp" alt="img"></a></p>
<p>è¿™æ ·ï¼ŒUserApplication(8081) ä½¿ç”¨çš„ profile æ˜¯ devï¼ŒUserApplication2(8082) ä½¿ç”¨çš„ profile æ˜¯test</p>
<p>å¯åŠ¨ UserApplication å’Œ UserApplication2</p>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8081/user/prop%EF%BC%8C%E7%BB%93%E6%9E%9C%EF%BC%9A">http://localhost:8081/user/propï¼Œç»“æœï¼š</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092400.png"><img src="https://cdn.xn2001.com/img/2021/20210901092400.png!/format/webp" alt="img"></a></p>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://localhost:8082/user/prop%EF%BC%8C%E7%BB%93%E6%9E%9C%EF%BC%9A">http://localhost:8082/user/propï¼Œç»“æœï¼š</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092419.png"><img src="https://cdn.xn2001.com/img/2021/20210901092419.png!/format/webp" alt="img"></a></p>
<p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸ç®¡æ˜¯ devï¼Œè¿˜æ˜¯ test ç¯å¢ƒï¼Œéƒ½è¯»å–åˆ°äº† envSharedValue è¿™ä¸ªå±æ€§çš„å€¼ã€‚</p>
<p>ä¸Šé¢çš„éƒ½æ˜¯åŒä¸€ä¸ªå¾®æœåŠ¡ä¸‹ï¼Œ<strong>é‚£ä¹ˆä¸åŒå¾®æœåŠ¡ä¹‹é—´å¯ä»¥ç¯å¢ƒå…±äº«å—ï¼Ÿ</strong></p>
<p>é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥æŒ‡å®šï¼š</p>
<ul>
<li>extension-configs</li>
<li>shared-configs</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span>
        <span class="token key atrule">extends-configs</span><span class="token punctuation">:</span> <span class="token comment"># å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># è¦å…±äº«çš„é…ç½®æ–‡ä»¶id</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment"># æ–‡ä»¶åç¼€å</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span> <span class="token comment"># å¤šå¾®æœåŠ¡é—´å…±äº«çš„é…ç½®åˆ—è¡¨</span>
          <span class="token punctuation">-</span> <span class="token key atrule">dataId</span><span class="token punctuation">:</span> common.yaml <span class="token comment"># è¦å…±äº«çš„é…ç½®æ–‡ä»¶id</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®ä¼˜å…ˆçº§-1"><a href="#é…ç½®ä¼˜å…ˆçº§-1" class="headerlink" title="é…ç½®ä¼˜å…ˆçº§"></a>é…ç½®ä¼˜å…ˆçº§</h2><p>å½“ nacosã€æœåŠ¡æœ¬åœ°åŒæ—¶<strong>å‡ºç°ç›¸åŒå±æ€§æ—¶</strong>ï¼Œä¼˜å…ˆçº§æœ‰é«˜ä½ä¹‹åˆ†ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092501.png"><img src="https://cdn.xn2001.com/img/2021/20210901092501.png!/format/webp" alt="img"></a></p>
<p>æ›´ç»†è‡´çš„é…ç½®</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092520.png"><img src="https://cdn.xn2001.com/img/2021/20210901092520.png!/format/webp" alt="img"></a></p>
<h1 id="Nacosé›†ç¾¤-1"><a href="#Nacosé›†ç¾¤-1" class="headerlink" title="Nacosé›†ç¾¤"></a>Nacosé›†ç¾¤</h1><h2 id="æ¶æ„ä»‹ç»"><a href="#æ¶æ„ä»‹ç»" class="headerlink" title="æ¶æ„ä»‹ç»"></a>æ¶æ„ä»‹ç»</h2><p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108181959897.png"><img src="https://cdn.xn2001.com/img/2021/202108181959897.png!/format/webp" alt="img"></a></p>
<p>å…¶ä¸­åŒ…å« 3 ä¸ªNacos èŠ‚ç‚¹ï¼Œç„¶åä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ Nginx ä»£ç† 3 ä¸ª Nacosï¼Œæˆ‘ä»¬è®¡åˆ’çš„ Nacos é›†ç¾¤å¦‚ä¸‹å›¾ï¼ŒMySQL çš„ä¸»ä»å¤åˆ¶åç»­å†æ·»åŠ ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108182000220.png"><img src="https://cdn.xn2001.com/img/2021/202108182000220.png!/format/webp" alt="img"></a></p>
<p>ä¸‰ä¸ª Nacos èŠ‚ç‚¹çš„åœ°å€</p>
<table>
<thead>
<tr>
<th align="left">èŠ‚ç‚¹</th>
<th align="left">ip</th>
<th align="left">port</th>
</tr>
</thead>
<tbody><tr>
<td align="left">nacos1</td>
<td align="left">192.168.150.1</td>
<td align="left">8845</td>
</tr>
<tr>
<td align="left">nacos2</td>
<td align="left">192.168.150.1</td>
<td align="left">8846</td>
</tr>
<tr>
<td align="left">nacos3</td>
<td align="left">192.168.150.1</td>
<td align="left">8847</td>
</tr>
</tbody></table>
<h2 id="åˆå§‹åŒ–æ•°æ®åº“-1"><a href="#åˆå§‹åŒ–æ•°æ®åº“-1" class="headerlink" title="åˆå§‹åŒ–æ•°æ®åº“"></a>åˆå§‹åŒ–æ•°æ®åº“</h2><p>Nacos é»˜è®¤æ•°æ®å­˜å‚¨åœ¨å†…åµŒæ•°æ®åº“ Derby ä¸­ï¼Œä¸å±äºç”Ÿäº§å¯ç”¨çš„æ•°æ®åº“ã€‚å®˜æ–¹æ¨èçš„æœ€ä½³å®è·µæ˜¯ä½¿ç”¨å¸¦æœ‰ä¸»ä»çš„é«˜å¯ç”¨æ•°æ®åº“é›†ç¾¤ï¼Œä¸»ä»æ¨¡å¼çš„é«˜å¯ç”¨æ•°æ®åº“ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥å•ç‚¹çš„æ•°æ®åº“ä¸ºä¾‹ã€‚</p>
<p>é¦–å…ˆæ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå‘½åä¸º nacosï¼Œè€Œåå¯¼å…¥ä¸‹é¢çš„ SQL</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_use<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>effect<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_aggr   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å†…å®¹'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¢åŠ ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_beta   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_info_tag   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = config_tags_relation   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = group_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>quota<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>usage<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span>

<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = his_config_info   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>app_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>md5<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_user<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>op_type<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>nid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¤šç§Ÿæˆ·æ”¹é€ '</span><span class="token punctuation">;</span>


<span class="token comment">/******************************************/</span>
<span class="token comment">/*   æ•°æ®åº“å…¨å = nacos_config   */</span>
<span class="token comment">/*   è¡¨åç§° = tenant_capacity   */</span>
<span class="token comment">/******************************************/</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>quota<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>usage<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span>


<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>kp<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_source<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>kp<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>users<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>enabled<span class="token punctuation">`</span></span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>roles<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>permissions<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>resource<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>action<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>role<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>resource<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>action<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é…ç½®Nacos-1"><a href="#é…ç½®Nacos-1" class="headerlink" title="é…ç½®Nacos"></a>é…ç½®Nacos</h2><p>è¿›å…¥ nacos çš„ conf ç›®å½•ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ cluster.conf.exampleï¼Œé‡å‘½åä¸º cluster.conf</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108182004564.png"><img src="https://cdn.xn2001.com/img/2021/202108182004564.png!/format/webp" alt="img"></a></p>
<p>æ·»åŠ å†…å®¹</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1:8845
127.0.0.1.8846
127.0.0.1.8847<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åä¿®æ”¹ application.properties æ–‡ä»¶ï¼Œæ·»åŠ æ•°æ®åº“é…ç½®</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">spring.datasource.platform</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>
<span class="token key attr-name">db.num</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token key attr-name">db.url.0</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span>
<span class="token key attr-name">db.user.0</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">db.password.0</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å°† nacos æ–‡ä»¶å¤¹å¤åˆ¶ä¸‰ä»½ï¼Œåˆ†åˆ«å‘½åä¸ºï¼šnacos1ã€nacos2ã€nacos3</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108182004103.png"><img src="https://cdn.xn2001.com/img/2021/202108182004103.png!/format/webp" alt="img"></a></p>
<p>ç„¶ååˆ†åˆ«ä¿®æ”¹ä¸‰ä¸ªæ–‡ä»¶å¤¹ä¸­çš„ application.propertiesï¼Œ</p>
<p>nacos1</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8845</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>nacos2</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8846</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>nacos3</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">server.port</span><span class="token punctuation">=</span><span class="token value attr-value">8847</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶ååˆ†åˆ«å¯åŠ¨ä¸‰ä¸ª nacos</p>
<pre class="line-numbers language-none"><code class="language-none">startup.cmd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Nginxåå‘ä»£ç†-1"><a href="#Nginxåå‘ä»£ç†-1" class="headerlink" title="Nginxåå‘ä»£ç†"></a>Nginxåå‘ä»£ç†</h2><p>ä¿®æ”¹ nginx æ–‡ä»¶å¤¹ä¸‹çš„ conf/nginx.conf æ–‡ä»¶ï¼Œé…ç½®å¦‚ä¸‹</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">upstream</span> nacos-cluster</span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8845</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8846</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server</span> 127.0.0.1:8847</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">location</span> /nacos</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://nacos-cluster</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨ nginxï¼Œåœ¨æµè§ˆå™¨è®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost/nacos">http://localhost/nacos</a></p>
<p>åœ¨ä»£ç ä¸­çš„ application.yml æ–‡ä»¶é…ç½®æ”¹ä¸ºå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">80</span> <span class="token comment"># Nacosåœ°å€</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®é™…éƒ¨ç½²æ—¶ï¼Œéœ€è¦ç»™åšåå‘ä»£ç†çš„ Nginx æœåŠ¡å™¨è®¾ç½®ä¸€ä¸ªåŸŸåï¼Œè¿™æ ·åç»­å¦‚æœæœ‰æœåŠ¡å™¨è¿ç§» Nacos çš„å®¢æˆ·ç«¯ä¹Ÿæ— éœ€æ›´æ”¹é…ç½®ã€‚Nacos çš„å„ä¸ªèŠ‚ç‚¹åº”è¯¥éƒ¨ç½²åˆ°å¤šä¸ªä¸åŒæœåŠ¡å™¨ï¼Œåšå¥½å®¹ç¾å’Œéš”ç¦»å·¥ä½œã€‚</p>
<h1 id="Feignè¿œç¨‹è°ƒç”¨-1"><a href="#Feignè¿œç¨‹è°ƒç”¨-1" class="headerlink" title="Feignè¿œç¨‹è°ƒç”¨"></a>Feignè¿œç¨‹è°ƒç”¨</h1><blockquote>
<p>ä»£ç å‚è€ƒ</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign">https://gitee.com/xn2001/cloudcode/tree/master/06-cloud-feign</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign">https://github.com/lexinhu/cloudcode/tree/master/06-cloud-feign</a></p>
</blockquote>
<p>æˆ‘ä»¬ä»¥å‰åˆ©ç”¨ RestTemplate å‘èµ·è¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092616.png"><img src="https://cdn.xn2001.com/img/2021/20210901092616.png!/format/webp" alt="img"></a></p>
<ul>
<li>ä»£ç å¯è¯»æ€§å·®ï¼Œç¼–ç¨‹ä½“éªŒä¸ç»Ÿä¸€</li>
<li>å‚æ•°å¤æ‚URLéš¾ä»¥ç»´æŠ¤</li>
</ul>
<p>Feign æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ http å®¢æˆ·ç«¯ï¼Œå®˜æ–¹åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a></p>
<p>å…¶ä½œç”¨å°±æ˜¯å¸®åŠ©æˆ‘ä»¬<strong>ä¼˜é›…çš„å®ç° http è¯·æ±‚çš„å‘é€</strong>ï¼Œè§£å†³ä¸Šé¢æåˆ°çš„é—®é¢˜ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092639.png"><img src="https://cdn.xn2001.com/img/2021/20210901092639.png!/format/webp" alt="img"></a></p>
<h2 id="Feignä½¿ç”¨-1"><a href="#Feignä½¿ç”¨-1" class="headerlink" title="Feignä½¿ç”¨"></a>Feignä½¿ç”¨</h2><p><strong>å¼•å…¥ä¾èµ–</strong></p>
<p>æˆ‘ä»¬åœ¨ order-service å¼•å…¥ feign ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ·»åŠ æ³¨è§£</strong></p>
<p>åœ¨ order-service å¯åŠ¨ç±»æ·»åŠ æ³¨è§£å¼€å¯ Feign</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092704.png"><img src="https://cdn.xn2001.com/img/2021/20210901092704.png!/format/webp" alt="img"></a></p>
<p><strong>è¯·æ±‚æ¥å£</strong></p>
<p>åœ¨ order-service ä¸­æ–°å»ºä¸€ä¸ªæ¥å£ï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>order<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>xn2001<span class="token punctuation">.</span>order<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"userservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user/{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>@FeignClient("userservice")</code>ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯å¾®æœåŠ¡å</p>
<p><code>@GetMapping("/user/{id}")</code>ï¼šå…¶ä¸­å‚æ•°å¡«å†™çš„æ˜¯è¯·æ±‚è·¯å¾„</p>
<p>è¿™ä¸ªå®¢æˆ·ç«¯ä¸»è¦æ˜¯åŸºäº SpringMVC çš„æ³¨è§£ <code>@GetMapping</code> æ¥å£°æ˜è¿œç¨‹è°ƒç”¨çš„ä¿¡æ¯</p>
<p>Feign å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘é€ http è¯·æ±‚ï¼Œæ— éœ€è‡ªå·±ä½¿ç”¨ RestTemplate æ¥å‘é€äº†ã€‚</p>
<p><strong>æµ‹è¯•</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserClient</span> userClient<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">queryOrderAndUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.æŸ¥è¯¢è®¢å•</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO: 2021/8/20 ä½¿ç”¨feignè¿œç¨‹è°ƒç”¨</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userClient<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. å°†ç”¨æˆ·ä¿¡æ¯å°è£…è¿›è®¢å•</span>
    order<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.è¿”å›</span>
    <span class="token keyword">return</span> order<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è‡ªå®šä¹‰é…ç½®-1"><a href="#è‡ªå®šä¹‰é…ç½®-1" class="headerlink" title="è‡ªå®šä¹‰é…ç½®"></a>è‡ªå®šä¹‰é…ç½®</h2><p>Feign å¯ä»¥æ”¯æŒå¾ˆå¤šçš„è‡ªå®šä¹‰é…ç½®ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th align="left">ç±»å‹</th>
<th align="left">ä½œç”¨</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>feign.Logger.Level</strong></td>
<td align="left">ä¿®æ”¹æ—¥å¿—çº§åˆ«</td>
<td align="left">åŒ…å«å››ç§ä¸åŒçš„çº§åˆ«ï¼šNONEã€BASICã€HEADERSã€FULL</td>
</tr>
<tr>
<td align="left">feign.codec.Decoder</td>
<td align="left">å“åº”ç»“æœçš„è§£æå™¨</td>
<td align="left">httpè¿œç¨‹è°ƒç”¨çš„ç»“æœåšè§£æï¼Œä¾‹å¦‚è§£æjsonå­—ç¬¦ä¸²ä¸ºjavaå¯¹è±¡</td>
</tr>
<tr>
<td align="left">feign.codec.Encoder</td>
<td align="left">è¯·æ±‚å‚æ•°ç¼–ç </td>
<td align="left">å°†è¯·æ±‚å‚æ•°ç¼–ç ï¼Œä¾¿äºé€šè¿‡httpè¯·æ±‚å‘é€</td>
</tr>
<tr>
<td align="left">feign.Contract</td>
<td align="left">æ”¯æŒçš„æ³¨è§£æ ¼å¼</td>
<td align="left">é»˜è®¤æ˜¯SpringMVCçš„æ³¨è§£</td>
</tr>
<tr>
<td align="left">feign.Retryer</td>
<td align="left">å¤±è´¥é‡è¯•æœºåˆ¶</td>
<td align="left">è¯·æ±‚å¤±è´¥çš„é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ï¼Œä¸è¿‡ä¼šä½¿ç”¨Ribbonçš„é‡è¯•</td>
</tr>
</tbody></table>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé»˜è®¤å€¼å°±èƒ½æ»¡è¶³æˆ‘ä»¬ä½¿ç”¨ï¼Œå¦‚æœè¦è‡ªå®šä¹‰æ—¶ï¼Œåªéœ€è¦åˆ›å»ºè‡ªå®šä¹‰çš„ @Bean è¦†ç›–é»˜è®¤ Bean å³å¯ã€‚ä¸‹é¢ä»¥æ—¥å¿—ä¸ºä¾‹æ¥æ¼”ç¤ºå¦‚ä½•è‡ªå®šä¹‰é…ç½®ã€‚</p>
<p>åŸºäºé…ç½®æ–‡ä»¶ä¿®æ”¹ feign çš„æ—¥å¿—çº§åˆ«å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">userservice</span><span class="token punctuation">:</span> <span class="token comment"># é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  æ—¥å¿—çº§åˆ« </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ä¹Ÿå¯ä»¥é’ˆå¯¹æ‰€æœ‰æœåŠ¡</strong>ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>  
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span> 
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># è¿™é‡Œç”¨defaultå°±æ˜¯å…¨å±€é…ç½®ï¼Œå¦‚æœæ˜¯å†™æœåŠ¡åç§°ï¼Œåˆ™æ˜¯é’ˆå¯¹æŸä¸ªå¾®æœåŠ¡çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> FULL <span class="token comment">#  æ—¥å¿—çº§åˆ« </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è€Œæ—¥å¿—çš„çº§åˆ«åˆ†ä¸ºå››ç§ï¼š</p>
<ul>
<li>NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚</li>
<li>BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´</li>
<li>HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯</li>
<li>FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®</li>
</ul>
<p>ä¹Ÿå¯ä»¥åŸºäº <strong>Java ä»£ç </strong>æ¥ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œå…ˆå£°æ˜ä¸€ä¸ªç±»ï¼Œç„¶åå£°æ˜ä¸€ä¸ª Logger.Level çš„å¯¹è±¡</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFeignConfiguration</span>  <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLogLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>BASIC<span class="token punctuation">;</span> <span class="token comment">// æ—¥å¿—çº§åˆ«ä¸ºBASIC</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœè¦<strong>å…¨å±€ç”Ÿæ•ˆ</strong>ï¼Œå°†å…¶æ”¾åˆ°å¯åŠ¨ç±»çš„ <code>@EnableFeignClients</code> è¿™ä¸ªæ³¨è§£ä¸­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>defaultConfiguration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¦‚æœæ˜¯<strong>å±€éƒ¨ç”Ÿæ•ˆ</strong>ï¼Œåˆ™æŠŠå®ƒæ”¾åˆ°å¯¹åº”çš„ <code>@FeignClient</code> è¿™ä¸ªæ³¨è§£ä¸­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"userservice"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">DefaultFeignConfiguration</span> <span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="æ€§èƒ½ä¼˜åŒ–-1"><a href="#æ€§èƒ½ä¼˜åŒ–-1" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><p>Feign åº•å±‚å‘èµ· http è¯·æ±‚ï¼Œä¾èµ–äºå…¶å®ƒçš„æ¡†æ¶ã€‚å…¶åº•å±‚å®¢æˆ·ç«¯å®ç°æœ‰ï¼š</p>
<ul>
<li><strong>URLConnection</strong>ï¼šé»˜è®¤å®ç°ï¼Œä¸æ”¯æŒè¿æ¥æ± </li>
<li><strong>Apache HttpClient</strong> ï¼šæ”¯æŒè¿æ¥æ± </li>
<li><strong>OKHttp</strong>ï¼šæ”¯æŒè¿æ¥æ± </li>
</ul>
<p>å› æ­¤æé«˜ Feign æ€§èƒ½çš„ä¸»è¦æ‰‹æ®µå°±æ˜¯ä½¿ç”¨<strong>è¿æ¥æ± </strong>ä»£æ›¿é»˜è®¤çš„ URLConnection</p>
<p>å¦å¤–ï¼Œæ—¥å¿—çº§åˆ«åº”è¯¥å°½é‡ç”¨ basic/noneï¼Œå¯ä»¥æœ‰æ•ˆæé«˜æ€§èƒ½ã€‚</p>
<p><strong>è¿™é‡Œæˆ‘ä»¬ç”¨ Apache çš„HttpClientæ¥æ¼”ç¤ºè¿æ¥æ± ã€‚</strong></p>
<p>åœ¨ order-service çš„ pom æ–‡ä»¶ä¸­å¼•å…¥ HttpClient ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--httpClientçš„ä¾èµ– --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>é…ç½®è¿æ¥æ± </strong></p>
<p>åœ¨ order-service çš„ application.yml ä¸­æ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token comment"># defaultå…¨å±€çš„é…ç½®</span>
        <span class="token key atrule">loggerLevel</span><span class="token punctuation">:</span> BASIC <span class="token comment"># æ—¥å¿—çº§åˆ«ï¼ŒBASICå°±æ˜¯åŸºæœ¬çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># å¼€å¯feignå¯¹HttpClientçš„æ”¯æŒ</span>
    <span class="token key atrule">max-connections</span><span class="token punctuation">:</span> <span class="token number">200</span> <span class="token comment"># æœ€å¤§çš„è¿æ¥æ•°</span>
    <span class="token key atrule">max-connections-per-route</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token comment"># æ¯ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ FeignClientFactoryBean ä¸­çš„ loadBalance æ–¹æ³•ä¸­æ‰“æ–­ç‚¹</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092729.png"><img src="https://cdn.xn2001.com/img/2021/20210901092729.png!/format/webp" alt="img"></a></p>
<p>Debug æ–¹å¼å¯åŠ¨ order-service æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ clientï¼Œåº•å±‚å°±æ˜¯ HttpClient</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092737.png"><img src="https://cdn.xn2001.com/img/2021/20210901092737.png!/format/webp" alt="img"></a></p>
<h2 id="æœ€ä½³å®è·µ-1"><a href="#æœ€ä½³å®è·µ-1" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="ç»§æ‰¿æ–¹å¼-1"><a href="#ç»§æ‰¿æ–¹å¼-1" class="headerlink" title="ç»§æ‰¿æ–¹å¼"></a>ç»§æ‰¿æ–¹å¼</h3><p>ä¸€æ ·çš„ä»£ç å¯ä»¥é€šè¿‡ç»§æ‰¿æ¥å…±äº«ï¼š</p>
<p>1ï¼‰å®šä¹‰ä¸€ä¸ª API æ¥å£ï¼Œåˆ©ç”¨å®šä¹‰æ–¹æ³•ï¼Œå¹¶åŸºäº SpringMVC æ³¨è§£åšå£°æ˜</p>
<p>2ï¼‰Feign å®¢æˆ·ç«¯ã€Controller éƒ½é›†æˆè¯¥æ¥å£</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092803.png"><img src="https://cdn.xn2001.com/img/2021/20210901092803.png!/format/webp" alt="img"></a></p>
<p>ä¼˜ç‚¹</p>
<ul>
<li>ç®€å•</li>
<li>å®ç°äº†ä»£ç å…±äº«</li>
</ul>
<p>ç¼ºç‚¹</p>
<ul>
<li>æœåŠ¡æä¾›æ–¹ã€æœåŠ¡æ¶ˆè´¹æ–¹ç´§è€¦åˆ</li>
<li>å‚æ•°åˆ—è¡¨ä¸­çš„æ³¨è§£æ˜ å°„å¹¶ä¸ä¼šç»§æ‰¿ï¼Œå› æ­¤ Controller ä¸­å¿…é¡»å†æ¬¡å£°æ˜æ–¹æ³•ã€å‚æ•°åˆ—è¡¨ã€æ³¨è§£</li>
</ul>
<h3 id="æŠ½å–æ–¹å¼-1"><a href="#æŠ½å–æ–¹å¼-1" class="headerlink" title="æŠ½å–æ–¹å¼"></a>æŠ½å–æ–¹å¼</h3><p>å°† FeignClient æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå¹¶ä¸”æŠŠæ¥å£æœ‰å…³çš„ pojoã€é»˜è®¤çš„ Feign é…ç½®éƒ½æ”¾åˆ°è¿™ä¸ªæ¨¡å—ä¸­ï¼Œæä¾›ç»™æ‰€æœ‰æ¶ˆè´¹è€…ä½¿ç”¨ã€‚</p>
<p>ä¾‹å¦‚ï¼šå°† UserClientã€Userã€Feign çš„é»˜è®¤é…ç½®éƒ½æŠ½å–åˆ°ä¸€ä¸ª feign-api åŒ…ä¸­ï¼Œæ‰€æœ‰å¾®æœåŠ¡å¼•ç”¨è¯¥ä¾èµ–åŒ…ï¼Œå³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092811.png"><img src="https://cdn.xn2001.com/img/2021/20210901092811.png!/format/webp" alt="img"></a></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç”¨è¯¥æ–¹æ³•åœ¨ä»£ç ä¸­å®ç°</p>
<p><strong>é¦–å…ˆåˆ›å»ºä¸€ä¸ª moduleï¼Œå‘½åä¸º feign-api</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092835.png"><img src="https://cdn.xn2001.com/img/2021/20210901092835.png!/format/webp" alt="img"></a></p>
<p>åœ¨ feign-api ä¸­ç„¶åå¼•å…¥ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>order-serviceä¸­ çš„ UserClientã€User éƒ½å¤åˆ¶åˆ° feign-api é¡¹ç›®ä¸­</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092848.png"><img src="https://cdn.xn2001.com/img/2021/20210901092848.png!/format/webp" alt="img"></a></p>
<p>æ¥ä¸‹æ¥åœ¨ order-service ä¸­ä½¿ç”¨ feign-api</p>
<p>ç”±äºæˆ‘ä»¬å·²ç»å°† UserClientã€User æ”¾åœ¨ fegin-api ä¸­å…±äº«äº† ï¼Œæ‰€ä»¥å¯ä»¥åˆ é™¤ order-service ä¸­çš„ UserClientã€Userï¼Œç„¶ååœ¨ order-service ä¸­å¼•å…¥ feign-api</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xn2001.feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ä¿®æ”¹æ³¨è§£</strong></p>
<p>å½“å®šä¹‰çš„ FeignClient ä¸åœ¨ SpringBootApplication çš„æ‰«æåŒ…èŒƒå›´ä¸‹æ—¶ï¼Œè¿™äº› FeignClient å°±ä¸èƒ½ä½¿ç”¨ã€‚</p>
<p>ä¿®æ”¹ order-service å¯åŠ¨ç±»ä¸Šçš„ <code>@EnableFeignClients</code> æ³¨è§£</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.xn2001.feign.clients"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="Gatewayç½‘å…³-1"><a href="#Gatewayç½‘å…³-1" class="headerlink" title="Gatewayç½‘å…³"></a>Gatewayç½‘å…³</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway">https://gitee.com/xn2001/cloudcode/tree/master/07-cloud-gateway</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway">https://github.com/lexinhu/cloudcode/tree/master/07-cloud-gateway</a></p>
</blockquote>
<p>Spring Cloud Gateway æ˜¯ Spring Cloud çš„ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ˜¯åŸºäº Spring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰å“åº”å¼ç¼–ç¨‹å’Œäº‹ä»¶æµæŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p>
<p>Gateway ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å®ˆé—¨ç¥ï¼Œ<strong>æ‰€æœ‰å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚</strong></p>
<p>ç½‘å…³çš„<strong>æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§</strong>ï¼š</p>
<ul>
<li>è¯·æ±‚è·¯ç”±</li>
<li>æƒé™æ§åˆ¶</li>
<li>é™æµ</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210901092857.png"><img src="https://cdn.xn2001.com/img/2021/20210901092857.png!/format/webp" alt="img"></a></p>
<p><strong>æƒé™æ§åˆ¶</strong>ï¼šç½‘å…³ä½œä¸ºå¾®æœåŠ¡å…¥å£ï¼Œéœ€è¦æ ¡éªŒç”¨æˆ·æ˜¯æ˜¯å¦æœ‰è¯·æ±‚èµ„æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‹¦æˆªã€‚</p>
<p><strong>è·¯ç”±å’Œè´Ÿè½½å‡è¡¡</strong>ï¼šä¸€åˆ‡è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ gatewayï¼Œä½†ç½‘å…³ä¸å¤„ç†ä¸šåŠ¡ï¼Œè€Œæ˜¯æ ¹æ®æŸç§è§„åˆ™ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°æŸä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè·¯ç”±ã€‚å½“ç„¶è·¯ç”±çš„ç›®æ ‡æœåŠ¡æœ‰å¤šä¸ªæ—¶ï¼Œè¿˜éœ€è¦åšè´Ÿè½½å‡è¡¡ã€‚</p>
<p><strong>é™æµ</strong>ï¼šå½“è¯·æ±‚æµé‡è¿‡é«˜æ—¶ï¼Œåœ¨ç½‘å…³ä¸­æŒ‰ç…§ä¸‹æµçš„å¾®æœåŠ¡èƒ½å¤Ÿæ¥å—çš„é€Ÿåº¦æ¥æ”¾è¡Œè¯·æ±‚ï¼Œé¿å…æœåŠ¡å‹åŠ›è¿‡å¤§ã€‚</p>
<p>åœ¨ SpringCloud ä¸­ç½‘å…³çš„å®ç°åŒ…æ‹¬ä¸¤ç§ï¼š</p>
<ul>
<li>gateway</li>
<li>zuul</li>
</ul>
<p>Zuul æ˜¯åŸºäº Servlet å®ç°ï¼Œå±äºé˜»å¡å¼ç¼–ç¨‹ã€‚è€Œ Spring Cloud Gateway åˆ™æ˜¯åŸºäº Spring5 ä¸­æä¾›çš„WebFluxï¼Œå±äºå“åº”å¼ç¼–ç¨‹çš„å®ç°ï¼Œå…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<h2 id="å…¥é—¨ä½¿ç”¨-1"><a href="#å…¥é—¨ä½¿ç”¨-1" class="headerlink" title="å…¥é—¨ä½¿ç”¨"></a>å…¥é—¨ä½¿ç”¨</h2><ol>
<li>åˆ›å»º SpringBoot å·¥ç¨‹ gatewayï¼Œå¼•å…¥ç½‘å…³ä¾èµ–</li>
<li>ç¼–å†™å¯åŠ¨ç±»</li>
<li>ç¼–å†™åŸºç¡€é…ç½®å’Œè·¯ç”±è§„åˆ™</li>
<li>å¯åŠ¨ç½‘å…³æœåŠ¡è¿›è¡Œæµ‹è¯•</li>
</ol>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--ç½‘å…³--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--nacosæœåŠ¡å‘ç°ä¾èµ–--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ›å»º application.yml æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment"># ç½‘å…³ç«¯å£</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway <span class="token comment"># æœåŠ¡åç§°</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># nacosåœ°å€</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># ç½‘å…³è·¯ç”±é…ç½®</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å°†ç¬¦åˆ<code>Path</code> è§„åˆ™çš„ä¸€åˆ‡è¯·æ±‚ï¼Œéƒ½ä»£ç†åˆ° <code>uri</code>å‚æ•°æŒ‡å®šçš„åœ°å€ã€‚</p>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† <code>/user/**</code> å¼€å¤´çš„è¯·æ±‚ï¼Œä»£ç†åˆ° <code>lb://userservice</code>ï¼Œå…¶ä¸­ lb æ˜¯è´Ÿè½½å‡è¡¡(LoadBalance)ï¼Œæ ¹æ®æœåŠ¡åæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</p>
<p>é‡å¯ç½‘å…³ï¼Œè®¿é—® <a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010/user/1</a> æ—¶ï¼Œç¬¦åˆ <code>/user/**</code> è§„åˆ™ï¼Œè¯·æ±‚è½¬å‘åˆ° uriï¼š<a target="_blank" rel="noopener" href="http://userservice/user/1">http://userservice/user/1</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108220125749.png"><img src="https://cdn.xn2001.com/img/2021/202108220125749.png!/format/webp" alt="img"></a></p>
<p>å¤šä¸ª predicates çš„è¯ï¼Œè¦åŒæ—¶æ»¡è¶³è§„åˆ™ï¼Œä¸‹æ–‡æœ‰ä¾‹å­ã€‚</p>
<h2 id="æµç¨‹å›¾-1"><a href="#æµç¨‹å›¾-1" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h2><p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108220127419.png"><img src="https://cdn.xn2001.com/img/2021/202108220127419.png!/format/webp" alt="img"></a></p>
<p>è·¯ç”±é…ç½®åŒ…æ‹¬ï¼š</p>
<ol>
<li>è·¯ç”±idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º</li>
<li>è·¯ç”±ç›®æ ‡ï¼ˆuriï¼‰ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œhttpä»£è¡¨å›ºå®šåœ°å€ï¼Œlbä»£è¡¨æ ¹æ®æœåŠ¡åè´Ÿè½½å‡è¡¡</li>
<li>è·¯ç”±æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šåˆ¤æ–­è·¯ç”±çš„è§„åˆ™</li>
<li>è·¯ç”±è¿‡æ»¤å™¨ï¼ˆfiltersï¼‰ï¼šå¯¹è¯·æ±‚æˆ–å“åº”åšå¤„ç†</li>
</ol>
<h2 id="æ–­è¨€å·¥å‚-1"><a href="#æ–­è¨€å·¥å‚-1" class="headerlink" title="æ–­è¨€å·¥å‚"></a>æ–­è¨€å·¥å‚</h2><p>æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å†™çš„æ–­è¨€è§„åˆ™åªæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢« Predicate Factory è¯»å–å¹¶å¤„ç†ï¼Œè½¬å˜ä¸ºè·¯ç”±åˆ¤æ–­çš„æ¡ä»¶ã€‚</p>
<p>ä¾‹å¦‚ <code>Path=/user/**</code> æ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œè¿™ä¸ªè§„åˆ™æ˜¯ç”±</p>
<p><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code> ç±»æ¥å¤„ç†çš„ï¼Œåƒè¿™æ ·çš„æ–­è¨€å·¥å‚åœ¨ Spring Cloud Gateway è¿˜æœ‰åå‡ ä¸ª</p>
<table>
<thead>
<tr>
<th align="left">åç§°</th>
<th align="left">è¯´æ˜</th>
<th align="left">ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td align="left">After</td>
<td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚</td>
<td align="left">- After=2037-01-20T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="left">Before</td>
<td align="left">æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
<td align="left">- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</td>
</tr>
<tr>
<td align="left">Between</td>
<td align="left">æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
<td align="left">- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</td>
</tr>
<tr>
<td align="left">Cookie</td>
<td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›cookie</td>
<td align="left">- Cookie=chocolate, ch.p</td>
</tr>
<tr>
<td align="left">Header</td>
<td align="left">è¯·æ±‚å¿…é¡»åŒ…å«æŸäº›header</td>
<td align="left">- Header=X-Request-Id, \d+</td>
</tr>
<tr>
<td align="left">Host</td>
<td align="left">è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ªhostï¼ˆåŸŸåï¼‰</td>
<td align="left">- Host=<code>**.somehost.org</code>, <code>**.anotherhost.org</code></td>
</tr>
<tr>
<td align="left">Method</td>
<td align="left">è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼</td>
<td align="left">- Method=GET,POST</td>
</tr>
<tr>
<td align="left">Path</td>
<td align="left">è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™</td>
<td align="left">- Path=/red/{segment},/blue/**</td>
</tr>
<tr>
<td align="left">Query</td>
<td align="left">è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°</td>
<td align="left">- Query=name, Jackæˆ–è€…- Query=name</td>
</tr>
<tr>
<td align="left">RemoteAddr</td>
<td align="left">è¯·æ±‚è€…çš„ipå¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´</td>
<td align="left">- RemoteAddr=192.168.1.1/24</td>
</tr>
<tr>
<td align="left">Weight</td>
<td align="left">æƒé‡å¤„ç†</td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories</a></p>
</blockquote>
<p>ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æŒæ¡ Pathï¼ŒåŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ï¼Œå°±å¯ä»¥åº”å¯¹å„ç§å·¥ä½œåœºæ™¯äº†ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>
  <span class="token punctuation">-</span> After=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åƒè¿™æ ·çš„è§„åˆ™ï¼Œç°åœ¨æ˜¯ 2021å¹´8æœˆ22æ—¥01:32:42ï¼Œå¾ˆæ˜æ˜¾ After æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯ä»¥ä¸ä¼šè½¬å‘ï¼Œè·¯ç”±ä¸èµ·ä½œç”¨ã€‚</p>
<h2 id="è¿‡æ»¤å™¨å·¥å‚-1"><a href="#è¿‡æ»¤å™¨å·¥å‚-1" class="headerlink" title="è¿‡æ»¤å™¨å·¥å‚"></a>è¿‡æ»¤å™¨å·¥å‚</h2><p>GatewayFilter æ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108220133487.png"><img src="https://cdn.xn2001.com/img/2021/202108220133487.png!/format/webp" alt="img"></a></p>
<p>Springæä¾›äº†31ç§ä¸åŒçš„è·¯ç”±è¿‡æ»¤å™¨å·¥å‚ã€‚</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories</a></p>
</blockquote>
<table>
<thead>
<tr>
<th align="left"><strong>åç§°</strong></th>
<th align="left"><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">AddRequestHeader</td>
<td align="left">ç»™å½“å‰è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´</td>
</tr>
<tr>
<td align="left">RemoveRequestHeader</td>
<td align="left">ç§»é™¤è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚å¤´</td>
</tr>
<tr>
<td align="left">AddResponseHeader</td>
<td align="left">ç»™å“åº”ç»“æœä¸­æ·»åŠ ä¸€ä¸ªå“åº”å¤´</td>
</tr>
<tr>
<td align="left">RemoveResponseHeader</td>
<td align="left">ä»å“åº”ç»“æœä¸­ç§»é™¤æœ‰ä¸€ä¸ªå“åº”å¤´</td>
</tr>
<tr>
<td align="left">RequestRateLimiter</td>
<td align="left">é™åˆ¶è¯·æ±‚çš„æµé‡</td>
</tr>
</tbody></table>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥ AddRequestHeader ä¸ºä¾‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108220139913.png"><img src="https://cdn.xn2001.com/img/2021/202108220139913.png!/format/webp" alt="img"></a></p>
<p><strong>éœ€æ±‚</strong>ï¼šç»™æ‰€æœ‰è¿›å…¥ userservice çš„è¯·æ±‚æ·»åŠ ä¸€ä¸ªè¯·æ±‚å¤´ï¼š<code>sign=xn2001.com is eternal</code></p>
<p>åªéœ€è¦ä¿®æ”¹ gateway æœåŠ¡çš„ application.ymlæ–‡ä»¶ï¼Œæ·»åŠ è·¯ç”±è¿‡æ»¤å³å¯ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment"># ç½‘å…³è·¯ç”±é…ç½®</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment"># è·¯ç”±idï¼Œè‡ªå®šä¹‰ï¼Œåªè¦å”¯ä¸€å³å¯</span>
          <span class="token comment"># uri: http://127.0.0.1:8081 # è·¯ç”±çš„ç›®æ ‡åœ°å€ httpå°±æ˜¯å›ºå®šåœ°å€</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment"># è·¯ç”±çš„ç›®æ ‡åœ°å€ lbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåé¢è·ŸæœåŠ¡åç§°</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment"># è·¯ç”±æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™çš„æ¡ä»¶</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span> <span class="token comment"># è¿™ä¸ªæ˜¯æŒ‰ç…§è·¯å¾„åŒ¹é…ï¼Œåªè¦ä»¥/user/å¼€å¤´å°±ç¬¦åˆè¦æ±‚</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># æ·»åŠ è¯·æ±‚å¤´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä½•éªŒè¯ï¼Œæˆ‘ä»¬ä¿®æ”¹ userservice ä¸­çš„ä¸€ä¸ªæ¥å£</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"sign"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sign<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡å¯ä¸¤ä¸ªæœåŠ¡ï¼Œè®¿é—®ï¼š<a target="_blank" rel="noopener" href="http://localhost:10010/user/1">http://localhost:10010/user/1</a></p>
<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°å‡ºäº†è¿™ä¸ªè¯·æ±‚å¤´</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108220145565.png"><img src="https://cdn.xn2001.com/img/2021/202108220145565.png!/format/webp" alt="img"></a></p>
<p>å½“ç„¶ï¼ŒGateway ä¹Ÿæ˜¯æœ‰<strong>å…¨å±€è¿‡æ»¤å™¨</strong>çš„ï¼Œå¦‚æœè¦<strong>å¯¹æ‰€æœ‰çš„è·¯ç”±éƒ½ç”Ÿæ•ˆ</strong>ï¼Œåˆ™å¯ä»¥å°†è¿‡æ»¤å™¨å·¥å‚å†™åˆ° default-filters ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> AddRequestHeader=sign<span class="token punctuation">,</span> xn2001.com is eternal <span class="token comment"># æ·»åŠ è¯·æ±‚å¤´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å…¨å±€è¿‡æ»¤å™¨-1"><a href="#å…¨å±€è¿‡æ»¤å™¨-1" class="headerlink" title="å…¨å±€è¿‡æ»¤å™¨"></a>å…¨å±€è¿‡æ»¤å™¨</h2><p>ä¸Šé¢ä»‹ç»çš„è¿‡æ»¤å™¨å·¥å‚ï¼Œç½‘å…³æä¾›äº† 31 ç§ï¼Œä½†æ¯ä¸€ç§è¿‡æ»¤å™¨çš„ä½œç”¨éƒ½æ˜¯å›ºå®šçš„ã€‚<strong>å¦‚æœæˆ‘ä»¬å¸Œæœ›æ‹¦æˆªè¯·æ±‚ï¼Œåšè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åˆ™æ²¡åŠæ³•å®ç°</strong>ã€‚</p>
<p>å…¨å±€è¿‡æ»¤å™¨çš„ä½œç”¨ä¹Ÿæ˜¯å¤„ç†ä¸€åˆ‡è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡å“åº”ï¼Œ<strong>ä¸ GatewayFilter çš„ä½œç”¨ä¸€æ ·</strong>ã€‚åŒºåˆ«åœ¨äº GlobalFilter çš„é€»è¾‘å¯ä»¥<strong>å†™ä»£ç æ¥è‡ªå®šä¹‰è§„åˆ™</strong>ï¼›è€Œ GatewayFilter é€šè¿‡é…ç½®å®šä¹‰ï¼Œå¤„ç†é€»è¾‘æ˜¯å›ºå®šçš„ã€‚</p>
<p><strong>éœ€æ±‚</strong>ï¼šå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªè¯·æ±‚ï¼Œåˆ¤æ–­è¯·æ±‚çš„å‚æ•°æ˜¯å¦æ»¡è¶³ä¸‹é¢æ¡ä»¶</p>
<ul>
<li>å‚æ•°ä¸­æ˜¯å¦æœ‰ authorization</li>
<li>authorization å‚æ•°å€¼æ˜¯å¦ä¸º admin</li>
</ul>
<p>å¦‚æœåŒæ—¶æ»¡è¶³åˆ™æ”¾è¡Œï¼Œå¦åˆ™æ‹¦æˆªã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token comment">// æµ‹è¯•ï¼šhttp://localhost:10010/order/101?authorization=admin</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ç¬¬ä¸€ä¸ª authorization å‚æ•°</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// æ”¾è¡Œ</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®¾ç½®æ‹¦æˆªçŠ¶æ€ç ä¿¡æ¯</span>
        exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®æ‹¦æˆª</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼Œå€¼è¶Šä½ä¼˜å…ˆçº§è¶Šé«˜</span>
    <span class="token comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨ @Order æ³¨è§£</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è¿‡æ»¤å™¨é¡ºåº-1"><a href="#è¿‡æ»¤å™¨é¡ºåº-1" class="headerlink" title="è¿‡æ»¤å™¨é¡ºåº"></a>è¿‡æ»¤å™¨é¡ºåº</h2><p>è¯·æ±‚è¿›å…¥ç½‘å…³ä¼šç¢°åˆ°ä¸‰ç±»è¿‡æ»¤å™¨ï¼šDefaultFilterã€å½“å‰è·¯ç”±çš„è¿‡æ»¤å™¨ã€GlobalFilterï¼›</p>
<p>è¯·æ±‚è·¯ç”±åï¼Œä¼šå°†ä¸‰è€…åˆå¹¶åˆ°ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼ˆé›†åˆï¼‰ä¸­ï¼Œæ’åºåä¾æ¬¡æ‰§è¡Œæ¯ä¸ªè¿‡æ»¤å™¨.</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/202108230002747.png"><img src="https://cdn.xn2001.com/img/2021/202108230002747.png!/format/webp" alt="img"></a></p>
<p>æ’åºçš„è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<ul>
<li>æ¯ä¸€ä¸ªè¿‡æ»¤å™¨éƒ½å¿…é¡»æŒ‡å®šä¸€ä¸ª int ç±»å‹çš„ order å€¼ï¼Œ<strong>order å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰§è¡Œé¡ºåºè¶Šé å‰</strong>ã€‚</li>
<li>GlobalFilter é€šè¿‡å®ç° Ordered æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨ @Order æ³¨è§£æ¥æŒ‡å®š order å€¼ï¼Œç”±æˆ‘ä»¬è‡ªå·±æŒ‡å®šã€‚</li>
<li>è·¯ç”±è¿‡æ»¤å™¨å’Œ defaultFilter çš„ order ç”± Spring æŒ‡å®šï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å£°æ˜é¡ºåºä»1é€’å¢ã€‚</li>
<li>å½“è¿‡æ»¤å™¨çš„ order å€¼ä¸€æ ·æ—¶ï¼Œ<strong>ä¼šæŒ‰ç…§ defaultFilter &gt; è·¯ç”±è¿‡æ»¤å™¨ &gt; GlobalFilter çš„é¡ºåºæ‰§è¡Œã€‚</strong></li>
</ul>
<h2 id="è·¨åŸŸé—®é¢˜-1"><a href="#è·¨åŸŸé—®é¢˜-1" class="headerlink" title="è·¨åŸŸé—®é¢˜"></a>è·¨åŸŸé—®é¢˜</h2><p>ä¸äº†è§£è·¨åŸŸé—®é¢˜çš„åŒå­¦å¯ä»¥ç™¾åº¦äº†è§£ä¸€ä¸‹ï¼›åœ¨ Gateway ç½‘å…³ä¸­è§£å†³è·¨åŸŸé—®é¢˜è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># å…¨å±€çš„è·¨åŸŸå¤„ç†</span>
        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># è§£å†³optionsè¯·æ±‚è¢«æ‹¦æˆªé—®é¢˜</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># å…è®¸å“ªäº›ç½‘ç«™çš„è·¨åŸŸè¯·æ±‚ allowedOrigins: â€œ*â€ å…è®¸æ‰€æœ‰ç½‘ç«™</span>
              <span class="token punctuation">-</span> <span class="token string">"http://localhost:8090"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># å…è®¸çš„è·¨åŸŸajaxçš„è¯·æ±‚æ–¹å¼</span>
              <span class="token punctuation">-</span> <span class="token string">"GET"</span>
              <span class="token punctuation">-</span> <span class="token string">"POST"</span>
              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>
              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>
              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">"*"</span> <span class="token comment"># å…è®¸åœ¨è¯·æ±‚ä¸­æºå¸¦çš„å¤´ä¿¡æ¯</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># æ˜¯å¦å…è®¸æºå¸¦cookie</span>
            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000</span> <span class="token comment"># è¿™æ¬¡è·¨åŸŸæ£€æµ‹çš„æœ‰æ•ˆæœŸ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶-1"><a href="#RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶-1" class="headerlink" title="RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶"></a>RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo">https://gitee.com/xn2001/cloudcode/tree/master/08-rabbitmq-demo</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/08-rabbitmq-demo">https://github.com/lexinhu/cloudcode/tree/master/08-rabbitmq-demo</a></p>
</blockquote>
<h2 id="åŒæ­¥å¼‚æ­¥é€šè®¯-1"><a href="#åŒæ­¥å¼‚æ­¥é€šè®¯-1" class="headerlink" title="åŒæ­¥å¼‚æ­¥é€šè®¯"></a>åŒæ­¥å¼‚æ­¥é€šè®¯</h2><p><strong>å¾®æœåŠ¡é—´é€šè®¯æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼</strong></p>
<p>åŒæ­¥é€šè®¯ï¼šå°±åƒæ‰“ç”µè¯ï¼Œéœ€è¦å®æ—¶å“åº”ã€‚</p>
<p>å¼‚æ­¥é€šè®¯ï¼šå°±åƒå‘é‚®ä»¶ï¼Œä¸éœ€è¦é©¬ä¸Šå›å¤ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904133345.png"><img src="https://cdn.xn2001.com/img/2021/20210904133345.png!/format/webp" alt="img"></a></p>
<p>ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ£ï¼Œæ‰“ç”µè¯å¯ä»¥ç«‹å³å¾—åˆ°å“åº”ï¼Œä½†æ˜¯ä½ å´ä¸èƒ½è·Ÿå¤šä¸ªäººåŒæ—¶é€šè¯ã€‚å‘é€é‚®ä»¶å¯ä»¥åŒæ—¶ä¸å¤šä¸ªäººæ”¶å‘é‚®ä»¶ï¼Œä½†æ˜¯å¾€å¾€å“åº”ä¼šæœ‰å»¶è¿Ÿã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ <strong>Feign è°ƒç”¨</strong>å°±å±äº<strong>åŒæ­¥æ–¹å¼</strong>ï¼Œè™½ç„¶è°ƒç”¨å¯ä»¥å®æ—¶å¾—åˆ°ç»“æœï¼Œä½†å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904133517.png"><img src="https://cdn.xn2001.com/img/2021/20210904133517.png!/format/webp" alt="img"></a></p>
<p><strong>åŒæ­¥è°ƒç”¨çš„ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li>æ—¶æ•ˆæ€§è¾ƒå¼ºï¼Œå¯ä»¥ç«‹å³å¾—åˆ°ç»“æœ</li>
</ul>
<p><strong>åŒæ­¥è°ƒç”¨çš„ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>è€¦åˆåº¦é«˜</li>
<li>æ€§èƒ½å’Œååèƒ½åŠ›ä¸‹é™</li>
<li>æœ‰é¢å¤–çš„èµ„æºæ¶ˆè€—</li>
<li>æœ‰çº§è”å¤±è´¥é—®é¢˜</li>
</ul>
<p>å¼‚æ­¥è°ƒç”¨åˆ™å¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬ä»¥è´­ä¹°å•†å“ä¸ºä¾‹ï¼Œç”¨æˆ·æ”¯ä»˜åéœ€è¦è°ƒç”¨è®¢å•æœåŠ¡å®Œæˆè®¢å•çŠ¶æ€ä¿®æ”¹ï¼Œè°ƒç”¨ç‰©æµæœåŠ¡ï¼Œä»ä»“åº“åˆ†é…å“åº”çš„åº“å­˜å¹¶å‡†å¤‡å‘è´§ã€‚åœ¨äº‹ä»¶æ¨¡å¼ä¸­ï¼Œæ”¯ä»˜æœåŠ¡æ˜¯äº‹ä»¶å‘å¸ƒè€…ï¼ˆpublisherï¼‰ï¼Œåœ¨æ”¯ä»˜å®Œæˆååªéœ€è¦å‘å¸ƒä¸€ä¸ªæ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼ˆeventï¼‰ï¼Œäº‹ä»¶ä¸­å¸¦ä¸Šè®¢å•idã€‚è®¢å•æœåŠ¡å’Œç‰©æµæœåŠ¡æ˜¯äº‹ä»¶è®¢é˜…è€…ï¼ˆConsumerï¼‰ï¼Œè®¢é˜…æ”¯ä»˜æˆåŠŸçš„äº‹ä»¶ï¼Œç›‘å¬åˆ°äº‹ä»¶åå®Œæˆè‡ªå·±ä¸šåŠ¡å³å¯ã€‚</p>
<p>ä¸ºäº†è§£é™¤äº‹ä»¶å‘å¸ƒè€…ä¸è®¢é˜…è€…ä¹‹é—´çš„è€¦åˆï¼Œä¸¤è€…å¹¶ä¸æ˜¯ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ªä¸­é—´äººï¼ˆBrokerï¼‰ã€‚å‘å¸ƒè€…å‘å¸ƒäº‹ä»¶åˆ°Brokerï¼Œä¸å…³å¿ƒè°æ¥è®¢é˜…äº‹ä»¶ã€‚è®¢é˜…è€…ä»Brokerè®¢é˜…äº‹ä»¶ï¼Œä¸å…³å¿ƒè°å‘æ¥çš„æ¶ˆæ¯ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904144714.png"><img src="https://cdn.xn2001.com/img/2021/20210904144714.png!/format/webp" alt="img"></a></p>
<p>Broker æ˜¯ä¸€ä¸ªåƒæ•°æ®æ€»çº¿ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ‰€æœ‰çš„æœåŠ¡è¦æ¥æ”¶æ•°æ®å’Œå‘é€æ•°æ®éƒ½å‘åˆ°è¿™ä¸ªæ€»çº¿ä¸Šï¼Œè¿™ä¸ªæ€»çº¿å°±åƒåè®®ä¸€æ ·ï¼Œè®©æœåŠ¡é—´çš„é€šè®¯å˜å¾—æ ‡å‡†å’Œå¯æ§ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904145001.png"><img src="https://cdn.xn2001.com/img/2021/20210904145001.png!/format/webp" alt="img"></a></p>
<p><strong>å¼‚æ­¥è°ƒç”¨å¥½å¤„</strong>ï¼š</p>
<ul>
<li>ååé‡æå‡ï¼šæ— éœ€ç­‰å¾…è®¢é˜…è€…å¤„ç†å®Œæˆï¼Œå“åº”æ›´å¿«é€Ÿ</li>
<li>æ•…éšœéš”ç¦»ï¼šæœåŠ¡æ²¡æœ‰ç›´æ¥è°ƒç”¨ï¼Œä¸å­˜åœ¨çº§è”å¤±è´¥é—®é¢˜</li>
<li>è°ƒç”¨é—´æ²¡æœ‰é˜»å¡ï¼Œä¸ä¼šé€ æˆæ— æ•ˆçš„èµ„æºå ç”¨</li>
<li>è€¦åˆåº¦æä½ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯ä»¥çµæ´»æ’æ‹”ï¼Œå¯æ›¿æ¢</li>
<li>æµé‡å‰Šå³°ï¼šä¸ç®¡å‘å¸ƒäº‹ä»¶çš„æµé‡æ³¢åŠ¨å¤šå¤§ï¼Œéƒ½ç”± Broker æ¥æ”¶ï¼Œè®¢é˜…è€…å¯ä»¥æŒ‰ç…§è‡ªå·±çš„é€Ÿåº¦å»å¤„ç†äº‹ä»¶</li>
</ul>
<p><strong>å¼‚æ­¥è°ƒç”¨ç¼ºç‚¹</strong>ï¼š</p>
<ul>
<li>æ¶æ„å¤æ‚äº†ï¼Œä¸šåŠ¡æ²¡æœ‰æ˜æ˜¾çš„æµç¨‹çº¿ï¼Œä¸å¥½ç®¡ç†</li>
<li>éœ€è¦ä¾èµ–äº Broker çš„å¯é ã€å®‰å…¨ã€æ€§èƒ½</li>
</ul>
<h2 id="MQæ¶ˆæ¯é˜Ÿåˆ—-1"><a href="#MQæ¶ˆæ¯é˜Ÿåˆ—-1" class="headerlink" title="MQæ¶ˆæ¯é˜Ÿåˆ—"></a>MQæ¶ˆæ¯é˜Ÿåˆ—</h2><p>MQï¼Œä¸­æ–‡æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessageQueueï¼‰ï¼Œå­—é¢æ¥çœ‹å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„ Broker</p>
<p>æ¯”è¾ƒå¸¸è§çš„ MQ å®ç°ï¼š</p>
<ul>
<li>ActiveMQ</li>
<li>RabbitMQ</li>
<li>RocketMQ</li>
<li>Kafka</li>
</ul>
<p>å‡ ç§å¸¸è§MQçš„å¯¹æ¯”ï¼š</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><strong>RabbitMQ</strong></th>
<th align="left"><strong>ActiveMQ</strong></th>
<th align="left"><strong>RocketMQ</strong></th>
<th align="left"><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">å…¬å¸/ç¤¾åŒº</td>
<td align="left">Rabbit</td>
<td align="left">Apache</td>
<td align="left">é˜¿é‡Œ</td>
<td align="left">Apache</td>
</tr>
<tr>
<td align="left">å¼€å‘è¯­è¨€</td>
<td align="left">Erlang</td>
<td align="left">Java</td>
<td align="left">Java</td>
<td align="left">Scala&amp;Java</td>
</tr>
<tr>
<td align="left">åè®®æ”¯æŒ</td>
<td align="left">AMQPã€XMPPã€SMTPã€STOMP</td>
<td align="left">OpenWireã€STOMPã€RESTã€XMPPã€AMQP</td>
<td align="left">è‡ªå®šä¹‰åè®®</td>
<td align="left">è‡ªå®šä¹‰åè®®</td>
</tr>
<tr>
<td align="left">å¯ç”¨æ€§</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">é«˜</td>
<td align="left">é«˜</td>
</tr>
<tr>
<td align="left">å•æœºååé‡</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">å·®</td>
<td align="left">é«˜</td>
<td align="left">éå¸¸é«˜</td>
</tr>
<tr>
<td align="left">æ¶ˆæ¯å»¶è¿Ÿ</td>
<td align="left">å¾®ç§’çº§</td>
<td align="left">æ¯«ç§’çº§</td>
<td align="left">æ¯«ç§’çº§</td>
<td align="left">æ¯«ç§’ä»¥å†…</td>
</tr>
<tr>
<td align="left">æ¶ˆæ¯å¯é æ€§</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
<td align="left">é«˜</td>
<td align="left">ä¸€èˆ¬</td>
</tr>
</tbody></table>
<p>ä»¥ RabbitMQ ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨ Centos7 è™šæ‹Ÿæœºä¸­ä½¿ç”¨ Docker æ¥å®‰è£…</p>
<p>åœ¨çº¿æ‹‰å–é•œåƒ</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker pull rabbitmq:3-management<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¥è¿è¡ŒMQå®¹å™¨</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker run \
 -e RABBITMQ_DEFAULT_USER=admin \
 -e RABBITMQ_DEFAULT_PASS=123456 \
 --name mq \
 --hostname mq1 \
 -p 15672:15672 \
 -p 5672:5672 \
 -d \
 rabbitmq:3-management<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨æˆåŠŸåè®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:15672/">http://192.168.211.128:15672</a></p>
<p><strong>RabbitMQ ä¸­çš„ä¸€äº›è§’è‰²</strong></p>
<ul>
<li>publisherï¼šç”Ÿäº§è€…</li>
<li>consumerï¼šæ¶ˆè´¹è€…</li>
<li>exchangeï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±</li>
<li>queueï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯</li>
<li>virtualHostï¼šè™šæ‹Ÿä¸»æœºï¼Œ<strong>éš”ç¦»ä¸åŒç§Ÿæˆ·</strong>çš„ exchangeã€queueã€æ¶ˆæ¯çš„éš”ç¦»</li>
</ul>
<p><strong>MQ çš„åŸºæœ¬ç»“æ„</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904172912.png"><img src="https://cdn.xn2001.com/img/2021/20210904172912.png!/format/webp" alt="img"></a></p>
<h2 id="å…¥é—¨æ¡ˆä¾‹-1"><a href="#å…¥é—¨æ¡ˆä¾‹-1" class="headerlink" title="å…¥é—¨æ¡ˆä¾‹"></a>å…¥é—¨æ¡ˆä¾‹</h2><p>RabbitMQ å®˜æ–¹æä¾›äº† 5 ä¸ªä¸åŒçš„ Demo ç¤ºä¾‹ï¼Œå¯¹åº”äº†ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904173739.png"><img src="https://cdn.xn2001.com/img/2021/20210904173739.png!/format/webp" alt="img"></a></p>
<p>Hello World æ¨¡å‹</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904200637.png"><img src="https://cdn.xn2001.com/img/2021/20210904200637.png!/format/webp" alt="img"></a></p>
<p>å®˜æ–¹çš„ HelloWorld æ˜¯åŸºäºæœ€åŸºç¡€çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹æ¥å®ç°çš„ï¼ŒåªåŒ…æ‹¬ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>publisherï¼šæ¶ˆæ¯å‘å¸ƒè€…ï¼Œå°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—queue</li>
<li>queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¥å—å¹¶ç¼“å­˜æ¶ˆæ¯</li>
<li>consumerï¼šè®¢é˜…é˜Ÿåˆ—ï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li>
</ul>
<h3 id="publisherå®ç°-1"><a href="#publisherå®ç°-1" class="headerlink" title="publisherå®ç°"></a>publisherå®ç°</h3><ul>
<li>å»ºç«‹è¿æ¥</li>
<li>åˆ›å»º channel</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>å‘é€æ¶ˆæ¯</li>
<li>å…³é—­è¿æ¥å’Œ channel</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç </span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.åˆ›å»ºé€šé“Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.åˆ›å»ºé˜Ÿåˆ—</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.å‘é€æ¶ˆæ¯</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"Hello RabbitMQï¼"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å‘é€æ¶ˆæ¯æˆåŠŸï¼š["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.å…³é—­é€šé“å’Œè¿æ¥</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="consumerå®ç°-1"><a href="#consumerå®ç°-1" class="headerlink" title="consumerå®ç°"></a>consumerå®ç°</h3><ul>
<li>å»ºç«‹è¿æ¥</li>
<li>åˆ›å»º channel</li>
<li>å£°æ˜é˜Ÿåˆ—</li>
<li>è®¢é˜…æ¶ˆæ¯</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.è®¾ç½®è¿æ¥å‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šä¸»æœºåã€ç«¯å£å·ã€vhostã€ç”¨æˆ·åã€å¯†ç </span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.211.128"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.å»ºç«‹è¿æ¥</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.åˆ›å»ºé€šé“Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.åˆ›å»ºé˜Ÿåˆ—</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.è®¢é˜…æ¶ˆæ¯</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span>
                                       <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.å¤„ç†æ¶ˆæ¯</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š["</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ä¸­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="SpringAMQP-1"><a href="#SpringAMQP-1" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h2><p>SpringAMQP æ˜¯åŸºäº RabbitMQ å°è£…çš„ä¸€å¥—æ¨¡æ¿ï¼Œå¹¶ä¸”è¿˜åˆ©ç”¨ SpringBoot å¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p>
<p>SpringAMQP çš„å®˜æ–¹åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp">https://spring.io/projects/spring-amqp</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904202046.png"><img src="https://cdn.xn2001.com/img/2021/20210904202046.png!/format/webp" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904202056.png"><img src="https://cdn.xn2001.com/img/2021/20210904202056.png!/format/webp" alt="img"></a></p>
<p>SpringAMQP æä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li>è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»</li>
<li>åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯</li>
<li>å°è£…äº† RabbitTemplate å·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯</li>
</ul>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="BasicQueue-1"><a href="#BasicQueue-1" class="headerlink" title="BasicQueue"></a>BasicQueue</h3><p>é¦–å…ˆé…ç½® MQåœ°å€ï¼Œåœ¨ publisherã€consumer æœåŠ¡ä¸­çš„ application.yml ä¸­æ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101 <span class="token comment"># ä¸»æœºå</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># ç«¯å£</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># è™šæ‹Ÿä¸»æœº</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin <span class="token comment"># ç”¨æˆ·å</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span> <span class="token comment"># å¯†ç </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ consumer æœåŠ¡ä¸­æ·»åŠ ç›‘å¬é˜Ÿåˆ—</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenSimpleQueueMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡ä¸­æ·»åŠ å‘é€æ¶ˆæ¯çš„æµ‹è¯•ç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAmqpTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜Ÿåˆ—åç§°</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¶ˆæ¯</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"ä½ å¥½å•Šï¼Œä¹å¿ƒæ¹–ï¼"</span><span class="token punctuation">;</span>
        <span class="token comment">// å‘é€æ¶ˆæ¯</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="WorkQueue-1"><a href="#WorkQueue-1" class="headerlink" title="WorkQueue"></a>WorkQueue</h3><p>Work queuesï¼Œä¹Ÿè¢«ç§°ä¸ºï¼ˆTask queuesï¼‰ï¼Œä»»åŠ¡æ¨¡å‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯<strong>è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</strong>ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904211238.png"><img src="https://cdn.xn2001.com/img/2021/20210904211238.png!/format/webp" alt="img"></a></p>
<p>å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚</p>
<p>æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ work æ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œé€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚</p>
<p>æˆ‘ä»¬å¾ªç¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§é‡æ¶ˆæ¯å †ç§¯ç°è±¡ï¼Œåœ¨ publisher æœåŠ¡ä¸­çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * workQueue
 * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// é˜Ÿåˆ—åç§°</span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, message_"</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‘é€æ¶ˆæ¯</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ¶ˆæ¯æ¥æ”¶</strong></p>
<p>è¦æ¨¡æ‹Ÿå¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬åœ¨ consumer æœåŠ¡çš„ RabbitMQListener ä¸­æ·»åŠ 2ä¸ªæ–°çš„æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"simple.queue"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨ ConsumerApplication åï¼Œåœ¨æ‰§è¡Œ publisher æœåŠ¡ä¸­åˆšåˆšç¼–å†™çš„å‘é€æµ‹è¯•æ–¹æ³• testWorkQueue</p>
<p>å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´æ¶ˆæ¯æ˜¯<strong>å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…</strong>ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚è¿™æ˜¯å› ä¸º RabbitMQ é»˜è®¤æœ‰ä¸€ä¸ªæ¶ˆæ¯é¢„å–æœºåˆ¶ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯èƒ½è€…å¤šåŠ³å˜›ï¼Œæ‰€ä»¥å»é™åˆ¶æ¯æ¬¡åªèƒ½å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>åœ¨ spring ä¸­æœ‰ä¸€ä¸ªç®€å•çš„é…ç½®ï¼Œè®¾ç½® prefetch å±æ€§ï¼Œæˆ‘ä»¬ä¿®æ”¹ consumer æœåŠ¡çš„ application.yml æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Work æ¨¡å‹çš„ä½¿ç”¨ï¼š</p>
<ul>
<li>å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</li>
<li>é€šè¿‡è®¾ç½® prefetch æ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡</li>
</ul>
<h3 id="å‘å¸ƒ-è®¢é˜…-1"><a href="#å‘å¸ƒ-è®¢é˜…-1" class="headerlink" title="å‘å¸ƒ/è®¢é˜…"></a>å‘å¸ƒ/è®¢é˜…</h3><p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904213455.png"><img src="https://cdn.xn2001.com/img/2021/20210904213455.png!/format/webp" alt="img"></a></p>
<p>å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è®¢é˜…æ¨¡å‹ä¸­ï¼Œå¤šäº†ä¸€ä¸ª exchange è§’è‰²ï¼Œè€Œä¸”è¿‡ç¨‹ç•¥æœ‰å˜åŒ–</p>
<ul>
<li>Publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åºï¼Œä½†æ˜¯ä¸å†å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œ<strong>è€Œæ˜¯å‘ç»™ exchangeï¼ˆäº¤æ¢æœºï¼‰</strong></li>
<li>Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸ä»¥å‰ä¸€æ ·ï¼Œè®¢é˜…é˜Ÿåˆ—ï¼Œæ²¡æœ‰å˜åŒ–</li>
<li>Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸ä»¥å‰ä¸€æ ·ï¼Œæ¥æ”¶æ¶ˆæ¯ã€ç¼“å­˜æ¶ˆæ¯</li>
<li>Exchangeï¼šäº¤æ¢æœºï¼Œä¸€æ–¹é¢ï¼Œæ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼›å¦ä¸€æ–¹é¢ï¼ŒçŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯ï¼Œä¾‹å¦‚é€’äº¤ç»™æŸä¸ªç‰¹åˆ«é˜Ÿåˆ—ã€é€’äº¤ç»™æ‰€æœ‰é˜Ÿåˆ—ã€æˆ–æ˜¯å°†æ¶ˆæ¯ä¸¢å¼ƒã€‚åˆ°åº•å¦‚ä½•æ“ä½œï¼Œå–å†³äº Exchange çš„ç±»å‹ã€‚Exchange æœ‰ä»¥ä¸‹3ç§ç±»å‹ï¼š<ul>
<li>Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—</li>
<li>Directï¼šå®šå‘ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆæŒ‡å®š routing key çš„é˜Ÿåˆ—</li>
<li>Topicï¼šé€šé…ç¬¦ï¼ŒæŠŠæ¶ˆæ¯äº¤ç»™ç¬¦åˆ routing patternï¼ˆè·¯ç”±æ¨¡å¼ï¼‰ çš„é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
<p><strong>Exchangeï¼ˆäº¤æ¢æœºï¼‰åªè´Ÿè´£è½¬å‘æ¶ˆæ¯ï¼Œä¸å…·å¤‡å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›</strong>ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰ä»»ä½•é˜Ÿåˆ—ä¸ Exchange ç»‘å®šï¼Œæˆ–è€…æ²¡æœ‰ç¬¦åˆè·¯ç”±è§„åˆ™çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¼šä¸¢å¤±ï¼</p>
<h3 id="Fanout-1"><a href="#Fanout-1" class="headerlink" title="Fanout"></a>Fanout</h3><p>Fanoutï¼Œè‹±æ–‡ç¿»è¯‘æ˜¯æ‰‡å‡ºï¼Œåœ¨ MQ ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç§°ä¸ºå¹¿æ’­ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912160350.png"><img src="https://cdn.xn2001.com/img/2021/20210912160350.png!/format/webp" alt="img"></a></p>
<p>åœ¨å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å‘é€æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>å¯ä»¥æœ‰å¤šä¸ªé˜Ÿåˆ—</li>
<li>æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šåˆ° Exchangeï¼ˆäº¤æ¢æœºï¼‰</li>
<li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š</li>
<li>äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—</li>
<li>è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯</li>
</ul>
<p>æ¥ä¸‹é‡Œæˆ‘ä»¬ç”¨ SpringAMQP æ¥ç®€å•å®ç° FanoutExchange</p>
<ol>
<li>åœ¨ consumer æœåŠ¡ä¸­ï¼Œåˆ©ç”¨ä»£ç å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºï¼Œå¹¶å°†ä¸¤è€…ç»‘å®š</li>
<li>åœ¨ consumer æœåŠ¡ä¸­ï¼Œç¼–å†™ä¸¤ä¸ªæ¶ˆè´¹è€…æ–¹æ³•ï¼Œåˆ†åˆ«ç›‘å¬ fanout.queue1 å’Œ fanout.queue2</li>
<li>åœ¨ publisher ä¸­ç¼–å†™æµ‹è¯•æ–¹æ³•ï¼Œå‘ fanoutå‘é€æ¶ˆæ¯</li>
</ol>
<p><strong>å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</strong></p>
<p>Spring æä¾›äº†ä¸€ä¸ªæ¥å£ Exchangeï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210904213809.png"><img src="https://cdn.xn2001.com/img/2021/20210904213809.png!/format/webp" alt="img"></a></p>
<p>åœ¨ consumer ä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºã€<strong>ç»‘å®šå¯¹è±¡ Binding</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * å£°æ˜äº¤æ¢æœº
     * @return Fanoutç±»å‹äº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">"xn2001.fanout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * å£°æ˜é˜Ÿåˆ—
     * @return Queue
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue1</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue2</span><span class="token punctuation">(</span><span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">,</span><span class="token class-name">Queue</span> fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912181932.png"><img src="https://cdn.xn2001.com/img/2021/20210912181932.png!/format/webp" alt="img"></a></p>
<p>é€šè¿‡è¿™æ · <code>@Bean</code> çš„æ–¹å¼æ¥ç”³æ˜ç¡®å®æ¯”è¾ƒéº»çƒ¦ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥é€šè¿‡ <code>@RabbitListener</code> æ³¨è§£æ¥å®Œæˆçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p>åœ¨ consumer æœåŠ¡çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸‰ä¸ªæ–¹æ³•ï¼Œä½œä¸ºæ¶ˆè´¹è€…</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"fanout.queue2"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"fanout.queue3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue3</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°fanout.queue3çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * fanout
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.fanout"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, everybody!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿è¡Œè¯¥æ–¹æ³•ï¼Œå¯ä»¥å‘ç° fanout.queue1ã€fanout.queue2 éƒ½æ”¶åˆ°äº†äº¤æ¢æœºçš„æ¶ˆæ¯ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912182458.png"><img src="https://cdn.xn2001.com/img/2021/20210912182458.png!/format/webp" alt="img"></a></p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>äº¤æ¢æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>æ¥æ”¶ publisher å‘é€çš„æ¶ˆæ¯</li>
<li>å°†æ¶ˆæ¯æŒ‰ç…§è§„åˆ™è·¯ç”±åˆ°ä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li>
<li>ä¸èƒ½ç¼“å­˜æ¶ˆæ¯ï¼Œè·¯ç”±å¤±è´¥ï¼Œæ¶ˆæ¯ä¸¢å¤±</li>
<li>FanoutExchange ä¼šå°†æ‰€æœ‰æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—</li>
</ul>
<h3 id="Direct-1"><a href="#Direct-1" class="headerlink" title="Direct"></a>Direct</h3><p>åœ¨ Fanout æ¨¡å¼ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ï¼Œä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ã€‚ä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ã€‚è¿™æ—¶å°±è¦ç”¨åˆ° DirectExchange</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912182822.png"><img src="https://cdn.xn2001.com/img/2021/20210912182822.png!/format/webp" alt="img"></a></p>
<p>åœ¨ Direct æ¨¡å‹ä¸‹ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ª<code>RoutingKey</code>ï¼ˆè·¯ç”±keyï¼‰</li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ <code>RoutingKey</code>ã€‚</li>
<li>Exchange ä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„<code>Routing Key</code>è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„<code>Routingkey</code> ä¸æ¶ˆæ¯çš„ <code>Routing key</code>å®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li>
</ul>
<p>åœ¨ consumer çš„ SpringRabbitListener ä¸­æ·»åŠ ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼ŒåŒæ—¶åŸºäºæ³¨è§£æ¥å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"b"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"direct.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ publisher æœåŠ¡çš„ SpringAmqpTest ç±»ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to a!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * direct
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirectExchangeToB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.direct"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">"hello, i am direct to b!"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Topic-1"><a href="#Topic-1" class="headerlink" title="Topic"></a>Topic</h3><p><code>Topic </code>ä¸ <code>Direct</code>ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®<code>RoutingKey</code>æŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚åªä¸è¿‡<code>Topic </code>ç±»å‹å¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®š<code>Routing key</code> çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼</p>
<p>é€šé…ç¬¦è§„åˆ™ï¼š</p>
<p><code>#</code>ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯</p>
<p><code>*</code>ï¼šåªèƒ½åŒ¹é…ä¸€ä¸ªè¯</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">item.#`ï¼šèƒ½å¤ŸåŒ¹é…`item.spu.insert` æˆ–è€… `item.spu
item.*`ï¼šåªèƒ½åŒ¹é…`item.spu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912194016.png"><img src="https://cdn.xn2001.com/img/2021/20210912194016.png!/format/webp" alt="img"></a></p>
<ul>
<li>Queue1ï¼šç»‘å®šçš„æ˜¯ <code>china.#</code> ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ <code>china.</code> å¼€å¤´çš„ <code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…åˆ°ã€‚åŒ…æ‹¬ china.news å’Œ china.weather</li>
<li>Queue2ï¼šç»‘å®šçš„æ˜¯ <code>#.news</code> ï¼Œå› æ­¤å‡¡æ˜¯ä»¥ <code>.news </code>ç»“å°¾çš„ <code>routing key</code> éƒ½ä¼šè¢«åŒ¹é…ã€‚åŒ…æ‹¬ china.news å’Œ japan.news</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"china.#"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"topic.queue2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"china.*"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * topic
 * å‘äº¤æ¢æœºå‘é€æ¶ˆæ¯
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTopicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº¤æ¢æœºåç§°</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"xn2001.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯</span>
    <span class="token class-name">String</span> message1 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> message2 <span class="token operator">=</span> <span class="token string">"hello, i am topic form china.news.2"</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news"</span><span class="token punctuation">,</span> message1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">"china.news.2"</span><span class="token punctuation">,</span> message2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912200012.png"><img src="https://cdn.xn2001.com/img/2021/20210912200012.png!/format/webp" alt="img"></a></p>
<h3 id="æ¶ˆæ¯è½¬æ¢å™¨"><a href="#æ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="æ¶ˆæ¯è½¬æ¢å™¨"></a>æ¶ˆæ¯è½¬æ¢å™¨</h3><p>Spring ä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™ MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸º Java å¯¹è±¡ã€‚</p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ Spring é‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯ JDK åºåˆ—åŒ–ã€‚</strong></p>
<p>æˆ‘ä»¬å¯ä»¥å»è¯•ä¸€ä¸‹æ•ˆæœ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"object.queue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenObjectQueue</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"objectæ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€"</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">"ã€‘"</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token comment">// å‡†å¤‡æ¶ˆæ¯</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Jack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å‘é€æ¶ˆæ¯</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"object.queue"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912204117.png"><img src="https://cdn.xn2001.com/img/2021/20210912204117.png!/format/webp" alt="img"></a></p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š</p>
<ul>
<li>æ•°æ®ä½“ç§¯è¿‡å¤§</li>
<li>æœ‰å®‰å…¨æ¼æ´</li>
<li>å¯è¯»æ€§å·®</li>
</ul>
<p>æˆ‘ä»¬æ¨èå¯ä»¥ä½¿ç”¨ JSON æ¥åºåˆ—åŒ–</p>
<p>åœ¨ publisher å’Œ consumer ä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-dataformat-xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é…ç½®æ¶ˆæ¯è½¬æ¢å™¨ã€‚</p>
<p>åœ¨å„è‡ªçš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ª Bean å³å¯</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">jsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210912204512.png"><img src="https://cdn.xn2001.com/img/2021/20210912204512.png!/format/webp" alt="img"></a></p>
<h1 id="ELasticsearchæœç´¢å¼•æ“-1"><a href="#ELasticsearchæœç´¢å¼•æ“-1" class="headerlink" title="ELasticsearchæœç´¢å¼•æ“"></a>ELasticsearchæœç´¢å¼•æ“</h1><blockquote>
<p>ä»£ç å‚è€ƒï¼š</p>
<p>Giteeï¼š<a target="_blank" rel="noopener" href="https://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo">https://gitee.com/xn2001/cloudcode/tree/master/09-elasticsearch-hotel-demo</a></p>
<p>GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/lexinhu/cloudcode/tree/master/09-elasticsearch-hotel-demo">https://github.com/lexinhu/cloudcode/tree/master/09-elasticsearch-hotel-demo</a></p>
</blockquote>
<p>ELasticsearch æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„å¼€æºæœç´¢å¼•æ“ï¼Œå…·å¤‡éå¸¸å¤šå¼ºå¤§åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»æµ·é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥å®ç°æœç´¢ã€æ—¥å¿—ç»Ÿè®¡ã€åˆ†æã€ç³»ç»Ÿç›‘æ§ç­‰åŠŸèƒ½ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918202359.png"><img src="https://cdn.xn2001.com/img/2021/20210918202359.png!/format/webp" alt="img"></a></p>
<h2 id="å€’æ’ç´¢å¼•-1"><a href="#å€’æ’ç´¢å¼•-1" class="headerlink" title="å€’æ’ç´¢å¼•"></a>å€’æ’ç´¢å¼•</h2><p><strong>é¦–å…ˆï¼Œå€’æ’ç´¢å¼•çš„æ¦‚å¿µæ˜¯åŸºäº MySQL è¿™æ ·çš„æ­£å‘ç´¢å¼•è€Œè¨€çš„ã€‚</strong></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å…ˆè®²ä½•ä¸ºæ­£å‘ç´¢å¼•ã€‚ä¾‹å¦‚ç»™ä¸‹è¡¨ï¼ˆtb_goodsï¼‰ä¸­çš„ id åˆ›å»ºç´¢å¼•</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918202527.png"><img src="https://cdn.xn2001.com/img/2021/20210918202527.png!/format/webp" alt="img"></a></p>
<p>å¦‚æœæ˜¯æ ¹æ® id æŸ¥è¯¢ï¼Œé‚£ä¹ˆç›´æ¥èµ°ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ã€‚</p>
<p>ä½†å¦‚æœæ˜¯åŸºäº title åšæ¨¡ç³ŠæŸ¥è¯¢ï¼Œåªèƒ½æ˜¯é€è¡Œæ‰«ææ•°æ®ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·æœç´¢æ•°æ®ï¼Œæ¡ä»¶æ˜¯ title ç¬¦åˆ <code>"%æ‰‹æœº%"</code></li>
<li>é€è¡Œè·å–æ•°æ®ï¼Œæ¯”å¦‚ id ä¸º 1 çš„æ•°æ®</li>
<li>åˆ¤æ–­æ•°æ®ä¸­çš„ title æ˜¯å¦ç¬¦åˆç”¨æˆ·æœç´¢æ¡ä»¶</li>
<li>å¦‚æœç¬¦åˆåˆ™æ”¾å…¥ç»“æœé›†ï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚ç„¶åå›åˆ°æ­¥éª¤1</li>
</ol>
<p>é€è¡Œæ‰«æï¼Œä¹Ÿå°±æ˜¯å…¨è¡¨æ‰«æï¼Œéšç€æ•°æ®é‡å¢åŠ ï¼Œå…¶æŸ¥è¯¢æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ã€‚å½“æ•°æ®é‡è¾¾åˆ°æ•°ç™¾ä¸‡æ—¶ï¼Œå°±æ˜¯ã€‚ã€‚ã€‚</p>
<p>è€Œå€’æ’ç´¢å¼•ä¸­æœ‰ä¸¤ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æ–‡æ¡£ï¼ˆ<code>Document</code>ï¼‰ï¼šç”¨æ¥æœç´¢çš„æ•°æ®ï¼Œå…¶ä¸­çš„æ¯ä¸€æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µã€ä¸€ä¸ªå•†å“ä¿¡æ¯</li>
<li>è¯æ¡ï¼ˆ<code>Term</code>ï¼‰ï¼šå¯¹æ–‡æ¡£æ•°æ®æˆ–ç”¨æˆ·æœç´¢æ•°æ®ï¼Œåˆ©ç”¨æŸç§ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°çš„å…·å¤‡å«ä¹‰çš„è¯è¯­å°±æ˜¯è¯æ¡ã€‚ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸­å›½äººï¼Œå°±å¯ä»¥åˆ†ä¸ºï¼šæˆ‘ã€æ˜¯ã€ä¸­å›½äººã€ä¸­å›½ã€å›½äººè¿™æ ·çš„å‡ ä¸ªè¯æ¡</li>
</ul>
<p><strong>åˆ›å»ºå€’æ’ç´¢å¼•</strong>æ˜¯å¯¹æ­£å‘ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šå¤„ç†ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å°†æ¯ä¸€ä¸ªæ–‡æ¡£çš„æ•°æ®åˆ©ç”¨ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ªè¯æ¡</li>
<li>åˆ›å»ºè¡¨ï¼Œæ¯è¡Œæ•°æ®åŒ…æ‹¬è¯æ¡ã€è¯æ¡æ‰€åœ¨æ–‡æ¡£ idã€ä½ç½®ç­‰ä¿¡æ¯</li>
<li>å› ä¸ºè¯æ¡å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»™è¯æ¡åˆ›å»ºç´¢å¼•ï¼Œä¾‹å¦‚ hash è¡¨ç»“æ„ç´¢å¼•</li>
</ul>
<p>å¦‚å›¾ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918203514.png"><img src="https://cdn.xn2001.com/img/2021/20210918203514.png!/format/webp" alt="img"></a></p>
<p><strong>å€’æ’ç´¢å¼•çš„æœç´¢æµç¨‹</strong>å¦‚ä¸‹ï¼ˆä»¥æœç´¢â€åä¸ºæ‰‹æœºâ€ä¸ºä¾‹ï¼‰</p>
<ol>
<li>ç”¨æˆ·è¾“å…¥æ¡ä»¶<code>"åä¸ºæ‰‹æœº"</code>è¿›è¡Œæœç´¢</li>
<li>å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹<strong>åˆ†è¯</strong>ï¼Œå¾—åˆ°è¯æ¡ï¼š<code>åä¸º</code>ã€<code>æ‰‹æœº</code></li>
<li>æ‹¿ç€è¯æ¡åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼Œå¯ä»¥å¾—åˆ°åŒ…å«è¯æ¡çš„æ–‡æ¡£ id æœ‰ 1ã€2ã€3</li>
<li>æ‹¿ç€æ–‡æ¡£ id åˆ°æ­£å‘ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“æ–‡æ¡£</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918203815.png"><img src="https://cdn.xn2001.com/img/2021/20210918203815.png!/format/webp" alt="img"></a></p>
<p><strong>è™½ç„¶è¦å…ˆæŸ¥è¯¢å€’æ’ç´¢å¼•ï¼Œå†æŸ¥è¯¢æ­£å‘ç´¢å¼•ï¼Œä½†æ˜¯è¯æ¡å’Œæ–‡æ¡£id éƒ½å»ºç«‹äº†ç´¢å¼•ï¼ŒæŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼æ— éœ€å…¨è¡¨æ‰«æã€‚</strong></p>
<p>ä¸ºä»€ä¹ˆä¸€ä¸ªå«åšæ­£å‘ç´¢å¼•ï¼Œä¸€ä¸ªå«åšå€’æ’ç´¢å¼•å‘¢ï¼Ÿ</p>
<p><strong>æ­£å‘ç´¢å¼•</strong>æ˜¯æœ€ä¼ ç»Ÿçš„ï¼Œæ ¹æ® id ç´¢å¼•çš„æ–¹å¼ã€‚ä½†æ ¹æ®è¯æ¡æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»å…ˆé€æ¡è·å–æ¯ä¸ªæ–‡æ¡£ï¼Œç„¶ååˆ¤æ–­æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€è¦çš„è¯æ¡ï¼Œæ˜¯<strong>æ ¹æ®æ–‡æ¡£æ‰¾è¯æ¡çš„è¿‡ç¨‹</strong></p>
<p><strong>å€’æ’ç´¢å¼•</strong>åˆ™ç›¸åï¼Œæ˜¯å…ˆæ‰¾åˆ°ç”¨æˆ·è¦æœç´¢çš„è¯æ¡ï¼Œæ ¹æ®å¾—åˆ°çš„æ–‡æ¡£ id è·å–è¯¥æ–‡æ¡£ã€‚æ˜¯<strong>æ ¹æ®è¯æ¡æ‰¾æ–‡æ¡£çš„è¿‡ç¨‹</strong></p>
<h2 id="æ–‡æ¡£å’Œå­—æ®µ-1"><a href="#æ–‡æ¡£å’Œå­—æ®µ-1" class="headerlink" title="æ–‡æ¡£å’Œå­—æ®µ"></a>æ–‡æ¡£å’Œå­—æ®µ</h2><p>elasticsearch æ˜¯é¢å‘<strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong>å­˜å‚¨çš„ï¼Œå¯ä»¥æ˜¯æ•°æ®åº“ä¸­çš„ä¸€æ¡å•†å“æ•°æ®ï¼Œä¸€ä¸ªè®¢å•ä¿¡æ¯ã€‚æ–‡æ¡£æ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸º json æ ¼å¼åå­˜å‚¨åœ¨ elasticsearch</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918212707.png"><img src="https://cdn.xn2001.com/img/2021/20210918212707.png!/format/webp" alt="img"></a></p>
<p>è€Œ JSON æ–‡æ¡£ä¸­å¾€å¾€åŒ…å«å¾ˆå¤šçš„<strong>å­—æ®µï¼ˆFieldï¼‰</strong>ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚</p>
<h2 id="ç´¢å¼•å’Œæ˜ å°„-1"><a href="#ç´¢å¼•å’Œæ˜ å°„-1" class="headerlink" title="ç´¢å¼•å’Œæ˜ å°„"></a>ç´¢å¼•å’Œæ˜ å°„</h2><p><strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong>ï¼Œå°±æ˜¯ç›¸åŒç±»å‹çš„æ–‡æ¡£çš„é›†åˆã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>æ‰€æœ‰ç”¨æˆ·æ–‡æ¡£ï¼Œå°±å¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºç”¨æˆ·çš„ç´¢å¼•ï¼›</li>
<li>æ‰€æœ‰å•†å“çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºå•†å“çš„ç´¢å¼•ï¼›</li>
<li>æ‰€æœ‰è®¢å•çš„æ–‡æ¡£ï¼Œå¯ä»¥ç»„ç»‡åœ¨ä¸€èµ·ï¼Œç§°ä¸ºè®¢å•çš„ç´¢å¼•ï¼›</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918213357.png"><img src="https://cdn.xn2001.com/img/2021/20210918213357.png!/format/webp" alt="img"></a></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç´¢å¼•å½“åšæ˜¯æ•°æ®åº“ä¸­çš„è¡¨ã€‚</p>
<p>æ•°æ®åº“çš„è¡¨ä¼šæœ‰çº¦æŸä¿¡æ¯ï¼Œç”¨æ¥å®šä¹‰è¡¨çš„ç»“æ„ã€å­—æ®µçš„åç§°ã€ç±»å‹ç­‰ä¿¡æ¯ã€‚å› æ­¤ï¼Œç´¢å¼•åº“ä¸­å°±æœ‰<strong>æ˜ å°„ï¼ˆmappingï¼‰</strong>ï¼Œæ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„å­—æ®µçº¦æŸä¿¡æ¯ï¼Œç±»ä¼¼è¡¨çš„ç»“æ„çº¦æŸã€‚</p>
<p><strong>mysql ä¸ elasticsearch</strong></p>
<table>
<thead>
<tr>
<th align="left"><strong>MySQL</strong></th>
<th align="left"><strong>Elasticsearch</strong></th>
<th align="left"><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Table</td>
<td align="left">Index</td>
<td align="left">ç´¢å¼•(index)ï¼Œå°±æ˜¯æ–‡æ¡£çš„é›†åˆï¼Œç±»ä¼¼æ•°æ®åº“çš„è¡¨(table)</td>
</tr>
<tr>
<td align="left">Row</td>
<td align="left">Document</td>
<td align="left">æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå°±æ˜¯ä¸€æ¡æ¡çš„æ•°æ®ï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„è¡Œï¼ˆRowï¼‰ï¼Œæ–‡æ¡£éƒ½æ˜¯JSONæ ¼å¼</td>
</tr>
<tr>
<td align="left">Column</td>
<td align="left">Field</td>
<td align="left">å­—æ®µï¼ˆFieldï¼‰ï¼Œå°±æ˜¯JSONæ–‡æ¡£ä¸­çš„å­—æ®µï¼Œç±»ä¼¼æ•°æ®åº“ä¸­çš„åˆ—ï¼ˆColumnï¼‰</td>
</tr>
<tr>
<td align="left">Schema</td>
<td align="left">Mapping</td>
<td align="left">Mappingï¼ˆæ˜ å°„ï¼‰æ˜¯ç´¢å¼•ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œä¾‹å¦‚å­—æ®µç±»å‹çº¦æŸã€‚ç±»ä¼¼æ•°æ®åº“çš„è¡¨ç»“æ„ï¼ˆSchemaï¼‰</td>
</tr>
<tr>
<td align="left">SQL</td>
<td align="left">DSL</td>
<td align="left">DSLæ˜¯elasticsearchæä¾›çš„JSONé£æ ¼çš„è¯·æ±‚è¯­å¥ï¼Œç”¨æ¥æ“ä½œelasticsearchï¼Œå®ç°CRUD</td>
</tr>
</tbody></table>
<ul>
<li>Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§</li>
<li>Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—</li>
</ul>
<p>å› æ­¤åœ¨ä¼ä¸šä¸­ï¼Œå¾€å¾€æ˜¯ä¸¤è€…ç»“åˆä½¿ç”¨ï¼š</p>
<ul>
<li>å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„å†™æ“ä½œï¼Œä½¿ç”¨ MySQL å®ç°</li>
<li>å¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æœç´¢éœ€æ±‚ï¼Œä½¿ç”¨ ELasticsearch å®ç°</li>
<li>ä¸¤è€…å†åŸºäºæŸç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918213631.png"><img src="https://cdn.xn2001.com/img/2021/20210918213631.png!/format/webp" alt="img"></a></p>
<h2 id="å®‰è£…Elasticsearch"><a href="#å®‰è£…Elasticsearch" class="headerlink" title="å®‰è£…Elasticsearch"></a>å®‰è£…Elasticsearch</h2><p>å› ä¸ºæˆ‘ä»¬è¿˜éœ€è¦éƒ¨ç½² kibana å®¹å™¨ï¼Œéœ€è¦è®© es å’Œ kibana å®¹å™¨äº’è”ã€‚è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªç½‘ç»œï¼š</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker network create es-net <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å®‰è£…</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker run -d \
--name es \
-e "ES_JAVA_OPTS=-Xms512m -Xmx512m" \
-e "discovery.type=single-node" \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
--privileged \
--network es-net \
-p 9200:9200 \
-p 9300:9300 \
elasticsearch:7.12.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘½ä»¤è§£é‡Šï¼š</p>
<ul>
<li><code>-e "cluster.name=es-docker-cluster"</code>ï¼šè®¾ç½®é›†ç¾¤åç§°</li>
<li><code>-e "http.host=0.0.0.0"</code>ï¼šç›‘å¬çš„åœ°å€ï¼Œå¯ä»¥å¤–ç½‘è®¿é—®</li>
<li><code>-e "ES_JAVA_OPTS=-Xms512m -Xmx512m"</code>ï¼šå†…å­˜å¤§å°</li>
<li><code>-e "discovery.type=single-node"</code>ï¼šéé›†ç¾¤æ¨¡å¼</li>
<li><code>-v es-data:/usr/share/elasticsearch/data</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ•°æ®ç›®å½•</li>
<li><code>-v es-logs:/usr/share/elasticsearch/logs</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ—¥å¿—ç›®å½•</li>
<li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>ï¼šæŒ‚è½½é€»è¾‘å·ï¼Œç»‘å®šesçš„æ’ä»¶ç›®å½•</li>
<li><code>--privileged</code>ï¼šæˆäºˆé€»è¾‘å·è®¿é—®æƒ</li>
<li><code>--network es-net</code> ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­</li>
<li><code>-p 9200:9200</code>ï¼šç«¯å£æ˜ å°„é…ç½®</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:9200/">http://192.168.211.128:9200</a> å³å¯çœ‹åˆ° elasticsearch çš„å“åº”ç»“æœ</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918214620.png"><img src="https://cdn.xn2001.com/img/2021/20210918214620.png!/format/webp" alt="img"></a></p>
<h2 id="å®‰è£…kibana"><a href="#å®‰è£…kibana" class="headerlink" title="å®‰è£…kibana"></a>å®‰è£…kibana</h2><p>kibana å¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª elasticsearch çš„å¯è§†åŒ–ç•Œé¢ï¼Œä¾¿äºæˆ‘ä»¬å­¦ä¹ å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker run -d \
--name kibana \
-e ELASTICSEARCH_HOSTS=http://es:9200 \
--network=es-net \
-p 5601:5601  \
kibana:7.12.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>--network es-net</code> ï¼šåŠ å…¥ä¸€ä¸ªåä¸º es-net çš„ç½‘ç»œä¸­ï¼Œä¸ elasticsearch åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­</li>
<li><code>-e ELASTICSEARCH_HOSTS=http://es:9200"</code>ï¼šè®¾ç½® elasticsearch çš„åœ°å€ï¼Œå› ä¸º kibana å·²ç»ä¸ elasticsearch åœ¨ä¸€ä¸ªç½‘ç»œï¼Œå› æ­¤å¯ä»¥ç”¨å®¹å™¨åç›´æ¥è®¿é—® elasticsearch</li>
<li><code>-p 5601:5601</code>ï¼šç«¯å£æ˜ å°„é…ç½®</li>
</ul>
<p>è®¿é—®åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:5601/">http://192.168.211.128:5601</a>ï¼Œå³å¯çœ‹åˆ°ç»“æœ</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918214722.png"><img src="https://cdn.xn2001.com/img/2021/20210918214722.png!/format/webp" alt="img"></a></p>
<p>æ§åˆ¶é¢æ¿ï¼š<a target="_blank" rel="noopener" href="http://192.168.211.128:5601/app/dev_tools#/console">http://192.168.211.128:5601/app/dev_tools#/console</a></p>
<h2 id="å®‰è£…IKåˆ†è¯å™¨"><a href="#å®‰è£…IKåˆ†è¯å™¨" class="headerlink" title="å®‰è£…IKåˆ†è¯å™¨"></a>å®‰è£…IKåˆ†è¯å™¨</h2><p>ç”±äºå›½å†…è®¿é—® GitHub è¾ƒæ…¢ï¼Œæˆ‘ä»¬é€‰æ‹©ç¦»çº¿æ¨¡å¼å®‰è£…ã€‚</p>
<p>å®‰è£…æ’ä»¶éœ€è¦çŸ¥é“ elasticsearch çš„ plugins ç›®å½•ä½ç½®ï¼Œè€Œæˆ‘ä»¬ç”¨äº†æ•°æ®å·æŒ‚è½½ï¼Œå› æ­¤éœ€è¦æŸ¥çœ‹ elasticsearch çš„æ•°æ®å·ç›®å½•ï¼Œé€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker volume inspect es-plugins<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ˜¾ç¤ºç»“æœï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"CreatedAt"</span><span class="token operator">:</span> <span class="token string">"2022-05-06T10:06:34+08:00"</span><span class="token punctuation">,</span>
        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Mountpoint"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/es-plugins/_data"</span><span class="token punctuation">,</span>
        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"es-plugins"</span><span class="token punctuation">,</span>
        <span class="token property">"Options"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Scope"</span><span class="token operator">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯´æ˜ plugins ç›®å½•è¢«æŒ‚è½½åˆ°äº† <code>/var/lib/docker/volumes/es-plugins/_data </code>è¿™ä¸ªç›®å½•ä¸­</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918215615.png"><img src="https://cdn.xn2001.com/img/2021/20210918215615.png!/format/webp" alt="img"></a></p>
<p>é‡å¯å®¹å™¨</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 4ã€é‡å¯å®¹å™¨</span>
<span class="token function">docker</span> restart es

<span class="token comment"># æŸ¥çœ‹esæ—¥å¿—</span>
<span class="token function">docker</span> logs -f es<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li><code>ik_smart</code>ï¼šæ™ºèƒ½åˆ‡åˆ†ï¼Œç²—ç²’åº¦</li>
<li><code>ik_max_word</code>ï¼šæœ€ç»†åˆ‡åˆ†ï¼Œç»†ç²’åº¦</li>
</ul>
<p>æˆ‘ä»¬åœ¨ä¸Šé¢çš„ Kibana æ§åˆ¶å°æµ‹è¯•</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /_analyze
<span class="token punctuation">{</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"é’Ÿè€å¸ˆä½ å¥½èœå•Š"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="æ‰©å±•è¯è¯å…¸-1"><a href="#æ‰©å±•è¯è¯å…¸-1" class="headerlink" title="æ‰©å±•è¯è¯å…¸"></a>æ‰©å±•è¯è¯å…¸</h2><p>åœ¨ä¸Šé¢çš„IKåˆ†è¯å™¨æˆ‘ä»¬å¯ä»¥éšç€çƒ­ç‚¹è¯æ¥æ‰©å±•ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ ï¼Œæ¯”å¦‚ â€é’Ÿè€å¸ˆåº”è¯¥æ˜¯ä¸€ä¸ªçƒ­ç‚¹è¯â€œï¼Œå¦å¤–ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸€äº›åœç”¨æ‰çš„æ•æ„Ÿè¯ï¼Œè®©å…¶ä¸è¿›è¡Œåˆ†è¯ã€‚</p>
<p>æ‰“å¼€IKåˆ†è¯å™¨ config ç›®å½•æ˜¯ <code>IKAnalyzer.cfg.xml</code>ï¼Œæ·»åŠ ä¸€ä¸ªæ–‡ä»¶åï¼Œæˆ‘ä»¬ä»¥ <code>ext.dic</code> æ–‡ä»¶åä¸ºä¾‹ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918221159.png"><img src="https://cdn.xn2001.com/img/2021/20210918221159.png!/format/webp" alt="img"></a></p>
<p>æˆ‘ä»¬å»åˆ›å»º <code>ext.dic</code> ï¼Œåœ¨å…¶ä¸­æ·»åŠ çƒ­ç‚¹è¯å°±å¥½äº†ï¼Œä¸€ä¸ªè¯ä¸€è¡Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918220910.png"><img src="https://cdn.xn2001.com/img/2021/20210918220910.png!/format/webp" alt="img"></a></p>
<p>é‡å¯ elasticsearch</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker restart es<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é‡æ–°æµ‹è¯•</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /_analyze
<span class="token punctuation">{</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"é’Ÿè€å¸ˆä½ å¥½èœå•Š"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918221424.png"><img src="https://cdn.xn2001.com/img/2021/20210918221424.png!/format/webp" alt="img"></a></p>
<h2 id="ç´¢å¼•åº“æ“ä½œ-1"><a href="#ç´¢å¼•åº“æ“ä½œ-1" class="headerlink" title="ç´¢å¼•åº“æ“ä½œ"></a>ç´¢å¼•åº“æ“ä½œ</h2><h3 id="Mappingå±æ€§æ˜ å°„-1"><a href="#Mappingå±æ€§æ˜ å°„-1" class="headerlink" title="Mappingå±æ€§æ˜ å°„"></a>Mappingå±æ€§æ˜ å°„</h3><p>ç´¢å¼•åº“å°±ç±»ä¼¼æ•°æ®åº“è¡¨ï¼Œ<strong>mapping æ˜ å°„å°±ç±»ä¼¼è¡¨çš„ç»“æ„</strong></p>
<p>æˆ‘ä»¬è¦å‘ es ä¸­å­˜å‚¨æ•°æ®ï¼Œå¿…é¡»å…ˆåˆ›å»ºâ€œåº“â€å’Œâ€œè¡¨â€</p>
<p>mapping æ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„ mapping å±æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li>typeï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š<ul>
<li>å­—ç¬¦ä¸²ï¼štextï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€keywordï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰</li>
<li>æ•°å€¼ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€</li>
<li>å¸ƒå°”ï¼šboolean</li>
<li>æ—¥æœŸï¼šdate</li>
<li>å¯¹è±¡ï¼šobject</li>
</ul>
</li>
<li><strong>indexï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸º true</strong></li>
<li>analyzerï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨</li>
<li>propertiesï¼šè¯¥å­—æ®µçš„å­å­—æ®µ</li>
</ul>
<p>æˆ‘ä»¬ä»¥éœ€è¦å­˜å‚¨ä¸‹é¢çš„ JSON ä¸ºä¾‹æ¥è®²è§£</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"age"</span><span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
    <span class="token property">"weight"</span><span class="token operator">:</span> <span class="token number">52.1</span><span class="token punctuation">,</span>
    <span class="token property">"isMarried"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"é’Ÿè€å¸ˆçœŸèœ"</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"jialna@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">99.1</span><span class="token punctuation">,</span> <span class="token number">99.5</span><span class="token punctuation">,</span> <span class="token number">98.9</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"æ¹–"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"å¿ƒ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é¦–å…ˆå¯¹åº”çš„æ¯ä¸ªå­—æ®µæ˜ å°„ï¼ˆmappingï¼‰æƒ…å†µå¦‚ä¸‹ï¼š</p>
<ul>
<li>ageï¼šç±»å‹ä¸º integerï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>weightï¼šç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>isMarriedï¼šç±»å‹ä¸ºbooleanï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>infoï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ textï¼›å‚ä¸æœç´¢ï¼Œindexä¸ºtrueï¼›åˆ†è¯å™¨å¯ä»¥ç”¨ ik_smart</li>
<li>emailï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸éœ€è¦åˆ†è¯ï¼Œå› æ­¤æ˜¯ keywordï¼›ä¸å‚ä¸æœç´¢ï¼Œindex ä¸º falseï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>scoreï¼šè™½ç„¶æ˜¯æ•°ç»„ï¼Œ<strong>ä½†æ˜¯æˆ‘ä»¬åªçœ‹å…ƒç´ çš„ç±»å‹</strong>ï¼Œç±»å‹ä¸º floatï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>nameï¼šç±»å‹ä¸º objectï¼Œéœ€è¦å®šä¹‰å¤šä¸ªå­å±æ€§<ul>
<li>name.firstNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
<li>name.lastNameï¼šç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œä¸éœ€è¦åˆ†è¯ï¼Œkeywordï¼›å‚ä¸æœç´¢ï¼Œindex ä¸º trueï¼›æ— éœ€åˆ†è¯å™¨</li>
</ul>
</li>
</ul>
<h3 id="åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„-1"><a href="#åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„-1" class="headerlink" title="åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„"></a>åˆ›å»ºç´¢å¼•åº“å’Œæ˜ å°„</h3><p>ä¸Šé¢æˆ‘ä»¬äº†è§£äº† Mapping å±æ€§æ˜ å°„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»çœ‹çœ‹å¦‚ä½•åˆ›å»ºç´¢å¼•åº“åŠæ˜ å°„ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /ç´¢å¼•åº“åç§°
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"å­—æ®µå"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"å­—æ®µå2"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"å­—æ®µå3"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"å­å­—æ®µ"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...ç•¥</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
PUT /xn2001
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"info"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"email"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210918224647.png"><img src="https://cdn.xn2001.com/img/2021/20210918224647.png!/format/webp" alt="img"></a></p>
<p>æˆ‘ä»¬ç”¨çœŸå®çš„æ•°æ®åº“è¡¨æ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•åº“</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210919164626.png"><img src="https://cdn.xn2001.com/img/2021/20210919164626.png!/format/webp" alt="img"></a></p>
<ul>
<li>å­—æ®µåã€å­—æ®µæ•°æ®ç±»å‹ï¼Œå¯ä»¥å‚è€ƒæ•°æ®è¡¨ç»“æ„çš„åç§°å’Œç±»å‹</li>
<li>æ˜¯å¦å‚ä¸æœç´¢è¦åˆ†æä¸šåŠ¡æ¥åˆ¤æ–­ï¼Œä¾‹å¦‚å›¾ç‰‡åœ°å€ï¼Œå°±æ— éœ€å‚ä¸æœç´¢</li>
<li>æ˜¯å¦åˆ†è¯å‘¢è¦çœ‹å†…å®¹ï¼Œå†…å®¹å¦‚æœæ˜¯ä¸€ä¸ªæ•´ä½“å°±æ— éœ€åˆ†è¯</li>
<li>åˆ†è¯å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç»Ÿä¸€ä½¿ç”¨ <code>ik_max_word</code></li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /hotel
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç‰¹æ®Šå­—æ®µè¯´æ˜ï¼š</p>
<ul>
<li>locationï¼šåœ°ç†åæ ‡ï¼Œé‡Œé¢åŒ…å«ç²¾åº¦ã€çº¬åº¦</li>
<li>allï¼šä¸€ä¸ªç»„åˆå­—æ®µï¼Œå…¶ç›®çš„æ˜¯å°†å¤šå­—æ®µçš„å€¼åˆ©ç”¨ <code>copy_to</code> åˆå¹¶ï¼Œæä¾›ç»™ç”¨æˆ·æœç´¢ï¼Œè¿™æ ·ä¸€æ¥å°±åªéœ€è¦æœç´¢ä¸€ä¸ªå­—æ®µå°±å¯ä»¥å¾—åˆ°ç»“æœï¼Œæ€§èƒ½æ›´å¥½ã€‚</li>
</ul>
<blockquote>
<p>ESä¸­æ”¯æŒä¸¤ç§åœ°ç†åæ ‡æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li>geo_pointï¼šç”±çº¬åº¦ï¼ˆlatitudeï¼‰å’Œç»åº¦ï¼ˆlongitudeï¼‰ç¡®å®šçš„ä¸€ä¸ªç‚¹ã€‚ä¾‹å¦‚ï¼šâ€32.8752345, 120.2981576â€</li>
<li>geo_shapeï¼šæœ‰å¤šä¸ª geo_point ç»„æˆçš„å¤æ‚å‡ ä½•å›¾å½¢ã€‚ä¾‹å¦‚ä¸€æ¡ç›´çº¿ï¼Œâ€LINESTRING (-77.03653 38.897676, -77.009051 38.889939)â€</li>
</ul>
</blockquote>
<h3 id="ä¿®æ”¹ç´¢å¼•åº“-1"><a href="#ä¿®æ”¹ç´¢å¼•åº“-1" class="headerlink" title="ä¿®æ”¹ç´¢å¼•åº“"></a>ä¿®æ”¹ç´¢å¼•åº“</h3><p>å€’æ’ç´¢å¼•ç»“æ„è™½ç„¶ä¸å¤æ‚ï¼Œä½†æ˜¯ä¸€æ—¦æ•°æ®ç»“æ„æ”¹å˜ï¼ˆæ¯”å¦‚æ”¹å˜äº†åˆ†è¯å™¨ï¼‰ï¼Œå°±éœ€è¦é‡æ–°åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œè¿™ç®€ç›´æ˜¯ç¾éš¾ã€‚å› æ­¤ç´¢å¼•åº“<strong>ä¸€æ—¦åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹ mapping</strong></p>
<p>è™½ç„¶æ— æ³•ä¿®æ”¹ mapping ä¸­å·²æœ‰çš„å­—æ®µï¼Œä½†æ˜¯å´å…è®¸æ·»åŠ æ–°çš„å­—æ®µåˆ° mapping ä¸­ï¼Œä¸ä¼šå¯¹å€’æ’ç´¢å¼•äº§ç”Ÿå½±å“ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /ç´¢å¼•åº“å/_mapping
<span class="token punctuation">{</span>
  <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"æ–°å­—æ®µå"</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ é™¤ç´¢å¼•åº“-1"><a href="#åˆ é™¤ç´¢å¼•åº“-1" class="headerlink" title="åˆ é™¤ç´¢å¼•åº“"></a>åˆ é™¤ç´¢å¼•åº“</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">DELETE /ç´¢å¼•åº“å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="æŸ¥è¯¢ç´¢å¼•åº“-1"><a href="#æŸ¥è¯¢ç´¢å¼•åº“-1" class="headerlink" title="æŸ¥è¯¢ç´¢å¼•åº“"></a>æŸ¥è¯¢ç´¢å¼•åº“</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /æ•°æ®åº“å<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="DSLæ–‡æ¡£æ“ä½œ-1"><a href="#DSLæ–‡æ¡£æ“ä½œ-1" class="headerlink" title="DSLæ–‡æ¡£æ“ä½œ"></a>DSLæ–‡æ¡£æ“ä½œ</h2><h3 id="æ–°å¢æ–‡æ¡£-1"><a href="#æ–°å¢æ–‡æ¡£-1" class="headerlink" title="æ–°å¢æ–‡æ¡£"></a>æ–°å¢æ–‡æ¡£</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /ç´¢å¼•åº“å/_doc/æ–‡æ¡£id
<span class="token punctuation">{</span>
    <span class="token property">"å­—æ®µ1"</span><span class="token operator">:</span> <span class="token string">"å€¼1"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ2"</span><span class="token operator">:</span> <span class="token string">"å€¼2"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ3"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"å­å±æ€§1"</span><span class="token operator">:</span> <span class="token string">"å€¼3"</span><span class="token punctuation">,</span>
        <span class="token property">"å­å±æ€§2"</span><span class="token operator">:</span> <span class="token string">"å€¼4"</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
POST /xn2001/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"æˆ‘ä¸ä¼šJava"</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"jialna@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"é’Ÿ"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"å¼Ÿå¼Ÿ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ä¿®æ”¹æ–‡æ¡£-1"><a href="#ä¿®æ”¹æ–‡æ¡£-1" class="headerlink" title="ä¿®æ”¹æ–‡æ¡£"></a>ä¿®æ”¹æ–‡æ¡£</h3><p>ä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£</li>
<li>å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</li>
</ul>
<p><strong>å…¨é‡ä¿®æ”¹</strong>æ˜¯è¦†ç›–åŸæ¥çš„æ–‡æ¡£ï¼Œå…¶æœ¬è´¨æ˜¯ï¼š</p>
<ul>
<li>æ ¹æ®æŒ‡å®šçš„ id åˆ é™¤æ–‡æ¡£</li>
<li>æ–°å¢ä¸€ä¸ªç›¸åŒ id çš„æ–‡æ¡£</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šå¦‚æœæ ¹æ® id åˆ é™¤æ—¶ï¼Œid ä¸å­˜åœ¨ï¼Œç¬¬äºŒæ­¥çš„æ–°å¢ä¹Ÿä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å˜æˆäº†æ–°å¢æ“ä½œ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /<span class="token punctuation">{</span>ç´¢å¼•åº“å<span class="token punctuation">}</span>/_doc/id
<span class="token punctuation">{</span>
    <span class="token property">"å­—æ®µ1"</span><span class="token operator">:</span> <span class="token string">"å€¼1"</span><span class="token punctuation">,</span>
    <span class="token property">"å­—æ®µ2"</span><span class="token operator">:</span> <span class="token string">"å€¼2"</span><span class="token punctuation">,</span>
    <span class="token comment">// ... ç•¥</span>
<span class="token punctuation">}</span>
PUT /xn2001/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">"info"</span><span class="token operator">:</span> <span class="token string">"æˆ‘ä¹Ÿä¸ä¼šæ•²ä»£ç "</span><span class="token punctuation">,</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"3300123589@qq.com"</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"firstName"</span><span class="token operator">:</span> <span class="token string">"å¼Ÿå¼Ÿ"</span><span class="token punctuation">,</span>
        <span class="token property">"lastName"</span><span class="token operator">:</span> <span class="token string">"é’Ÿ"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>å¢é‡ä¿®æ”¹</strong>æ˜¯åªä¿®æ”¹æŒ‡å®š id åŒ¹é…çš„æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /<span class="token punctuation">{</span>ç´¢å¼•åº“å<span class="token punctuation">}</span>/_update/æ–‡æ¡£id
<span class="token punctuation">{</span>
    <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token property">"å­—æ®µå"</span><span class="token operator">:</span> <span class="token string">"æ–°çš„å€¼"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
POST /heima/_update/<span class="token number">1</span>
<span class="token punctuation">{</span>
  <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"update@qq.com"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æŸ¥è¯¢æ–‡æ¡£"><a href="#æŸ¥è¯¢æ–‡æ¡£" class="headerlink" title="æŸ¥è¯¢æ–‡æ¡£"></a>æŸ¥è¯¢æ–‡æ¡£</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /<span class="token punctuation">{</span>ç´¢å¼•åº“åç§°<span class="token punctuation">}</span>/_doc/<span class="token punctuation">{</span>id<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="åˆ é™¤æ–‡æ¡£"><a href="#åˆ é™¤æ–‡æ¡£" class="headerlink" title="åˆ é™¤æ–‡æ¡£"></a>åˆ é™¤æ–‡æ¡£</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json">DELETE /<span class="token punctuation">{</span>ç´¢å¼•åº“å<span class="token punctuation">}</span>/_doc/<span class="token punctuation">{</span>id<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230101221215408.png" alt="image-20230101221215408"></p>
<h2 id="RestClientæ–‡æ¡£æ“ä½œ"><a href="#RestClientæ–‡æ¡£æ“ä½œ" class="headerlink" title="RestClientæ–‡æ¡£æ“ä½œ"></a>RestClientæ–‡æ¡£æ“ä½œ</h2><p>ES å®˜æ–¹æä¾›äº†å„ç§ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œç”¨æ¥æ“ä½œ ESã€‚è¿™äº›å®¢æˆ·ç«¯çš„æœ¬è´¨å°±æ˜¯ç»„è£… DSL è¯­å¥ï¼Œé€šè¿‡ http è¯·æ±‚å‘é€ç»™ ESã€‚å®˜æ–¹æ–‡æ¡£åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p>å…¶ä¸­çš„Java Rest ClientåˆåŒ…æ‹¬ä¸¤ç§ï¼š</p>
<ul>
<li>Java Low Level Rest Client</li>
<li>Java High Level Rest Client</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210919234405.png!/format/webp" alt="img"></p>
<p>æˆ‘ä»¬ä¸‹é¢å­¦ä¹ çš„æ˜¯ <strong>Java HighLevel Rest Client å®¢æˆ·ç«¯ API</strong></p>
<h3 id="åˆå§‹åŒ–RestClient"><a href="#åˆå§‹åŒ–RestClient" class="headerlink" title="åˆå§‹åŒ–RestClient"></a>åˆå§‹åŒ–RestClient</h3><p>åœ¨ elasticsearch æä¾›çš„ API ä¸­ï¼Œelasticsearch ä¸€åˆ‡äº¤äº’éƒ½å°è£…åœ¨ä¸€ä¸ªåä¸º RestHighLevelClient çš„ç±»ä¸­ï¼Œå¿…é¡»å…ˆå®Œæˆè¿™ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œå»ºç«‹ä¸ elasticsearch çš„è¿æ¥ã€‚</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>SpringBoot é»˜è®¤çš„ ES ç‰ˆæœ¬æ˜¯ 7.6.2ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–é»˜è®¤çš„ESç‰ˆæœ¬</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆå§‹åŒ– RestHighLevelClientï¼Œåˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç±» HotelIndexTestï¼Œç„¶åå°†åˆå§‹åŒ–çš„ä»£ç ç¼–å†™åœ¨ <code>@BeforeEach</code> æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelIndexTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ›å»ºç´¢å¼•åº“"><a href="#åˆ›å»ºç´¢å¼•åº“" class="headerlink" title="åˆ›å»ºç´¢å¼•åº“"></a><strong>åˆ›å»ºç´¢å¼•åº“</strong></h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">//æŒ‡å®šç´¢å¼•åº“å</span>
    <span class="token class-name">CreateIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å†™å…¥JSONæ•°æ®ï¼Œè¿™é‡Œæ˜¯Mappingæ˜ å°„</span>
    hotel<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token class-name">HotelConstants</span><span class="token punctuation">.</span>MAPPING_TEMPLATE<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ›å»ºç´¢å¼•åº“</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelConstants</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> MAPPING_TEMPLATE <span class="token operator">=</span> <span class="token string">"{\n"</span> <span class="token operator">+</span>
            <span class="token string">"  \"mappings\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"    \"properties\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"id\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"name\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"address\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"price\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"score\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"brand\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"city\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"starName\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"business\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"location\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"geo_point\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"pic\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"all\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      }\n"</span> <span class="token operator">+</span>
            <span class="token string">"    }\n"</span> <span class="token operator">+</span>
            <span class="token string">"  }\n"</span> <span class="token operator">+</span>
            <span class="token string">"}"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ é™¤ç´¢å¼•åº“-2"><a href="#åˆ é™¤ç´¢å¼•åº“-2" class="headerlink" title="åˆ é™¤ç´¢å¼•åº“"></a>åˆ é™¤ç´¢å¼•åº“</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">deleteHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DeleteIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ¤æ–­ç´¢å¼•åº“"><a href="#åˆ¤æ–­ç´¢å¼•åº“" class="headerlink" title="åˆ¤æ–­ç´¢å¼•åº“"></a>åˆ¤æ–­ç´¢å¼•åº“</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">existHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">GetIndexRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230102110309856.png" alt="image-20230102110309856"></p>
<h3 id="æ–°å¢æ–‡æ¡£-2"><a href="#æ–°å¢æ–‡æ¡£-2" class="headerlink" title="æ–°å¢æ–‡æ¡£"></a>æ–°å¢æ–‡æ¡£</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/9/19 17:18
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDocumentTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">61083L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.å‡†å¤‡Requestå¯¹è±¡</span>
        <span class="token class-name">IndexRequest</span> hotelIndex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.å‡†å¤‡Jsonæ–‡æ¡£</span>
        hotelIndex<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.å‘é€è¯·æ±‚</span>
        restHighLevelClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>hotelIndex<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æŸ¥è¯¢æ–‡æ¡£-1"><a href="#æŸ¥è¯¢æ–‡æ¡£-1" class="headerlink" title="æŸ¥è¯¢æ–‡æ¡£"></a>æŸ¥è¯¢æ–‡æ¡£</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testGetDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.å‡†å¤‡Request</span>
    <span class="token class-name">GetRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”</span>
    <span class="token class-name">GetResponse</span> hotelResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.è§£æå“åº”ç»“æœ</span>
    <span class="token class-name">String</span> hotelDocSourceAsString <span class="token operator">=</span> hotelResponse<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.jsonè½¬å®ä½“ç±»</span>
    <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>hotelDocSourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ é™¤æ–‡æ¡£-1"><a href="#åˆ é™¤æ–‡æ¡£-1" class="headerlink" title="åˆ é™¤æ–‡æ¡£"></a>åˆ é™¤æ–‡æ¡£</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DeleteRequest</span> hotel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>hotel<span class="token punctuation">,</span><span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ä¿®æ”¹æ–‡æ¡£-2"><a href="#ä¿®æ”¹æ–‡æ¡£-2" class="headerlink" title="ä¿®æ”¹æ–‡æ¡£"></a>ä¿®æ”¹æ–‡æ¡£</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¿®æ”¹æ–‡æ¡£æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£</li>
<li>å¢é‡ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</li>
</ul>
<p>åœ¨ RestClient çš„ API ä¸­ï¼Œå…¨é‡ä¿®æ”¹ä¸æ–°å¢çš„ API å®Œå…¨ä¸€è‡´ï¼Œåˆ¤æ–­ä¾æ®æ˜¯ ID</p>
<ul>
<li>å¦‚æœæ–°å¢æ—¶ï¼ŒIDå·²ç»å­˜åœ¨ï¼Œåˆ™ä¿®æ”¹</li>
<li>å¦‚æœæ–°å¢æ—¶ï¼ŒIDä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢</li>
</ul>
<p>æ‰€ä»¥å…¨é‡ä¿®æ”¹å†™æ³•ä¸æ–°å¢æ–‡æ¡£ä¸€æ ·ï¼Œä¸‹é¢æˆ‘ä»¬ä¸»è¦æ˜¯ä»‹ç»å¢é‡ä¿®æ”¹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.å‡†å¤‡Request</span>
    <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å‡†å¤‡è¯·æ±‚å‚æ•°</span>
    request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>
        <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"952"</span><span class="token punctuation">,</span>
        <span class="token string">"starName"</span><span class="token punctuation">,</span> <span class="token string">"å››é’»"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.å‘é€è¯·æ±‚</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230102112332560.png" alt="image-20230102112332560"></p>
<h3 id="æ‰¹é‡å¯¼å…¥æ–‡æ¡£"><a href="#æ‰¹é‡å¯¼å…¥æ–‡æ¡£" class="headerlink" title="æ‰¹é‡å¯¼å…¥æ–‡æ¡£"></a>æ‰¹é‡å¯¼å…¥æ–‡æ¡£</h3><p>æ¡ˆä¾‹éœ€æ±‚ï¼šåˆ©ç”¨ <code>BulkRequest</code> æ‰¹é‡å°†æ•°æ®åº“æ•°æ®å¯¼å…¥åˆ°ç´¢å¼•åº“ä¸­ã€‚</p>
<ul>
<li>åˆ©ç”¨ mybatis-plus æŸ¥è¯¢é…’åº—æ•°æ®</li>
<li>å°†æŸ¥è¯¢åˆ°çš„é…’åº—æ•°æ®ï¼ˆHotelï¼‰è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹æ•°æ®ï¼ˆHotelDocï¼‰</li>
<li>åˆ©ç”¨ JavaRestClient ä¸­çš„ BulkRequest æ‰¹å¤„ç†ï¼Œå®ç°æ‰¹é‡æ–°å¢æ–‡æ¡£</li>
</ul>
<p>æ‰¹é‡å¤„ç† BulkRequestï¼Œå…¶æœ¬è´¨å°±æ˜¯å°†å¤šä¸ªæ™®é€šçš„ CRUD è¯·æ±‚ç»„åˆåœ¨ä¸€èµ·å‘é€ã€‚</p>
<p>å› æ­¤Bulkä¸­æ·»åŠ äº†å¤šä¸ªIndexRequestï¼Œå°±æ˜¯æ‰¹é‡æ–°å¢åŠŸèƒ½äº†ã€‚ç¤ºä¾‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210919234350.png!/format/webp" alt="img"></p>
<p>åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºè‡ªå·±éœ€è¦çš„ä»£ç ï¼Œå¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">&gt;</span></span> hotelList <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotelList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    restHighLevelClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>æ€»ä¹‹ï¼Œåœ¨ Java ä»£ç ä¸­ï¼Œclient é’ˆå¯¹æ“ä½œç´¢å¼•åº“è¿˜æ˜¯æ–‡æ¡£ï¼ŒåŸºæœ¬éƒ½æ˜¯ä¸€æ ·çš„ä»£ç </p>
<p>restHighLevelClient.indices().xxxï¼Œä»£è¡¨æ“ä½œç´¢å¼•åº“</p>
<p>restHighLevelClient.xxxï¼Œä»£è¡¨æ“ä½œæ–‡æ¡£</p>
<p>è€Œå…¶ä¸­æ‰€éœ€è¦çš„å‚æ•°ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ <strong>ctrl+p</strong> è¿™æ ·çš„å¿«æ·é”®å»æŸ¥çœ‹å°±å¯ä»¥ï¼Œä¸éœ€è¦å•ç‹¬è®°ä½ã€‚</p>
<h2 id="DSLæ–‡æ¡£æŸ¥è¯¢"><a href="#DSLæ–‡æ¡£æŸ¥è¯¢" class="headerlink" title="DSLæ–‡æ¡£æŸ¥è¯¢"></a>DSLæ–‡æ¡£æŸ¥è¯¢</h2><p><img src="https://md-1314217273.cos.ap-nanjing.myqcloud.com//imgimage-20230103205845227.png" alt="image-20230103205845227"></p>
<p>Elasticsearch æä¾›äº†åŸºäº JSON çš„ DSL(<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Domain Specific Language</a>)æ¥å®šä¹‰æŸ¥è¯¢ã€‚å¸¸è§çš„æŸ¥è¯¢ç±»å‹åŒ…æ‹¬ï¼š</p>
<p><strong>æŸ¥è¯¢æ‰€æœ‰</strong>ï¼šæŸ¥è¯¢å‡ºæ‰€æœ‰æ•°æ®ï¼Œä¸€èˆ¬æµ‹è¯•ç”¨ã€‚ä¾‹å¦‚ï¼šmatch_all</p>
<p><strong>å…¨æ–‡æ£€ç´¢ï¼ˆfull textï¼‰æŸ¥è¯¢</strong>ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥å†…å®¹åˆ†è¯ï¼Œç„¶åå»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>match_query</li>
<li>multi_match_query</li>
</ul>
<p><strong>ç²¾ç¡®æŸ¥è¯¢</strong>ï¼šæ ¹æ®ç²¾ç¡®è¯æ¡å€¼æŸ¥æ‰¾æ•°æ®ï¼Œä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>ids</li>
<li>range</li>
<li>term</li>
</ul>
<p><strong>åœ°ç†ï¼ˆgeoï¼‰æŸ¥è¯¢</strong>ï¼šæ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>geo_distance</li>
<li>geo_bounding_box</li>
</ul>
<p><strong>å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢</strong>ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†ä¸Šè¿°å„ç§æŸ¥è¯¢æ¡ä»¶ç»„åˆèµ·æ¥ï¼Œåˆå¹¶æŸ¥è¯¢æ¡ä»¶ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>bool</li>
<li>function_score</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// æŸ¥è¯¢æ‰€æœ‰</span>
GET <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="å…¨æ–‡æ£€ç´¢"><a href="#å…¨æ–‡æ£€ç´¢" class="headerlink" title="å…¨æ–‡æ£€ç´¢"></a>å…¨æ–‡æ£€ç´¢</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå…¨æ–‡æ£€ç´¢æŸ¥è¯¢çš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯¹ç”¨æˆ·æœç´¢çš„å†…å®¹åšåˆ†è¯ï¼Œå¾—åˆ°è¯æ¡</li>
<li>æ ¹æ®è¯æ¡å»å€’æ’ç´¢å¼•åº“ä¸­åŒ¹é…ï¼Œå¾—åˆ°æ–‡æ¡£id</li>
<li>æ ¹æ®æ–‡æ¡£idæ‰¾åˆ°æ–‡æ¡£ï¼Œè¿”å›ç»™ç”¨æˆ·</li>
</ul>
<p>æ¯”è¾ƒå¸¸ç”¨çš„åœºæ™¯åŒ…æ‹¬ï¼š</p>
<ul>
<li>å•†åŸçš„è¾“å…¥æ¡†æœç´¢</li>
<li>ç™¾åº¦è¾“å…¥æ¡†æœç´¢</li>
</ul>
<p>ä¾‹å¦‚äº¬ä¸œï¼š</p>
<p>å› ä¸ºæ˜¯æ‹¿ç€è¯æ¡å»åŒ¹é…ï¼Œå› æ­¤å‚ä¸æœç´¢çš„å­—æ®µä¹Ÿå¿…é¡»æ˜¯å¯åˆ†è¯çš„textç±»å‹çš„å­—æ®µã€‚</p>
<p>å¸¸è§çš„å…¨æ–‡æ£€ç´¢æŸ¥è¯¢åŒ…æ‹¬ï¼š</p>
<ul>
<li>match æŸ¥è¯¢ï¼šå•å­—æ®µæŸ¥è¯¢</li>
<li>multi_match æŸ¥è¯¢ï¼šå¤šå­—æ®µæŸ¥è¯¢ï¼Œä»»æ„ä¸€ä¸ªå­—æ®µç¬¦åˆæ¡ä»¶å°±ç®—ç¬¦åˆæŸ¥è¯¢æ¡ä»¶</li>
</ul>
<p>match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>mulit_match æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span><span class="token punctuation">,</span>
      <span class="token string">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"FIELD1"</span><span class="token punctuation">,</span> <span class="token string">" FIELD12"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å› ä¸ºæˆ‘ä»¬å°† brandã€nameã€business å€¼éƒ½åˆ©ç”¨ <strong>copy_to</strong> å¤åˆ¶åˆ°äº† <strong>all</strong> å­—æ®µä¸­ï¼Œä½ æ ¹æ®ä¸‰ä¸ªå­—æ®µæœç´¢ï¼Œå’Œæ ¹æ® allå­—æ®µæœç´¢æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"all"</span><span class="token operator">:</span> <span class="token string">"7å¤©é…’åº—"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

GET <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token string">"7å¤©é…’åº—"</span><span class="token punctuation">,</span>
      <span class="token string">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"brand"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æœç´¢å­—æ®µè¶Šå¤šï¼Œå¯¹æŸ¥è¯¢æ€§èƒ½å½±å“è¶Šå¤§ï¼Œå› æ­¤å»ºè®®é‡‡ç”¨ copy_to å°†å¤šä¸ªå­—æ®µåˆå¹¶ä¸ºä¸€ä¸ªï¼Œç„¶åä½¿ç”¨å•å­—æ®µæŸ¥è¯¢çš„æ–¹å¼ã€‚</strong></p>
<h3 id="ç²¾å‡†æŸ¥è¯¢"><a href="#ç²¾å‡†æŸ¥è¯¢" class="headerlink" title="ç²¾å‡†æŸ¥è¯¢"></a>ç²¾å‡†æŸ¥è¯¢</h3><p>ç²¾ç¡®æŸ¥è¯¢ä¸€èˆ¬æ˜¯æŸ¥æ‰¾ keywordã€æ•°å€¼ã€æ—¥æœŸã€boolean ç­‰ç±»å‹å­—æ®µã€‚æ‰€ä»¥<strong>ä¸ä¼š</strong>å¯¹æœç´¢æ¡ä»¶åˆ†è¯ã€‚</p>
<ul>
<li>termï¼šæ ¹æ®è¯æ¡ç²¾ç¡®å€¼æŸ¥è¯¢</li>
<li>rangeï¼šæ ¹æ®å€¼çš„èŒƒå›´æŸ¥è¯¢</li>
</ul>
<h4 id="termæŸ¥è¯¢"><a href="#termæŸ¥è¯¢" class="headerlink" title="termæŸ¥è¯¢"></a>termæŸ¥è¯¢</h4><p>å› ä¸ºç²¾ç¡®æŸ¥è¯¢çš„å­—æ®µæœæ˜¯ä¸åˆ†è¯çš„å­—æ®µï¼Œå› æ­¤æŸ¥è¯¢çš„æ¡ä»¶ä¹Ÿå¿…é¡»æ˜¯<strong>ä¸åˆ†è¯</strong>çš„è¯æ¡ã€‚æŸ¥è¯¢æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„å†…å®¹è·Ÿè‡ªåŠ¨å€¼å®Œå…¨åŒ¹é…æ—¶æ‰è®¤ä¸ºç¬¦åˆæ¡ä»¶ã€‚å¦‚æœç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿‡å¤šï¼Œåè€Œæœç´¢ä¸åˆ°æ•°æ®ã€‚</p>
<p>è¯­æ³•è¯´æ˜ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">// termæŸ¥è¯¢
GET /indexName/_search
{
  "query": {
    "term": {
      "FIELD": {
        "value": "VALUE"
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">GET <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"brand"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">"value"</span><span class="token operator">:</span> <span class="token string">"7å¤©é…’åº—"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="rangeæŸ¥è¯¢"><a href="#rangeæŸ¥è¯¢" class="headerlink" title="rangeæŸ¥è¯¢"></a>rangeæŸ¥è¯¢</h4><p>èŒƒå›´æŸ¥è¯¢ï¼Œä¸€èˆ¬åº”ç”¨åœ¨å¯¹æ•°å€¼ç±»å‹åšèŒƒå›´è¿‡æ»¤çš„æ—¶å€™ã€‚æ¯”å¦‚åšä»·æ ¼èŒƒå›´è¿‡æ»¤ã€‚</p>
<p>åŸºæœ¬è¯­æ³•ï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// rangeæŸ¥è¯¢</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// è¿™é‡Œçš„gteä»£è¡¨å¤§äºç­‰äºï¼Œgtåˆ™ä»£è¡¨å¤§äº</span>
        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// lteä»£è¡¨å°äºç­‰äºï¼Œltåˆ™ä»£è¡¨å°äº</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç¤ºä¾‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921182858.png!/format/webp" alt="img"></p>
<p>ç²¾ç¡®æŸ¥è¯¢å¸¸è§çš„æœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>term æŸ¥è¯¢ï¼šæ ¹æ®è¯æ¡ç²¾ç¡®åŒ¹é…ï¼Œä¸€èˆ¬æœç´¢ keyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€å¸ƒå°”ç±»å‹ã€æ—¥æœŸç±»å‹å­—æ®µ</li>
<li>range æŸ¥è¯¢ï¼šæ ¹æ®æ•°å€¼èŒƒå›´æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯æ•°å€¼ã€æ—¥æœŸçš„èŒƒå›´</li>
</ul>
<h3 id="åœ°ç†åæ ‡æŸ¥è¯¢"><a href="#åœ°ç†åæ ‡æŸ¥è¯¢" class="headerlink" title="åœ°ç†åæ ‡æŸ¥è¯¢"></a>åœ°ç†åæ ‡æŸ¥è¯¢</h3><p>åœ°ç†åæ ‡æŸ¥è¯¢ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢ï¼Œå®˜æ–¹æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</a></p>
<p>å¸¸è§çš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p>
<ul>
<li>æºç¨‹ï¼šæœç´¢æˆ‘é™„è¿‘çš„é…’åº—</li>
<li>æ»´æ»´ï¼šæœç´¢æˆ‘é™„è¿‘çš„å‡ºç§Ÿè½¦</li>
<li>å¾®ä¿¡ï¼šæœç´¢æˆ‘é™„è¿‘çš„äºº</li>
</ul>
<p>é™„è¿‘çš„é…’åº—ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183030.png!/format/webp" alt="img"></p>
<p>é™„è¿‘çš„è½¦ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183033.png!/format/webp" alt="img"></p>
<blockquote>
<p>çŸ©å½¢èŒƒå›´æŸ¥è¯¢</p>
</blockquote>
<p>çŸ©å½¢èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯ <code>geo_bounding_box</code> æŸ¥è¯¢ï¼ŒæŸ¥è¯¢åæ ‡è½åœ¨æŸä¸ªçŸ©å½¢èŒƒå›´çš„æ‰€æœ‰æ–‡æ¡£</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183124.gif" alt="img"></p>
<p>æŸ¥è¯¢æ—¶ï¼Œéœ€è¦æŒ‡å®šçŸ©å½¢çš„<strong>å·¦ä¸Š</strong>ã€<strong>å³ä¸‹</strong>ä¸¤ä¸ªç‚¹çš„åæ ‡ï¼Œç„¶åç”»å‡ºä¸€ä¸ªçŸ©å½¢ï¼Œè½åœ¨è¯¥çŸ©å½¢å†…çš„éƒ½æ˜¯ç¬¦åˆæ¡ä»¶çš„ç‚¹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// geo_bounding_boxæŸ¥è¯¢</span>
GET <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{</span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"geo_bounding_box"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">"top_left"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// å·¦ä¸Šç‚¹</span>
          <span class="token string">"lat"</span><span class="token operator">:</span> <span class="token number">31.1</span><span class="token punctuation">,</span>
          <span class="token string">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"bottom_right"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// å³ä¸‹ç‚¹</span>
          <span class="token string">"lat"</span><span class="token operator">:</span> <span class="token number">30.9</span><span class="token punctuation">,</span>
          <span class="token string">"lon"</span><span class="token operator">:</span> <span class="token number">121.7</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>é™„è¿‘æŸ¥è¯¢</p>
</blockquote>
<p>é™„è¿‘æŸ¥è¯¢ï¼Œä¹Ÿå«åšè·ç¦»æŸ¥è¯¢ï¼ˆgeo_distanceï¼‰ï¼šæŸ¥è¯¢åˆ°æŒ‡å®šä¸­å¿ƒç‚¹å°äºæŸä¸ªè·ç¦»å€¼çš„æ‰€æœ‰æ–‡æ¡£</p>
<p>åœ¨åœ°å›¾ä¸Šæ‰¾ä¸€ä¸ªç‚¹ä½œä¸ºåœ†å¿ƒï¼Œä»¥æŒ‡å®šè·ç¦»ä¸ºåŠå¾„ï¼Œç”»ä¸€ä¸ªåœ†ï¼Œè½åœ¨åœ†å†…çš„åæ ‡éƒ½ç®—ç¬¦åˆæ¡ä»¶ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183215.gif" alt="img"></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// geo_distance æŸ¥è¯¢</span>
GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"distance"</span><span class="token operator">:</span> <span class="token string">"15km"</span><span class="token punctuation">,</span> <span class="token comment">// åŠå¾„</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"31.21,121.5"</span> <span class="token comment">// åœ†å¿ƒ</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å…ˆæœç´¢é™†å®¶å˜´é™„è¿‘15kmçš„é…’åº—</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183228.png!/format/webp" alt="img"></p>
<p>å‘ç°å…±æœ‰47å®¶é…’åº—ï¼Œç„¶åæŠŠåŠå¾„ç¼©çŸ­åˆ°3å…¬é‡Œ</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921183240.png!/format/webp" alt="img"></p>
<p>å¯ä»¥å‘ç°ï¼Œæœç´¢åˆ°çš„é…’åº—æ•°é‡å‡å°‘åˆ°äº†5å®¶ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"31.034661,121.612282"</span><span class="token punctuation">,</span> <span class="token comment">//åœ†å¿ƒ</span>
          <span class="token property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> <span class="token comment">//æ’åº</span>
          <span class="token property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span> <span class="token comment">//å•ä½</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»“æœä¸ºï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"hits"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"_index"</span> <span class="token operator">:</span> <span class="token string">"hotel"</span><span class="token punctuation">,</span>
        <span class="token property">"_type"</span> <span class="token operator">:</span> <span class="token string">"_doc"</span><span class="token punctuation">,</span>
        <span class="token property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2056298828"</span><span class="token punctuation">,</span>
        <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            ...
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"sort"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token number">4.8541199685347785</span> <span class="token comment">//è¿™é‡Œçš„ç»“æœä¸ºç¦»åœ†å¿ƒçš„è·ç¦»</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ³¨æ„ï¼šè¾“å‡ºç»“æœä¸­çš„ <strong>sort</strong> ä¸ºè·ç¦»ï¼Œæ¯”è¾ƒå¸¸ç”¨ã€‚</p>
<p>æ’åºå®Œæˆåï¼Œé¡µé¢è¿˜è¦è·å–æˆ‘é™„è¿‘æ¯ä¸ªé…’åº—çš„å…·ä½“<strong>è·ç¦»</strong>å€¼ï¼Œè¿™ä¸ªå€¼åœ¨å“åº”ç»“æœä¸­æ˜¯ç‹¬ç«‹çš„ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211019011334.png!/format/webp" alt="img"></p>
<h3 id="å¤åˆæŸ¥è¯¢"><a href="#å¤åˆæŸ¥è¯¢" class="headerlink" title="å¤åˆæŸ¥è¯¢"></a>å¤åˆæŸ¥è¯¢</h3><p>å¤åˆï¼ˆcompoundï¼‰æŸ¥è¯¢ï¼šå¤åˆæŸ¥è¯¢å¯ä»¥å°†å…¶å®ƒç®€å•æŸ¥è¯¢ç»„åˆèµ·æ¥ï¼Œå®ç°æ›´å¤æ‚çš„æœç´¢é€»è¾‘ã€‚</p>
<ul>
<li>fuction scoreï¼šç®—åˆ†å‡½æ•°æŸ¥è¯¢ï¼Œå¯ä»¥æ§åˆ¶æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œæ§åˆ¶æ–‡æ¡£æ’å</li>
<li>bool queryï¼šå¸ƒå°”æŸ¥è¯¢ï¼Œåˆ©ç”¨é€»è¾‘å…³ç³»ç»„åˆå¤šä¸ªå…¶å®ƒçš„æŸ¥è¯¢ï¼Œå®ç°å¤æ‚æœç´¢</li>
</ul>
<h3 id="ç›¸å…³æ€§ç®—åˆ†"><a href="#ç›¸å…³æ€§ç®—åˆ†" class="headerlink" title="ç›¸å…³æ€§ç®—åˆ†"></a>ç›¸å…³æ€§ç®—åˆ†</h3><blockquote>
<p>è¿™éƒ¨åˆ†å†…å®¹ä½œä¸ºäº†è§£å³å¯ã€‚</p>
</blockquote>
<p>å½“æˆ‘ä»¬åˆ©ç”¨ match æŸ¥è¯¢æ—¶ï¼Œæ–‡æ¡£ç»“æœä¼šæ ¹æ®ä¸æœç´¢è¯æ¡çš„å…³è”åº¦æ‰“åˆ†ï¼ˆ_scoreï¼‰ï¼Œè¿”å›ç»“æœæ—¶æŒ‰ç…§åˆ†å€¼é™åºæ’åˆ—ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœç´¢ â€œè™¹æ¡¥å¦‚å®¶â€ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">17.850193</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"è™¹æ¡¥å¦‚å®¶é…’åº—çœŸä¸é”™"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">12.259849</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"å¤–æ»©å¦‚å®¶é…’åº—çœŸä¸é”™"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token property">"_score"</span> <span class="token operator">:</span> <span class="token number">11.91091</span><span class="token punctuation">,</span>
    <span class="token property">"_source"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span> <span class="token operator">:</span> <span class="token string">"è¿ªå£«å°¼å¦‚å®¶é…’åº—çœŸä¸é”™"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>elasticsearch æ—©æœŸä½¿ç”¨çš„æ‰“åˆ†ç®—æ³•æ˜¯ <strong>TF-IDF ç®—æ³•</strong>ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921205752.png!/format/webp" alt="img"></p>
<p>åœ¨åæ¥çš„5.1ç‰ˆæœ¬å‡çº§ä¸­ï¼Œelasticsearch å°†ç®—æ³•æ”¹è¿›ä¸º <strong>BM25 ç®—æ³•</strong>ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921205757.png!/format/webp" alt="img"></p>
<p>TF-IDF ç®—æ³•æœ‰ä¸€å„ç¼ºé™·ï¼Œå°±æ˜¯è¯æ¡é¢‘ç‡è¶Šé«˜ï¼Œæ–‡æ¡£å¾—åˆ†ä¹Ÿä¼šè¶Šé«˜ï¼Œå•ä¸ªè¯æ¡å¯¹æ–‡æ¡£å½±å“è¾ƒå¤§ã€‚è€Œ BM25 åˆ™ä¼šè®©å•ä¸ªè¯æ¡çš„ç®—åˆ†æœ‰ä¸€ä¸ªä¸Šé™ï¼Œæ›²çº¿æ›´åŠ å¹³æ»‘ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921205831.png!/format/webp" alt="img"></p>
<h3 id="ç®—åˆ†å‡½æ•°æŸ¥è¯¢"><a href="#ç®—åˆ†å‡½æ•°æŸ¥è¯¢" class="headerlink" title="ç®—åˆ†å‡½æ•°æŸ¥è¯¢"></a>ç®—åˆ†å‡½æ•°æŸ¥è¯¢</h3><p>æ ¹æ®ç›¸å…³åº¦æ‰“åˆ†æ˜¯æ¯”è¾ƒåˆç†çš„éœ€æ±‚ï¼Œä½†æœ‰æ—¶å€™ä¹Ÿä¸èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>ä»¥ç™¾åº¦ä¸ºä¾‹ï¼Œä½ æœç´¢çš„ç»“æœä¸­ï¼Œå¹¶ä¸æ˜¯ç›¸å…³åº¦è¶Šé«˜æ’åè¶Šé å‰ï¼Œè€Œæ˜¯è°ç»™çš„é’±å¤šæ’åå°±è¶Šé å‰ã€‚</p>
<p><strong>è¦æƒ³è®¤ä¸ºæ§åˆ¶ç›¸å…³æ€§ç®—åˆ†ï¼Œå°±éœ€è¦åˆ©ç”¨ elasticsearch ä¸­çš„ function score æŸ¥è¯¢äº†ã€‚</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921210256.png!/format/webp" alt="img"></p>
<p>function score æŸ¥è¯¢ä¸­åŒ…å«å››éƒ¨åˆ†å†…å®¹ï¼š</p>
<ul>
<li><strong>åŸå§‹æŸ¥è¯¢</strong>æ¡ä»¶ï¼šquery éƒ¨åˆ†ï¼ŒåŸºäºè¿™ä¸ªæ¡ä»¶æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”åŸºäºBM25ç®—æ³•ç»™æ–‡æ¡£æ‰“åˆ†ï¼Œ<strong>åŸå§‹ç®—åˆ†</strong>ï¼ˆquery score)</li>
<li><strong>è¿‡æ»¤æ¡ä»¶</strong>ï¼šfilter éƒ¨åˆ†ï¼Œç¬¦åˆè¯¥æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼š<strong>é‡æ–°ç®—åˆ†</strong></li>
<li><strong>ç®—åˆ†å‡½æ•°</strong>ï¼šç¬¦åˆ filter æ¡ä»¶çš„æ–‡æ¡£è¦æ ¹æ®è¿™ä¸ªå‡½æ•°åšè¿ç®—ï¼Œå¾—åˆ°çš„<strong>å‡½æ•°ç®—åˆ†</strong>ï¼ˆfunction scoreï¼‰ï¼Œæœ‰å››ç§å‡½æ•°<ul>
<li>weightï¼šå‡½æ•°ç»“æœæ˜¯å¸¸é‡</li>
<li>field_value_factorï¼šä»¥æ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µå€¼ä½œä¸ºå‡½æ•°ç»“æœ</li>
<li>random_scoreï¼šä»¥éšæœºæ•°ä½œä¸ºå‡½æ•°ç»“æœ</li>
<li>script_scoreï¼šè‡ªå®šä¹‰ç®—åˆ†å‡½æ•°ç®—æ³•</li>
</ul>
</li>
<li><strong>è¿ç®—æ¨¡å¼</strong>ï¼šç®—åˆ†å‡½æ•°çš„ç»“æœã€åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§ç®—åˆ†ï¼Œä¸¤è€…ä¹‹é—´çš„è¿ç®—æ–¹å¼ï¼ŒåŒ…æ‹¬ï¼š<ul>
<li>multiplyï¼šç›¸ä¹˜</li>
<li>replaceï¼šç”¨ function score æ›¿æ¢ query score</li>
<li>sumã€avgã€maxã€min</li>
</ul>
</li>
</ul>
<p>function score çš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ ¹æ®<strong>åŸå§‹æ¡ä»¶</strong>æŸ¥è¯¢æœç´¢æ–‡æ¡£ï¼Œå¹¶ä¸”è®¡ç®—ç›¸å…³æ€§ç®—åˆ†ï¼Œç§°ä¸º<strong>åŸå§‹ç®—åˆ†</strong>ï¼ˆquery scoreï¼‰</li>
<li>æ ¹æ®<strong>è¿‡æ»¤æ¡ä»¶</strong>ï¼Œè¿‡æ»¤æ–‡æ¡£</li>
<li>ç¬¦åˆ<strong>è¿‡æ»¤æ¡ä»¶</strong>çš„æ–‡æ¡£ï¼ŒåŸºäº<strong>ç®—åˆ†å‡½æ•°</strong>è¿ç®—ï¼Œå¾—åˆ°<strong>å‡½æ•°ç®—åˆ†</strong>ï¼ˆfunction scoreï¼‰</li>
<li>å°†<strong>åŸå§‹ç®—åˆ†</strong>ï¼ˆquery scoreï¼‰å’Œ<strong>å‡½æ•°ç®—åˆ†</strong>ï¼ˆfunction scoreï¼‰åŸºäº<strong>è¿ç®—æ¨¡å¼</strong>åšè¿ç®—ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœï¼Œä½œä¸ºç›¸å…³æ€§ç®—åˆ†ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œå…¶ä¸­çš„å…³é”®ç‚¹æ˜¯</p>
<ul>
<li>è¿‡æ»¤æ¡ä»¶ï¼šå†³å®šå“ªäº›æ–‡æ¡£çš„ç®—åˆ†è¢«ä¿®æ”¹</li>
<li>ç®—åˆ†å‡½æ•°ï¼šå†³å®šå‡½æ•°ç®—åˆ†çš„ç®—æ³•</li>
<li>è¿ç®—æ¨¡å¼ï¼šå†³å®šæœ€ç»ˆç®—åˆ†ç»“æœ</li>
</ul>
<p>ä¾‹å¦‚ï¼šæˆ‘ä»¬ç»™â€œå¦‚å®¶â€è¿™ä¸ªå“ç‰Œçš„é…’åº—æ’åé å‰ä¸€äº›</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"function_score"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  .... <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// åŸå§‹æŸ¥è¯¢ï¼Œå¯ä»¥æ˜¯ä»»æ„æ¡ä»¶</span>
      <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// ç®—åˆ†å‡½æ•°</span>
        <span class="token punctuation">{</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// æ»¡è¶³çš„æ¡ä»¶ï¼Œå“ç‰Œå¿…é¡»æ˜¯å¦‚å®¶</span>
            <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"å¦‚å®¶"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"weight"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// ç®—åˆ†æƒé‡ä¸º10</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"boost_mode"</span><span class="token operator">:</span> <span class="token string">"sum"</span> <span class="token comment">// åŠ æƒæ¨¡å¼ï¼Œæ±‚å’Œ</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æµ‹è¯•ï¼Œåœ¨æœªæ·»åŠ ç®—åˆ†å‡½æ•°æ—¶ï¼Œå¦‚å®¶å¾—åˆ†å¦‚ä¸‹</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921231508.png!/format/webp" alt="img"></p>
<p>æ·»åŠ äº†ç®—åˆ†å‡½æ•°åï¼Œå¦‚å®¶å¾—åˆ†å°±æå‡äº†</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921231513.png!/format/webp" alt="img"></p>
<h3 id="å¸ƒå°”æŸ¥è¯¢"><a href="#å¸ƒå°”æŸ¥è¯¢" class="headerlink" title="å¸ƒå°”æŸ¥è¯¢"></a>å¸ƒå°”æŸ¥è¯¢</h3><p>å¸ƒå°”æŸ¥è¯¢æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆï¼Œæ¯ä¸€ä¸ªå­å¥å°±æ˜¯ä¸€ä¸ª<strong>å­æŸ¥è¯¢</strong>ã€‚å­æŸ¥è¯¢çš„ç»„åˆæ–¹å¼æœ‰</p>
<ul>
<li>mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€</li>
<li>shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€</li>
<li>must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œ<strong>ä¸å‚ä¸ç®—åˆ†</strong>ï¼Œç±»ä¼¼â€œéâ€</li>
<li>filterï¼šå¿…é¡»åŒ¹é…ï¼Œ<strong>ä¸å‚ä¸ç®—åˆ†</strong></li>
</ul>
<p>æ¯”å¦‚åœ¨æœç´¢é…’åº—æ—¶ï¼Œé™¤äº†å…³é”®å­—æœç´¢å¤–ï¼Œæˆ‘ä»¬è¿˜å¯èƒ½æ ¹æ®å“ç‰Œã€ä»·æ ¼ã€åŸå¸‚ç­‰å­—æ®µåšè¿‡æ»¤</p>
<p><strong>æ¯ä¸€ä¸ªä¸åŒçš„å­—æ®µï¼Œå…¶æŸ¥è¯¢çš„æ¡ä»¶ã€æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œå¿…é¡»æ˜¯å¤šä¸ªä¸åŒçš„æŸ¥è¯¢ï¼Œè€Œè¦ç»„åˆè¿™äº›æŸ¥è¯¢ï¼Œå°±å¿…é¡»ç”¨ boolæŸ¥è¯¢äº†ã€‚</strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœç´¢æ—¶ï¼Œå‚ä¸<strong>æ‰“åˆ†çš„å­—æ®µè¶Šå¤šï¼ŒæŸ¥è¯¢çš„æ€§èƒ½ä¹Ÿè¶Šå·®</strong>ã€‚å› æ­¤è¿™ç§å¤šæ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œå»ºè®®è¿™æ ·åšï¼š</p>
<ul>
<li>æœç´¢æ¡†çš„å…³é”®å­—æœç´¢ï¼Œæ˜¯å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œä½¿ç”¨ must æŸ¥è¯¢ï¼Œå‚ä¸ç®—åˆ†</li>
<li>å…¶å®ƒè¿‡æ»¤æ¡ä»¶ï¼Œé‡‡ç”¨ filter æŸ¥è¯¢ï¼Œä¸å‚ä¸ç®—åˆ†</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"ä¸Šæµ·"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"çš‡å† å‡æ—¥"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"brand"</span><span class="token operator">:</span> <span class="token string">"åç¾è¾¾"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"must_not"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">45</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éœ€æ±‚ï¼šæœç´¢åå­—åŒ…å«â€œå¦‚å®¶â€ï¼Œä»·æ ¼ä¸é«˜äº 400ï¼Œåœ¨åæ ‡ 31.21,121.5 å‘¨å›´ 10km èŒƒå›´å†…çš„é…’åº—ã€‚</p>
<ul>
<li>åç§°æœç´¢ï¼Œå±äºå…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œåº”è¯¥å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must ä¸­</li>
<li>ä»·æ ¼ä¸é«˜äº 400ï¼Œç”¨ range æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° must_not ä¸­</li>
<li>å‘¨å›´ 10km èŒƒå›´å†…ï¼Œç”¨ geo_distance æŸ¥è¯¢ï¼Œå±äºè¿‡æ»¤æ¡ä»¶ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œæ”¾åˆ° filter ä¸­</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210921233252.png!/format/webp" alt="img"></p>
<p>bool æŸ¥è¯¢çš„å‡ ç§é€»è¾‘å…³ç³»</p>
<ul>
<li>mustï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œä¸â€</li>
<li>shouldï¼šé€‰æ‹©æ€§åŒ¹é…çš„æ¡ä»¶ï¼Œå¯ä»¥ç†è§£ä¸ºâ€œæˆ–â€</li>
<li>must_notï¼šå¿…é¡»ä¸åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†</li>
<li>filterï¼šå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œä¸å‚ä¸æ‰“åˆ†</li>
</ul>
<h2 id="æœç´¢ç»“æœå¤„ç†"><a href="#æœç´¢ç»“æœå¤„ç†" class="headerlink" title="æœç´¢ç»“æœå¤„ç†"></a>æœç´¢ç»“æœå¤„ç†</h2><h3 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h3><p>elasticsearch é»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html">ç»“æœæ’åº</a>ã€‚å¯ä»¥æ’åºå­—æ®µç±»å‹æœ‰ï¼škeyword ç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹ç­‰</p>
<p>keywordã€æ•°å€¼ã€æ—¥æœŸç±»å‹æ’åºçš„è¯­æ³•åŸºæœ¬ä¸€è‡´ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"desc"</span>  <span class="token comment">// æ’åºå­—æ®µã€æ’åºæ–¹å¼ASCã€DESC</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ’åºæ¡ä»¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å†™å¤šä¸ªæ’åºæ¡ä»¶ã€‚æŒ‰ç…§å£°æ˜çš„é¡ºåºï¼Œå½“ç¬¬ä¸€ä¸ªæ¡ä»¶ç›¸ç­‰æ—¶ï¼Œå†æŒ‰ç…§ç¬¬äºŒä¸ªæ¡ä»¶æ’åºã€‚</p>
<p>éœ€æ±‚æè¿°ï¼šé…’åº—æ•°æ®æŒ‰ç…§ç”¨æˆ·è¯„ä»·ï¼ˆscore)é™åºæ’åºï¼Œè¯„ä»·ç›¸åŒçš„æŒ‰ç…§ä»·æ ¼(price)å‡åºæ’åº</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921233829.png!/format/webp" alt="img"></p>
<p>åœ°ç†åæ ‡æ’åºç•¥æœ‰ä¸åŒ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /indexName/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"FIELD"</span> <span class="token operator">:</span> <span class="token string">"çº¬åº¦ï¼Œç»åº¦"</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡æ¡£ä¸­geo_pointç±»å‹çš„å­—æ®µåã€ç›®æ ‡åæ ‡ç‚¹</span>
          <span class="token property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> <span class="token comment">// æ’åºæ–¹å¼</span>
          <span class="token property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span> <span class="token comment">// æ’åºçš„è·ç¦»å•ä½</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"31.034661,121.612282"</span><span class="token punctuation">,</span> 
          <span class="token property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> 
          <span class="token property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>è·å–ä½ çš„ä½ç½®çš„ç»çº¬åº¦çš„æ–¹å¼ï¼š<a target="_blank" rel="noopener" href="https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat">https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat</a></p>
</blockquote>
<p>å‡è®¾æˆ‘çš„ä½ç½®æ˜¯ï¼š31.034661ï¼Œ121.612282ï¼Œå¯»æ‰¾æˆ‘å‘¨å›´è·ç¦»æœ€è¿‘çš„é…’åº—ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921233931.png!/format/webp" alt="img"></p>
<h3 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a>åˆ†é¡µ</h3><p>elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å› top10 çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†ã€‚</p>
<p>elasticsearch é€šè¿‡ä¿®æ”¹ fromã€size å‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š</p>
<ul>
<li>fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹</li>
<li>sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£</li>
</ul>
<p>ç±»ä¼¼äºmysqlä¸­çš„<code>limit ?, ?</code></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>æ·±åº¦åˆ†é¡µé—®é¢˜</p>
</blockquote>
<p>ç°åœ¨ï¼Œæˆ‘è¦æŸ¥è¯¢990~1000çš„æ•°æ®ï¼ŒæŸ¥è¯¢é€»è¾‘è¦è¿™ä¹ˆå†™</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">990</span><span class="token punctuation">,</span> <span class="token comment">// åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// æœŸæœ›è·å–çš„æ–‡æ¡£æ€»æ•°</span>
  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œæ˜¯æŸ¥è¯¢990å¼€å§‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ç¬¬990~ç¬¬1000æ¡ æ•°æ®ã€‚</p>
<p>æ³¨æ„ï¼šelasticsearch å†…éƒ¨åˆ†é¡µæ—¶ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢ 0~1000æ¡ï¼Œç„¶åæˆªå–å…¶ä¸­çš„ 990 ~ 1000 çš„è¿™10æ¡</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921234503.png!/format/webp" alt="img"></p>
<p>æŸ¥è¯¢TOP1000ï¼Œå¦‚æœ es æ˜¯å•ç‚¹æ¨¡å¼ï¼Œè¿™å¹¶æ— å¤ªå¤§å½±å“ã€‚</p>
<p>ä½†æ˜¯ elasticsearch å°†æ¥ä¸€å®šæ˜¯é›†ç¾¤ï¼Œä¾‹å¦‚æˆ‘é›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘è¦æŸ¥è¯¢ TOP1000 çš„æ•°æ®ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹æŸ¥è¯¢200æ¡å°±å¯ä»¥äº†ã€‚èŠ‚ç‚¹Açš„ TOP200ï¼Œåœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æ’åˆ°10000åä»¥å¤–äº†ã€‚</p>
<p><strong>å› æ­¤è¦æƒ³è·å–æ•´ä¸ªé›†ç¾¤çš„ TOP1000ï¼Œå¿…é¡»å…ˆæŸ¥è¯¢å‡ºæ¯ä¸ªèŠ‚ç‚¹çš„ TOP1000ï¼Œæ±‡æ€»ç»“æœåï¼Œé‡æ–°æ’åï¼Œé‡æ–°æˆªå– TOP1000ã€‚</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921234555.png!/format/webp" alt="img"></p>
<p><strong>å½“æŸ¥è¯¢åˆ†é¡µæ·±åº¦è¾ƒå¤§æ—¶ï¼Œæ±‡æ€»æ•°æ®è¿‡å¤šï¼Œå¯¹å†…å­˜å’ŒCPUä¼šäº§ç”Ÿéå¸¸å¤§çš„å‹åŠ›ï¼Œå› æ­¤ elasticsearch ä¼šç¦æ­¢from+ size è¶…è¿‡10000çš„è¯·æ±‚ã€‚</strong></p>
<p>é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼ŒESæä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p>
<ul>
<li>search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚</li>
<li>scrollï¼šåŸç†å°†æ’åºåçš„æ–‡æ¡£idå½¢æˆå¿«ç…§ï¼Œä¿å­˜åœ¨å†…å­˜ã€‚å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ã€‚</li>
</ul>
<hr>
<p>åˆ†é¡µæŸ¥è¯¢çš„å¸¸è§å®ç°æ–¹æ¡ˆä»¥åŠä¼˜ç¼ºç‚¹</p>
<ul>
<li><code>from + size</code><ul>
<li>ä¼˜ç‚¹ï¼šæ”¯æŒéšæœºç¿»é¡µ</li>
<li>ç¼ºç‚¹ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜ï¼Œé»˜è®¤æŸ¥è¯¢ä¸Šé™ï¼ˆfrom + sizeï¼‰æ˜¯10000</li>
<li>åœºæ™¯ï¼šç™¾åº¦ã€äº¬ä¸œã€è°·æ­Œã€æ·˜å®è¿™æ ·çš„éšæœºç¿»é¡µæœç´¢</li>
</ul>
</li>
<li><code>after search</code><ul>
<li>ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰</li>
<li>ç¼ºç‚¹ï¼šåªèƒ½å‘åé€é¡µæŸ¥è¯¢ï¼Œä¸æ”¯æŒéšæœºç¿»é¡µ</li>
<li>åœºæ™¯ï¼šæ²¡æœ‰éšæœºç¿»é¡µéœ€æ±‚çš„æœç´¢ï¼Œä¾‹å¦‚æ‰‹æœºå‘ä¸‹æ»šåŠ¨ç¿»é¡µ</li>
</ul>
</li>
<li><code>scroll</code><ul>
<li>ä¼˜ç‚¹ï¼šæ²¡æœ‰æŸ¥è¯¢ä¸Šé™ï¼ˆå•æ¬¡æŸ¥è¯¢çš„sizeä¸è¶…è¿‡10000ï¼‰</li>
<li>ç¼ºç‚¹ï¼šä¼šæœ‰é¢å¤–å†…å­˜æ¶ˆè€—ï¼Œå¹¶ä¸”æœç´¢ç»“æœæ˜¯éå®æ—¶çš„</li>
<li>åœºæ™¯ï¼šæµ·é‡æ•°æ®çš„è·å–å’Œè¿ç§»ã€‚ä»ES7.1å¼€å§‹ä¸æ¨èï¼Œå»ºè®®ç”¨ after searchæ–¹æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<h3 id="é«˜äº®"><a href="#é«˜äº®" class="headerlink" title="é«˜äº®"></a>é«˜äº®</h3><p>æˆ‘ä»¬åœ¨ç™¾åº¦ï¼Œäº¬ä¸œæœç´¢æ—¶ï¼Œå…³é”®å­—ä¼šå˜æˆçº¢è‰²ï¼Œæ¯”è¾ƒé†’ç›®ï¼Œè¿™å«é«˜äº®æ˜¾ç¤ºï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20210921234711.png!/format/webp" alt="img"></p>
<p>é«˜äº®æ˜¾ç¤ºçš„å®ç°åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ul>
<li>1ï¼‰ç»™æ–‡æ¡£ä¸­çš„æ‰€æœ‰å…³é”®å­—éƒ½æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œä¾‹å¦‚<code>&lt;em&gt;</code>æ ‡ç­¾</li>
<li>2ï¼‰é¡µé¢ç»™<code>&lt;em&gt;</code>æ ‡ç­¾ç¼–å†™CSSæ ·å¼</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span> <span class="token comment">// æŸ¥è¯¢æ¡ä»¶ï¼Œé«˜äº®ä¸€å®šè¦ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// æŒ‡å®šè¦é«˜äº®çš„å­—æ®µ</span>
      <span class="token property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em&gt;"</span><span class="token punctuation">,</span>  <span class="token comment">// ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„å‰ç½®æ ‡ç­¾</span>
        <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em&gt;"</span> <span class="token comment">// ç”¨æ¥æ ‡è®°é«˜äº®å­—æ®µçš„åç½®æ ‡ç­¾</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>é«˜äº®æ˜¯å¯¹å…³é”®å­—é«˜äº®ï¼Œå› æ­¤<strong>æœç´¢æ¡ä»¶å¿…é¡»å¸¦æœ‰å…³é”®å­—</strong>ï¼Œè€Œä¸èƒ½æ˜¯èŒƒå›´è¿™æ ·çš„æŸ¥è¯¢ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>é«˜äº®çš„å­—æ®µï¼Œå¿…é¡»ä¸æœç´¢æŒ‡å®šçš„å­—æ®µä¸€è‡´</strong>ï¼Œå¦åˆ™æ— æ³•é«˜äº®</li>
<li>å¦‚æœè¦å¯¹éæœç´¢å­—æ®µé«˜äº®ï¼Œåˆ™éœ€è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼š<code>required_field_match=false</code></li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2021/20210921234739.png!/format/webp" alt="img"></p>
<blockquote>
<p>DSL æ€»ä½“ç»“æ„å¦‚ä¸‹ï¼š</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20210921235330.png"><img src="https://cdn.xn2001.com/img/2021/20210921235330.png!/format/webp" alt="img"></a></p>
<h2 id="RestClientæ–‡æ¡£æŸ¥è¯¢"><a href="#RestClientæ–‡æ¡£æŸ¥è¯¢" class="headerlink" title="RestClientæ–‡æ¡£æŸ¥è¯¢"></a>RestClientæ–‡æ¡£æŸ¥è¯¢</h2><h3 id="å‘èµ·æŸ¥è¯¢è¯·æ±‚"><a href="#å‘èµ·æŸ¥è¯¢è¯·æ±‚" class="headerlink" title="å‘èµ·æŸ¥è¯¢è¯·æ±‚"></a>å‘èµ·æŸ¥è¯¢è¯·æ±‚</h3><p><img src="https://cdn.xn2001.com/img/2021/20211016170057.png!/format/webp" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelSearchTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">match_All</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º<code>SearchRequest</code>å¯¹è±¡ï¼ŒæŒ‡å®šç´¢å¼•åº“å</li>
<li>ç¬¬äºŒæ­¥ï¼Œåˆ©ç”¨<code>request.source()</code>æ„å»º DSLï¼ŒDSL ä¸­å¯ä»¥åŒ…å«æŸ¥è¯¢ã€åˆ†é¡µã€æ’åºã€é«˜äº®ç­‰<ul>
<li><code>query()</code>ï¼šä»£è¡¨æŸ¥è¯¢æ¡ä»¶ï¼Œåˆ©ç”¨ <code>QueryBuilders.matchAllQuery()</code> æ„å»ºä¸€ä¸ª match_all æŸ¥è¯¢çš„ DSL</li>
</ul>
</li>
<li>ç¬¬ä¸‰æ­¥ï¼Œåˆ©ç”¨ <code>client.search()</code> å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”</li>
</ul>
<p>å…³é”®çš„ API æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ <code>request.source()</code>ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢ã€æ’åºã€åˆ†é¡µã€é«˜äº®ç­‰æ‰€æœ‰åŠŸèƒ½</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211016170203.png!/format/webp" alt="img"></p>
<p>å¦ä¸€ä¸ªæ˜¯ <code>QueryBuilders</code>ï¼Œå…¶ä¸­åŒ…å« matchã€termã€function_scoreã€bool ç­‰å„ç§æŸ¥è¯¢</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211016170234.png!/format/webp" alt="img"></p>
<h3 id="è§£ææŸ¥è¯¢å“åº”"><a href="#è§£ææŸ¥è¯¢å“åº”" class="headerlink" title="è§£ææŸ¥è¯¢å“åº”"></a>è§£ææŸ¥è¯¢å“åº”</h3><p><img src="https://cdn.xn2001.com/img/2021/20211016174631.png!/format/webp" alt="img"></p>
<p>Elasticsearch è¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œç»“æ„åŒ…å«</p>
<ul>
<li><code>hits</code>ï¼šå‘½ä¸­çš„ç»“æœ<ul>
<li><code>total</code>ï¼šæ€»æ¡æ•°ï¼Œå…¶ä¸­çš„valueæ˜¯å…·ä½“çš„æ€»æ¡æ•°å€¼</li>
<li><code>max_score</code>ï¼šæ‰€æœ‰ç»“æœä¸­å¾—åˆ†æœ€é«˜çš„æ–‡æ¡£çš„ç›¸å…³æ€§ç®—åˆ†</li>
<li><code>hits</code>ï¼šæœç´¢ç»“æœçš„æ–‡æ¡£æ•°ç»„ï¼Œå…¶ä¸­çš„æ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯ä¸€ä¸ª json å¯¹è±¡<ul>
<li><code>_source</code>ï¼šæ–‡æ¡£ä¸­çš„åŸå§‹æ•°æ®ï¼Œä¹Ÿæ˜¯ json å¯¹è±¡</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è§£æå“åº”ç»“æœï¼Œå°±æ˜¯é€å±‚è§£æ JSON å­—ç¬¦ä¸²ï¼Œæµç¨‹å¦‚ä¸‹</p>
<ul>
<li><code>SearchHits</code>ï¼šé€šè¿‡ <code>response.getHits()</code> è·å–ï¼Œå°±æ˜¯ json ä¸­çš„æœ€å¤–å±‚çš„ hitsï¼Œä»£è¡¨å‘½ä¸­çš„ç»“æœ<ul>
<li><code>SearchHits.getTotalHits().value</code>ï¼šè·å–æ€»æ¡æ•°ä¿¡æ¯</li>
<li><code>SearchHits.getHits()</code>ï¼šè·å– SearchHit æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ–‡æ¡£æ•°ç»„<ul>
<li><code>SearchHit.getSourceAsString()</code>ï¼šè·å–æ–‡æ¡£ç»“æœä¸­çš„ <code>_source</code>ï¼Œä¹Ÿå°±æ˜¯åŸå§‹çš„ json æ–‡æ¡£æ•°æ®</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ä¹å¿ƒæ¹–
 * @version 1.0
 * @date 2021/10/16 17:05
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelSearchTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">match_All</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().æ¡æ•° = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.211.128:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>restHighLevelClient<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="matchæŸ¥è¯¢"><a href="#matchæŸ¥è¯¢" class="headerlink" title="matchæŸ¥è¯¢"></a>matchæŸ¥è¯¢</h3><p><img src="https://cdn.xn2001.com/img/2021/20211016182859.png!/format/webp" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span><span class="token string">"å¦‚å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().æ¡æ•° = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span><span class="token string">"å¦‚å®¶"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().æ¡æ•° = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ç²¾ç¡®æŸ¥è¯¢"><a href="#ç²¾ç¡®æŸ¥è¯¢" class="headerlink" title="ç²¾ç¡®æŸ¥è¯¢"></a>ç²¾ç¡®æŸ¥è¯¢</h3><p>ç²¾ç¡®æŸ¥è¯¢ä¸»è¦æ˜¯ä¸¤è€…</p>
<ul>
<li>termï¼šè¯æ¡ç²¾ç¡®åŒ¹é…</li>
<li>rangeï¼šèŒƒå›´æŸ¥è¯¢</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20211016192658.png"><img src="https://cdn.xn2001.com/img/2021/20211016192658.png!/format/webp" alt="img"></a></p>
<h3 id="å¸ƒå°”æŸ¥è¯¢-1"><a href="#å¸ƒå°”æŸ¥è¯¢-1" class="headerlink" title="å¸ƒå°”æŸ¥è¯¢"></a>å¸ƒå°”æŸ¥è¯¢</h3><p>å¸ƒå°”æŸ¥è¯¢æ˜¯ç”¨ mustã€must_notã€filterç­‰æ–¹å¼ç»„åˆå…¶å®ƒæŸ¥è¯¢ï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20211016192745.png"><img src="https://cdn.xn2001.com/img/2021/20211016192745.png!/format/webp" alt="img"></a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.å‡†å¤‡Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å‡†å¤‡DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                    <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"ä¸Šæµ·"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.å‘é€è¯·æ±‚</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.è§£æå“åº”</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().æ¡æ•° = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ’åºã€åˆ†é¡µ"><a href="#æ’åºã€åˆ†é¡µ" class="headerlink" title="æ’åºã€åˆ†é¡µ"></a>æ’åºã€åˆ†é¡µ</h3><p>æœç´¢ç»“æœçš„æ’åºå’Œåˆ†é¡µæ˜¯ä¸ query åŒçº§çš„å‚æ•°ï¼Œå› æ­¤åŒæ ·æ˜¯ä½¿ç”¨ <code>request.source()</code> æ¥è®¾ç½®ã€‚</p>
<p>å¯¹åº”çš„APIå¦‚ä¸‹</p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20211016202447.png"><img src="https://cdn.xn2001.com/img/2021/20211016202447.png!/format/webp" alt="img"></a></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// é¡µç ï¼Œæ¯é¡µå¤§å°</span>
    <span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.å‡†å¤‡Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å‡†å¤‡DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.æ’åº sort</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.åˆ†é¡µ fromã€size</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.å‘é€è¯·æ±‚</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.è§£æå“åº”</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hits.getTotalHits().æ¡æ•° = "</span> <span class="token operator">+</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="é«˜äº®-1"><a href="#é«˜äº®-1" class="headerlink" title="é«˜äº®"></a>é«˜äº®</h3><ul>
<li>æŸ¥è¯¢çš„ DSLï¼šå…¶ä¸­é™¤äº†æŸ¥è¯¢æ¡ä»¶ï¼Œè¿˜éœ€è¦æ·»åŠ é«˜äº®æ¡ä»¶ï¼ŒåŒæ ·æ˜¯ä¸ query åŒçº§ã€‚</li>
<li>ç»“æœè§£æï¼šç»“æœé™¤äº†è¦è§£æ <code>_source</code> æ–‡æ¡£æ•°æ®ï¼Œè¿˜è¦è§£æé«˜äº®ç»“æœ</li>
</ul>
<p><strong>é«˜äº®è¯·æ±‚çš„æ„å»º API</strong></p>
<p><a target="_blank" rel="noopener" href="https://cdn.xn2001.com/img/2021/20211016202707.png"><img src="https://cdn.xn2001.com/img/2021/20211016202707.png!/format/webp" alt="img"></a></p>
<p>ä¸Šè¿°ä»£ç çœç•¥äº†æŸ¥è¯¢æ¡ä»¶éƒ¨åˆ†ï¼Œä½†æ˜¯é«˜äº®æŸ¥è¯¢å¿…é¡»ä½¿ç”¨å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼Œå¹¶ä¸”è¦æœ‰æœç´¢å…³é”®å­—ï¼Œå°†æ¥æ‰å¯ä»¥å¯¹å…³é”®å­—é«˜äº®.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.å‡†å¤‡Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.å‡†å¤‡DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"å¦‚å®¶"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.é«˜äº®</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.å‘é€è¯·æ±‚</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.è§£æå“åº”</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ä»£ç åœ¨ä¸‹æ–‡</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>é«˜äº®ç»“æœè§£æ</strong></p>
<p>é«˜äº®çš„ç»“æœä¸æŸ¥è¯¢çš„æ–‡æ¡£ç»“æœé»˜è®¤æ˜¯åˆ†ç¦»çš„ï¼Œå¹¶ä¸åœ¨ä¸€èµ·ã€‚</p>
<p>å› æ­¤è§£æé«˜äº®çš„ä»£ç éœ€è¦é¢å¤–å¤„ç†ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211016202853.png!/format/webp" alt="img"></p>
<ul>
<li>ç¬¬ä¸€æ­¥ï¼šä»ç»“æœä¸­è·å– sourceã€‚<code>hit.getSourceAsString()</code>ï¼Œè¿™éƒ¨åˆ†æ˜¯éé«˜äº®ç»“æœï¼Œjson å­—ç¬¦ä¸²ï¼Œéœ€è¦ååºåˆ—ä¸º HotelDoc å¯¹è±¡</li>
<li>ç¬¬äºŒæ­¥ï¼šè·å–é«˜äº®ç»“æœã€‚<code>hit.getHighlightFields()</code>ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ª Mapï¼Œkey æ˜¯é«˜äº®å­—æ®µåç§°ï¼Œå€¼æ˜¯HighlightField å¯¹è±¡ï¼Œä»£è¡¨é«˜äº®å€¼</li>
<li>ç¬¬ä¸‰æ­¥ï¼šä» map ä¸­æ ¹æ®é«˜äº®å­—æ®µåç§°ï¼Œè·å–é«˜äº®å­—æ®µå€¼å¯¹è±¡ HighlightField</li>
<li>ç¬¬å››æ­¥ï¼šä» HighlightField ä¸­è·å– Fragmentsï¼Œå¹¶ä¸”è½¬ä¸ºå­—ç¬¦ä¸²ã€‚<strong>è¿™éƒ¨åˆ†æ˜¯çœŸæ­£çš„é«˜äº®å­—ç¬¦ä¸²</strong></li>
<li>ç¬¬äº”æ­¥ï¼šç”¨é«˜äº®çš„ç»“æœæ›¿æ¢ HotelDoc ä¸­çš„éé«˜äº®ç»“æœ</li>
</ul>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 4.è§£æå“åº”</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.è·å–æ€»æ¡æ•°</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å…±æœç´¢åˆ°"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"æ¡æ•°æ®"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.æ–‡æ¡£æ•°ç»„</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.éå†</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æ–‡æ¡£source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ååºåˆ—åŒ–</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–é«˜äº®ç»“æœ</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¹æ®å­—æ®µåè·å–é«˜äº®ç»“æœ</span>
            <span class="token class-name">HighlightField</span> highlightField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å–é«˜äº®å€¼</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> highlightField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¦†ç›–éé«˜äº®ç»“æœ</span>
                hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åœ°ç†åæ ‡æŸ¥è¯¢-1"><a href="#åœ°ç†åæ ‡æŸ¥è¯¢-1" class="headerlink" title="åœ°ç†åæ ‡æŸ¥è¯¢"></a>åœ°ç†åæ ‡æŸ¥è¯¢</h3><p><img src="https://cdn.xn2001.com/img/2021/20211019000540.png!/format/webp" alt="img"></p>
<h3 id="ç›¸å…³æ€§å¾—åˆ†"><a href="#ç›¸å…³æ€§å¾—åˆ†" class="headerlink" title="ç›¸å…³æ€§å¾—åˆ†"></a>ç›¸å…³æ€§å¾—åˆ†</h3><p>function_score æŸ¥è¯¢ç»“æ„å¦‚ä¸‹</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211019011433.png!/format/webp" alt="img"></p>
<p>å¯¹åº”çš„ JavaAPI å¦‚ä¸‹</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211019011439.png!/format/webp" alt="img"></p>
<h2 id="DSLæ•°æ®èšåˆ"><a href="#DSLæ•°æ®èšåˆ" class="headerlink" title="DSLæ•°æ®èšåˆ"></a>DSLæ•°æ®èšåˆ</h2><p>**<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">èšåˆï¼ˆ</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">ï¼‰</a>**å¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ã€‚</p>
<ul>
<li>ä»€ä¹ˆå“ç‰Œçš„æ‰‹æœºæœ€å—æ¬¢è¿ï¼Ÿ</li>
<li>è¿™äº›æ‰‹æœºçš„å¹³å‡ä»·æ ¼ã€æœ€é«˜ä»·æ ¼ã€æœ€ä½ä»·æ ¼ï¼Ÿ</li>
<li>è¿™äº›æ‰‹æœºæ¯æœˆçš„é”€å”®æƒ…å†µå¦‚ä½•ï¼Ÿ</li>
</ul>
<p>åœ¨ Elasticsearch å®ç°è¿™äº›ç»Ÿè®¡åŠŸèƒ½æ¯”æ•°æ®åº“çš„ sql è¦æ–¹ä¾¿çš„å¤šï¼Œè€Œä¸”æŸ¥è¯¢é€Ÿåº¦éå¸¸å¿«ï¼Œå¯ä»¥å®ç°è¿‘å®æ—¶æœç´¢æ•ˆæœã€‚</p>
<p>èšåˆå¸¸è§çš„æœ‰ä¸‰ç±»</p>
<ul>
<li><strong>æ¡¶ï¼ˆBucketï¼‰</strong>èšåˆï¼šç”¨æ¥å¯¹æ–‡æ¡£åšåˆ†ç»„<ul>
<li>TermAggregationï¼šæŒ‰ç…§æ–‡æ¡£å­—æ®µå€¼åˆ†ç»„ï¼Œä¾‹å¦‚æŒ‰ç…§å“ç‰Œå€¼åˆ†ç»„ã€æŒ‰ç…§å›½å®¶åˆ†ç»„</li>
<li>Date Histogramï¼šæŒ‰ç…§æ—¥æœŸé˜¶æ¢¯åˆ†ç»„ï¼Œä¾‹å¦‚ä¸€å‘¨ä¸ºä¸€ç»„ï¼Œæˆ–è€…ä¸€æœˆä¸ºä¸€ç»„</li>
</ul>
</li>
<li><strong>åº¦é‡ï¼ˆMetricï¼‰</strong>èšåˆï¼šç”¨ä»¥è®¡ç®—ä¸€äº›å€¼ï¼Œæ¯”å¦‚ï¼šæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰<ul>
<li>Avgï¼šæ±‚å¹³å‡å€¼</li>
<li>Maxï¼šæ±‚æœ€å¤§å€¼</li>
<li>Minï¼šæ±‚æœ€å°å€¼</li>
<li>Statsï¼šåŒæ—¶æ±‚ maxã€minã€avgã€sum ç­‰</li>
</ul>
</li>
<li><strong>ç®¡é“ï¼ˆpipelineï¼‰</strong>èšåˆï¼šå…¶å®ƒèšåˆçš„ç»“æœä¸ºåŸºç¡€åšèšåˆ</li>
</ul>
<blockquote>
<p><strong>æ³¨æ„</strong>ï¼šå‚åŠ èšåˆçš„å­—æ®µå¿…é¡»æ˜¯keywordã€æ—¥æœŸã€æ•°å€¼ã€å¸ƒå°”ç±»å‹</p>
</blockquote>
<h3 id="Bucketèšåˆè¯­æ³•"><a href="#Bucketèšåˆè¯­æ³•" class="headerlink" title="Bucketèšåˆè¯­æ³•"></a>Bucketèšåˆè¯­æ³•</h3><p>ä¾‹å¦‚ï¼šæˆ‘ä»¬è¦ç»Ÿè®¡æ‰€æœ‰æ•°æ®ä¸­çš„é…’åº—å“ç‰Œæœ‰å‡ ç§ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§å“ç‰Œå¯¹æ•°æ®åˆ†ç»„ã€‚æ­¤æ—¶å¯ä»¥æ ¹æ®é…’åº—å“ç‰Œçš„åç§°åšèšåˆï¼Œä¹Ÿå°±æ˜¯ Bucket èšåˆã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// è®¾ç½®sizeä¸º0ï¼Œç»“æœä¸­ä¸åŒ…å«æ–‡æ¡£ï¼ŒåªåŒ…å«èšåˆç»“æœ</span>
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// å®šä¹‰èšåˆ</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//ç»™èšåˆèµ·ä¸ªåå­—</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// èšåˆçš„ç±»å‹ï¼ŒæŒ‰ç…§å“ç‰Œå€¼èšåˆï¼Œæ‰€ä»¥é€‰æ‹©term</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token comment">// å‚ä¸èšåˆçš„å­—æ®µ</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// å¸Œæœ›è·å–çš„èšåˆç»“æœæ•°é‡</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://cdn.xn2001.com/img/2021/20211022184007.png!/format/webp" alt="img"></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆä¼šç»Ÿè®¡ Bucket å†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º <code>_count</code>ï¼Œå¹¶ä¸”æŒ‰ç…§ <code>_count</code> é™åºæ’åºã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æŒ‡å®š order å±æ€§ï¼Œè‡ªå®šä¹‰èšåˆçš„æ’åºæ–¹å¼</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// æŒ‰ç…§_countå‡åºæ’åˆ—</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒBucket èšåˆæ˜¯å¯¹ç´¢å¼•åº“çš„æ‰€æœ‰æ–‡æ¡£åšèšåˆï¼Œä½†çœŸå®åœºæ™¯ä¸‹ï¼Œç”¨æˆ·ä¼šè¾“å…¥æœç´¢æ¡ä»¶ï¼Œå› æ­¤èšåˆå¿…é¡»æ˜¯å¯¹æœç´¢ç»“æœèšåˆã€‚é‚£ä¹ˆèšåˆå¿…é¡»æ·»åŠ é™å®šæ¡ä»¶ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é™å®šè¦èšåˆçš„æ–‡æ¡£èŒƒå›´ï¼Œåªè¦æ·»åŠ  query æ¡ä»¶å³å¯ï¼›</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// åªå¯¹200å…ƒä»¥ä¸‹çš„æ–‡æ¡£èšåˆ</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ¬¡ï¼Œèšåˆå¾—åˆ°çš„å“ç‰Œæ˜æ˜¾å˜å°‘äº†</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211022184549.png!/format/webp" alt="img"></p>
<h3 id="Metricèšåˆè¯­æ³•"><a href="#Metricèšåˆè¯­æ³•" class="headerlink" title="Metricèšåˆè¯­æ³•"></a>Metricèšåˆè¯­æ³•</h3><p>ä¸Šé¢ï¼Œæˆ‘ä»¬å¯¹é…’åº—æŒ‰ç…§å“ç‰Œåˆ†ç»„ï¼Œå½¢æˆäº†ä¸€ä¸ªä¸ªæ¡¶ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å¯¹æ¡¶å†…çš„é…’åº—åšè¿ç®—ï¼Œè·å–æ¯ä¸ªå“ç‰Œçš„ç”¨æˆ·è¯„åˆ†çš„ minã€maxã€avg ç­‰å€¼ã€‚</p>
<p>è¿™å°±è¦ç”¨åˆ° Metric èšåˆäº†ï¼Œä¾‹å¦‚ stats èšåˆï¼šå°±å¯ä»¥è·å– minã€maxã€avg ç­‰ç»“æœ</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /hotel/_search
<span class="token punctuation">{</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> 
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// æ˜¯brandsèšåˆçš„å­èšåˆï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„åå¯¹æ¯ç»„åˆ†åˆ«è®¡ç®—</span>
        <span class="token property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// èšåˆåç§°</span>
          <span class="token property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// èšåˆç±»å‹ï¼Œè¿™é‡Œstatså¯ä»¥è®¡ç®—minã€maxã€avgç­‰</span>
            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span> <span class="token comment">// èšåˆå­—æ®µï¼Œè¿™é‡Œæ˜¯score</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ¬¡çš„ score_stats èšåˆæ˜¯åœ¨ brandAgg çš„èšåˆå†…éƒ¨åµŒå¥—çš„å­èšåˆã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªæ¡¶åˆ†åˆ«è®¡ç®—ã€‚</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»™èšåˆç»“æœåšä¸ªæ’åºï¼Œä¾‹å¦‚æŒ‰ç…§æ¯ä¸ªæ¡¶çš„é…’åº—å¹³å‡åˆ†åšæ’åº</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211022184847.png!/format/webp" alt="img"></p>
<h2 id="RestAPIæ•°æ®èšåˆ"><a href="#RestAPIæ•°æ®èšåˆ" class="headerlink" title="RestAPIæ•°æ®èšåˆ"></a>RestAPIæ•°æ®èšåˆ</h2><p>èšåˆæ¡ä»¶ä¸ query æ¡ä»¶åŒçº§åˆ«ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ <code>request.source()</code> æ¥æŒ‡å®šèšåˆæ¡ä»¶</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211022190429.png!/format/webp" alt="img"></p>
<p>èšåˆçš„ç»“æœä¹Ÿä¸æŸ¥è¯¢ç»“æœä¸åŒï¼ŒAPI ä¹Ÿæ¯”è¾ƒç‰¹æ®Šã€‚ä¸è¿‡åŒæ ·æ˜¯ JSON é€å±‚è§£æ</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211022190457.png!/format/webp" alt="img"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brand"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Terms</span> brandAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brandAgg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> brandAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"key = "</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è‡ªåŠ¨è¡¥å…¨"><a href="#è‡ªåŠ¨è¡¥å…¨" class="headerlink" title="è‡ªåŠ¨è¡¥å…¨"></a>è‡ªåŠ¨è¡¥å…¨</h2><p>å½“ç”¨æˆ·åœ¨æœç´¢æ¡†è¾“å…¥å­—ç¬¦æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æç¤ºå‡ºä¸è¯¥å­—ç¬¦æœ‰å…³çš„æœç´¢é¡¹ï¼Œæç¤ºå®Œæ•´è¯æ¡çš„åŠŸèƒ½ï¼Œå°±æ˜¯è‡ªåŠ¨è¡¥å…¨äº†ã€‚</p>
<h3 id="æ‹¼éŸ³åˆ†è¯å™¨"><a href="#æ‹¼éŸ³åˆ†è¯å™¨" class="headerlink" title="æ‹¼éŸ³åˆ†è¯å™¨"></a>æ‹¼éŸ³åˆ†è¯å™¨</h3><p>å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®æ‹¼éŸ³å­—æ¯æ¥æ¨æ–­ï¼Œå› æ­¤è¦ç”¨åˆ°æ‹¼éŸ³åˆ†è¯åŠŸèƒ½ã€‚</p>
<p>è¦å®ç°æ ¹æ®å­—æ¯åšè¡¥å…¨ï¼Œå°±å¿…é¡»å¯¹æ–‡æ¡£æŒ‰ç…§æ‹¼éŸ³åˆ†è¯ã€‚æ’ä»¶åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p>
<p><img src="https://cdn.xn2001.com/img/2021/20211023015636.png!/format/webp" alt="img"></p>
<p>ä½¿ç”¨ <code>docker volume inspect es-plugins</code> æŸ¥çœ‹æ’ä»¶ç›®å½•ï¼Œå°†ä¸‹è½½çš„æ–‡ä»¶è§£å‹ä¸Šä¼ ï¼Œé‡å¯ Elasticsearch</p>
<p>æµ‹è¯•ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">POST /_analyze
<span class="token punctuation">{</span>
  <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"å¦‚å®¶é…’åº—è¿˜ä¸é”™"</span><span class="token punctuation">,</span>
  <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»“æœï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211023021713.png!/format/webp" alt="img"></p>
<h3 id="è‡ªå®šä¹‰åˆ†è¯å™¨"><a href="#è‡ªå®šä¹‰åˆ†è¯å™¨" class="headerlink" title="è‡ªå®šä¹‰åˆ†è¯å™¨"></a>è‡ªå®šä¹‰åˆ†è¯å™¨</h3><p>é»˜è®¤çš„æ‹¼éŸ³åˆ†è¯å™¨ä¼šå°†æ¯ä¸ªæ±‰å­—å•ç‹¬åˆ†ä¸ºæ‹¼éŸ³ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯æ¯ä¸ªè¯æ¡å½¢æˆä¸€ç»„æ‹¼éŸ³ï¼Œéœ€è¦å¯¹æ‹¼éŸ³åˆ†è¯å™¨åšä¸ªæ€§åŒ–å®šåˆ¶ï¼Œå½¢æˆè‡ªå®šä¹‰åˆ†è¯å™¨ã€‚</p>
<p>elasticsearch ä¸­åˆ†è¯å™¨ï¼ˆanalyzerï¼‰çš„ç»„æˆåŒ…å«ä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>character filtersï¼šåœ¨ tokenizer ä¹‹å‰å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚åˆ é™¤å­—ç¬¦ã€æ›¿æ¢å­—ç¬¦</li>
<li>tokenizerï¼šå°†æ–‡æœ¬æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ‡å‰²æˆè¯æ¡ï¼ˆtermï¼‰ã€‚ä¾‹å¦‚ keywordï¼Œå°±æ˜¯ä¸åˆ†è¯ï¼›è¿˜æœ‰ ik_smart</li>
<li>tokenizer filterï¼šå°† tokenizer è¾“å‡ºçš„è¯æ¡åšè¿›ä¸€æ­¥å¤„ç†ã€‚ä¾‹å¦‚å¤§å°å†™è½¬æ¢ã€åŒä¹‰è¯å¤„ç†ã€æ‹¼éŸ³å¤„ç†ç­‰</li>
</ul>
<p>æ–‡æ¡£åˆ†è¯æ—¶ä¼šä¾æ¬¡ç”±è¿™ä¸‰éƒ¨åˆ†æ¥å¤„ç†æ–‡æ¡£ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211023021451.png!/format/webp" alt="img"></p>
<p>å£°æ˜è‡ªå®šä¹‰åˆ†è¯å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /test
<span class="token punctuation">{</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// è‡ªå®šä¹‰åˆ†è¯å™¨</span>
        <span class="token property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// åˆ†è¯å™¨åç§°</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// è‡ªå®šä¹‰tokenizer filter</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// è¿‡æ»¤å™¨åç§°</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span> <span class="token comment">// è¿‡æ»¤å™¨ç±»å‹ï¼Œè¿™é‡Œæ˜¯pinyin</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æµ‹è¯•</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211023021532.png!/format/webp" alt="img"></p>
<p>æ³¨æ„<strong>ï¼šä¸ºäº†é¿å…æœç´¢åˆ°åŒéŸ³å­—ï¼Œæœç´¢æ—¶ä¸è¦ä½¿ç”¨æ‹¼éŸ³åˆ†è¯å™¨</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20211023022355.png!/format/webp" alt="img"></p>
<h3 id="è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢"><a href="#è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢" class="headerlink" title="è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢"></a>è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢</h3><p>elasticsearch æä¾›äº† <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html">Completion Suggester</a> æŸ¥è¯¢æ¥å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚è¿™ä¸ªæŸ¥è¯¢ä¼šåŒ¹é…ä»¥ç”¨æˆ·è¾“å…¥å†…å®¹å¼€å¤´çš„è¯æ¡å¹¶è¿”å›ï¼›ä¸ºäº†æé«˜è¡¥å…¨æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯¹äºæ–‡æ¡£ä¸­å­—æ®µçš„ç±»å‹æœ‰ä¸€äº›çº¦æŸ</p>
<ul>
<li>å‚ä¸è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µå¿…é¡»æ˜¯ completion ç±»å‹ã€‚</li>
<li>å­—æ®µçš„å†…å®¹ä¸€èˆ¬æ˜¯ç”¨æ¥è¡¥å…¨çš„å¤šä¸ªè¯æ¡å½¢æˆçš„æ•°ç»„ã€‚</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// åˆ›å»ºç´¢å¼•åº“</span>
PUT test
<span class="token punctuation">{</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"title"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åæ’å…¥ä¸‹é¢çš„æ•°æ®</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// ç¤ºä¾‹æ•°æ®</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WH-1000XM3"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
POST test/_doc
<span class="token punctuation">{</span>
  <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nintendo"</span><span class="token punctuation">,</span> <span class="token string">"switch"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŸ¥è¯¢çš„ DSL è¯­å¥å¦‚ä¸‹</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// è‡ªåŠ¨è¡¥å…¨æŸ¥è¯¢</span>
GET /test/_search
<span class="token punctuation">{</span>
  <span class="token property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// å…³é”®å­—</span>
      <span class="token property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// è¡¥å…¨æŸ¥è¯¢çš„å­—æ®µ</span>
        <span class="token property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// è·³è¿‡é‡å¤çš„</span>
        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// è·å–å‰10æ¡ç»“æœ</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¾‹å¦‚ä¸€ä¸ªé…’åº—çš„ç´¢å¼•åº“å®Œæ•´æ¡ˆä¾‹</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// é…’åº—æ•°æ®ç´¢å¼•åº“</span>
PUT /hotel
<span class="token punctuation">{</span>
  <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"text_anlyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"completion_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
          <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"py"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span>
          <span class="token property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"address"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"price"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"score"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"brand"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"city"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"starName"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"business"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"location"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"pic"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"all"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"text_anlyzer"</span><span class="token punctuation">,</span>
        <span class="token property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"suggestion"</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span><span class="token punctuation">,</span>
          <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"completion_analyzer"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="JavaAPI"><a href="#JavaAPI" class="headerlink" title="JavaAPI"></a>JavaAPI</h3><p><img src="https://cdn.xn2001.com/img/2021/20211025113007.png!/format/webp" alt="img"></p>
<p>è§£æå“åº”çš„ä»£ç å¦‚ä¸‹</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025113011.png!/format/webp" alt="img"></p>
<h2 id="æ•°æ®åŒæ­¥"><a href="#æ•°æ®åŒæ­¥" class="headerlink" title="æ•°æ®åŒæ­¥"></a>æ•°æ®åŒæ­¥</h2><p>elasticsearch ä¸­çš„æ•°æ®æ¥è‡ªäº mysqlæ•°æ®åº“ï¼Œå› æ­¤ mysql æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œelasticsearch ä¹Ÿå¿…é¡»è·Ÿç€æ”¹å˜ï¼Œè¿™ä¸ªå°±æ˜¯ elasticsearch ä¸ mysql ä¹‹é—´çš„<strong>æ•°æ®åŒæ­¥</strong></p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025163219.png!/format/webp" alt="img"></p>
<p>å¸¸è§çš„æ•°æ®åŒæ­¥æ–¹æ¡ˆæœ‰ä¸‰ç§</p>
<ul>
<li>åŒæ­¥è°ƒç”¨</li>
<li>å¼‚æ­¥é€šçŸ¥</li>
<li>ç›‘å¬ binlog</li>
</ul>
<h3 id="åŒæ­¥è°ƒç”¨"><a href="#åŒæ­¥è°ƒç”¨" class="headerlink" title="åŒæ­¥è°ƒç”¨"></a>åŒæ­¥è°ƒç”¨</h3><p>æ–¹æ¡ˆä¸€ï¼šåŒæ­¥è°ƒç”¨</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025163313.png!/format/webp" alt="img"></p>
<ul>
<li>hotel-demoå¯¹å¤–æä¾›æ¥å£ï¼Œç”¨æ¥ä¿®æ”¹ elasticsearch ä¸­çš„æ•°æ®</li>
<li>é…’åº—ç®¡ç†æœåŠ¡åœ¨å®Œæˆæ•°æ®åº“æ“ä½œåï¼Œç›´æ¥è°ƒç”¨ hotel-demo æä¾›çš„æ¥å£</li>
</ul>
<h3 id="å¼‚æ­¥é€šçŸ¥"><a href="#å¼‚æ­¥é€šçŸ¥" class="headerlink" title="å¼‚æ­¥é€šçŸ¥"></a>å¼‚æ­¥é€šçŸ¥</h3><p>æ–¹æ¡ˆäºŒï¼šå¼‚æ­¥é€šçŸ¥</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025163346.png!/format/webp" alt="img"></p>
<ul>
<li>hotel-admin å¯¹ mysql æ•°æ®åº“æ•°æ®å®Œæˆå¢ã€åˆ ã€æ”¹åï¼Œå‘é€ MQ æ¶ˆæ¯</li>
<li>hotel-demoç›‘å¬ MQï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯åå®Œæˆ elasticsearch æ•°æ®ä¿®æ”¹</li>
</ul>
<h3 id="ç›‘å¬binlog"><a href="#ç›‘å¬binlog" class="headerlink" title="ç›‘å¬binlog"></a>ç›‘å¬binlog</h3><p>æ–¹æ¡ˆä¸‰ï¼šç›‘å¬binlog</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025163428.png!/format/webp" alt="img"></p>
<ul>
<li>mysql å¼€å¯ binlog åŠŸèƒ½</li>
<li>mysql å®Œæˆå¢ã€åˆ ã€æ”¹æ“ä½œéƒ½ä¼šè®°å½•åœ¨ binlog ä¸­</li>
<li>hotel-demo åŸºäºcanal ç›‘å¬ binlog å˜åŒ–ï¼Œå®æ—¶æ›´æ–° elasticsearch ä¸­çš„å†…å®¹</li>
</ul>
<h3 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p>æ–¹å¼ä¸€ï¼šåŒæ­¥è°ƒç”¨</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç²—æš´</li>
<li>ç¼ºç‚¹ï¼šä¸šåŠ¡è€¦åˆåº¦é«˜</li>
</ul>
<p>æ–¹å¼äºŒï¼šå¼‚æ­¥é€šçŸ¥</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä½è€¦åˆï¼Œå®ç°éš¾åº¦ä¸€èˆ¬</li>
<li>ç¼ºç‚¹ï¼šä¾èµ– mq çš„å¯é æ€§</li>
</ul>
<p>æ–¹å¼ä¸‰ï¼šç›‘å¬binlog</p>
<ul>
<li>ä¼˜ç‚¹ï¼šå®Œå…¨è§£é™¤æœåŠ¡é—´è€¦åˆ</li>
<li>ç¼ºç‚¹ï¼šå¼€å¯ binlog å¢åŠ æ•°æ®åº“è´Ÿæ‹…ã€å®ç°å¤æ‚åº¦é«˜</li>
</ul>
<h3 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h3><p>æˆ‘ä»¬ä»¥<strong>å¼‚æ­¥é€šçŸ¥</strong>ä¸ºä¾‹ï¼Œä½¿ç”¨ MQ æ¶ˆæ¯ä¸­é—´ä»¶</p>
<p>MQç»“æ„å¦‚å›¾ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2021/20211025163734.png!/format/webp" alt="img"></p>
<p><strong>å¼•å…¥ä¾èµ–</strong>ï¼Œåœ¨ hotel-adminã€hotel-demo ä¸­å¼•å…¥ rabbitmq çš„ä¾èµ–ï¼š</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--amqp--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>å£°æ˜é˜Ÿåˆ—äº¤æ¢æœº</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MQConstants</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * äº¤æ¢æœº
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_EXCHANGE <span class="token operator">=</span> <span class="token string">"hotel.topic"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * ç›‘å¬æ–°å¢å’Œä¿®æ”¹çš„é˜Ÿåˆ—
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.insert.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * ç›‘å¬åˆ é™¤çš„é˜Ÿåˆ—
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_QUEUE <span class="token operator">=</span> <span class="token string">"hotel.delete.queue"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * æ–°å¢æˆ–ä¿®æ”¹çš„RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_INSERT_KEY <span class="token operator">=</span> <span class="token string">"hotel.insert"</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * åˆ é™¤çš„RoutingKey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> HOTEL_DELETE_KEY <span class="token operator">=</span> <span class="token string">"hotel.delete"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¶ˆæ¯æ¥æ”¶æ–¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MqConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TopicExchange</span> <span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">insertQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">insertQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deleteQueueBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deleteQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">topicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¶ˆæ¯å‘é€æ–¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_KEY<span class="token punctuation">,</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_EXCHANGE<span class="token punctuation">,</span> <span class="token class-name">MQConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_KEY<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ¶ˆæ¯æ¥æ”¶æ–¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹æ®idæŸ¥è¯¢é…’åº—æ•°æ®</span>
        <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HotelService</span> hotelService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * ç›‘å¬é…’åº—æ–°å¢æˆ–ä¿®æ”¹çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_INSERT_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelInsertOrUpdate</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hotelService<span class="token punctuation">.</span><span class="token function">insertById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * ç›‘å¬é…’åº—åˆ é™¤çš„ä¸šåŠ¡
     *
     * @param id é…’åº—id
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token class-name">MqConstants</span><span class="token punctuation">.</span>HOTEL_DELETE_QUEUE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenHotelDelete</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hotelService<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="Elasticsearché›†ç¾¤"><a href="#Elasticsearché›†ç¾¤" class="headerlink" title="Elasticsearché›†ç¾¤"></a>Elasticsearché›†ç¾¤</h1><p>å•æœºçš„ Elasticsearch åšæ•°æ®å­˜å‚¨ï¼Œå¿…ç„¶é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼šæµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ã€å•ç‚¹æ•…éšœé—®é¢˜ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜ï¼šå°†ç´¢å¼•åº“ä»é€»è¾‘ä¸Šæ‹†åˆ†ä¸ºNä¸ªåˆ†ç‰‡ï¼ˆshardï¼‰ï¼Œå­˜å‚¨åˆ°å¤šä¸ªèŠ‚ç‚¹</li>
<li>å•ç‚¹æ•…éšœé—®é¢˜ï¼šå°†åˆ†ç‰‡æ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹å¤‡ä»½ï¼ˆreplica ï¼‰</li>
</ul>
<p><strong>ESé›†ç¾¤ç›¸å…³æ¦‚å¿µ</strong>ï¼š</p>
<ul>
<li>é›†ç¾¤ï¼ˆclusterï¼‰ï¼šä¸€ç»„æ‹¥æœ‰å…±åŒçš„ cluster name çš„ èŠ‚ç‚¹ã€‚</li>
<li>èŠ‚ç‚¹ï¼ˆnode) ï¼šé›†ç¾¤ä¸­çš„ä¸€ä¸ª Elasticearch å®ä¾‹</li>
<li>åˆ†ç‰‡ï¼ˆshardï¼‰ï¼šç´¢å¼•å¯ä»¥è¢«æ‹†åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†è¿›è¡Œå­˜å‚¨ï¼Œç§°ä¸ºåˆ†ç‰‡ã€‚<strong>åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç´¢å¼•çš„ä¸åŒåˆ†ç‰‡å¯ä»¥æ‹†åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸­ï¼Œè§£å†³æ•°æ®é‡å¤ªå¤§ï¼Œå•ç‚¹å­˜å‚¨é‡æœ‰é™çš„é—®é¢˜ã€‚</strong></li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2022/202205071006783.png!/format/webp" alt="img"></p>
<blockquote>
<p>æ­¤å¤„ï¼Œæˆ‘ä»¬æŠŠæ•°æ®åˆ†æˆ3ç‰‡ï¼šshard0ã€shard1ã€shard2</p>
<p>ä¸»åˆ†ç‰‡ï¼ˆPrimary shardï¼‰ï¼šç›¸å¯¹äºå‰¯æœ¬åˆ†ç‰‡çš„å®šä¹‰ã€‚</p>
<p>å‰¯æœ¬åˆ†ç‰‡ï¼ˆReplica shardï¼‰æ¯ä¸ªä¸»åˆ†ç‰‡å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‰¯æœ¬ï¼Œæ•°æ®å’Œä¸»åˆ†ç‰‡ä¸€æ ·ã€‚</p>
</blockquote>
<p>æ•°æ®å¤‡ä»½å¯ä»¥ä¿è¯é«˜å¯ç”¨ï¼Œä½†æ˜¯æ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½åœ¨èŠ‚ç‚¹ä¸Šï¼Œæ‰€éœ€è¦çš„èŠ‚ç‚¹æ•°é‡å°±ä¼šç¿»å€ï¼Œæˆæœ¬å¤ªé«˜ã€‚ä¸ºäº†åœ¨é«˜å¯ç”¨å’Œæˆæœ¬é—´å¯»æ±‚å¹³è¡¡</p>
<ul>
<li>é¦–å…ˆå¯¹æ•°æ®åˆ†ç‰‡ï¼Œå­˜å‚¨åˆ°ä¸åŒèŠ‚ç‚¹</li>
<li>ç„¶åå¯¹æ¯ä¸ªåˆ†ç‰‡è¿›è¡Œå¤‡ä»½ï¼Œæ”¾åˆ°å¯¹æ–¹èŠ‚ç‚¹ï¼Œ<strong>å®Œæˆäº’ç›¸å¤‡ä»½</strong></li>
</ul>
<p>è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘æ‰€éœ€è¦çš„æœåŠ¡èŠ‚ç‚¹æ•°é‡ï¼Œå¦‚å›¾ï¼Œæˆ‘ä»¬ä»¥3åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¤‡ä»½ä¸€ä»½ä¸ºä¾‹ï¼š</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071006790.png!/format/webp" alt="img"></p>
<p>ç°åœ¨ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰1ä¸ªå¤‡ä»½ï¼Œå­˜å‚¨åœ¨3ä¸ªèŠ‚ç‚¹ï¼š</p>
<ul>
<li>node0ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ1</li>
<li>node1ï¼šä¿å­˜äº†åˆ†ç‰‡0å’Œ2</li>
<li>node2ï¼šä¿å­˜äº†åˆ†ç‰‡1å’Œ2</li>
</ul>
<h2 id="éƒ¨ç½²é›†ç¾¤"><a href="#éƒ¨ç½²é›†ç¾¤" class="headerlink" title="éƒ¨ç½²é›†ç¾¤"></a>éƒ¨ç½²é›†ç¾¤</h2><h3 id="æ­å»ºElasticsearch"><a href="#æ­å»ºElasticsearch" class="headerlink" title="æ­å»ºElasticsearch"></a>æ­å»ºElasticsearch</h3><p>æˆ‘ä»¬ä¼šåœ¨å•æœºä¸Šåˆ©ç”¨ Docker å®¹å™¨è¿è¡Œå¤šä¸ª Elasticsearch å®ä¾‹æ¥æ¨¡æ‹Ÿé›†ç¾¤ã€‚</p>
<p>å¯ä»¥ç›´æ¥ä½¿ç”¨ docker-compose æ¥å®Œæˆï¼Œè¿™è¦æ±‚ä½ çš„Linuxè™šæ‹Ÿæœºè‡³å°‘æœ‰<strong>4G</strong>ä»¥ä¸Šçš„å†…å­˜ç©ºé—´ã€‚</p>
<p>docker-compose.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">es01</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.12.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es01
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> node.name=es01
      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>cluster
      <span class="token punctuation">-</span> discovery.seed_hosts=es02<span class="token punctuation">,</span>es03
      <span class="token punctuation">-</span> cluster.initial_master_nodes=es01<span class="token punctuation">,</span>es02<span class="token punctuation">,</span>es03
      <span class="token punctuation">-</span> <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data01<span class="token punctuation">:</span>/usr/share/elasticsearch/data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elastic
  <span class="token key atrule">es02</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.12.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es02
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> node.name=es02
      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>cluster
      <span class="token punctuation">-</span> discovery.seed_hosts=es01<span class="token punctuation">,</span>es03
      <span class="token punctuation">-</span> cluster.initial_master_nodes=es01<span class="token punctuation">,</span>es02<span class="token punctuation">,</span>es03
      <span class="token punctuation">-</span> <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data02<span class="token punctuation">:</span>/usr/share/elasticsearch/data
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9201<span class="token punctuation">:</span><span class="token number">9200</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elastic
  <span class="token key atrule">es03</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.12.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es03
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> node.name=es03
      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>cluster
      <span class="token punctuation">-</span> discovery.seed_hosts=es01<span class="token punctuation">,</span>es02
      <span class="token punctuation">-</span> cluster.initial_master_nodes=es01<span class="token punctuation">,</span>es02<span class="token punctuation">,</span>es03
      <span class="token punctuation">-</span> <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> data03<span class="token punctuation">:</span>/usr/share/elasticsearch/data
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> elastic
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9202<span class="token punctuation">:</span><span class="token number">9200</span>
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">data01</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
  <span class="token key atrule">data02</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
  <span class="token key atrule">data03</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">elastic</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¿®æ”¹ Linux ç³»ç»Ÿæƒé™ï¼Œä¿®æ”¹ <code>/etc/sysctl.conf</code> æ–‡ä»¶</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">vi /etc/sysctl.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ·»åŠ ä¸‹é¢çš„å†…å®¹</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">vm.max_map_count=262144<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è®©é…ç½®ç”Ÿæ•ˆï¼š</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">sysctl -p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>é€šè¿‡docker-composeå¯åŠ¨é›†ç¾¤</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">docker-compose up -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="é›†ç¾¤çŠ¶æ€ç›‘æ§"><a href="#é›†ç¾¤çŠ¶æ€ç›‘æ§" class="headerlink" title="é›†ç¾¤çŠ¶æ€ç›‘æ§"></a>é›†ç¾¤çŠ¶æ€ç›‘æ§</h3><p>kibana å¯ä»¥ç›‘æ§ Elasticsearch é›†ç¾¤ï¼Œä½†æ˜¯æ›´æ¨èä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/lmenezes/cerebro">cerebro</a></p>
<p>ä¸‹è½½è§£å‹æ‰“å¼€ /bin/cerebro.bat</p>
<p>è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:9000/">http://localhost:9000</a> å³å¯è¿›å…¥ç®¡ç†ç•Œé¢</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071018030.png!/format/webp" alt="img"></p>
<p>è¾“å…¥ä»»æ„èŠ‚ç‚¹çš„åœ°å€å’Œç«¯å£ï¼Œç‚¹å‡» connect</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071018761.png!/format/webp" alt="img"></p>
<p>ç»¿è‰²çš„çº¿æ¡ä»£è¡¨é›†ç¾¤å¤„äºç»¿è‰²ï¼ˆå¥åº·çŠ¶æ€ï¼‰</p>
<h3 id="åˆ›å»ºç´¢å¼•åº“-1"><a href="#åˆ›å»ºç´¢å¼•åº“-1" class="headerlink" title="åˆ›å»ºç´¢å¼•åº“"></a>åˆ›å»ºç´¢å¼•åº“</h3><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ cerebro åˆ›å»ºç´¢å¼•åº“ï¼Œå½“ç„¶ä½ éœ€è¦ä½¿ç”¨ kibana ä¹Ÿå¯ä»¥ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071020771.png!/format/webp" alt="img"></p>
<p>å¡«å†™ç´¢å¼•åº“ä¿¡æ¯</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071023380.png!/format/webp" alt="img"></p>
<p>å›åˆ°é¦–é¡µï¼Œå³å¯æŸ¥çœ‹ç´¢å¼•åº“åˆ†ç‰‡æ•ˆæœ</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071024397.png!/format/webp" alt="img"></p>
<h2 id="é›†ç¾¤èŒè´£åˆ’åˆ†"><a href="#é›†ç¾¤èŒè´£åˆ’åˆ†" class="headerlink" title="é›†ç¾¤èŒè´£åˆ’åˆ†"></a>é›†ç¾¤èŒè´£åˆ’åˆ†</h2><p>Elasticsearch ä¸­é›†ç¾¤èŠ‚ç‚¹æœ‰ä¸åŒçš„èŒè´£åˆ’åˆ†</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071029258.png!/format/webp" alt="img"></p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒæ—¶å…¼èŒä¸Šè¿°å››ç§è§’è‰²ã€‚</strong></p>
<p>çœŸå®çš„é›†ç¾¤ä¸€å®šè¦å°†é›†ç¾¤èŒè´£åˆ†ç¦»</p>
<ul>
<li>master èŠ‚ç‚¹ï¼šå¯¹ CPU è¦æ±‚é«˜ï¼Œä½†æ˜¯å†…å­˜è¦æ±‚ä½</li>
<li>data èŠ‚ç‚¹ï¼šå¯¹ CPU å’Œå†…å­˜è¦æ±‚éƒ½é«˜</li>
<li>coordinating èŠ‚ç‚¹ï¼šå¯¹ç½‘ç»œå¸¦å®½ã€CPU è¦æ±‚é«˜</li>
</ul>
<p>èŒè´£åˆ†ç¦»å¯ä»¥è®©æˆ‘ä»¬æ ¹æ®ä¸åŒèŠ‚ç‚¹çš„éœ€æ±‚åˆ†é…ä¸åŒçš„ç¡¬ä»¶å»éƒ¨ç½²ã€‚è€Œä¸”é¿å…ä¸šåŠ¡ä¹‹é—´çš„äº’ç›¸å¹²æ‰°ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071029263.png!/format/webp" alt="img"></p>
<h2 id="é›†ç¾¤è„‘è£‚é—®é¢˜"><a href="#é›†ç¾¤è„‘è£‚é—®é¢˜" class="headerlink" title="é›†ç¾¤è„‘è£‚é—®é¢˜"></a>é›†ç¾¤è„‘è£‚é—®é¢˜</h2><p>è„‘è£‚æ˜¯å› ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¤±è”å¯¼è‡´çš„ã€‚</p>
<p>ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä¸»èŠ‚ç‚¹ node1 ä¸å…¶å®ƒèŠ‚ç‚¹å¤±è”ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071029267.png!/format/webp" alt="img"></p>
<p>æ­¤æ—¶ï¼Œnode2 å’Œ node3 è®¤ä¸º node1 å®•æœºï¼Œå°±ä¼šé‡æ–°é€‰ä¸»ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071344676.png!/format/webp" alt="img"></p>
<p>å½“ node3 å½“é€‰åï¼Œé›†ç¾¤ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ï¼Œnode2 å’Œ node3 è‡ªæˆé›†ç¾¤ï¼Œnode1 è‡ªæˆé›†ç¾¤ï¼Œä¸¤ä¸ªé›†ç¾¤æ•°æ®ä¸åŒæ­¥ï¼Œå‡ºç°æ•°æ®å·®å¼‚ã€‚</p>
<p>å½“ç½‘ç»œæ¢å¤åï¼Œå› ä¸ºé›†ç¾¤ä¸­æœ‰ä¸¤ä¸ª master èŠ‚ç‚¹ï¼Œé›†ç¾¤çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œå‡ºç°è„‘è£‚çš„æƒ…å†µã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071344829.png!/format/webp" alt="img"></p>
<p>è§£å†³è„‘è£‚çš„æ–¹æ¡ˆæ˜¯ï¼Œè¦æ±‚é€‰ç¥¨è¶…è¿‡ <strong>(eligibleèŠ‚ç‚¹æ•°é‡+1)/2</strong> æ‰èƒ½å½“é€‰ä¸º masterï¼Œå› æ­¤ eligible èŠ‚ç‚¹æ•°é‡æœ€å¥½æ˜¯å¥‡æ•°ã€‚å¯¹åº”é…ç½®é¡¹æ˜¯<code>discovery.zen.minimum_master_nodes</code>ï¼Œåœ¨ç‰ˆæœ¬ 7.0 ä»¥åï¼Œå·²ç»æˆä¸ºé»˜è®¤é…ç½®ï¼Œå› æ­¤ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿè„‘è£‚é—®é¢˜ã€‚</p>
<p>ä¾‹å¦‚ï¼š3ä¸ªèŠ‚ç‚¹å½¢æˆçš„é›†ç¾¤ï¼Œé€‰ç¥¨å¿…é¡»è¶…è¿‡ (3+1)/2 ï¼Œä¹Ÿå°±æ˜¯ 2 ç¥¨ã€‚node3 å¾—åˆ° node2 å’Œ node3 çš„é€‰ç¥¨ï¼Œå½“é€‰ä¸º masterã€‚node1 åªæœ‰è‡ªå·± 1 ç¥¨ï¼Œæ²¡æœ‰å½“é€‰ã€‚é›†ç¾¤ä¸­ä¾ç„¶åªæœ‰1ä¸ªä¸»èŠ‚ç‚¹ï¼Œæ²¡æœ‰å‡ºç°è„‘è£‚ã€‚</p>
<h2 id="é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨"><a href="#é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨" class="headerlink" title="é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨"></a>é›†ç¾¤åˆ†å¸ƒå¼å­˜å‚¨</h2><p>å½“æ–°å¢æ–‡æ¡£æ—¶ï¼Œåº”è¯¥ä¿å­˜åˆ°ä¸åŒåˆ†ç‰‡ï¼Œä¿è¯æ•°æ®å‡è¡¡ï¼Œé‚£ä¹ˆ coordinating node å¦‚ä½•ç¡®å®šæ•°æ®è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡å‘¢ï¼Ÿ</p>
<p>Elasticsearch ä¼šé€šè¿‡ hash ç®—æ³•æ¥è®¡ç®—æ–‡æ¡£åº”è¯¥å­˜å‚¨åˆ°å“ªä¸ªåˆ†ç‰‡</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071412275.png!/format/webp" alt="img"></p>
<ul>
<li>_routing é»˜è®¤æ˜¯æ–‡æ¡£çš„ id</li>
<li>ç®—æ³•ä¸åˆ†ç‰‡æ•°é‡æœ‰å…³ï¼Œå› æ­¤ç´¢å¼•åº“ä¸€æ—¦åˆ›å»ºï¼Œåˆ†ç‰‡æ•°é‡ä¸èƒ½ä¿®æ”¹ï¼</li>
</ul>
<p>æ–°å¢æ–‡æ¡£çš„æµç¨‹å¦‚ä¸‹å›¾ï¼Œ</p>
<ol>
<li>æ–°å¢ä¸€ä¸ª id=1 çš„æ–‡æ¡£</li>
<li>å¯¹ id åš hash è¿ç®—ï¼Œå‡å¦‚å¾—åˆ°çš„æ˜¯ 2ï¼Œåˆ™åº”è¯¥å­˜å‚¨åˆ° shard-2</li>
<li>shard-2 çš„ä¸»åˆ†ç‰‡åœ¨ node3 èŠ‚ç‚¹ï¼Œå°†æ•°æ®è·¯ç”±åˆ° node3ï¼Œnode3 ä¿å­˜æ–‡æ¡£</li>
<li>åŒæ­¥ç»™ shard-2 çš„å‰¯æœ¬åˆ†ç‰‡2(R-2)ï¼Œåœ¨ node2 èŠ‚ç‚¹</li>
<li>è¿”å›ç»“æœç»™ coordinating-node èŠ‚ç‚¹(node1)</li>
</ol>
<p><img src="https://cdn.xn2001.com/img/2022/202205071412283.png!/format/webp" alt="img"></p>
<h2 id="é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢"><a href="#é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢" class="headerlink" title="é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢"></a>é›†ç¾¤åˆ†å¸ƒå¼æŸ¥è¯¢</h2><p>Elasticsearch æŸ¥è¯¢åˆ†æˆä¸¤ä¸ªé˜¶æ®µ</p>
<ul>
<li>scatter phaseï¼šåˆ†æ•£é˜¶æ®µï¼Œcoordinating node ä¼šæŠŠè¯·æ±‚åˆ†å‘åˆ°æ¯ä¸€ä¸ªåˆ†ç‰‡ã€‚</li>
<li>gather phaseï¼šèšé›†é˜¶æ®µï¼Œcoordinating node æ±‡æ€» data node çš„æœç´¢ç»“æœï¼Œå¹¶å¤„ç†ä¸ºæœ€ç»ˆç»“æœé›†è¿”å›ç»™ç”¨æˆ·ã€‚</li>
</ul>
<p><img src="https://cdn.xn2001.com/img/2022/202205071422105.png!/format/webp" alt="img"></p>
<h2 id="é›†ç¾¤æ•…éšœè½¬ç§»"><a href="#é›†ç¾¤æ•…éšœè½¬ç§»" class="headerlink" title="é›†ç¾¤æ•…éšœè½¬ç§»"></a>é›†ç¾¤æ•…éšœè½¬ç§»</h2><p>é›†ç¾¤çš„ master èŠ‚ç‚¹ä¼šç›‘æ§é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœ‰èŠ‚ç‚¹å®•æœºï¼Œä¼šç«‹å³å°†å®•æœºèŠ‚ç‚¹çš„åˆ†ç‰‡æ•°æ®è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼Œè¿™ä¸ªå«åšæ•…éšœè½¬ç§»ã€‚</p>
<p>ä¾‹å¦‚ä¸€ä¸ªé›†ç¾¤ç»“æ„å¦‚å›¾ï¼Œä¸‰ä¸ªéƒ½æ˜¯å¥åº·çš„ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071516134.png!/format/webp" alt="img"></p>
<p>ç°åœ¨ï¼Œnode1 æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå…¶å®ƒä¸¤ä¸ªèŠ‚ç‚¹æ˜¯ä»èŠ‚ç‚¹ã€‚çªç„¶ï¼Œnode1 å‘ç”Ÿäº†æ•…éšœ</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071516139.png!/format/webp" alt="img"></p>
<p>å®•æœºåçš„ç¬¬ä¸€ä»¶äº‹ï¼Œéœ€è¦é‡æ–°é€‰ä¸»ï¼Œä¾‹å¦‚é€‰ä¸­äº† node2</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071516685.png!/format/webp" alt="img"></p>
<p>node2 æˆä¸ºä¸»èŠ‚ç‚¹åï¼Œä¼šæ£€æµ‹é›†ç¾¤ç›‘æ§çŠ¶æ€ï¼Œå°† node1 ä¸Šçš„æ•°æ®è¿ç§»åˆ° node2ã€node3ï¼Œç¡®ä¿æ•°æ®ä¾æ—§æ­£å¸¸è®¿é—®ã€‚</p>
<p><img src="https://cdn.xn2001.com/img/2022/202205071516805.png!/format/webp" alt="img"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">zhr</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zhang159-a.github.io/2022/09/16/wei-fu-wu-ji-zhu-zhan/">https://zhang159-a.github.io/2022/09/16/wei-fu-wu-ji-zhu-zhan/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">zhr</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/springcloud/">
                                    <span class="chip bg-color">springcloud</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2022/09/16/python-gong-jiang-2-shu-zhi-yu-zi-fu-chuan/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Pythonå·¥åŒ ï¼š2ã€æ•°å€¼ä¸å­—ç¬¦ä¸²">
                        
                        <span class="card-title">Pythonå·¥åŒ ï¼š2ã€æ•°å€¼ä¸å­—ç¬¦ä¸²</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-09-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Python%E5%B7%A5%E5%8C%A0/" class="post-category">
                                    Pythonå·¥åŒ 
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/python/">
                        <span class="chip bg-color">python</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/09/15/python-gong-jiang-1-bian-liang-he-zhu-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="Pythonå·¥åŒ ï¼š1ã€å˜é‡å’Œæ³¨é‡Š">
                        
                        <span class="card-title">Pythonå·¥åŒ ï¼š1ã€å˜é‡å’Œæ³¨é‡Š</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-09-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Python%E5%B7%A5%E5%8C%A0/" class="post-category">
                                    Pythonå·¥åŒ 
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/python/">
                        <span class="chip bg-color">python</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <a href="/about" target="_blank">Zhr</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;ç«™ç‚¹æ€»å­—æ•°:&nbsp;<span
                        class="white-color">494.2k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "09";
                        var startDate = "1";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // åŒºåˆ†æ˜¯å¦æœ‰å¹´ä»½.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = 'æœ¬ç«™å·²è¿è¡Œ ' + diffDays + ' å¤©';
                            } else if (language === 'zh-HK') {
                                daysTip = 'æœ¬ç«™å·²é‹è¡Œ ' + diffDays + ' å¤©';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = 'æœ¬ç«™å·²è¿è¡Œ ' + diffYears + ' å¹´ ' + diffDays + ' å¤©';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = 'æœ¬ç«™å·²é‹è¡Œ ' + diffYears + ' å¹´ ' + diffDays + ' å¤©';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zhang159-a" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1397543194@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1397543194" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 1397543194" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- ç™½å¤©å’Œé»‘å¤œä¸»é¢˜ -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- é›ªèŠ±ç‰¹æ•ˆ -->
    

    <!-- é¼ æ ‡æ˜Ÿæ˜Ÿç‰¹æ•ˆ -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--è…¾è®¯å…”å°å·¢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>

</html>
